<!DOCTYPE html>

<html lang="ar" dir="rtl">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NC 1 Eagles - Botros Race Ultimate</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>



    <style>

        :root {

    --bg-primary: #0f172a; 

    --bg-secondary: rgba(30, 41, 59, 0.75); 

    --bg-tertiary: rgba(51, 65, 85, 0.75);

    --bg-locked: rgba(71, 85, 105, 0.75); 

    --accent-cyan: #06b6d4; 

    --accent-green: #22c55e;

    --accent-red: #ef4444; 

    --accent-yellow: #facc15; 

    --accent-purple: #8b5cf6; 

    --accent-blue: #3b82f6;

    --text-primary: #f8fafc; 

    --text-secondary: #94a3b8;

}

body { 

    font-family: 'Cairo', sans-serif; 

    background-image: url('https://v15mbanna3.github.io/my-sounds/Botros%20race.png'); 

    background-size: cover; 

    background-position: center; 

    background-attachment: fixed; 

    color: var(--text-primary); 

    margin: 0; 

    padding: 1rem; 

    display: flex; 

    align-items: center; 

    justify-content: center; 

    min-height: 100vh; 

    box-sizing: border-box; 

}

main { 

    width: 100%; 

    max-width: 900px; 

}

.screen-container { 

    width: 100%; 

    padding: 1.5rem; 

    border: 1px solid rgba(51, 65, 85, 0.5); 

    border-radius: 1.5rem; 

    background-color: rgba(15, 23, 42, 0.85); 

    backdrop-filter: blur(10px); 

    box-sizing: border-box; 

    display: none; 

    position: relative; 

    overflow: hidden; 

}

.screen-container.active { 

    display: block; 

    animation: fadeIn 0.5s ease; 

}

@keyframes fadeIn { 

    from { opacity: 0; transform: translateY(10px); } 

    to { opacity: 1; transform: translateY(0); } 

}

.screen-title { 

    font-size: 2rem; 

    font-weight: 900; 

    text-align: center; 

    margin-top: 0; 

    margin-bottom: 2rem; 

    color: var(--accent-cyan); 

    text-shadow: 2px 2px 4px rgba(0,0,0,0.5); 

    display: flex; 

    align-items: center; 

    justify-content: center; 

    gap: 0.75rem; 

}

.screen-title i { 

    font-size: 2.5rem; 

}

.screen-subtitle { 

    text-align: center; 

    color: var(--text-secondary); 

    font-size: 1rem; 

    margin-top: -1.5rem; 

    margin-bottom: 2rem; 

    max-width: 500px; 

    margin-left: auto; 

    margin-right: auto; 

}

.input-field { 

    width: 100%; 

    padding: 0.75rem 1rem; 

    background-color: var(--bg-secondary); 

    border: 1px solid var(--bg-tertiary); 

    border-radius: 0.75rem; 

    font-size: 1rem; 

    color: var(--text-primary); 

    box-sizing: border-box; 

    text-align: right; 

    transition: border-color 0.3s; 

}

.input-field:focus { 

    border-color: var(--accent-cyan); 

    outline: none; 

}

.form-group { 

    margin-bottom: 1.25rem; 

    text-align: right; 

}

.form-label { 

    display: block; 

    margin-bottom: 0.5rem; 

    font-weight: 700; 

    color: var(--text-secondary); 

}

.btn { 

    width: 100%; 

    padding: 1rem; 

    border-radius: 0.75rem; 

    font-size: 1.125rem; 

    font-weight: 700; 

    border: none; 

    cursor: pointer; 

    transition: all 0.2s; 

    display: flex; 

    align-items: center; 

    justify-content: center; 

    gap: 0.75rem; 

}

.btn i { 

    font-size: 1.5em; 

}

.btn:disabled { 

    background-color: var(--bg-locked); 

    color: var(--text-secondary); 

    cursor: not-allowed; 

}

.btn-primary { 

    background-color: var(--accent-cyan); 

    color: white; 

} 

.btn-primary:hover:not(:disabled) { 

    background-color: #0891b2; 

    transform: translateY(-2px); 

}

.btn-secondary { 

    background-color: var(--bg-tertiary); 

    color: var(--text-primary); 

} 

.btn-secondary:hover:not(:disabled) { 

    background-color: rgba(71, 85, 105, 0.8); 

}

.back-btn { 

    display: block; 

    margin: 2rem auto 0; 

    width: fit-content; 

    padding: 0.5rem 1.5rem; 

    font-size: 1rem; 

}

#mute-btn { 

    position: fixed; 

    top: 1.5rem; 

    right: 1.5rem; 

    width: 50px; 

    height: 50px; 

    border-radius: 50%; 

    background-color: rgba(255, 255, 255, 0.1); 

    color: white; 

    font-size: 1.5rem; 

    border: 1px solid var(--bg-tertiary); 

    cursor: pointer; 

    z-index: 1000; 

    display: flex; 

    align-items: center; 

    justify-content: center; 

}



#main-menu-screen .welcome-container { 

    position: relative; 

    padding-bottom: 1rem; 

}

#main-menu-screen .welcome-message { 

    font-size: 1.75rem; 

    font-weight: 900; 

    text-align: center; 

    margin-bottom: 0.5rem; 

}

#main-menu-screen .welcome-message .name { 

    color: var(--accent-cyan); 

}

#main-menu-screen .welcome-message .team-tag { 

    font-size: 1.2rem; 

    color: var(--accent-yellow); 

    font-weight: 700; 

}

#logout-btn { 

    position: absolute; 

    top: 0; 

    left: 0; 

    background: none; 

    border: none; 

    color: var(--text-secondary); 

    cursor: pointer; 

    padding: 0.5rem; 

    font-size: 1.5rem; 

}

#logout-btn:hover { 

    color: var(--accent-red); 

}

.tabs-container { 

    display: grid; 

    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 

    gap: 1rem; 

}

.tab-item { 

    background-color: var(--bg-secondary); 

    padding: 1rem; 

    border-radius: 1rem; 

    text-align: center; 

    font-size: 1rem; 

    font-weight: 700; 

    cursor: pointer; 

    transition: transform 0.2s ease, background-color 0.2s ease, border-bottom-color 0.2s ease;

    border-bottom: 4px solid transparent; 

}

.tab-item:hover { 

    transform: translateY(-5px); 

    background-color: var(--bg-tertiary); 

    border-bottom-color: var(--accent-cyan); 

}

.tab-item .tab-icon { 

    font-size: 2.5rem; 

    margin-bottom: 0.5rem; 

    line-height: 1; 

    color: var(--accent-cyan); 

}



.list-container { 

    max-height: 450px; 

    overflow-y: auto; 

    padding-right: 0.5rem; 

    scrollbar-width: thin; 

    scrollbar-color: var(--accent-cyan) var(--bg-tertiary); 

}

.list-item { 

    display: flex; 

    justify-content: space-between; 

    align-items: center; 

    background-color: var(--bg-secondary); 

    padding: 1rem; 

    border-radius: 0.75rem; 

    margin-bottom: 0.75rem; 

    transition: background-color 0.3s; 

}

.list-item:hover { 

    background-color: var(--bg-tertiary); 

}

.list-item .item-info { 

    display: flex; 

    align-items: center; 

    gap: 1rem; 

}

.list-item .item-rank { 

    font-weight: 900; 

    font-size: 1.2rem; 

    color: var(--accent-cyan); 

    width: 40px; 

    text-align: center; 

}

.list-item .item-name { 

    font-weight: 700; 

    font-size: 1.1rem; 

}

.list-item .player-details { 

    display: flex; 

    align-items: center; 

    gap: 0.5rem; 

}

.list-item .player-level { 

    background-color: var(--accent-purple); 

    color: white; 

    font-size: 0.8rem; 

    font-weight: bold; 

    padding: 2px 8px; 

    border-radius: 12px; 

}

.list-item .player-medals { 

    font-size: 1rem; 

}

.list-item .item-value { 

    font-weight: 700; 

    font-size: 1.2rem; 

    color: var(--accent-yellow); 

}



.card { 

    background-color: var(--bg-secondary); 

    padding: 1.5rem; 

    border-radius: 1rem; 

    border: 2px solid var(--bg-tertiary); 

    transition: all 0.2s; 

    text-align: center; 

}

.card:not(.locked) { 

    cursor: pointer; 

}

.card:not(.locked):hover { 

    border-color: var(--accent-cyan); 

    transform: translateY(-5px); 

    box-shadow: 0 5px 15px rgba(6, 182, 212, 0.2); 

}

.card.locked { 

    background-color: var(--bg-locked); 

    color: var(--text-secondary); 

    cursor: not-allowed; 

}

.card.completed { 

    border-color: var(--accent-green); 

    background-color: rgba(34, 197, 94, 0.1); 

}

.card .card-icon { 

    font-size: 3rem; 

    color: var(--accent-cyan); 

    margin-bottom: 1rem; 

}

.progress-bar-container { 

    background-color: var(--bg-tertiary); 

    border-radius: 99px; 

    height: 10px; 

    overflow: hidden; 

    margin-top: 1rem; 

}

.progress-bar { 

    background-color: var(--accent-green); 

    height: 100%; 

    width: 0%; 

    transition: width 0.5s; 

}

.grid-container { 

    display: grid; 

    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 

    gap: 1rem; 

}



#options-grid { 

    display: grid; 

    grid-template-columns: 1fr 1fr; 

    gap:1rem;

}

#question-text { 

    font-size: 1.4rem; /* <-- تم التصغير هنا */

    font-weight: 700; 

    margin-bottom: 1.5rem; 

    min-height: 100px; 

}

.option-btn.correct { 

    background-color: var(--accent-green) !important; 

    transform: scale(1.05); color: white; 

}

.option-btn.wrong { 

    background-color: var(--accent-red) !important; 

    color: white; 

}

.option-btn.disabled { 

    opacity: 0.6; 

    pointer-events: none; 

}

#explanation-box { 

    background-color: rgba(250, 204, 21, 0.1); 

    border: 1px solid var(--accent-yellow); 

    border-radius: 0.75rem; 

    padding: 1rem; 

    margin-top: 1.5rem; 

    display: none; 

}



.modal { 

    position: fixed; 

    top: 0; left: 0; 

    width: 100%; 

    height: 100%; 

    background-color: rgba(0,0,0,0.7); 

    display: flex; 

    align-items: center; 

    justify-content: center; 

    z-index: 2000; 

    opacity: 0; 

    pointer-events: none; 

    transition: opacity 0.3s; 

}

.modal.visible { 

    opacity: 1; 

    pointer-events: auto; 

}

.modal-content { 

    background-color: var(--bg-primary); 

    padding: 2rem; 

    border-radius: 1rem; 

    text-align: center; 

    border: 1px solid var(--bg-tertiary); 

    max-width: 90%; 

    width: 400px; 

}

.modal-actions { 

    display: flex; 

    gap: 1rem; 

    justify-content: center; 

}

#toast-container { 

    position: fixed; 

    bottom: 20px; 

    left: 50%; 

    transform: translateX(-50%); 

    z-index: 3000; 

    display: flex; 

    flex-direction: column; 

    gap: 0.5rem; 

}

.toast { 

    background-color: var(--accent-purple); 

    color: white; 

    padding: 1rem 1.5rem; 

    border-radius: 0.75rem; 

    font-weight: 700; 

    box-shadow: 0 4px 15px rgba(0,0,0,0.3); 

    opacity: 0; 

    transform: translateY(20px); 

    transition: all 0.5s ease; 

}

.toast.show { 

    opacity: 1; 

    transform: translateY(0); 

}



.achievement-item { 

    display: flex; 

    align-items: center; 

    gap: 1.5rem; 

    padding: 1rem; 

    background-color: var(--bg-secondary); 

    border-radius: 0.75rem; 

    margin-bottom: 1rem; 

    border-left: 5px solid var(--bg-tertiary); 

    opacity: 0.6; 

    transition: all 0.3s ease; 

}

.achievement-item.unlocked { 

    opacity: 1; 

    border-left-color: var(--accent-green); 

    background: linear-gradient(90deg, rgba(34, 197, 94, 0.1), var(--bg-secondary)); 

}

.achievement-icon { 

    font-size: 3rem; 

    line-height: 1; 

    color: var(--accent-yellow); 

}



.island-map-grid { 

    display: grid; 

    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 

    gap: 1.5rem; 

    padding: 1rem; 

}

.island-tile { 

    background-color: var(--bg-secondary); 

    border-radius: 1rem; 

    padding: 1.5rem; 

    text-align: center; 

    border: 3px solid var(--bg-tertiary); 

    transition: all 0.3s; 

    position: relative; 

}

.island-tile.my-team { 

    border-color: var(--accent-green); 

    box-shadow: 0 0 20px rgba(34, 197, 94, 0.6); 

}

.island-tile.enemy-team { 

    border-color: var(--accent-red); 

}

.island-tile .island-icon { 

    font-size: 4rem; 

    margin-bottom: 1rem; 

}

.island-name { 

    font-size: 1.5rem; 

    font-weight: 900; 

    margin-bottom: 0.5rem; 

}

.island-owner .team-tag { 

    font-size: 1.1rem; 

    color: var(--accent-yellow); 

}

.island-tile .btn { 

    margin-top: 1rem; 

    padding: 0.5rem 1rem; 

    width: auto; 

    font-size: 1rem; 

}

.island-reward-timer { 

    font-size: 0.8rem; 

    color: var(--text-secondary); 

    margin-top: 0.5rem; 

}



/* Chat Styles */

#chat-screen .chat-messages { 

    height: 400px; 

    overflow-y: auto; 

    border: 1px solid var(--bg-tertiary); 

    border-radius: 0.75rem; 

    padding: 1rem; 

    margin-bottom: 1rem; 

    display: flex; 

    flex-direction: column-reverse; 

}

.chat-message { 

    background-color: var(--bg-secondary); 

    padding: 0.75rem 1rem; 

    border-radius: 10px; 

    margin-bottom: 0.75rem; 

    max-width: 80%; 

    align-self: flex-start; 

}

.chat-message.mine { 

    background-color: var(--accent-blue); 

    align-self: flex-end; 

}

.chat-message .sender { 

    font-weight: bold; 

    color: var(--accent-cyan); 

    margin-bottom: 0.25rem; 

    font-size: 0.9rem; 

}

.chat-message.mine .sender { 

    color: var(--text-primary); 

}

.chat-message .timestamp { 

    font-size: 0.7rem; 

    color: var(--text-secondary); 

    margin-top: 0.25rem; 

}

#chat-input-container { 

    display: flex; 

    gap: 1rem; 

}

#chat-input-container input { 

    flex-grow: 1; 

}

/* --- START: كود تلوين القائمة الرئيسية --- */



/* احتلال الجزر (أخضر) */

.tab-item[data-action="show-island-conquest"] .tab-icon { color: var(--accent-green); }

.tab-item[data-action="show-island-conquest"]:hover { border-bottom-color: var(--accent-green); }



/* اللعب الفردي (أزرق) */

.tab-item[data-action="show-single-player"] .tab-icon { color: var(--accent-blue); }

.tab-item[data-action="show-single-player"]:hover { border-bottom-color: var(--accent-blue); }



/* مباريات حرة (أحمر) */

.tab-item[data-action="show-online-menu"] .tab-icon { color: var(--accent-red); }

.tab-item[data-action="show-online-menu"]:hover { border-bottom-color: var(--accent-red); }



/* الفريق (بنفسجي) */

.tab-item[data-action="show-team-hub"] .tab-icon { color: var(--accent-purple); }

.tab-item[data-action="show-team-hub"]:hover { border-bottom-color: var(--accent-purple); }



/* الصدارة (أصفر) */

.tab-item[data-action="show-leaderboards"] .tab-icon { color: var(--accent-yellow); }

.tab-item[data-action="show-leaderboards"]:hover { border-bottom-color: var(--accent-yellow); }



/* الإنجازات (سيان - اللون الأصلي) */

.tab-item[data-action="show-achievements"] .tab-icon { color: var(--accent-cyan); }

.tab-item[data-action="show-achievements"]:hover { border-bottom-color: var(--accent-cyan); }



/* الدردشة العامة (أزرق فاتح) */

.tab-item[data-action="show-chat"] .tab-icon { color: var(--accent-blue); }

.tab-item[data-action="show-chat"]:hover { border-bottom-color: var(--accent-blue); }



/* --- END: كود تلوين القائمة الرئيسية --- */

    </style>

</head>

<body>

    <button id="mute-btn" data-action="toggle-music"><i class='bx bx-volume-mute'></i></button>

    <div id="toast-container"></div>



    <main>

        <div id="registration-screen" class="screen-container active"></div>

        <div id="loading-screen" class="screen-container"></div>

        <div id="main-menu-screen" class="screen-container"></div>

        <div id="single-player-menu-screen" class="screen-container"></div>

        <div id="level-select-screen" class="screen-container"></div>

        <div id="online-menu-screen" class="screen-container"></div>

        <div id="join-lobby-screen" class="screen-container"></div>

        <div id="online-lobby-screen" class="screen-container"></div>

        <div id="team-hub-screen" class="screen-container"></div>

        <div id="create-team-screen" class="screen-container"></div>

        <div id="join-team-screen" class="screen-container"></div>

        <div id="leaderboard-screen" class="screen-container"></div>

        <div id="achievements-screen" class="screen-container"></div>

        <div id="island-conquest-screen" class="screen-container"></div>

        <div id="chat-screen" class="screen-container"></div>

        <div id="match-screen" class="screen-container"></div>

        <div id="game-over-screen" class="screen-container"></div>

        <div id="notifications-screen" class="screen-container"></div>

<template id="notifications-screen-template">

    <h1 class="screen-title"><i class='bx bxs-bell-ring'></i> الإشعارات</h1>

    <div id="notifications-list" class="list-container"></div>

    <button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button>

</template>

    </main>

    <div id="modal" class="modal"></div>

    

    <template id="loading-screen-template"><h1 class="screen-title"><i class='bx bx-loader-alt bx-spin'></i> ...جار التحميل</h1></template>

    

    <template id="registration-screen-template"><div style="max-width:400px;margin:auto"><h1 class="screen-title"><i class='bx bxl-flutter'></i> NC 1 Eagles<br>Islands Conquer</h1><div class="form-group"><label for="name-input" class="form-label">الاسم الكامل</label><input id="name-input" type="text" class="input-field"></div><div class="form-group"><label for="teleopti-id-input" class="form-label">Teleopti ID</label><input id="teleopti-id-input" type="tel" pattern="[0-9]*" class="input-field"></div><div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin:1.5rem 0;color:var(--text-secondary)"><input type="checkbox" id="remember-me-checkbox" checked><label for="remember-me-checkbox">تذكرني</label></div><button data-action="login" class="btn btn-primary"><i class='bx bx-log-in-circle'></i> دخول</button></div></template>

    

    <template id="main-menu-screen-template"><div class="welcome-container"><h1 id="welcome-message" class="welcome-message"><button data-action="show-notifications" id="notifications-btn" style="position: absolute; top: 0; right: 0; background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; font-size: 1.5rem;">

    <i class='bx bxs-bell'></i>

    <span id="notification-indicator" style="position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: var(--accent-red); border-radius: 50%; display: none;"></span>

</button></h1><button data-action="logout" id="logout-btn" title="تسجيل الخروج"><i class='bx bx-exit'></i></button></div><div class="tabs-container"><div data-action="show-island-conquest" class="tab-item"><div class="tab-icon"><i class='bx bxs-map-alt'></i></div><div>احتلال الجزر</div></div><div data-action="show-single-player" class="tab-item"><div class="tab-icon"><i class='bx bxs-user'></i></div><div>اللعب الفردي</div></div><div data-action="show-online-menu" class="tab-item"><div class="tab-icon"><i class='bx bxs-group'></i></div><div>مباريات حرة</div></div><div data-action="show-team-hub" class="tab-item"><div class="tab-icon"><i class='bx bxs-shield-alt-2'></i></div><div>الفريق</div></div><div data-action="show-leaderboards" class="tab-item"><div class="tab-icon"><i class='bx bxs-trophy'></i></div><div>الصدارة</div></div><div data-action="show-achievements" class="tab-item"><div class="tab-icon"><i class='bx bxs-medal'></i></div><div>الإنجازات</div></div><div data-action="show-chat" class="tab-item"><div class="tab-icon"><i class='bx bxs-message-square-dots'></i></div><div>الدردشة العامة</div></div></div></template>

    

    <template id="single-player-menu-screen-template"><h1 class="screen-title"><i class='bx bxs-user'></i> طور اللعب الفردي</h1><p class="screen-subtitle">أكمل المستويات لتفتح تحديات أصعب وتحصل على ميداليات.</p><div id="tiers-grid" class="grid-container"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></template>

    

    <template id="level-select-screen-template"><h1 id="level-select-title" class="screen-title"></h1><div id="levels-grid" class="grid-container"></div><button data-action="show-single-player" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></template>



    <template id="online-lobby-screen-template"><h1 id="lobby-title" class="screen-title">غرفة الانتظار</h1><div style="text-align:center;margin-bottom:1.5rem"><p>شارك الكود التالي:</p><h2 id="lobby-id-display" style="color:var(--accent-yellow);cursor:pointer" title="اضغط للنسخ"></h2></div><h3>اللاعبون في الردهة (<span id="player-count">0</span>)</h3><div id="lobby-players-list" class="list-container" style="max-height:150px"></div><div id="lobby-chat-container" style="margin-top:1rem;"><h4>دردشة اللوبي</h4><div id="chat-screen" style="direction: ltr;"><div class="chat-messages" id="lobby-chat-messages" style="height: 120px;"></div><div id="chat-input-container"><input type="text" id="lobby-chat-input" class="input-field" placeholder="اكتب رسالتك..."><button data-action="send-lobby-chat" id="lobby-chat-send" class="btn btn-primary" style="width: auto; padding: 0.75rem;"><i class='bx bxs-send'></i></button></div></div></div><button id="start-game" data-action="start-game" class="btn btn-primary" style="margin-top:1.5rem"><i class='bx bx-rocket'></i> ابدأ المباراة (للمضيف)</button><button data-action="leave-lobby" class="btn btn-secondary back-btn" style="background-color: var(--accent-red);"><i class='bx bx-log-out'></i> مغادرة</button></template>



 <template id="team-hub-screen-template">

    <div id="no-team-view">

        <h1 class="screen-title"><i class='bx bxs-shield-x'></i> لم تنضم لفريق بعد</h1>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;max-width:500px;margin:auto">

            <button data-action="show-create-team" class="btn btn-primary"><i class='bx bxs-shield-plus'></i> إنشاء فريق</button>

            <button data-action="show-join-team" class="btn btn-secondary"><i class='bx bx-user-plus'></i> الانضمام لفريق</button>

        </div>

    </div>

    <div id="team-view" style="display:none">

        <h1 id="team-name-title" class="screen-title"></h1>

        <p class="screen-subtitle">مجموع نقاط الفريق: <strong id="team-score" style="color:var(--accent-yellow)">0</strong> | كود الفريق: <strong id="team-id-display" style="color:var(--accent-cyan);cursor:pointer" title="اضغط للنسخ"></strong></p>

        <h3><i class='bx bxs-user-detail'></i> أعضاء الفريق (<span id="team-member-count">0</span>)</h3>

        <div id="team-members-list" class="list-container" style="max-height:250px"></div>



        <div id="team-requests-container" style="display:none; margin-top: 2rem;">

            <h3><i class='bx bx-user-plus'></i> طلبات الانضمام</h3>

            <div id="team-requests-list" class="list-container" style="max-height: 200px;"></div>

        </div>



        <button data-action="show-team-chat" class="btn btn-primary" style="margin-top: 2rem;"><i class='bx bxs-message-alt-dots'></i> دردشة الفريق</button>

        <button data-action="leave-team" class="btn btn-secondary" style="background-color:var(--accent-red);margin-top:1rem"><i class='bx bx-exit'></i> مغادرة الفريق</button>

    </div>

    <button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button>

</template>



    <template id="leaderboard-screen-template"><h1 class="screen-title"><i class='bx bxs-trophy'></i> لوحة الصدارة</h1><div style="display:flex;gap:1rem;margin-bottom:2rem;border-bottom:2px solid var(--bg-tertiary)"><button id="pills-individual" data-action="show-individual-leaderboard" class="btn btn-primary" style="flex:1"><i class='bx bxs-user'></i> فردي</button><button id="pills-teams" data-action="show-teams-leaderboard" class="btn btn-secondary" style="flex:1"><i class='bx bxs-shield-alt-2'></i> فرق</button></div><div id="leaderboard-list" class="list-container"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></template>

    

    <template id="achievements-screen-template"><h1 class="screen-title"><i class='bx bxs-medal'></i> الإنجازات</h1><p class="screen-subtitle">افتح الإنجازات لتحصل على نقاط إضافية وتثبت جدارتك.</p><div id="achievements-list" class="list-container"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></template>

    

    <template id="island-conquest-screen-template"><h1 class="screen-title"><i class='bx bxs-map-alt'></i> احتلال الجزر</h1><p class="screen-subtitle">سيطر على الجزر مع فريقك. كل جزيرة تمثل فئة أسئلة مختلفة. السيطرة تمنح فريقك نقاطًا إضافية يوميًا!</p><div id="island-map-grid" class="island-map-grid"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></template>

    

    <template id="chat-screen-template"><h1 id="chat-screen-title" class="screen-title"><i class='bx bxs-message-square-dots'></i> الدردشة العامة</h1><p id="chat-screen-subtitle" class="screen-subtitle">تواصل مع جميع اللاعبين في اللعبة.</p><div id="chat-container" style="direction: ltr;"><div class="chat-messages" id="chat-messages-list"></div><div id="chat-input-container"><input type="text" id="chat-input-field" class="input-field" placeholder="اكتب رسالتك..."><button id="chat-send-btn" class="btn btn-primary" style="width: auto; padding: 0.75rem;"><i class='bx bxs-send'></i></button></div></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></template>    

    <template id="game-over-screen-template"><h1 id="game-over-title" class="screen-title">انتهت المباراة!</h1><h2 id="game-over-subtitle" class="screen-subtitle"></h2><div id="final-results-list" class="list-container"></div><button data-action="back" class="btn btn-primary back-btn">العودة للقائمة الرئيسية</button></template>



    <template id="online-menu-screen-template"><h1 class="screen-title"><i class='bx bxs-game'></i> مباريات حرة</h1><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;max-width:500px;margin:0 auto 2rem"><button data-action="create-lobby" data-type="1v1" class="btn btn-primary"><i class='bx bxs-user-check'></i> إنشاء مواجهة 1 ضد 1</button><button data-action="create-lobby" data-type="massive" class="btn btn-primary"><i class='bx bxs-group'></i> إنشاء منافسة حاشدة</button></div><button data-action="show-join-lobby" class="btn btn-secondary"><i class='bx bx-link-external'></i> الانضمام بكود</button><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></template>

    

    <template id="join-lobby-screen-template"><div style="max-width:400px;margin:auto;text-align:center"><h1 class="screen-title">الانضمام لمنافسة</h1><p class="screen-subtitle">أدخل كود المنافسة للانضمام.</p><input id="lobby-id-input" type="text" class="input-field" placeholder="KOD" style="text-align:center;text-transform:uppercase;font-size:1.5rem;letter-spacing:5px"><button data-action="submit-join-lobby" class="btn btn-primary" style="margin-top:1rem">انضم الآن</button><button data-action="show-online-menu" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></div></template>

    

    <template id="create-team-screen-template"><div style="max-width:400px;margin:auto"><h1 class="screen-title">إنشاء فريق جديد</h1><div class="form-group"><label for="team-name-input" class="form-label">اسم الفريق</label><input id="team-name-input" type="text" class="input-field"></div><div class="form-group"><label for="team-tag-input" class="form-label">شعار الفريق (Tag - 3 إلى 5 حروف)</label><input id="team-tag-input" type="text" class="input-field" maxlength="5" minlength="3"></div><button data-action="submit-create-team" class="btn btn-primary">أنشئ الفريق</button><button data-action="show-team-hub" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></div></template>

    

    <template id="join-team-screen-template"><div style="max-width:400px;margin:auto;text-align:center"><h1 class="screen-title">الانضمام لفريق</h1><input id="team-id-input" type="text" class="input-field" placeholder="أدخل كود الفريق" style="text-align:center;font-size:1.5rem;letter-spacing:5px;margin-top:2rem"><button data-action="submit-join-team" class="btn btn-primary" style="margin-top:1rem">انضمام</button><button data-action="show-team-hub" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> العودة</button></div></template>

    

<template id="match-screen-template">

    <div class="match-layout" style="display: flex; gap: 1.5rem;">



        <div class="match-main-content" style="flex-grow: 1;">

            <h2 id="match-header" style="font-size:1.5rem;font-weight:900;margin-bottom:1rem"></h2>

            <p id="question-counter"></p>

            <div id="timer-container" style="width:100%;background-color:var(--bg-tertiary);border-radius:5px;margin-bottom:1.5rem">

                <div id="timer-bar" style="height:10px;background-color:var(--accent-red);border-radius:5px;transition:width 1s linear"></div>

            </div>

            <div id="question-text"></div>

            <div id="options-grid" class="grid-container"></div>

            <div id="explanation-box"></div>

            <button data-action="surrender" class="btn btn-secondary" style="background-color:var(--accent-red);margin-top:2rem">استسلام</button>

        </div>

    

        <aside id="live-scoreboard-container" style="width: 280px; flex-shrink: 0; background-color: rgba(0,0,0,0.2); border-radius: 1rem; padding: 1rem;">

            <h3 style="text-align: center; margin-top: 0; color: var(--accent-cyan);">النتائج المباشرة</h3>

            <div id="live-scoreboard-list" class="list-container" style="max-height: 400px;">

                </div>

        </aside>



    </div>

    <button data-action="back" class="btn btn-secondary back-btn" style="display:none">العودة</button>

</template>    

    <template id="modal-template"><div class="modal-content"><h2 id="modal-title" style="margin-top:0;color:var(--accent-cyan)"></h2><p id="modal-body"></p><div class="modal-actions"><button data-action="modal-confirm" class="btn btn-primary">نعم</button><button data-action="modal-cancel" class="btn btn-secondary">إلغاء</button></div></div></template>



    <script type="module">

// FINAL, COMPLETE, AND VERIFIED SCRIPT - RESTRUCTURED

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, where, orderBy, limit, serverTimestamp, updateDoc, arrayUnion, runTransaction, getDocs, writeBatch, increment, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyAvGDEbWA3UumCa0P4AfFUVv6xxwL5Porc", authDomain: "nc1-eagles-race.firebaseapp.com", projectId: "nc1-eagles-race", storageBucket: "nc1-eagles-race.appspot.com", messagingSenderId: "772415266484", appId: "1:772415266484:web:5813cb3355f7298ade81e1" };



// ===================================================================================

// ✨✨✨ تهيئة إعدادات اللعبة وبنوك الأسئلة ✨✨✨

// ===================================================================================

const GAME_CONFIG = {

    // --- ⬇️⬇️⬇️ هنا تضع بنوك الأسئلة الخاصة بك ⬇️⬇️⬇️ ---

    questionBanks: {

        // بنك أسئلة الوضع الفردي

        singlePlayer: [

            { id: 1, question: "ما هي عاصمة مصر؟", options: { "1": "القاهرة", "2": "الجيزة" }, correct_answer: "1", explanation: "القاهرة هي عاصمة جمهورية مصر العربية." },

            { id: 2, question: "كم عدد ألوان علم مصر؟", options: { "1": "لونان", "2": "ثلاثة ألوان" }, correct_answer: "2", explanation: "علم مصر يتكون من ثلاثة ألوان: الأحمر والأبيض والأسود." }

        ],

        // بنك أسئلة اللعب الأونلاين (المباريات الحرة)

        online: [

            { id: 101, question: "سؤال عام أونلاين 1", options: { "1": "أ", "2": "ب" }, correct_answer: "1", explanation: "شرح الإجابة" },

            { id: 102, question: "سؤال عام أونلاين 2", options: { "1": "أ", "2": "ب" }, correct_answer: "2", explanation: "شرح الإجابة" }

        ],

        // بداية اللصق من هنا

islands: {

    // بنك أسئلة جزيرة Tech

    'island_tech': [

        { id: 201, question: "سؤال Tech رقم 1؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "1", explanation: "شرح الإجابة الصحيحة." },

        { id: 202, question: "سؤال Tech رقم 2؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "2", explanation: "شرح الإجابة الصحيحة." }

    ],

    // بنك أسئلة جزيرة Non-Tech

    'island_non_tech': [

        { id: 301, question: "سؤال Non-Tech رقم 1؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "1", explanation: "شرح الإجابة الصحيحة." },

        { id: 302, question: "سؤال Non-Tech رقم 2؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "2", explanation: "شرح الإجابة الصحيحة." }

    ],

    // بنك أسئلة جزيرة Faulty

    'island_faulty': [

        { id: 401, question: "سؤال Faulty رقم 1؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "1", explanation: "شرح الإجابة الصحيحة." },

        { id: 402, question: "سؤال Faulty رقم 2؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "2", explanation: "شرح الإجابة الصحيحة." }

    ],

    // بنك أسئلة جزيرة Quality

    'island_quality': [

        { id: 501, question: "سؤال Quality رقم 1؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "1", explanation: "شرح الإجابة الصحيحة." },

        { id: 502, question: "سؤال Quality رقم 2؟", options: { "1": "إجابة أ", "2": "إجابة ب" }, correct_answer: "2", explanation: "شرح الإجابة الصحيحة." }

    ]

}

// نهاية اللصق هنا

    },

    // تعريف الجزر

  // بداية اللصق من هنا

islandDefinitions: { 

    'island_tech': { name: "جزيرة Tech", icon: "<i class='bx bx-chip'></i>", dailyReward: 75 },

    'island_non_tech': { name: "جزيرة Non-Tech", icon: "<i class='bx bx-book-content'></i>", dailyReward: 75 },

    'island_faulty': { name: "جزيرة Faulty", icon: "<i class='bx bxs-bug'></i>", dailyReward: 75 },

    'island_quality': { name: "جزيرة Quality", icon: "<i class='bx bxs-check-shield'></i>", dailyReward: 75 }

},

    // تعريف فئات اللعب الفردي

    singlePlayerTiers: [ 

        { id: 'tier-1', name: 'ايجنت عادي', levels: 3, questionsPerLevel: 5, timePerQuestion: 30, medal: '🥉', points: 10, awardPoints: 50, icon: 'bx-shield-quarter' },

        { id: 'tier-2', name: 'ايجنت جامد', levels: 3, questionsPerLevel: 5, timePerQuestion: 25, medal: '🥈', points: 15, awardPoints: 75, icon: 'bx-shield-alt-2' },

        { id: 'tier-3', name: 'ايجنت كوالتي', levels: 6, questionsPerLevel: 10, timePerQuestion: 20, medal: '🥇', points: 20, awardPoints: 100, icon: 'bx-shield-x' },

        { id: 'tier-4', name: 'ايجنت سوبرفايزر', levels: 6, questionsPerLevel: 20, timePerQuestion: 15, medal: '🏆', points: 25, awardPoints: 150, icon: 'bxs-shield' },

        { id: 'tier-5', name: 'ايجنت بطرس', levels: 6, questionsPerLevel: 40, timePerQuestion: 10, medal: '💎', points: 30, awardPoints: 200, icon: 'bxs-diamond' }

    ],

    // قائمة الإنجازات

    // بداية اللصق من هنا

achievements: {

    // --- 🎖️ إنجازات اللعب الجماعي (Online Matches) 🎖️ ---

    'play_1_game':      { name: "بداية الرحلة", description: "أكمل أول مباراة جماعية", icon: "<i class='bx bx-rocket'></i>", target: 1, stat: 'gamesPlayed', rewardPoints: 10 },

    'play_10_games':     { name: "لاعب متمرس", description: "أكمل 10 مباريات جماعية", icon: "<i class='bx bxs-hot'></i>", target: 10, stat: 'gamesPlayed', rewardPoints: 50 },

    'play_50_games':     { name: "محارب مخضرم", description: "أكمل 50 مباراة جماعية", icon: "<i class='bx bxs-crown'></i>", target: 50, stat: 'gamesPlayed', rewardPoints: 200 },

    

    'win_1_1v1':         { name: "محارب مبتدئ", description: "فز في أول مواجهة 1 ضد 1", icon: "<i class='bx bx-swords'></i>", target: 1, stat: 'wins1v1', rewardPoints: 25 },

    'win_10_1v1':        { name: "مبارز محترف", description: "فز في 10 مواجهات 1 ضد 1", icon: "<i class='bx bxs-swords'></i>", target: 10, stat: 'wins1v1', rewardPoints: 100 },

    'win_5_massive':     { name: "سيد الحشود", description: "فز في 5 منافسات حاشدة", icon: "<i class='bx bxs-group'></i>", target: 5, stat: 'winsMassive', rewardPoints: 150 },



    // --- 🛡️ إنجازات الفرق والقيادة (Teams & Leadership) 🛡️ ---

    'create_team':       { name: "القائد المؤسس", description: "قم بإنشاء فريقك الخاص", icon: "<i class='bx bxs-shield-plus'></i>", target: 1, stat: 'teamsLed', rewardPoints: 30 },

    'join_team':         { name: "جزء من المجموعة", description: "انضم إلى فريق لأول مرة", icon: "<i class='bx bx-user-plus'></i>", target: 1, stat: 'joinedTeam', rewardPoints: 15 },

    'team_reach_1000':   { name: "فريق صاعد", description: "ساهم في وصول فريقك إلى 1000 نقطة", icon: "<i class='bx bxs-chart'></i>", target: 1, stat: 'team1000Points', rewardPoints: 75 },

    'team_reach_5000':   { name: "قوة لا يستهان بها", description: "ساهم في وصول فريقك إلى 5000 نقطة", icon: "<i class='bx bxs-bar-chart-alt-2'></i>", target: 1, stat: 'team5000Points', rewardPoints: 250 },



    // --- 🏝️ إنجازات احتلال الجزر (Island Conquest) 🏝️ ---

    'challenge_island':  { name: "المتحدي الأول", description: "خض أول تحدي لك على جزيرة", icon: "<i class='bx bxs-flag-alt'></i>", target: 1, stat: 'islandChallenges', rewardPoints: 20 },

    'conquer_1_island':  { name: "فاتح الجزر", description: "ساهم في السيطرة على جزيرة واحدة مع فريقك", icon: "<i class='bx bxs-landscape'></i>", target: 1, stat: 'islandVictories', rewardPoints: 200 },

    'conquer_all_islands': { name: "الإمبراطور", description: "ساهم في سيطرة فريقك على جميع الجزر في وقت واحد", icon: "<i class='bx bxs-map-alt'></i>", target: 1, stat: 'conqueredAllIslands', rewardPoints: 1000 },

    'hold_island_bonus': { name: "مكافأة السيطرة", description: "احصل على مكافأة السيطرة اليومية على جزيرة", icon: "<i class='bx bxs-gift'></i>", target: 1, stat: 'islandBonusCollected', rewardPoints: 50 },

    

    // --- 🏆 إنجازات اللعب الفردي (Single Player) 🏆 ---

    'complete_tier1':    { name: "ايجنت طموح", description: "أكمل جميع مستويات فئة 'ايجنت عادي'", icon: "<i class='bx bx-shield-quarter'></i>", target: 1, stat: 'tier1unlocked', rewardPoints: 50 },

    'complete_tier3':    { name: "خبير الجودة", description: "أكمل جميع مستويات فئة 'ايجنت كوالتي'", icon: "<i class='bx bx-shield-x'></i>", target: 1, stat: 'tier3unlocked', rewardPoints: 150 },

    'complete_all_sp':   { name: "أسطورة فردية", description: "أكمل جميع مستويات اللعب الفردي", icon: "<i class='bx bxs-diamond'></i>", target: 1, stat: 'allSPCompleted', rewardPoints: 500 },



    // --- ✨ إنجازات متنوعة واجتماعية (Misc & Social) ✨ ---

    'chat_first_message':{ name: "اجتماعي", description: "أرسل أول رسالة لك في الدردشة العامة", icon: "<i class='bx bxs-message-dots'></i>", target: 1, stat: 'messagesSent', rewardPoints: 10 },

    'reach_level_10':    { name: "مستوى 10", description: "أوصل حسابك إلى المستوى 10", icon: "<i class='bx bxs-up-arrow-circle'></i>", target: 1, stat: 'level10Reached', rewardPoints: 40 },

    'reach_level_25':    { name: "مستوى 25", description: "أوصل حسابك إلى المستوى 25", icon: "<i class='bx bxs-chevrons-up'></i>", target: 1, stat: 'level25Reached', rewardPoints: 120 }

}

// نهاية اللصق هنا

};



const app = initializeApp(firebaseConfig);

const auth = getAuth(app);

const db = getFirestore(app);

let AppState = { currentUser: null, playerProfile: null, playerTeam: null, currentLobbyId: null, modalCallback: null, musicPlayer: null, isMuted: true, unsubscribers: {}, singlePlayerState: { currentTier: null, currentLevel: null, questions: [], currentQuestionIndex: 0, answers: [] }, questionTimer: null };



// ===================================================================================

// ✨ دوال مساعدة وواجهة المستخدم ✨

// ===================================================================================

function showScreen(screenId) {

    document.querySelectorAll('.screen-container').forEach(s => s.classList.remove('active'));

    const screen = document.getElementById(screenId);

    if (screen) {

        if (!screen.hasAttribute('data-rendered')) {

            const template = document.getElementById(`${screenId}-template`);

            if (template) { screen.innerHTML = template.innerHTML; screen.setAttribute('data-rendered', 'true'); }

        }

        screen.classList.add('active');

    }

}

function showModal(title, message, confirmText = 'نعم', cancelText = 'إلغاء', onConfirm) {

    const modal = document.getElementById('modal');

    if(!modal) return;

    modal.innerHTML = document.getElementById('modal-template').innerHTML;

    const titleEl = modal.querySelector('#modal-title'), bodyEl = modal.querySelector('#modal-body'), confirmBtn = modal.querySelector('[data-action="modal-confirm"]'), cancelBtn = modal.querySelector('[data-action="modal-cancel"]');

    if (titleEl) titleEl.textContent = title;

    if (bodyEl) bodyEl.textContent = message;

    if (confirmBtn) confirmBtn.textContent = confirmText;

    if (cancelBtn) cancelBtn.textContent = cancelText;

    if (!onConfirm) {

        if (confirmBtn) confirmBtn.style.display = 'none';

        if (cancelBtn) cancelBtn.textContent = 'حسنًا';

        cancelBtn.onclick = hideModal;

    } else {

        if (confirmBtn) confirmBtn.style.display = 'flex';

        confirmBtn.onclick = () => { onConfirm(); hideModal(); };

        cancelBtn.onclick = hideModal;

    }

    AppState.modalCallback = onConfirm;

    modal.classList.add('visible');

}

function hideModal() { 

    const modal = document.getElementById('modal');

    if(modal) modal.classList.remove('visible'); 

    AppState.modalCallback = null; 

}

function showToast(message) {

    const container = document.getElementById('toast-container'); if (!container) return;

    const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = `🎉 ${message}`;

    container.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);

    setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);

}

function toggleMusic() {

    if (!AppState.musicPlayer) { AppState.musicPlayer = new Audio('https://v15mbanna3.github.io/my-sounds/Gna7%20felsama.mp3'); AppState.musicPlayer.loop = true; }

    AppState.isMuted = !AppState.isMuted;

    const muteBtn = document.getElementById('mute-btn');

    if (AppState.isMuted) { AppState.musicPlayer.pause(); if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-mute'></i>"; } 

    else { AppState.musicPlayer.play().catch(() => { AppState.isMuted = true; if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-mute'></i>"; }); if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-full'></i>"; }

}

function cleanupListeners() { Object.values(AppState.unsubscribers).forEach(unsub => unsub()); AppState.unsubscribers = {}; AppState.currentLobbyId = null; clearTimeout(AppState.questionTimer); }



/**

 * دالة جديدة للحصول على الأسئلة من البنك المحدد

 * @param {string} bankName - اسم البنك ('singlePlayer', 'online', أو 'islands.island_id')

 * @param {number} count - عدد الأسئلة المطلوب

 * @returns {Array}

 */

function getQuestions(bankName, count) {

    let bank;

    if (bankName.startsWith('islands.')) {

        const islandId = bankName.split('.')[1];

        bank = GAME_CONFIG.questionBanks.islands[islandId] || [];

    } else {

        bank = GAME_CONFIG.questionBanks[bankName] || [];

    }

    const shuffled = [...bank].sort(() => 0.5 - Math.random());

    return shuffled.slice(0, count);

}



// ===================================================================================

// ✨ نظام اللاعبين، الإحصائيات، والإنجازات ✨

// ===================================================================================

async function updatePlayerStat(stat, value = 1) {

    if (!AppState.playerProfile || !AppState.playerProfile.id) return;

    const playerRef = doc(db, "players", AppState.playerProfile.id);

    try {

        await updateDoc(playerRef, { [`stats.${stat}`]: increment(value) });

        if (!AppState.playerProfile.stats) AppState.playerProfile.stats = {};

        AppState.playerProfile.stats[stat] = (AppState.playerProfile.stats[stat] || 0) + value;

        await checkAndGrantAchievements();

    } catch(e) { console.error("Failed to update stat: ", e); }

}



async function checkAndGrantAchievements() {

    const profile = AppState.playerProfile;

    if (!profile || !profile.stats) return;

    const myAchievements = profile.unlockedAchievements || [];

    let newAchievements = false;

    const batch = writeBatch(db);

    const playerRef = doc(db, "players", profile.id);

    let pointsToAdd = 0;

    for (const [key, ach] of Object.entries(GAME_CONFIG.achievements)) {

        if (!myAchievements.includes(key)) {

            const statValue = profile.stats[ach.stat] || 0;

            if (statValue >= ach.target) {

                myAchievements.push(key); newAchievements = true; pointsToAdd += ach.rewardPoints;

                batch.update(playerRef, { unlockedAchievements: arrayUnion(key) });

                showToast(`إنجاز جديد: ${ach.name}! (+${ach.rewardPoints} نقطة)`);

            }

        }

    }

    if (newAchievements) {

        batch.update(playerRef, { score: increment(pointsToAdd) });

        await batch.commit().catch(console.error);

        AppState.playerProfile.unlockedAchievements = myAchievements;

        AppState.playerProfile.score = (AppState.playerProfile.score || 0) + pointsToAdd;

        updateMainMenu();

    }

}



function showAchievementsScreen() {

    showScreen('achievements-screen');

    const list = document.getElementById('achievements-list');

    if(!list) return;

    const myAchievements = AppState.playerProfile.unlockedAchievements || [];

    list.innerHTML = Object.entries(GAME_CONFIG.achievements).map(([key, ach]) => {

        const unlocked = myAchievements.includes(key);

        const currentProgress = AppState.playerProfile.stats?.[ach.stat] || 0;

        const progressText = unlocked ? 'مكتمل' : `${currentProgress} / ${ach.target}`;

        const iconHTML = typeof ach.icon === 'string' && ach.icon.startsWith('<') ? ach.icon : `<div class="achievement-icon">${ach.icon}</div>`;

        return `<div class="achievement-item ${unlocked ? 'unlocked' : ''}">${iconHTML}<div><h3 style="margin:0;">${ach.name}</h3><p style="color:var(--text-secondary); margin:0;">${ach.description}</p><p style="color:var(--accent-cyan); margin:0.5rem 0 0 0; font-weight:bold;">${progressText}</p></div></div>`;

    }).join('');

}



async function handleLogin() {

    const name = document.getElementById('name-input')?.value.trim();

    const teleoptiId = document.getElementById('teleopti-id-input')?.value.trim();

    if (!name || !teleoptiId || !/^\d+$/.test(teleoptiId)) return showModal("خطأ", "الرجاء إدخال الاسم و Teleopti ID صحيح (أرقام فقط).", null, "حسنًا");

    showScreen('loading-screen');

    try {

        if (!auth.currentUser) await signInAnonymously(auth);

        AppState.currentUser = auth.currentUser;

        const playerRef = doc(db, "players", teleoptiId);

        await runTransaction(db, async (t) => {

            const playerDoc = await t.get(playerRef);

            const defaultStats = Object.keys(GAME_CONFIG.achievements).reduce((acc, key) => {

                acc[GAME_CONFIG.achievements[key].stat] = 0;

                return acc;

            }, {});



            if (!playerDoc.exists()) {

                t.set(playerRef, { name, teleoptiId, uid: auth.currentUser.uid, score: 0, awards: [], singlePlayerProgress: {}, stats: defaultStats, unlockedAchievements: [], teamId: null, createdAt: serverTimestamp() });

          } else {

    // للاعبين الحاليين، نقوم فقط بتحديث وقت آخر تسجيل دخول.

    // لا نقوم بتحديث الاسم أو الـ UID لتجنب أخطاء الصلاحيات

    // مع المستخدمين المجهولين المتكررين.

    t.update(playerRef, { lastLogin: serverTimestamp() });

}

        });

        if (document.getElementById('remember-me-checkbox')?.checked) {

            localStorage.setItem('triviaTeleoptiId', teleoptiId); localStorage.setItem('triviaName', name);

        } else {

            localStorage.removeItem('triviaTeleoptiId'); localStorage.removeItem('triviaName');

        }

        await loadPlayerProfile(teleoptiId);

    } catch (error) { console.error(error); showModal("فشل تسجيل الدخول", `حدث خطأ: ${error.message}`, null, "حسنًا"); showScreen('registration-screen'); }

}



async function loadPlayerProfile(teleoptiId) {

    try {

        const playerDoc = await getDoc(doc(db, "players", teleoptiId));

        if (playerDoc.exists()) {

            AppState.playerProfile = { ...playerDoc.data(), id: playerDoc.id };

            if (!AppState.playerProfile.stats) AppState.playerProfile.stats = {}; // Safety check

            if (AppState.playerProfile.teamId) {

                const teamDoc = await getDoc(doc(db, "teams", AppState.playerProfile.teamId));

                AppState.playerTeam = teamDoc.exists() ? { ...teamDoc.data(), id: teamDoc.id } : null;

            } else { AppState.playerTeam = null; }

            showScreen('main-menu-screen');

            updateMainMenu();

            await checkAndGrantAchievements();

        } else {

            localStorage.removeItem('triviaTeleoptiId'); showScreen('registration-screen'); showModal("خطأ", "لم يتم العثور على ملف اللاعب هذا.", null, "حسنًا");

        }

    } catch (error) { console.error(error); showScreen('registration-screen'); showModal("خطأ في الشبكة", `لا يمكن تحميل ملفك الشخصي: ${error.message}`, null, "حسنًا"); }

}



function handleLogout() {

    showModal('تسجيل الخروج', 'هل أنت متأكد؟', 'نعم', 'لا', async () => {

        cleanupListeners();

        await signOut(auth).catch(console.error);

        AppState = { ...AppState, currentUser: null, playerProfile: null, playerTeam: null };

        localStorage.removeItem('triviaTeleoptiId'); localStorage.removeItem('triviaName');

        showScreen('registration-screen');

        repopulateLoginFields();

    });

}



function repopulateLoginFields() {

    try {

        document.getElementById('name-input').value = localStorage.getItem('triviaName') || '';

        document.getElementById('teleopti-id-input').value = localStorage.getItem('triviaTeleoptiId') || '';

    } catch (e) {}

}



function updateMainMenu() {

    

    if (!AppState.playerProfile) return;

    const welcomeMsg = document.getElementById('welcome-message');

    const teamTagDisplay = AppState.playerTeam ? `<span class="team-tag">[${AppState.playerTeam.tag}]</span>` : '';

    if (welcomeMsg) welcomeMsg.innerHTML = `أهلاً بك, ${teamTagDisplay} <span class="name">${AppState.playerProfile.name}</span>`;

}

function listenForNotifications() {

    if (!AppState.playerProfile?.id) return;

    const notificationsRef = collection(db, `players/${AppState.playerProfile.id}/notifications`);

    const q = query(notificationsRef, where("isRead", "==", false));



    AppState.unsubscribers.notifications = onSnapshot(q, (snapshot) => {

        const indicator = document.getElementById('notification-indicator');

        if (!indicator) return;



        if (snapshot.empty) {

            indicator.style.display = 'none';

        } else {

            indicator.style.display = 'block';

        }

    });

}

// === أضف هذه الدالة الجديدة ===

async function sendNotification(playerId, message) {

    if (!playerId || !message) return;

    const notificationsRef = collection(db, `players/${playerId}/notifications`);

    await addDoc(notificationsRef, {

        text: message,

        isRead: false,

        timestamp: serverTimestamp()

    });

}

// === أضف هذه الدالة الجديدة ===

async function showNotificationsScreen() {

    showScreen('notifications-screen');

    const list = document.getElementById('notifications-list');

    list.innerHTML = `<p>جار تحميل الإشعارات...</p>`;



    const notificationsRef = collection(db, `players/${AppState.playerProfile.id}/notifications`);

    const q = query(notificationsRef, orderBy("timestamp", "desc"));

    const snapshot = await getDocs(q);



    if (snapshot.empty) {

        list.innerHTML = `<p style="text-align:center;">لا توجد لديك إشعارات.</p>`;

    } else {

        list.innerHTML = snapshot.docs.map(doc => {

            const notif = doc.data();

            // يمكنك إضافة تصميم أفضل هنا لاحقًا

            return `<div class="list-item">${notif.text}</div>`;

        }).join('');

    }

}

// بداية اللصق من هنا

async function checkLevelUpAchievements() {

    if (!AppState.playerProfile) return;

    const score = AppState.playerProfile.score || 0;

    const level = Math.floor(score / 500) + 1;

    const achievements = AppState.playerProfile.unlockedAchievements || [];



    if (level >= 10 && !achievements.includes('reach_level_10')) {

        await updatePlayerStat('level10Reached');

    }

    if (level >= 25 && !achievements.includes('reach_level_25')) {

        await updatePlayerStat('level25Reached');

    }

}

// نهاية اللصق هنا

// ===================================================================================

// ✨ نظام الفرق ✨

// ===================================================================================

async function showTeamHub() {

    showScreen('team-hub-screen');

    const noTeamView = document.getElementById('no-team-view');

    const teamView = document.getElementById('team-view');

    if (!AppState.playerProfile || !noTeamView || !teamView) return;



    if (!AppState.playerTeam) {

        noTeamView.style.display = 'block';

        teamView.style.display = 'none';

    } else {

        noTeamView.style.display = 'none';

        teamView.style.display = 'block';



        const teamDoc = await getDoc(doc(db, "teams", AppState.playerTeam.id));

        const teamData = teamDoc.data();

        // ... (باقي الكود الخاص بعرض اسم الفريق والأعضاء يبقى كما هو) ...

        document.getElementById('team-name-title').textContent = `${teamData.name} [${teamData.tag}]`;

        // ...



        // >> كود جديد: إظهار طلبات الانضمام للقائد <<

        const requestsContainer = document.getElementById('team-requests-container');

        if (AppState.currentUser.uid === teamData.leaderId) {

            requestsContainer.style.display = 'block';

            const requestsList = document.getElementById('team-requests-list');



            const requestsQuery = query(collection(db, `teams/${AppState.playerTeam.id}/joinRequests`));

            onSnapshot(requestsQuery, (snapshot) => {

                if (snapshot.empty) {

                    requestsList.innerHTML = '<p style="text-align:center;">لا توجد طلبات انضمام حالية.</p>';

                    return;

                }

                requestsList.innerHTML = snapshot.docs.map(doc => {

                    const request = doc.data();

                    return `

                        <div class="list-item">

                            <div>

                                <span class="item-name">${request.name}</span>

                                <span class="item-value" style="font-size:0.9rem; margin-right: 1rem;">${request.score} نقطة</span>

                            </div>

                            <div style="display:flex; gap:0.5rem;">

                                <button data-action="accept-join-request" data-player-id="${request.playerId}" data-team-id="${AppState.playerTeam.id}" class="btn" style="background-color:var(--accent-green); padding: 0.5rem; width:auto;">قبول</button>

                                <button data-action="decline-join-request" data-request-id="${doc.id}" data-team-id="${AppState.playerTeam.id}" class="btn" style="background-color:var(--accent-red); padding: 0.5rem; width:auto;">رفض</button>

                            </div>

                        </div>

                    `;

                }).join('');

            });

        } else {

            requestsContainer.style.display = 'none';

        }

    }

}

// === أضف هاتين الدالتين الجديدتين ===



async function acceptJoinRequest(playerId, teamId) {

    const playerRef = doc(db, "players", playerId);

    const requestRef = doc(db, `teams/${teamId}/joinRequests`, playerId);

    const teamRef = doc(db, "teams", teamId);



    try {

        const teamDoc = await getDoc(teamRef);

        const teamName = teamDoc.exists() ? teamDoc.data().name : "فريقك";



        await runTransaction(db, async (t) => {

            t.update(playerRef, { teamId: teamId });

            t.delete(requestRef);

        });



        sendNotification(playerId, `تهانينا! تم قبول طلب انضمامك لفريق "${teamName}".`);

        showToast("تم قبول اللاعب بنجاح!");



        // تحديث واجهة الفريق لإظهار العضو الجديد فورًا

        if(document.getElementById('team-hub-screen').classList.contains('active')) {

            showTeamHub();

        }

    } catch(error) {

        console.error("Failed to accept request", error);

        showToast("حدث خطأ أثناء قبول الطلب.");

    }

}



async function declineJoinRequest(requestId, teamId) {

    await deleteDoc(doc(db, `teams/${teamId}/joinRequests`, requestId));

    showToast("تم رفض الطلب.");

}



async function handleCreateTeam() {

    const nameInput = document.getElementById('team-name-input');

    const tagInput = document.getElementById('team-tag-input');

    if (!nameInput || !tagInput) return;



    const name = nameInput.value.trim();

    const tag = tagInput.value.trim().toUpperCase();



    if (!name || tag.length < 3) {

        return showModal("خطأ", "يجب إدخال اسم وشعار للفريق (3-5 حروف).", null, "حسنًا");

    }



    const teamId = Math.random().toString(36).substring(2, 8).toUpperCase();

    const teamRef = doc(db, "teams", teamId);

    const playerRef = doc(db, "players", AppState.playerProfile.id);



    try {

        await runTransaction(db, async (t) => {

            t.set(teamRef, { name, tag, leaderId: AppState.currentUser.uid, score: 0, createdAt: serverTimestamp(), islandControlCount: 0 });

            t.update(playerRef, { teamId: teamId });

        });

        await updatePlayerStat('teamsLed');

        await loadPlayerProfile(AppState.playerProfile.id);

        showTeamHub();

    } catch (error) {

        console.error("Team creation failed:", error);

        showModal("خطأ", "فشل إنشاء الفريق. يرجى المحاولة مرة أخرى.", null, "حسنًا");

    }

    listenForNotifications();

}



// دالة الانضمام لفريق (النسخة الجديدة بنظام الطلبات)

async function handleJoinTeam() {

    const teamIdInput = document.getElementById('team-id-input');

    if(!teamIdInput) return;

    const teamId = teamIdInput.value.trim().toUpperCase();

    if (!teamId) return showModal("خطأ", "الرجاء إدخال كود الفريق.", null, "حسنًا");



    const teamRef = doc(db, "teams", teamId);

    try {

        const teamDoc = await getDoc(teamRef);

        if (!teamDoc.exists()) {

            return showModal("خطأ", "كود الفريق غير صحيح.", null, "حسنًا");

        }

        

        // إنشاء طلب انضمام بدلاً من الانضمام المباشر

        const requestRef = doc(db, `teams/${teamId}/joinRequests`, AppState.playerProfile.id);

        await setDoc(requestRef, {

            playerId: AppState.playerProfile.id,

            name: AppState.playerProfile.name,

            score: AppState.playerProfile.score || 0,

            requestedAt: serverTimestamp()

        });



        // إرسال إشعار لقائد الفريق (سنضيف دالة الإشعارات لاحقًا)

        const teamData = teamDoc.data();

        if(teamData.leaderId) {

              sendNotification(teamData.leaderId, `اللاعب ${AppState.playerProfile.name} يريد الانضمام لفريقك.`);

        }



        showToast("تم إرسال طلب الانضمام بنجاح!");

        showScreen('main-menu-screen');



    } catch (error) {

        console.error("Send join request failed:", error);

        showModal("خطأ", "فشل إرسال طلب الانضمام.", null, "حسنًا");

    }

}



function handleLeaveTeam() {

    showModal("مغادرة الفريق", "هل أنت متأكد أنك تريد مغادرة الفريق؟", "نعم", "لا", async () => {

        if (!AppState.playerProfile) return;

        const playerRef = doc(db, "players", AppState.playerProfile.id);

        await updateDoc(playerRef, { teamId: null });

        AppState.playerTeam = null; // Clear local state immediately

        showTeamHub();

    });

}

// ===================================================================================

// ✨ نظام اللعب الفردي ✨

// ===================================================================================

function displayTiers() {

    showScreen('single-player-menu-screen');

    const grid = document.getElementById('tiers-grid');

    if(!grid) return;

    grid.innerHTML = '';

    let lastTierCompleted = true;

    GAME_CONFIG.singlePlayerTiers.forEach((tier, index) => {

        const completedLevels = AppState.playerProfile.singlePlayerProgress?.[tier.id]?.length || 0;

        const isLocked = index > 0 && !lastTierCompleted;

        const progressPercent = (completedLevels / tier.levels) * 100;

        

        const card = document.createElement('div');

        card.className = `card ${isLocked ? 'locked' : ''}`;

        card.innerHTML = `

            <div class="card-icon"><i class='bx ${isLocked ? 'bxs-lock' : tier.icon}'></i></div>

            <h3 class="card-title">${tier.name} ${tier.medal}</h3>

            <p class="screen-subtitle" style="margin:0.5rem 0;">المستويات: ${tier.levels}</p>

            <div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>

        `;

        if (!isLocked) card.onclick = () => displayLevels(tier);

        grid.appendChild(card);

        if (progressPercent < 100) lastTierCompleted = false;

    });

}



function displayLevels(tier) {

    AppState.singlePlayerState.currentTier = tier;

    showScreen('level-select-screen');

    document.getElementById('level-select-title').textContent = tier.name;

    const grid = document.getElementById('levels-grid');

    if(!grid) return;

    grid.innerHTML = '';

    const completedInTier = AppState.playerProfile.singlePlayerProgress?.[tier.id] || [];

    for (let i = 0; i < tier.levels; i++) {

        const isCompleted = completedInTier.includes(i);

        const card = document.createElement('div');

        card.className = `card level-card ${isCompleted ? 'completed' : ''}`;

        card.innerHTML = `<h3 class="card-title">المستوى ${i + 1}</h3> ${isCompleted ? '<p style="color:var(--accent-green); margin:0;">✅ مكتمل</p>' : ''}`;

        card.onclick = () => startSinglePlayerLevel(tier, i);

        grid.appendChild(card);

    }

}



function startSinglePlayerLevel(tier, levelIndex) {

    AppState.singlePlayerState = { currentTier: tier, currentLevel: levelIndex, questions: getQuestions('singlePlayer', tier.questionsPerLevel), currentQuestionIndex: 0, answers: [] };

    displaySinglePlayerQuestion();

}



function displaySinglePlayerQuestion() {

    showScreen('match-screen');

    document.querySelector('#match-screen [data-action="surrender"]').style.display = 'none';

    const backBtn = document.querySelector('#match-screen .back-btn');

    if(backBtn) {

        backBtn.style.display = 'block';

        backBtn.onclick = () => {

            cleanupListeners();

            showScreen('level-select-screen');

            displayLevels(AppState.singlePlayerState.currentTier);

        };

    }



    const { currentTier, currentQuestionIndex, questions } = AppState.singlePlayerState;

    if (!questions || questions.length === 0) {

        showModal("خطأ", "لا يوجد أسئلة متاحة لهذا المستوى.", null, "موافق", () => displayTiers());

        return;

    }

    const question = questions[currentQuestionIndex];



    document.getElementById('match-header').textContent = `${currentTier.name} - المستوى ${AppState.singlePlayerState.currentLevel + 1}`;

    document.getElementById('question-counter').textContent = `السؤال ${currentQuestionIndex + 1} / ${questions.length}`;

    document.getElementById('question-text').innerHTML = question.question;

    document.getElementById('explanation-box').style.display = 'none';

    const optionsGrid = document.getElementById('options-grid');

    optionsGrid.innerHTML = '';



    Object.entries(question.options).forEach(([key, optionText]) => {

        const btn = document.createElement('button');

        btn.className = 'btn btn-secondary option-btn';

        btn.textContent = optionText;

        btn.onclick = () => handleSinglePlayerAnswer(key);

        optionsGrid.appendChild(btn);

    });

}



function handleSinglePlayerAnswer(selectedKey) {

    const { questions, currentQuestionIndex, currentTier } = AppState.singlePlayerState;

    const question = questions[currentQuestionIndex];

    const isCorrect = selectedKey === question.correct_answer;

    

    document.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

    const correctBtn = Array.from(document.querySelectorAll('.option-btn')).find(btn => btn.textContent === question.options[question.correct_answer]);

    if(correctBtn) correctBtn.classList.add('correct');



    if (!isCorrect) {

        const wrongBtn = Array.from(document.querySelectorAll('.option-btn')).find(btn => btn.textContent === question.options[selectedKey]);

        if(wrongBtn) wrongBtn.classList.add('wrong');

        const explanationBox = document.getElementById('explanation-box');

        if (question.explanation && explanationBox) {

            explanationBox.textContent = `التفسير: ${question.explanation}`;

            explanationBox.style.display = 'block';

        }

        setTimeout(() => {

            showModal("للأسف!", "إجابة خاطئة. يجب عليك الإجابة على كل الأسئلة بشكل صحيح لإكمال المستوى.", null, 'حاول مرة أخرى', () => {

                displayLevels(currentTier);

            });

        }, 2000);

    } else {

        AppState.singlePlayerState.answers.push(isCorrect);

        if (AppState.singlePlayerState.currentQuestionIndex < questions.length - 1) {

            AppState.singlePlayerState.currentQuestionIndex++;

            setTimeout(displaySinglePlayerQuestion, 1200);

        } else {

            finishSinglePlayerLevel();

        }

    }

}



// بداية اللصق (هذه هي النسخة الصحيحة والكاملة للدالة)

// بداية اللصق (هذه هي النسخة الصحيحة والكاملة للدالة)

async function finishSinglePlayerLevel() {

    const { id: tierId, name, medal, points, awardPoints } = AppState.singlePlayerState.currentTier;

    const levelIndex = AppState.singlePlayerState.currentLevel;

    const playerRef = doc(db, "players", AppState.playerProfile.id);



    const wasAlreadyCompleted = AppState.playerProfile.singlePlayerProgress[tierId]?.includes(levelIndex);



    if (!wasAlreadyCompleted) {

        await updateDoc(playerRef, {

            score: increment(points),

            [`singlePlayerProgress.${tierId}`]: arrayUnion(levelIndex)

        });

        AppState.playerProfile.score += points;

        if (!AppState.playerProfile.singlePlayerProgress[tierId]) {

            AppState.playerProfile.singlePlayerProgress[tierId] = [];

        }

        AppState.playerProfile.singlePlayerProgress[tierId].push(levelIndex);

    }



    const allTiers = GAME_CONFIG.singlePlayerTiers;

    const currentTierData = allTiers.find(t => t.id === tierId);

    const completedLevelsInTier = new Set(AppState.playerProfile.singlePlayerProgress[tierId] || []).size;

    const wasTierAlreadyCompleted = AppState.playerProfile.awards?.includes(medal);



    if (completedLevelsInTier >= currentTierData.levels && !wasTierAlreadyCompleted) {

        await updateDoc(playerRef, {

            awards: arrayUnion(medal),

            score: increment(awardPoints)

        });

        showModal("تهانينا!", `لقد أكملت فئة ${name} وحصلت على الميدالية ${medal} ومكافأة ${awardPoints} نقطة!`, null, "رائع");



        if (tierId === 'tier-1') await updatePlayerStat('tier1unlocked');

        if (tierId === 'tier-3') await updatePlayerStat('tier3unlocked');



        const allTiersCompleted = allTiers.every(tier => {

            const progress = AppState.playerProfile.singlePlayerProgress[tier.id] || [];

            return progress.length >= tier.levels;

        });



        if (allTiersCompleted) {

            await updatePlayerStat('allSPCompleted');

        }

    } else {

        showModal("مستوى مكتمل!", `أحسنت! لقد أكملت هذا المستوى بنجاح. ${!wasAlreadyCompleted ? `+${points} نقاط.` : ''}`, null, "متابعة");

    }



    await loadPlayerProfile(AppState.playerProfile.id);

    displayTiers();

    await checkLevelUpAchievements();

}

// نهاية اللصق

// ===================================================================================

// ✨✨✨ نظام احتلال الجزر المطور ✨✨✨

// ===================================================================================

async function showIslandConquestScreen() {

    if (!AppState.playerTeam) return showModal("ميزة للفرق فقط", "يجب أن تكون عضوًا في فريق للمشاركة في احتلال الجزر.", null, "حسنًا");

    showScreen('island-conquest-screen');

    const grid = document.getElementById('island-map-grid');

    if(!grid) return;

    grid.innerHTML = `<p>جار تحميل خريطة الجزر...</p>`;

    cleanupListeners();



    await grantDailyIslandRewards();



    AppState.unsubscribers.islands = onSnapshot(collection(db, 'islands'), async (snapshot) => {

        const islands = {}; snapshot.docs.forEach(doc => { islands[doc.id] = doc.data(); });

        const teamIds = new Set(Object.values(islands).map(i => i.controllingTeamId).filter(Boolean));

        const teamDataMap = {};

        if (teamIds.size > 0) {

            const teamsQuery = query(collection(db, "teams"), where("__name__", "in", Array.from(teamIds)));

            const teamDocs = await getDocs(teamsQuery);

            teamDocs.forEach(doc => { teamDataMap[doc.id] = doc.data(); });

        }

        

        grid.innerHTML = Object.entries(GAME_CONFIG.islandDefinitions).map(([id, def]) => {

            const islandState = islands[id];

            const ownerTeamId = islandState?.controllingTeamId;

            let ownerTag = 'لا أحد';

            let tileClass = '';

            if (ownerTeamId && teamDataMap[ownerTeamId]) {

                ownerTag = teamDataMap[ownerTeamId].tag;

                if(ownerTeamId === AppState.playerTeam.id) tileClass = 'my-team'; else tileClass = 'enemy-team';

            }

            return `<div class="island-tile ${tileClass}">

                        <div class="island-icon">${def.icon}</div>

                        <h3 class="island-name">${def.name}</h3>

                        <div class="island-owner">المسيطر: <span class="team-tag">${ownerTag}</span></div>

                        ${ownerTeamId === AppState.playerTeam.id 

                            ? `<p style="color:var(--accent-green); font-weight:bold;">تحت سيطرتكم</p><div class="island-reward-timer">المكافأة التالية خلال ~24 ساعة</div>` 

                            : `<button data-action="challenge-island" data-island-id="${id}" class="btn btn-primary"><i class='bx bxs-flag-alt'></i> تحدي</button>`}

                    </div>`;

        }).join('');

    });

}



// ✅✅✅ الصق هذا الكود النظيف في مكان الكتلة المحذوفة ✅✅✅

async function handleChallengeIsland(islandId) {
    const islandDef = GAME_CONFIG.islandDefinitions[islandId];
    if (!islandDef) {
        console.error("Island definition not found for:", islandId);
        return;
    }

    showModal("تحدي الجزيرة!", `هل أنت مستعد لتحدي السيطرة على ${islandDef.name}؟ ستواجه أنت ولاعب آخر من فريقك لاعبين من الفريق المسيطر. الفائز يسيطر على الجزيرة!`, "ابدأ التحدي", "إلغاء", async () => {
        createLobby('island_challenge', { islandId: islandId });
        await updatePlayerStat('islandChallenges');
        showToast(`تم إنشاء لوبي لتحدي ${islandDef.name}!`);
    });
}

async function grantDailyIslandRewards() {

    if (!AppState.playerTeam) return;



    const islandsQuery = query(collection(db, "islands"), where("controllingTeamId", "==", AppState.playerTeam.id));

    const ownedIslandsSnap = await getDocs(islandsQuery);



    const batch = writeBatch(db);

    const now = Date.now();

    const oneDay = 24 * 60 * 60 * 1000;

    let rewardsGranted = 0;

    let pointsAwarded = 0;



    ownedIslandsSnap.forEach(islandDoc => {

        const island = islandDoc.data();

        const islandDef = GAME_CONFIG.islandDefinitions[islandDoc.id];

        const lastRewardTime = island.lastRewardGrantedAt?.toMillis() || 0;



        if (now - lastRewardTime > oneDay) {

            const teamRef = doc(db, "teams", island.controllingTeamId);

            batch.update(teamRef, { score: increment(islandDef.dailyReward) });

            batch.update(islandDoc.ref, { lastRewardGrantedAt: serverTimestamp() });

            rewardsGranted++;

            pointsAwarded += islandDef.dailyReward;

        }

    });



    if (rewardsGranted > 0) {

        await batch.commit();

        await updatePlayerStat('islandBonusCollected', rewardsGranted);

        showToast(`حصل فريقك على ${pointsAwarded} نقطة كمكافأة للسيطرة على ${rewardsGranted} جزيرة!`);

    }

}

// ===================================================================================

// ✨ نظام المباريات والأونلاين ✨

// ===================================================================================



async function createLobby(type, options = {}) {

    if (!AppState.currentUser || !AppState.playerProfile) return showModal("خطأ", "يجب تسجيل الدخول أولاً.", null, "حسنًا");

    const lobbyCode = Math.random().toString(36).substring(2, 7).toUpperCase();

    const lobbyRef = doc(db, "lobbies", lobbyCode);

    const player = { uid: AppState.currentUser.uid, name: AppState.playerProfile.name, teleoptiId: AppState.playerProfile.id, score: 0 };

    const newLobby = {

        lobbyCode, type, hostUid: AppState.currentUser.uid,

        createdAt: serverTimestamp(), status: "waiting",

        players: [player], currentQuestionIndex: -1, answers: {},

        options

    };

    await setDoc(lobbyRef, newLobby);

    joinLobby(lobbyCode);

}



function joinLobby(code) {

    if (!AppState.currentUser || !AppState.playerProfile) return showModal("خطأ", "يجب تسجيل الدخول أولاً للانضمام.", null, "حسنًا");

    const lobbyCode = code.toUpperCase();

    const lobbyRef = doc(db, "lobbies", lobbyCode);

    cleanupListeners();

    AppState.unsubscribers.lobby = onSnapshot(lobbyRef, async (docSnap) => {

        if (!docSnap.exists()) {

            cleanupListeners();

            return showModal("خطأ", "الغرفة غير موجودة أو تم إغلاقها.", null, "حسنًا", () => showScreen('online-menu-screen'));

        }

        const lobbyData = docSnap.data();

        AppState.currentLobbyId = lobbyData.lobbyCode;

        const playerInLobby = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);

        if (lobbyData.status !== 'waiting' && !playerInLobby) {

            cleanupListeners();

            return showModal("مغلق", "هذه المنافسة قد بدأت بالفعل أو انتهت.", null, "حسنًا", () => showScreen('online-menu-screen'));

        }

        if (lobbyData.type === '1v1' && lobbyData.players.length >= 2 && !playerInLobby) {

            cleanupListeners();

            return showModal("ممتلئة", "هذه المواجهة ممتلئة بالفعل.", null, "حسنًا", () => showScreen('online-menu-screen'));

        }

        if (!playerInLobby) {

            const newPlayer = { uid: AppState.currentUser.uid, name: AppState.playerProfile.name, teleoptiId: AppState.playerProfile.id, score: 0 };

            await updateDoc(lobbyRef, { players: arrayUnion(newPlayer) });

        } else {

            switch (lobbyData.status) {

                case 'waiting': 

                    showScreen('online-lobby-screen'); 

                    updateLobbyScreen(lobbyData); 

                    break;

                case 'intermission':

                case 'in-progress': 

                    runGame(lobbyData); 

                    break;

                case 'finished': 

                    displayGameOver(lobbyData); 

                    break;

            }

        }

    }, (error) => {

        console.error("Lobby snapshot error:", error);

        cleanupListeners();

        showModal("خطأ بالاتصال", "فقد الاتصال بغرفة اللعب.", null, "حسنًا", () => showScreen('main-menu-screen'));

    });

}



function updateLobbyScreen(lobbyData) {

    if (!lobbyData || !document.getElementById('online-lobby-screen').classList.contains('active')) return;

    document.getElementById('lobby-title').textContent = lobbyData.type === '1v1' ? 'ردهة المواجهة (1 ضد 1)' : 'ردهة المنافسة الحاشدة';

    document.getElementById('lobby-id-display').textContent = lobbyData.lobbyCode;

    document.getElementById('player-count').textContent = lobbyData.players.length;

    document.getElementById('lobby-players-list').innerHTML = lobbyData.players.map(p => `<div class="list-item" style="justify-content: center;"><span class="item-name">${p.name}${p.uid === lobbyData.hostUid ? ' 👑' : ''}</span></div>`).join('');

    const startGameBtn = document.getElementById('start-game');

    const isHost = lobbyData.hostUid === AppState.currentUser.uid;

    startGameBtn.style.display = isHost ? 'flex' : 'none';

    const canStart = lobbyData.type === '1v1' ? lobbyData.players.length === 2 : lobbyData.players.length >= 1;

    startGameBtn.disabled = !canStart;

    setupLobbyChat(); 

 };





function leaveLobby() {

    cleanupListeners();

    showScreen('online-menu-screen');

}



async function startGame() {

    if (!AppState.currentLobbyId) return;

    const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

    try {

        await runTransaction(db, async (t) => {

            const lobbyDoc = await t.get(lobbyRef);

            if (!lobbyDoc.exists()) throw "Lobby not found";

            const lobbyData = lobbyDoc.data();

            if (lobbyData.status !== 'waiting') throw "Lobby not in waiting state";

            let gameQuestions;

            if (lobbyData.type === 'island_challenge') {

                gameQuestions = getQuestions(`islands.${lobbyData.options.islandId}`, 10);

            } else {

                gameQuestions = getQuestions('online', 30);

            }

            t.update(lobbyRef, { questions: gameQuestions, status: 'in-progress', currentQuestionIndex: 0, questionStartTime: serverTimestamp() });

        });

        await updatePlayerStat('gamesPlayed');

    } catch (error) {

        console.error("Failed to start game:", error);

        showModal("خطأ", "لا يمكن بدء اللعبة.", null, "حسنًا");

    }

}



function runGame(lobbyData) {

    if (lobbyData.status === 'in-progress' || lobbyData.status === 'intermission') {

        displayOnlineMatchScreen(lobbyData);

    } else if (lobbyData.status === 'finished') {

        displayGameOver(lobbyData);

    }

}



function displayOnlineMatchScreen(lobbyData) {

    showScreen('match-screen');

    const questionIndex = lobbyData.currentQuestionIndex;

    if (questionIndex < 0 || !lobbyData.questions || questionIndex >= lobbyData.questions.length) return;



    const question = lobbyData.questions[questionIndex];

    const isIntermission = lobbyData.status === 'intermission';



    document.getElementById('match-header').textContent = lobbyData.type === '1v1' ? 'مواجهة 1 ضد 1' : 'منافسة حاشدة';

    document.getElementById('question-counter').textContent = `السؤال ${questionIndex + 1} / ${lobbyData.questions.length}`;

    document.getElementById('question-text').innerHTML = question.question;

    

    const explanationBox = document.getElementById('explanation-box');

    if (isIntermission && question.explanation) {

        explanationBox.textContent = `التفسير: ${question.explanation}`;

        explanationBox.style.display = 'block';

    } else {

        explanationBox.style.display = 'none';

    }



    const optionsGrid = document.getElementById('options-grid');

    optionsGrid.innerHTML = '';

    const myAnswerData = lobbyData.answers?.[questionIndex]?.[AppState.currentUser.uid];



    Object.entries(question.options).forEach(([key, optionText]) => {

        const btn = document.createElement('button');

        btn.className = 'btn btn-secondary option-btn';

        btn.textContent = optionText;



        if (isIntermission) {

            btn.classList.add('disabled');

            if (key === lobbyData.lastCorrectAnswer) {

                btn.classList.add('correct');

            } else if (myAnswerData?.key === key) {

                btn.classList.add('wrong');

            }

        } else {

            if (!!myAnswerData) {

                btn.classList.add('disabled');

                if (myAnswerData.key === key) btn.style.borderColor = 'var(--accent-yellow)';

            } else {

                btn.onclick = () => handleOnlineAnswer(questionIndex, key);

            }

        }

        optionsGrid.appendChild(btn);

    });



    if (!isIntermission && lobbyData.hostUid === AppState.currentUser.uid) {

        clearTimeout(AppState.questionTimer);

        AppState.questionTimer = setTimeout(advanceOnlineQuestion, 25000);

    }



    const scoreboardList = document.getElementById('live-scoreboard-list');

    if (scoreboardList) {

        const sortedPlayers = [...lobbyData.players].sort((a, b) => (b.score || 0) - (a.score || 0));

        scoreboardList.innerHTML = sortedPlayers.map((p, i) => {

            const isMe = p.uid === AppState.currentUser.uid;

            const myStyle = isMe ? 'background-color: var(--accent-blue);' : '';

            return `<div class="list-item" style="padding: 0.75rem; ${myStyle}"><div class="item-info" style="gap: 0.75rem;"><span class="item-rank" style="font-size: 1rem;">${i + 1}</span><span class="item-name" style="font-size: 0.9rem;">${p.name}</span></div><span class="item-value" style="font-size: 1rem;">${p.score || 0}</span></div>`;

        }).join('');

    }

}



async function handleOnlineAnswer(questionIndex, selectedKey) {

    if (!AppState.currentLobbyId || !AppState.currentUser) return;

    const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

    const answerPath = `answers.${questionIndex}.${AppState.currentUser.uid}`;

    await updateDoc(lobbyRef, { [answerPath]: { key: selectedKey, time: serverTimestamp() } });

}



async function advanceOnlineQuestion() {

    if (!AppState.currentLobbyId) return;

    const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

    try {

        const lobbyDoc = await getDoc(lobbyRef);

        if (!lobbyDoc.exists()) return;

        

        const lobbyData = lobbyDoc.data();

        const question = lobbyData.questions[lobbyData.currentQuestionIndex];

        const updatedPlayers = scoreOnlineRound(lobbyData, lobbyData.currentQuestionIndex);



        await updateDoc(lobbyRef, {

            players: updatedPlayers,

            lastCorrectAnswer: question.correct_answer,

            status: 'intermission'

        });



        setTimeout(() => {

            moveToNextQuestion(lobbyData, updatedPlayers);

        }, 10000);



    } catch (error) {

        console.error("Error advancing question:", error);

    }

}



async function moveToNextQuestion(lobbyData, players) {

    const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

    const oldIndex = lobbyData.currentQuestionIndex;



    if (oldIndex >= lobbyData.questions.length - 1) {

        await updateDoc(lobbyRef, { status: 'finished' });

        await finalizeOnlineGameAwards({ ...lobbyData, players: players });

    } else {

        await updateDoc(lobbyRef, {

            status: 'in-progress',

            currentQuestionIndex: oldIndex + 1,

            lastCorrectAnswer: null,

            answers: {} 

        });

    }

}



function scoreOnlineRound(lobbyData, questionIndex) {

    if (questionIndex < 0) return lobbyData.players;

    const question = lobbyData.questions[questionIndex];

    const answersForRound = lobbyData.answers?.[questionIndex] || {};

    let players = JSON.parse(JSON.stringify(lobbyData.players));



    Object.keys(answersForRound).forEach(uid => {

        if (answersForRound[uid].key === question.correct_answer) {

            const player = players.find(p => p.uid === uid);

            if (player) player.score += 10;

        }

    });

    return players;

}



async function finalizeOnlineGameAwards(lobbyData) {

    const batch = writeBatch(db);

    const sortedPlayers = [...lobbyData.players].sort((a, b) => (b.score || 0) - (a.score || 0));

    if (sortedPlayers.length === 0 || sortedPlayers[0].score === 0) return;



    const winner = sortedPlayers[0];

    const winnerRef = doc(db, "players", winner.teleoptiId);

    let pointsToAdd = 0;



    if (lobbyData.type === '1v1' && sortedPlayers.length > 1) {

        if (winner.score > (sortedPlayers[1].score || 0)) {

            pointsToAdd = 50;

            batch.update(winnerRef, { score: increment(pointsToAdd), "stats.wins1v1": increment(1) });

        }

    } else if (lobbyData.type === 'massive') {

        pointsToAdd = 100;

        batch.update(winnerRef, { 

            score: increment(pointsToAdd),

            "stats.winsMassive": increment(1) 

        });

    }



    await batch.commit();

    AppState.playerProfile.score = (AppState.playerProfile.score || 0) + pointsToAdd;

    await checkLevelUpAchievements();

} // <--- إغلاق finalizeOnlineGameAwards





function displayGameOver(lobbyData) {

    cleanupListeners();

    showScreen('game-over-screen');

    const subtitle = document.getElementById('game-over-subtitle');

    const resultsList = document.getElementById('final-results-list');

    const sortedPlayers = [...lobbyData.players].sort((a, b) => (b.score || 0) - (a.score || 0));



    if (lobbyData.surrendered?.uid) {

        const surrenderer = lobbyData.players.find(p => p.uid === lobbyData.surrendered.uid);

        const winner = lobbyData.players.find(p => p.uid !== lobbyData.surrendered.uid);

        if(subtitle && surrenderer && winner) subtitle.textContent = `${surrenderer.name} استسلم! الفائز هو ${winner.name}!`;

    } else if (sortedPlayers.length > 0) {

        if(subtitle) subtitle.textContent = `الفائز هو ${sortedPlayers[0].name}!`;

    }



    if (resultsList) {

        resultsList.innerHTML = sortedPlayers.map((p, i) =>

            `<div class="list-item"><div class="item-info"><span class="item-rank">${i + 1}</span><span class="item-name">${p.name} ${p.surrendered ? '(مستسلم)' : ''}</span></div><span class="item-value">${p.score} نقطة</span></div>`

        ).join('');

    }

}



async function surrender() {

    showModal("تأكيد الاستسلام", "هل أنت متأكد؟ سيتم اعتبارك خاسرًا.", "نعم, استسلم", "إلغاء", async () => {

        if (!AppState.currentLobbyId || !AppState.currentUser) return;

        const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

        try {

            await runTransaction(db, async (t) => {

                const lobbyDoc = await t.get(lobbyRef);

                if (!lobbyDoc.exists()) throw new Error("Lobby not found");

                const lobbyData = lobbyDoc.data();

                if (lobbyData.status !== 'in-progress') return;



                if (lobbyData.type === '1v1') {

                    t.update(lobbyRef, {

                        status: 'finished',

                        surrendered: { uid: AppState.currentUser.uid, name: AppState.playerProfile.name }

                    });

                } else {

                    const players = lobbyData.players;

                    const playerIndex = players.findIndex(p => p.uid === AppState.currentUser.uid);

                    if (playerIndex > -1) {

                        players[playerIndex].surrendered = true;

                        t.update(lobbyRef, { players: players });

                    }

                }

            });

            const finalDoc = await getDoc(lobbyRef);

            if (finalDoc.exists() && finalDoc.data().type === 'massive') {

                cleanupListeners();

                showScreen('main-menu-screen');

            }

        } catch (error) {

            console.error("Surrender failed:", error);

        }

    });

}

// ===================================================================================

// ✨ لوحة الصدارة المطورة ✨

// ===================================================================================

function getPlayerLevelInfo(score = 0) {

    const calculatedLevel = Math.floor(score / 500) + 1;

    const levelColors = ['#94a3b8', '#3b82f6', '#22c55e', '#facc15', '#ef4444', '#8b5cf6', '#ec4899'];

    const color = levelColors[Math.min(Math.floor(calculatedLevel / 10), levelColors.length - 1)];

    return { level: calculatedLevel, color: color };

}



async function showLeaderboards(type = 'individual') {

    showScreen('leaderboard-screen');

    const individualPill = document.getElementById('pills-individual');

    const teamsPill = document.getElementById('pills-teams');

    const listContainer = document.getElementById('leaderboard-list');

    if(!individualPill || !teamsPill || !listContainer) return;

    listContainer.innerHTML = `<p>جار تحميل البيانات...</p>`;

    

    if (type === 'individual') {

        individualPill.classList.replace('btn-secondary', 'btn-primary');

        teamsPill.classList.replace('btn-primary', 'btn-secondary');

        const q = query(collection(db, "players"), orderBy("score", "desc"), limit(50));

        const snapshot = await getDocs(q);

        const players = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

        listContainer.innerHTML = players.length ? players.map((p, i) => {

            const { level, color } = getPlayerLevelInfo(p.score);

            const medals = (p.awards || []).join(' ');

            return `

                <div class="list-item">

                    <div class="item-info">

                        <span class="item-rank">${i+1}</span>

                        <div class="player-details">

                            <span class="item-name">${p.name}</span>

                            <span class="player-level" style="background-color: ${color};">Lvl ${level}</span>

                            <span class="player-medals">${medals}</span>

                        </div>

                    </div>

                    <span class="item-value">${p.score || 0}</span>

                </div>`;

        }).join('') : '<p style="text-align:center;">لا يوجد لاعبون لعرضهم.</p>';

    } else {

        teamsPill.classList.replace('btn-secondary', 'btn-primary');

        individualPill.classList.replace('btn-primary', 'btn-secondary');

        const q = query(collection(db, "teams"), orderBy("score", "desc"), limit(50));

        const snapshot = await getDocs(q);

        const teams = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

        listContainer.innerHTML = teams.length ? teams.map((t, i) => `

            <div class="list-item">

                <div class="item-info">

                    <span class="item-rank">${i+1}</span>

                    <span class="item-name">${t.name} [${t.tag}]</span>

                </div>

                <span class="item-value">${t.score || 0}</span>

            </div>`

        ).join('') : '<p style="text-align:center;">لا توجد فرق لعرضها.</p>';

    }

}

// ===================================================================================

// ✨ نظام الدردشة المطور ✨

// ===================================================================================

function setupChatScreen(type) {

    showScreen('chat-screen');

    const titleEl = document.getElementById('chat-screen-title');

    const subtitleEl = document.getElementById('chat-screen-subtitle');

    const messagesContainer = document.getElementById('chat-messages-list');

    const input = document.getElementById('chat-input-field');

    const sendBtn = document.getElementById('chat-send-btn');



    if (!titleEl || !messagesContainer || !input || !sendBtn) {

         console.error("Chat screen elements not found!");

         return;

    }

    

    let collectionName = '';

    

    if (type === 'global') {

        titleEl.innerHTML = "<i class='bx bxs-message-square-dots'></i> الدردشة العامة";

        subtitleEl.textContent = "تواصل مع جميع اللاعبين في اللعبة.";

        collectionName = 'chat_global';

    } else if (type === 'team') {

        if (!AppState.playerTeam) return showModal("خطأ", "يجب أن تكون في فريق للوصول لدردشة الفريق.", null, "حسنًا", () => showScreen('main-menu-screen'));

        titleEl.innerHTML = `<i class='bx bxs-shield-alt-2'></i> دردشة فريق [${AppState.playerTeam.tag}]`;

        subtitleEl.textContent = `تواصل مع أعضاء فريقك.`;

        collectionName = `teams/${AppState.playerTeam.id}/chat`;

    }



    // إزالة أي مستمعين قدامى لتجنب التكرار

    if (AppState.unsubscribers.chat) AppState.unsubscribers.chat();

    

    // إعداد مستمع الرسائل الجديد

    const q = query(collection(db, collectionName), orderBy('timestamp', 'desc'), limit(50));

    AppState.unsubscribers.chat = onSnapshot(q, (snapshot) => {messagesContainer.innerHTML = snapshot.docs.map(doc => {

        const msg = doc.data();

            const isMine = msg.uid === AppState.currentUser.uid;

            const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';

            return `<div class="chat-message ${isMine ? 'mine' : ''}"><div class="sender">${isMine ? 'أنا' : msg.senderName} <span class="team-tag">[${msg.teamTag || '---'}]</span></div><div class="text" style="direction: rtl;">${msg.text}</div><div class="timestamp">${time}</div></div>`;

        }).join('');

        // التمرير للأسفل بعد تحديث الرسائل

        messagesContainer.scrollTop = messagesContainer.scrollHeight; 

    }, (error) => {

        console.error(`Error listening to ${collectionName}:`, error);

        messagesContainer.innerHTML = `<p style="text-align:center; color: var(--accent-red);">خطأ في تحميل الرسائل.</p>`;

    });



    // ربط زر الإرسال

    const sendMessageHandler = () => sendChatMessage(collectionName, input);

    sendBtn.onclick = sendMessageHandler;

    

    // ربط مفتاح Enter

    input.onkeypress = (e) => {

        if (e.key === 'Enter') {

            e.preventDefault();

            sendMessageHandler();

        }

    };

}



async function sendChatMessage(collectionName, inputElement) {

    const text = inputElement.value.trim();

    if (!text || !AppState.currentUser || !collectionName) return;



    // تعطيل مؤقت لمنع الإرسال المزدوج

    inputElement.disabled = true;



    try {

        await addDoc(collection(db, collectionName), {

            uid: AppState.currentUser.uid,

            senderName: AppState.playerProfile.name,

            teamTag: AppState.playerTeam?.tag || 'N/A',

            text: text,

            timestamp: serverTimestamp()

        });



        if (collectionName === 'chat_global' && (!AppState.playerProfile.stats.messagesSent || AppState.playerProfile.stats.messagesSent < 1)) {

            await updatePlayerStat('messagesSent');

        }

        inputElement.value = '';

    } catch (error) {

        console.error("Error sending message:", error);

    } finally {

        inputElement.disabled = false;

        inputElement.focus();

    }

}



function setupLobbyChat() {

    const lobbyId = AppState.currentLobbyId;

    if (!lobbyId) return;



    const messagesContainer = document.getElementById('lobby-chat-messages');

    const input = document.getElementById('lobby-chat-input');

    const sendBtn = document.getElementById('lobby-chat-send');

    if (!messagesContainer || !input || !sendBtn) return;

    

    const collectionName = `lobbies/${lobbyId}/chat`;



    if (AppState.unsubscribers.lobbyChat) AppState.unsubscribers.lobbyChat();



    const q = query(collection(db, collectionName), orderBy('timestamp', 'desc'), limit(25));

    AppState.unsubscribers.lobbyChat = onSnapshot(q, (snapshot) => {

        messagesContainer.innerHTML = snapshot.docs.reverse().map(doc => {             const msg = doc.data();

            const isMine = msg.uid === AppState.currentUser.uid;

            const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';

            return `<div class="chat-message ${isMine ? 'mine' : ''}" style="max-width: 95%;"><div class="sender">${isMine ? 'أنا' : msg.senderName}</div><div class="text" style="direction: rtl;">${msg.text}</div><div class="timestamp">${time}</div></div>`;

        }).join('');

        messagesContainer.scrollTop = messagesContainer.scrollHeight;

    });



    const sendLobbyMessageHandler = () => sendChatMessage(collectionName, input);

    sendBtn.onclick = sendLobbyMessageHandler;

    

    input.onkeypress = (e) => {

        if (e.key === 'Enter') {

            e.preventDefault();

            sendLobbyMessageHandler();

        }

    };

}

// ===================================================================================

// ✨ مشغل الأحداث الرئيسي وبدء التطبيق ✨

// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {

    const actions = {

        'login': handleLogin,

        'logout': handleLogout,

        'toggle-music': toggleMusic,

        'back': (target) => {

            const parentScreenId = target.closest('.screen-container')?.id;

            if (parentScreenId === 'level-select-screen') {

                displayTiers();

            } else if (parentScreenId === 'chat-screen') {

                 if (AppState.unsubscribers.chat) AppState.unsubscribers.chat(); // Stop listening to chat

                 showScreen('main-menu-screen');

            }

            else {

                cleanupListeners();

                showScreen('main-menu-screen');

            }

        },

        'show-single-player': displayTiers,

        'show-online-menu': () => showScreen('online-menu-screen'),

        'create-lobby': (target) => createLobby(target.dataset.type),

        'show-join-lobby': () => showScreen('join-lobby-screen'),

        'submit-join-lobby': () => {

            const code = document.getElementById('lobby-id-input')?.value.trim().toUpperCase();

            if (code) joinLobby(code);

            else showModal("خطأ", "الرجاء إدخال كود المنافسة.", null, "حسنًا");

        },

        'start-game': startGame,

        'leave-lobby': leaveLobby,

        'surrender': surrender,

        'show-team-hub': showTeamHub,

        'show-create-team': () => showScreen('create-team-screen'),

        'show-join-team': () => showScreen('join-team-screen'),

        'submit-create-team': handleCreateTeam,

        'submit-join-team': handleJoinTeam,

        'leave-team': handleLeaveTeam,

        'show-leaderboards': () => showLeaderboards('individual'),

        'show-individual-leaderboard': () => showLeaderboards('individual'),

        'show-teams-leaderboard': () => showLeaderboards('teams'),

        'show-achievements': showAchievementsScreen,

        'show-island-conquest': showIslandConquestScreen,

        'challenge-island': (target) => handleChallengeIsland(target.dataset.islandId),

        'show-chat': () => setupChatScreen('global'),

        'show-team-chat': () => setupChatScreen('team'),

        'modal-cancel': hideModal,

        'modal-confirm': () => {

            if (AppState.modalCallback) AppState.modalCallback();

        },

        'accept-join-request': (target) => acceptJoinRequest(target.dataset.playerId, target.dataset.teamId),

        'decline-join-request': (target) => declineJoinRequest(target.dataset.requestId, target.dataset.teamId),

        'show-notifications': showNotificationsScreen,

    };



    document.body.addEventListener('click', (e) => {

        const target = e.target.closest('[data-action]');

        if (target && actions[target.dataset.action]) {

            if (target.dataset.action === 'start-game' && !target.disabled) {

                target.disabled = true;

                target.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> ...جار بدء اللعبة";

            }

            actions[target.dataset.action](target);

        }

    });



    onAuthStateChanged(auth, (user) => {

        AppState.currentUser = user;

        if (user) {

            const rememberedId = localStorage.getItem('triviaTeleoptiId');

            if (rememberedId) {

                showScreen('loading-screen');

                loadPlayerProfile(rememberedId);

            } else {

                showScreen('registration-screen');

                repopulateLoginFields();

            }

        } else {

            showScreen('registration-screen');

            repopulateLoginFields();

        }

    });

});

</script>

</body>

</html>
