<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NC 1 Eagles - Botros Race Ultimate</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        /* =================================
           ✨ CSS مطور - الإصدار الجديد ✨
           ================================= */

        :root {
            --bg-primary: #0d121f; --bg-glass: rgba(255, 255, 255, 0.05);
            --border-glass: rgba(255, 255, 255, 0.1); --bg-locked: rgba(30, 41, 59, 0.5); 
            --accent-cyan: #00ddff; --accent-green: #39d353; --accent-red: #ff4757;
            --accent-yellow: #ffd32a; --accent-purple: #a55eea; --accent-blue: #3782ff;
            --brand-glow: rgba(0, 221, 255, 0.5); --text-primary: #f0f4f8; --text-secondary: #a3b3c8;
        }

        /* === ✨ تحسين وضوح الخطوط (الإصلاح الجديد) ✨ === */
#question-text, #match-header, #game-over-screen .screen-title, #results-container h2 {
    color: #FFFFFF; /* أبيض ساطع */
    font-weight: 700; /* خط عريض */
    text-shadow: 0 1px 6px rgba(0, 0, 0, 0.7); /* ظل لتحسين الوضوح */
}

.option-btn, .btn {
     font-weight: 700; /* جعل كل الأزرار بخط عريض */
}

.ladder-step, .vacancy-main-content #turn-indicator {
    color: #FFFFFF;
    font-weight: 700;
    text-shadow: 0 1px 4px rgba(0,0,0,0.5);
}

.modal-content p, .screen-subtitle {
     color: #e2e8f0; /* لون أفتح وأوضح من السابق */
     font-size: 1.1rem;
     line-height: 1.6;
}
/* === نهاية إصلاح الخطوط === */

/* ✨ شريط بث مطور ✨ */
.broadcast-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    /* 1. تغيير الخلفية لتصبح زجاجية شفافة */
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    
    /* 2. تغيير لون الخط إلى البرتقالي */
    color: #ff8c00; /* هذا هو لون برتقالي غامق */
    
    padding: 0.5rem;
    z-index: 4000;
    text-align: center;
    font-weight: 700;
    font-size: 1.1rem;
    overflow: hidden;
    white-space: nowrap;
    display: none; 
}

.broadcast-container.active {
    display: block;
}

.broadcast-message {
    display: inline-block;
    padding-left: 100%;
    /* 3. إبطاء مدة الحركة إلى 35 ثانية */
    animation: marquee 35s linear infinite;
    margin: 0;
}

/* 4. تعديل الحركة لإضافة وقفة قبل التكرار */
@keyframes marquee {
    0% { transform: translate(0, 0); }
    85% { transform: translate(-100%, 0); } /* إنهاء الحركة عند 85% من الوقت */
    100% { transform: translate(-100%, 0); } /* البقاء في مكان النهاية حتى انتهاء الوقت */
}

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        /* --- Base Styles --- */
        body {
            font-family: 'Tajawal', sans-serif; background-color: var(--bg-primary);
            background-image: radial-gradient(circle at 1% 1%, var(--accent-blue), transparent 30%), radial-gradient(circle at 99% 99%, var(--accent-purple), transparent 30%);
            background-size: cover; background-attachment: fixed; color: var(--text-primary);
            margin: 0; padding: 1rem; display: flex; align-items: center; justify-content: center;
            min-height: 100vh; box-sizing: border-box; overflow-x: hidden;
        }
        main { width: 100%; max-width: 900px; }

        /* --- Container Styles (Glassmorphism) --- */
        .screen-container {
            width: 100%; padding: 2rem; border: 1px solid var(--border-glass); border-radius: 1.5rem;
            background: var(--bg-glass); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); box-sizing: border-box;
            display: none; position: relative; overflow: hidden;
        }


        .screen-container.active { display: block; animation: fadeIn 0.6s ease-out; }

/* ======================================= */
/* ✨ NEW: Screen Background Images ✨ */
/* ======================================= */

/* إعدادات عامة للخلفيات */
.screen-container {
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-blend-mode: screen; 
}

/* خلفية القائمة الرئيسية واحتلال الجزر */
#main-menu-screen, #island-conquest-screen {
    background-image: url('https://raw.githubusercontent.com/V15Mbanna3/my-sounds/main/main.png');
}

/* خلفية من سيربح الفاكنسي */
#vacancy-match-screen {
    background-image: url('https://raw.githubusercontent.com/V15Mbanna3/my-sounds/main/vacancy.png');
}

/* خلفية المباريات الحرة (1ضد1، حاشدة) */
#online-menu-screen, #online-lobby-screen, #match-screen {
    background-image: url('https://raw.githubusercontent.com/V15Mbanna3/my-sounds/main/versus.png');
}
        /* --- Typography --- */
        .screen-title {
            font-size: 2.25rem; font-weight: 900; text-align: center; margin-top: 0; margin-bottom: 2rem;
            color: var(--text-primary); text-shadow: 0 0 15px var(--brand-glow); display: flex;
            align-items: center; justify-content: center; gap: 1rem;
        }
        .screen-title i { font-size: 2.5rem; color: var(--accent-cyan); filter: drop-shadow(0 0 10px var(--brand-glow)); }
        .screen-subtitle {
            text-align: center; color: var(--text-secondary); font-size: 1.1rem; font-weight: 500;
            margin-top: -1.5rem; margin-bottom: 2.5rem; max-width: 550px; margin-left: auto;
            margin-right: auto; line-height: 1.6;
        }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 1.5rem; text-align: right; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: var(--text-secondary); }
        .input-field {
            width: 100%; padding: 1rem; background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-glass); border-radius: 0.75rem;
            font-size: 1rem; color: var(--text-primary); box-sizing: border-box;
            text-align: right; transition: all 0.3s ease;
        }
        .input-field:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 10px var(--brand-glow); }

        /* --- Buttons --- */
        .btn {
            width: 100%; padding: 1rem; border-radius: 0.75rem; font-size: 1.125rem;
            font-weight: 700; border: none; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
            position: relative; overflow: hidden;
        }
        .btn-primary { background: linear-gradient(45deg, var(--accent-cyan), var(--accent-blue)); color: white; box-shadow: 0 4px 15px rgba(0, 221, 255, 0.2); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 221, 255, 0.4); }
        .btn:disabled { background: var(--bg-locked); color: var(--text-secondary); cursor: not-allowed; transform: none; box-shadow: none; }
       /* الخطوة 3: إصلاح وتوحيد استايل زر العودة */
.back-btn {
    display: block; margin: 2rem auto 0; width: fit-content; padding: 0.5rem 1.5rem;
    font-size: 1rem; background-color: var(--bg-glass); color: var(--text-secondary);
    border: 1px solid var(--border-glass);
    transition: all 0.3s ease;
}
.back-btn:hover:not(:disabled) {
    background-color: var(--accent-red); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    color: white;
}
        /* --- Music Button Style --- */
        /* --- Music Controls Style --- */
#music-controls-container {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 1000;
    display: flex;
    gap: 0.5rem;
    background: var(--bg-glass);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 0.5rem;
    border-radius: 50px; /* لجعل الحاوية بيضاوية */
    border: 1px solid var(--border-glass);
}

.music-control-btn {
    width: 40px;   /* تصغير الحجم */
    height: 40px;  /* تصغير الحجم */
    border-radius: 50%;
    background-color: transparent;
    color: white;
    font-size: 1.2rem; /* تصغير حجم الأيقونة قليلاً */
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.music-control-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

        /* --- Main Menu --- */
        #main-menu-screen .welcome-container { position: relative; padding-bottom: 1rem; text-align: center; }
        #main-menu-screen .welcome-message { font-size: 1.75rem; font-weight: 900; margin-bottom: 0.25rem; }
        #main-menu-screen .welcome-message .name { color: var(--accent-cyan); }
        #main-menu-screen .welcome-message .team-tag { font-size: 1.2rem; color: var(--accent-yellow); font-weight: 700; margin: 0 0.25rem; }
        #player-awards-display { display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 1.5rem; height: 30px; }
        #logout-btn { position: absolute; top: -1rem; left: -1rem; background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; font-size: 1.75rem; transition: all 0.3s ease; }
        #logout-btn:hover { color: var(--accent-red); transform: scale(1.1); }
        .tabs-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .tab-item { background-color: var(--bg-glass); border: 1px solid var(--border-glass); padding: 1.25rem 1rem; border-radius: 1rem; text-align: center; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .tab-item:hover { transform: translateY(-5px); background-color: rgba(255, 255, 255, 0.1); }
        .tab-item .tab-icon { font-size: 2.75rem; margin-bottom: 0.75rem; line-height: 1; color: var(--text-secondary); transition: all 0.3s ease; }
        .tab-item[data-action="show-island-conquest"]:hover { border-color: var(--accent-green); }
        .tab-item[data-action="show-island-conquest"]:hover .tab-icon { color: var(--accent-green); filter: drop-shadow(0 0 8px var(--accent-green)); }
        .tab-item[data-action="show-single-player"]:hover { border-color: var(--accent-blue); }
        .tab-item[data-action="show-single-player"]:hover .tab-icon { color: var(--accent-blue); filter: drop-shadow(0 0 8px var(--accent-blue)); }
        .tab-item[data-action="show-online-menu"]:hover { border-color: var(--accent-red); }
        .tab-item[data-action="show-online-menu"]:hover .tab-icon { color: var(--accent-red); filter: drop-shadow(0 0 8px var(--accent-red)); }
        .tab-item[data-action="show-team-hub"]:hover { border-color: var(--accent-purple); }
        .tab-item[data-action="show-team-hub"]:hover .tab-icon { color: var(--accent-purple); filter: drop-shadow(0 0 8px var(--accent-purple)); }
        .tab-item[data-action="show-leaderboards"]:hover { border-color: var(--accent-yellow); }
        .tab-item[data-action="show-leaderboards"]:hover .tab-icon { color: var(--accent-yellow); filter: drop-shadow(0 0 8px var(--accent-yellow)); }
        .tab-item[data-action="show-achievements"]:hover { border-color: var(--accent-cyan); }
        .tab-item[data-action="show-achievements"]:hover .tab-icon { color: var(--accent-cyan); filter: drop-shadow(0 0 8px var(--accent-cyan)); }
        .tab-item[data-action="show-chat"]:hover { border-color: var(--accent-blue); }
        .tab-item[data-action="show-chat"]:hover .tab-icon { color: var(--accent-blue); filter: drop-shadow(0 0 8px var(--accent-blue)); }
        
        /* --- Modals & Toasts --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--bg-primary); padding: 2rem; border-radius: 1rem; text-align: center; border: 1px solid var(--border-glass); max-width: 90%; width: 400px; animation: fadeIn 0.3s ease-out; }
        .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; }
        .modal-actions .btn { width: auto; padding-left: 2rem; padding-right: 2rem; }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background-color: var(--accent-purple); color: white; padding: 1rem 1.5rem; border-radius: 0.75rem; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* --- Single Player & Match Styles --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .card { background-color: var(--bg-glass); border: 1px solid var(--border-glass); padding: 1.5rem; border-radius: 1rem; transition: all 0.3s ease; text-align: center; }
        .card:not(.locked) { cursor: pointer; }
        .card:not(.locked):hover { transform: translateY(-5px); border-color: var(--accent-cyan); box-shadow: 0 5px 20px rgba(0, 221, 255, 0.2); }
        .card.locked { background-color: var(--bg-locked); color: var(--text-secondary); cursor: not-allowed; }
        .card.completed { border-color: var(--accent-green); background-color: rgba(57, 211, 83, 0.1); }
        .card .card-icon { font-size: 3rem; color: var(--accent-cyan); margin-bottom: 1rem; }
        .progress-bar-container { background-color: rgba(0,0,0,0.3); border-radius: 99px; height: 10px; overflow: hidden; margin-top: 1rem; }
        .progress-bar { background-color: var(--accent-green); height: 100%; width: 0%; transition: width 0.5s; }
        #match-screen #options-grid { grid-template-columns: 1fr 1fr; gap: 1rem; }
        #question-text { font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; min-height: 100px; color: var(--text-primary); }
        .option-btn { background-color: rgba(255,255,255,0.05); border: 1px solid var(--border-glass); color: var(--text-primary); }
        .option-btn:hover:not(:disabled) { background-color: rgba(255,255,255,0.1); border-color: var(--accent-cyan); }
        .option-btn.correct { background: linear-gradient(45deg, var(--accent-green), #2ed573) !important; color: white; transform: scale(1.05); border-color: var(--accent-green) !important; }
        .option-btn.wrong { background: linear-gradient(45deg, var(--accent-red), #ff4757) !important; color: white; border-color: var(--accent-red) !important; }
        .option-btn.disabled { opacity: 0.6; pointer-events: none; }
        #explanation-box { background-color: rgba(255, 211, 42, 0.1); border: 1px solid var(--accent-yellow); border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem; display: none; }
        #timer-container { width:100%;background-color:rgba(0,0,0,0.3);border-radius:5px;margin-bottom:1.5rem; }
        #timer-bar { height:10px;background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow));border-radius:5px;transition:width 1s linear; }

        /* --- Lists & Team Hub & Leaderboard Styles --- */
        .list-container { max-height: 450px; overflow-y: auto; padding-right: 0.5rem; scrollbar-width: thin; scrollbar-color: var(--accent-cyan) var(--bg-locked); }
        .list-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.75rem; margin-bottom: 0.75rem; transition: background-color 0.3s; border-left: 4px solid transparent; }
        .list-item:hover { background-color: rgba(0,0,0,0.4); border-left-color: var(--accent-cyan); }
        .list-item .item-info { display: flex; align-items: center; gap: 1rem; }
        .list-item .item-rank { font-weight: 900; font-size: 1.2rem; color: var(--accent-cyan); width: 40px; text-align: center; }
        .list-item .item-name { font-weight: 700; font-size: 1.1rem; }
        .list-item .item-value { font-weight: 700; font-size: 1.2rem; color: var(--accent-yellow); }
        #team-id-display { color:var(--accent-cyan); cursor:pointer; font-weight: 700; background: rgba(0,0,0,0.3); padding: 0.25rem 0.75rem; border-radius: 8px; }
        .player-details { display: flex; align-items: center; gap: 0.5rem; }
        .player-level { color: white; font-size: 0.8rem; font-weight: bold; padding: 2px 8px; border-radius: 12px; }
        .player-medals { font-size: 1rem; }
        .pills-container { display:flex; gap:1rem; margin-bottom:2rem; background-color: rgba(0,0,0,0.2); border-radius: 12px; padding: 0.5rem; }
        .pill-btn { flex:1; padding: 0.75rem; border-radius: 8px; font-size: 1rem; background-color: transparent; color: var(--text-secondary); }
        .pill-btn.active { background-color: var(--accent-cyan); color: var(--bg-primary); box-shadow: 0 0 10px var(--brand-glow); }
        .list-separator { height: 2px; background-color: var(--border-glass); margin: 1.5rem 0; border-radius: 2px; }
        .list-item.my-rank { background-color: rgba(0, 221, 255, 0.15); border-left-color: var(--accent-yellow); box-shadow: 0 0 15px rgba(0, 221, 255, 0.2); }

        /* --- ✨ NEW: Achievement Styles ✨ --- */
        .achievement-item { display: flex; align-items: center; gap: 1.5rem; padding: 1rem; background-color: rgba(0,0,0,0.2); border-radius: 0.75rem; margin-bottom: 1rem; border-left: 5px solid var(--bg-locked); opacity: 0.6; transition: all 0.3s ease; }
        .achievement-item.unlocked { opacity: 1; border-left-color: var(--accent-green); background: linear-gradient(90deg, rgba(57, 211, 83, 0.1), transparent); }
        .achievement-icon { font-size: 3rem; line-height: 1; color: var(--accent-yellow); }
        .achievement-item.unlocked .achievement-icon { filter: drop-shadow(0 0 10px var(--accent-yellow)); }
        .achievement-progress { margin-top: 0.5rem; }
        .achievement-progress .progress-bar-container { background-color: rgba(0,0,0,0.5); }
        .achievement-progress .progress-bar { background-color: var(--accent-yellow); }
/* --- Island Conquest Styles --- */
/* الخطوة 1: تصميم حاوية الخريطة الجديدة */
.map-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    margin: 2rem auto;
    aspect-ratio: 16 / 9;
    /* استخدام صورة لخريطة قديمة كخلفية */
    background-image: url('https://www.transparenttextures.com/patterns/old-paper.png'), 
                      radial-gradient(circle, #5a4e40, #3c342a);
    background-color: #4a4035; /* لون احتياطي */
    border-radius: 1rem;
    border: 3px solid #6b5a4b;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.3);
    overflow: hidden; /* مهم لإخفاء أجزاء المسارات الزائدة */
}

/* ✨ --- Island Conquest Map (Final Bubble Version) --- ✨ */

/* ======================================= */
/* ✨ NEW: Solid & Colorful Island Design ✨ */
/* ======================================= */

/* الحركة العائمة المحسّنة (موجودة من قبل) */
@keyframes bobbing {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-8px); }
  100% { transform: translateY(0px); }
}

/* حركة النبض الجديدة للإطار */
@keyframes pulse-border {
    0% { box-shadow: 0 0 0 0px rgba(255, 255, 255, 0.7); }
    100% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
}

/* حاوية الخريطة (لا تغيير) */
.map-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    margin: 2rem auto;
    aspect-ratio: 16 / 9;
    background-image: radial-gradient(rgba(0, 221, 255, 0.1) 1px, transparent 1px),
                      radial-gradient(rgba(0, 221, 255, 0.05) 1px, transparent 1px);
    background-size: 20px 20px, 40px 40px;
    background-position: 0 0, 20px 20px;
    background-color: transparent;
    border-radius: 1.5rem;
    border: 1px solid var(--border-glass);
    box-shadow: none;
}

/* حاوية الجزيرة الرئيسية */
.island {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    z-index: 10;
    transition: transform 0.3s ease;
    animation: bobbing 6s ease-in-out infinite;
}

.island:hover {
    z-index: 11;
    transform: scale(1.05);
}

/* تصميم الدائرة الرئيسية للأيقونة - النسخة الجديدة */
.island-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 4px solid white; /* إطار أبيض سميك وواضح */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: white; /* لون الأيقونة أبيض دائماً */
    transition: all 0.3s ease;
    box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    position: relative;
}

.island:hover .island-icon {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
}

/* كلاسات الألوان الجديدة */
.island.owned-by-me .island-icon {
    background-color: var(--accent-green); /* أخضر لفريقنا */
    border-color: #c8ffda; /* إطار أخضر فاتح */
}

.island.owned-by-enemy .island-icon {
    background-color: var(--accent-red); /* أحمر للعدو */
    border-color: #ffc8c8; /* إطار أحمر فاتح */
}

.island.neutral .island-icon {
    background-color: #576574; /* رمادي للجزر المحايدة */
    border-color: #a3b3c8; /* إطار رمادي فاتح */
}

/* الجزيرة المستهدفة من فريقي */
.island.targeted-by-my-team .island-icon {
    animation: pulse-border 2s infinite;
}

/* تصميم نصوص الجزيرة */
.island-name {
    margin-top: 0.75rem;
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--text-primary);
    text-shadow: 0 0 5px var(--bg-primary);
    line-height: 1.1;
}

.island-owner {
    font-size: 0.75rem;
    font-weight: bold;
    color: var(--accent-yellow);
    text-shadow: 0 0 5px var(--bg-primary);
}

/* --- كود شريط الصحة الجديد --- */
.island-hp-bar-container {
    width: 60px;
    height: 8px;
    background-color: rgba(0,0,0,0.5);
    border-radius: 4px;
    border: 1px solid #fff3;
    margin-top: 5px;
    overflow: hidden; /* مهم لإخفاء الزوايا */
}
.island-hp-bar {
    height: 100%;
    width: 100%; /* سيبدأ دائماً ممتلئاً */
    border-radius: 3px;
    background-color: var(--accent-green);
    transition: width 0.5s ease;
}
/* --- نهاية كود شريط الصحة --- */

/* --- Chat Styles --- */
.chat-message {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    margin-bottom: 0.75rem;
    max-width: 80%;
    display: flex;
    flex-direction: column;
}

.chat-message.my-message {
    background-color: var(--accent-blue);
    align-self: flex-end; /* رسائلي على اليمين */
    border-bottom-right-radius: 0.25rem;
}

.chat-message.other-message {
    background-color: var(--bg-locked);
    align-self: flex-start; /* رسائل الآخرين على اليسار */
    border-bottom-left-radius: 0.25rem;
}

.chat-message .message-meta {
    font-size: 0.8rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
    opacity: 0.8;
}

.chat-message.my-message .message-meta {
    text-align: right;
}

.chat-message .message-content {
    font-size: 1rem;
    line-height: 1.5;
    word-wrap: break-word;
    color: var(--text-primary);
}

/* ======================================= */
/* ✨ NEW: Vacancy Mode Styles ✨ */
/* ======================================= */

.vacancy-game-layout {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
    width: 100%;
    height: 100%;
}

.vacancy-ladder-container {
    flex: 1;
    min-width: 220px;
    max-width: 280px;
    background-color: rgba(0,0,0,0.2);
    padding: 1.5rem 1rem;
    border-radius: 1rem;
    display: flex;
    flex-direction: column-reverse; /* لعرض السلم من الأسفل للأعلى */
    gap: 0.75rem;
    height: 70vh;
}

.ladder-step {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    border: 2px solid var(--border-glass);
    font-weight: 700;
    transition: all 0.3s ease;
    opacity: 0.5; /* الخطوات غير النشطة تكون باهتة */
}

.ladder-step.current-player {
    opacity: 1;
    background: var(--accent-purple);
    border-color: var(--accent-purple);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 0 15px var(--accent-purple);
}

.ladder-step.other-player {
    opacity: 0.9;
    border-color: var(--accent-cyan);
}

.ladder-step .step-players {
    display: flex;
    gap: 0.5rem;
}

.ladder-step .player-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: var(--accent-red);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 900;
    border: 1px solid white;
}

.vacancy-main-content {
    flex: 3;
}

.player-abilities-container {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.ability-btn {
    width: 120px;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem;
    font-size: 0.9rem;
}

.ability-btn i {
    font-size: 1.75rem;
}

/* ======================================= */
/* ✨ NEW: Special Ability Animations ✨ */
/* ======================================= */

.animation-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none; /* مخفي بشكل افتراضي */
    justify-content: center;
    align-items: center;
    z-index: 5000; /* للتأكد من أنه يظهر فوق كل شيء */
    pointer-events: none; /* لمنع الضغط عليه */
    background-color: rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
}

.animation-overlay.show {
    display: flex;
}

.ability-animation-icon {
    font-size: 10rem; /* حجم كبير للأيقونة */
    text-shadow: 0 0 30px white, 0 0 50px var(--brand-glow);
    animation: play-ability-animation 1.5s ease-out forwards;
}

@keyframes play-ability-animation {
    0% {
        transform: scale(0.3);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
        opacity: 1;
    }
    90% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 0;
    }
}

/* ======================================= */
/* ✨ إصلاح وضوح خطوط شاشة المواجهة ✨ */
/* ======================================= */

#vacancy-match-screen #question-text,
#vacancy-match-screen #turn-indicator {
    color: #FFFFFF; /* لون أبيض ناصع */
    font-weight: 700; /* خط عريض */
    /* ظل أسود قوي جداً لتحسين الوضوح على الخلفيات المعقدة */
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.9);
}

#vacancy-match-screen .option-btn {
    font-weight: 700;
    color: #FFFFFF;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
}

#vacancy-ladder-container .ladder-step {
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
}


    </style>
</head>
<body>
    
     <div id="music-controls-container">
    <button class="music-control-btn" data-action="play-previous" title="الأغنية السابقة"><i class='bx bx-skip-previous'></i></button>
    <button id="mute-btn" class="music-control-btn" data-action="toggle-music" title="كتم/تشغيل"><i class='bx bx-volume-mute'></i></button>
    <button class="music-control-btn" data-action="play-next" title="الأغنية التالية"><i class='bx bx-skip-next'></i></button>
</div>
    <div id="broadcast-bar" class="broadcast-container">
        <p class="broadcast-message"></p>
    </div>

    <div id="toast-container"></div>

    <main>
        <div id="registration-screen" class="screen-container active"></div>
        <div id="loading-screen" class="screen-container"></div>
        <div id="main-menu-screen" class="screen-container"></div>
        <div id="single-player-menu-screen" class="screen-container"></div>
        <div id="level-select-screen" class="screen-container"></div>
        <div id="online-menu-screen" class="screen-container"></div>
        <div id="join-lobby-screen" class="screen-container"></div>
        <div id="online-lobby-screen" class="screen-container"></div>
        <div id="team-hub-screen" class="screen-container"></div>
        <div id="create-team-screen" class="screen-container"></div>
        <div id="join-team-screen" class="screen-container"></div>
        <div id="leaderboard-screen" class="screen-container"></div>
        <div id="achievements-screen" class="screen-container"></div>
        <div id="island-conquest-screen" class="screen-container"></div>
        <div id="chat-screen" class="screen-container"></div>
        <div id="match-screen" class="screen-container"></div>
        <div id="game-over-screen" class="screen-container"></div>
        <div id="notifications-screen" class="screen-container"></div>
         <div id="team-browser-screen" class="screen-container"></div>
         <div id="inbox-screen" class="screen-container"></div>
<div id="island-attack-screen" class="screen-container"></div>
<div id="vacancy-match-screen" class="screen-container"></div>
<div id="swap-finder-screen" class="screen-container"></div>
<div id="select-swap-type-screen" class="screen-container"></div>
<div id="create-off-swap-screen" class="screen-container"></div>
<div id="create-shift-swap-screen" class="screen-container"></div>

    </main>

    <div id="modal" class="modal"></div>
    
    <!-- =================================
       ✨ قوالب الشاشات - Templates ✨
       ================================= -->

    <template id="loading-screen-template"><h1 class="screen-title"><i class='bx bx-loader-alt bx-spin'></i> ...جار التحميل</h1></template>
    
    <template id="registration-screen-template">
        <div style="max-width:400px; margin:auto">
            <h1 class="screen-title"><i class='bx bxl-flutter'></i> NC 1 Eagles<br>Islands Conquer</h1>
            <div class="form-group"><label for="name-input" class="form-label">الاسم الكامل</label><input id="name-input" type="text" class="input-field"></div>
            <div class="form-group"><label for="teleopti-id-input" class="form-label">Teleopti ID</label><input id="teleopti-id-input" type="tel" pattern="[0-9]*" class="input-field"></div>
            <div style="display:flex; align-items:center; justify-content:center; gap:.5rem; margin:1.5rem 0; color:var(--text-secondary)"><input type="checkbox" id="remember-me-checkbox" checked><label for="remember-me-checkbox">تذكرني</label></div>
            <button data-action="login" class="btn btn-primary"><i class='bx bx-log-in-circle'></i> دخول</button>
        </div>
    </template>
    
    <template id="main-menu-screen-template">
       <div class="welcome-container">
    <div id="player-resources" style="text-align: center; margin-bottom: 1rem; font-weight: bold; font-size: 1.1rem;"></div>
        <h1 id="welcome-message" class="welcome-message"></h1>
    <div id="player-awards-display"></div>

            <div id="notifications-icon" data-action="show-inbox" style="position: absolute; top: -0.5rem; right: -0.5rem; cursor: pointer; font-size: 2rem; color: var(--text-secondary);">
    <i class='bx bxs-bell'></i>
    <span id="notifications-badge" style="position: absolute; top: 0; right: 0; background-color: var(--accent-red); color: white; font-size: 0.7rem; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; display: none;">0</span>
</div>
            <button data-action="logout" id="logout-btn" title="تسجيل الخروج"><i class='bx bx-exit'></i></button>
        </div>
 <div class="tabs-container">
    <div data-action="show-swap-finder" class="tab-item" style="grid-column: 1 / -1; background: linear-gradient(45deg, var(--accent-yellow), var(--accent-green)); color: white; border-color: var(--accent-yellow);">
        <div class="tab-icon" style="color: white;"><i class='bx bx-transfer-alt'></i></div>
        <div style="font-weight: 900; font-size: 1.2rem;">سوابك عندي (Find Your Swap)</div>
    </div>

        <div data-action="show-island-conquest" class="tab-item"><div class="tab-icon"><i class='bx bxs-map-alt'></i></div><div>احتلال الجزر</div></div>
    <div data-action="show-single-player" class="tab-item"><div class="tab-icon"><i class='bx bxs-user'></i></div><div>اللعب الفردي</div></div>
    <div data-action="show-online-menu" class="tab-item"><div class="tab-icon"><i class='bx bxs-group'></i></div><div>مباريات حرة</div></div>
    <div data-action="show-team-hub" class="tab-item"><div class="tab-icon"><i class='bx bxs-shield-alt-2'></i></div><div>الفريق</div></div>
    <div data-action="show-leaderboards" class="tab-item"><div class="tab-icon"><i class='bx bxs-trophy'></i></div><div>الصدارة</div></div>
    <div data-action="show-achievements" class="tab-item"><div class="tab-icon"><i class='bx bxs-medal'></i></div><div>الإنجازات</div></div>
    <div data-action="show-chat" class="tab-item"><div class="tab-icon"><i class='bx bxs-message-square-dots'></i></div><div>الدردشة العامة</div></div>
</div>

    </template>

    <template id="modal-template">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top:0; color:var(--accent-cyan)"></h2>
            <p id="modal-body"></p>
            <div class="modal-actions"><button data-action="modal-confirm" class="btn btn-primary">نعم</button><button data-action="modal-cancel" class="btn" style="background-color: var(--bg-locked);">إلغاء</button></div>
        </div>
    </template>

    <template id="single-player-menu-screen-template">
        <h1 class="screen-title"><i class='bx bxs-user'></i> طور اللعب الفردي</h1>
        <p class="screen-subtitle">أكمل المستويات لتفتح تحديات أصعب وتحصل على ميداليات ونقاط.</p>
        <div id="tiers-grid" class="grid-container"></div>
        <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
    </template>
    
    <template id="level-select-screen-template">
        <h1 id="level-select-title" class="screen-title"></h1>
        <div id="levels-grid" class="grid-container"></div>
        <button data-action="show-single-player" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للفئات</button>
    </template>

<template id="match-screen-template">
        <div class="match-layout" style="display: flex; gap: 1.5rem; align-items: flex-start;">
            <div class="live-scoreboard-container" style="flex: 1; min-width: 200px; max-width: 250px; background-color: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.75rem;">
                <h3 style="margin-top: 0; text-align: center; color: var(--accent-yellow); border-bottom: 1px solid var(--border-glass); padding-bottom: 0.5rem;">النتائج المباشرة</h3>
                <div id="live-scoreboard-entries" style="display: flex; flex-direction: column; gap: 1rem;"></div>
            </div>
            <div class="match-main-content" style="flex: 3;">
                <div id="surrender-banner" style="display: none; padding: 0.75rem; background-color: var(--accent-red); color: white; text-align: center; font-weight: 700; border-radius: 0.5rem; margin-bottom: 1rem;"></div>
                <h2 id="match-header" style="font-size:1.5rem; font-weight:900; margin-bottom:1rem; text-align:center;"></h2>
                <p id="question-counter" style="text-align:center; color: var(--text-secondary); margin-top:-1rem; margin-bottom: 1rem;"></p>
                <div id="timer-container"><div id="timer-bar"></div></div>
                <h3 id="question-text" style="font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; min-height: 100px;"></h3>
                <div id="options-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;"></div>
                <div id="explanation-box" style="background-color: rgba(255, 211, 42, 0.1); border: 1px solid var(--accent-yellow); border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem; display: none;"></div>
                <button data-action="surrender-game" class="btn" style="background-color:var(--accent-red); margin-top: 2rem;"><i class='bx bx-flag'></i> استسلام</button>
            </div>
        </div>
    </template>

    <template id="team-hub-screen-template">
        <div id="no-team-view">
            <h1 class="screen-title"><i class='bx bxs-shield-x'></i> لم تنضم لفريق بعد</h1>
            <p class="screen-subtitle">قم بإنشاء فريقك الخاص لدعوة أصدقائك، أو انضم إلى فريق موجود.</p>
<div style="display: flex; flex-direction: column; gap: 1rem; max-width: 400px; margin: 2rem auto 0;">
    <button data-action="show-create-team" class="btn btn-primary">
        <i class='bx bxs-shield-plus'></i> إنشاء فريق جديد
    </button>
    <button data-action="browse-teams" class="btn btn-primary">
        <i class='bx bx-list-ul'></i> استعراض كل الفرق
    </button>
    <button data-action="show-join-team" class="btn" style="background-color: var(--accent-purple);">
        <i class='bx bx-hash'></i> الانضمام بكود
    </button>
</div>

        </div>
        <div id="team-view" style="display:none">
            <h1 id="team-name-title" class="screen-title"></h1>
            <p class="screen-subtitle">
                مجموع نقاط الفريق: <strong id="team-score" style="color:var(--accent-yellow)">0</strong> | 
                كود الفريق: <strong id="team-id-display" title="اضغط للنسخ"></strong>
            </p>
            <h3><i class='bx bxs-user-detail'></i> أعضاء الفريق (<span id="team-member-count">0</span>)</h3>
            <div id="team-members-list" class="list-container" style="max-height:250px"></div>
            <div id="join-requests-section" style="display: none; margin-top: 2rem;">
                <div class="list-separator"></div>
                <h3><i class='bx bxs-user-plus'></i> طلبات الانضمام المعلقة</h3>
                <div id="join-requests-list" class="list-container" style="max-height: 200px;"></div>
            </div>
            <button data-action="leave-team" class="btn" style="background-color:var(--accent-red); margin-top:2rem"><i class='bx bx-exit'></i> مغادرة الفريق</button>
        </div>
        <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
    </template>

    <template id="create-team-screen-template">
        <div style="max-width:400px; margin:auto">
            <h1 class="screen-title">إنشاء فريق جديد</h1>
            <div class="form-group">
                <label for="team-name-input" class="form-label">اسم الفريق</label>
                <input id="team-name-input" type="text" class="input-field">
            </div>
            <div class="form-group">
                <label for="team-tag-input" class="form-label">شعار الفريق (Tag - من 3 إلى 5 حروف)</label>
                <input id="team-tag-input" type="text" class="input-field" maxlength="5" minlength="3">
            </div>
            <button data-action="submit-create-team" class="btn btn-primary">أنشئ الفريق</button>
            <button data-action="show-team-hub" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة</button>
        </div>
    </template>
    
    <template id="join-team-screen-template">
        <div style="max-width:400px; margin:auto; text-align:center">
            <h1 class="screen-title">الانضمام إلى فريق</h1>
            <p class="screen-subtitle">أدخل كود الفريق المكون من 6 حروف للانضمام.</p>
            <input id="team-id-input" type="text" class="input-field" placeholder="KOD" style="text-align:center; text-transform:uppercase; font-size:1.5rem; letter-spacing:5px">
            <button data-action="submit-join-team" class="btn btn-primary" style="margin-top:1rem">انضم الآن</button>
            <button data-action="show-team-hub" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة</button>
        </div>
    </template>

    <template id="leaderboard-screen-template">
        <h1 class="screen-title"><i class='bx bxs-trophy'></i> لوحة الصدارة</h1>
        <div class="pills-container">
            <button id="pills-individual" data-action="show-individual-leaderboard" class="btn pill-btn active"><i class='bx bxs-user'></i> فردي</button>
            <button id="pills-teams" data-action="show-teams-leaderboard" class="btn pill-btn"><i class='bx bxs-shield-alt-2'></i> فرق</button>
        </div>
        <div id="leaderboard-list" class="list-container"></div>
        <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
    </template>

    <!-- ✨ NEW: Achievements Template ✨ -->
    <template id="achievements-screen-template">
        <h1 class="screen-title"><i class='bx bxs-medal'></i> الإنجازات</h1>
        <p class="screen-subtitle">افتح الإنجازات لتحصل على نقاط إضافية وتثبت جدارتك.</p>
        <div id="achievements-list" class="list-container"></div>
        <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
    </template>
<template id="online-menu-screen-template">
    <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 400px; margin: 2rem auto;">
    <button data-action="create-vacancy-lobby" class="btn" style="background: linear-gradient(45deg, #ffd32a, #f97316); color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        <i class='bx bxs-crown'></i> من سيربح الفاكنسي
    </button>
        <h1 class="screen-title"><i class='bx bxs-group'></i> مباريات حرة</h1>
        <p class="screen-subtitle">اختر نوع المواجهة التي تريدها أو انضم إلى أصدقائك باستخدام كود.</p>
<div style="display: flex; flex-direction: column; gap: 1rem; max-width: 400px; margin: 2rem auto;">
                        <button data-action="start-conquest-match" id="conquest-match-btn" class="btn" style="background: linear-gradient(45deg, #ef4444, #f97316); color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);" disabled>
                <i class='bx bxs-flag-checkered'></i> مباراة احتلال
            </button>
            
                        <button data-action="create-massive-lobby" class="btn btn-primary" style="background-color: var(--accent-purple);">
                <i class='bx bxs-group'></i> منافسة حاشدة
            </button>
            <button data-action="create-1v1-lobby" class="btn btn-primary">
                <i class='bx bxs-swords'></i> مواجهة 1 ضد 1
            </button>
            <button data-action="show-join-lobby" class="btn" style="background-color: var(--bg-locked);">
                <i class='bx bx-log-in-circle'></i> الانضمام بكود
            </button>
            <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
        </div>

    </template>

    <template id="join-lobby-screen-template">
        <div style="max-width:400px; margin:auto; text-align:center">
            <h1 class="screen-title"><i class='bx bx-user-plus'></i> الانضمام لمنافسة</h1>
            <p class="screen-subtitle">أدخل كود المنافسة المكون من 4 حروف للانضمام.</p>
            <input id="lobby-code-input" type="text" class="input-field" placeholder="KOD" style="text-align: center; text-transform: uppercase; font-size:1.5rem; letter-spacing:5px; max-width: 200px; margin: auto;">
            <button data-action="submit-join-lobby" class="btn btn-primary" style="margin-top:1rem">انضم الآن</button>
            <button data-action="show-online-menu" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة</button>
         </div>
    </template>

    <template id="online-lobby-screen-template">
        <h1 id="lobby-title" class="screen-title">غرفة الانتظار</h1>
        <div class="lobby-code-container" style="padding: 1rem; background-color: rgba(0,0,0,0.2); border-radius: 0.75rem; text-align: center; margin-bottom: 1.5rem;">
            <p class="screen-subtitle" style="margin: 0 0 0.5rem 0;">شارك هذا الكود مع زملائك</p>
            <div id="lobby-code-display" style="font-size: 2.5rem; font-weight: 700; letter-spacing: 0.2em; color: var(--accent-cyan); user-select: all; cursor: pointer;" title="اضغط للنسخ"></div>
        </div>
        <h3 style="text-align:center;">اللاعبون المتواجدون</h3>
        <div id="lobby-players-list" class="list-container" style="max-height: 200px;"></div>
        <div id="lobby-status" style="font-size: 1.25rem; font-weight: 700; color: var(--accent-yellow); margin-top: 1.5rem; text-align: center; min-height: 2rem;">في انتظار اللاعبين...</div>
        <button id="start-game-btn" data-action="start-game" class="btn btn-primary" style="margin-top: 1.5rem;" disabled>ابدأ المباراة (للمضيف فقط)</button>
        <button data-action="leave-lobby" class="btn back-btn" style="background-color:var(--accent-red);"><i class='bx bx-exit'></i> الخروج من الغرفة</button>
    </template>

    <template id="game-over-screen-template">
    <h1 class="screen-title"><i class='bx bxs-flag-checkered'></i> انتهت المباراة!</h1>
    <div id="results-container" style="text-align: center;"></div>
    <h3 style="text-align:center; margin-top: 2rem;">النتائج النهائية</h3>
    <div id="results-list" class="list-container"></div>
    <button data-action="back-to-main" class="btn btn-primary" style="margin-top: 2rem;">العودة للقائمة الرئيسية</button>
</template>

<template id="island-conquest-screen-template">
    <h1 class="screen-title"><i class='bx bxs-map-alt'></i> احتلال الجزر</h1>
    <p class="screen-subtitle">سيطر مع فريقك على الجزر لجمع الموارد والفوز بجوائز الموسم!</p>
  <div class="map-container">
    <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0; z-index: 1;">
        <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#c2a98e" />
            </marker>
        </defs>
        <path d="M 50% 18% L 50% 48%" stroke="#c2a98e" stroke-width="2" fill="none" stroke-dasharray="5, 5" />
        <path d="M 21% 50% L 48% 50%" stroke="#c2a98e" stroke-width="2" fill="none" stroke-dasharray="5, 5" />
        <path d="M 79% 50% L 52% 50%" stroke="#c2a98e" stroke-width="2" fill="none" stroke-dasharray="5, 5" />
        <path d="M 33% 82% L 48% 53%" stroke="#c2a98e" stroke-width="2" fill="none" stroke-dasharray="5, 5" />
        <path d="M 67% 82% L 52% 53%" stroke="#c2a98e" stroke-width="2" fill="none" stroke-dasharray="5, 5" />
    </svg>
    </div>
    <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
</template>

<template id="chat-screen-template">
    <h1 class="screen-title"><i class='bx bxs-message-square-dots'></i> الدردشة العامة</h1>
    <p class="screen-subtitle">تواصل مع جميع اللاعبين في الوقت الفعلي.</p>
    
    <div id="chat-messages-container" class="list-container" style="height: 40vh; display: flex; flex-direction: column-reverse; overflow-y: auto;">
        </div>
    
    <form id="chat-form" style="display: flex; gap: 1rem; margin-top: 1.5rem;" onsubmit="return false;">
        <input id="chat-message-input" type="text" class="input-field" placeholder="اكتب رسالتك هنا..." style="flex-grow: 1;">
        <button data-action="send-chat-message" class="btn btn-primary" style="width: auto; padding: 0 1.5rem;"><i class='bx bxs-send'></i></button>
    </form>

    <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
</template>

<template id="team-browser-screen-template">
    <h1 class="screen-title"><i class='bx bxs-shield-alt-2'></i> قائمة فرق اللعبة</h1>
    <p class="screen-subtitle">تصفح الفرق المتاحة وقدم طلب انضمام للفريق الذي يناسبك.</p>
    <div id="team-browser-list" class="list-container"></div>
    <button data-action="show-team-hub" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة</button>
</template>
<template id="inbox-screen-template">
    <h1 class="screen-title"><i class='bx bxs-inbox'></i> صندوق الوارد</h1>
    <p class="screen-subtitle">هنا تجد آخر التنبيهات والرسائل الخاصة بك.</p>
    <div id="inbox-list" class="list-container"></div>
    <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
</template>
<template id="island-attack-screen-template">
    <h1 id="island-attack-title" class="screen-title"></h1>
    <p class="screen-subtitle">اختر كيف تريد المساهمة في احتلال هذه الجزيرة.</p>

    <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">

        <div class="card" data-action="start-solo-raid">
            <div class="card-icon"><i class='bx bxs-user-pin'></i></div>
            <h3 class="card-title">غارة فردية</h3>
            <p class="screen-subtitle" style="font-size: 0.9rem; margin: 0.5rem 0;">هاجم بمفردك لزيادة نفوذ فريقك. تحصل على نقاط خبرة ونقاط نفوذ بناءً على أدائك.</p>
        </div>

        <div class="card" data-action="start-conquest-match">
            <div class="card-icon"><i class='bx bxs-server'></i></div>
            <h3 class="card-title">مواجهة فرق</h3>
            <p class="screen-subtitle" style="font-size: 0.9rem; margin: 0.5rem 0;">ادخل في تحدٍ مباشر ضد فريق منافس. الفوز يمنح فريقك نقاط نفوذ ضخمة.</p>
        </div>

    </div>
    <button data-action="show-island-conquest" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للخريطة</button>
</template>

<template id="vacancy-match-screen-template">
    <div class="vacancy-game-layout">
        <div class="animation-overlay" id="animation-overlay">
        <i id="animation-icon" class="ability-animation-icon"></i>
    </div>
        <div id="vacancy-ladder-container" class="vacancy-ladder-container">
            </div>

        <div class="vacancy-main-content">
            <div id="turn-indicator" style="text-align: center; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 700;"></div>
            <div id="timer-container"><div id="timer-bar"></div></div>
            <h3 id="question-text" style="font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; min-height: 100px;"></h3>
            <div id="options-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;"></div>
            <div id="explanation-box" style="display: none;"></div>

            <div id="player-abilities-container" class="player-abilities-container">
                </div>

            <button data-action="leave-lobby" class="btn back-btn" style="background-color:var(--accent-red);"><i class='bx bx-exit'></i> مغادرة المباراة</button>
        </div>
    </div>
</template>

<template id="swap-finder-screen-template">
    <h1 class="screen-title"><i class='bx bx-transfer-alt'></i> سوابك عندي</h1>
    <p class="screen-subtitle">تصفح طلبات تبديل الشيفتات المتاحة حالياً أو قم بعرض طلبك الخاص.</p>

    <button data-action="show-select-swap-type" class="btn btn-primary" style="margin-bottom: 2rem;">
        <i class='bx bx-plus-circle'></i> عرض طلب سواب جديد (التكلفة: 25 عملة)
    </button>

    <div id="swap-list-container" class="list-container" style="max-height: 50vh;">
        <p style="text-align:center; color: var(--text-secondary);">لا توجد طلبات متاحة حالياً.</p>
    </div>

    <button data-action="back-to-main" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للقائمة</button>
</template>

<template id="select-swap-type-screen-template">
    <h1 class="screen-title"><i class='bx bx-git-compare'></i> اختر نوع المبادلة</h1>
    <p class="screen-subtitle">هل تريد تبديل يوم إجازة أم شيفت عمل؟</p>
    <div class="grid-container" style="grid-template-columns: 1fr 1fr;">

        <div class="card" data-action="show-create-off-swap">
            <div class="card-icon" style="color: var(--accent-green);"><i class='bx bx-calendar-off'></i></div>
            <h3 class="card-title">تبديل يوم إجازة</h3>
            <p class="screen-subtitle" style="font-size: 0.9rem;">عرض يوم إجازتك مقابل يوم آخر.</p>
        </div>

        <div class="card" data-action="show-create-shift-swap">
            <div class="card-icon" style="color: var(--accent-blue);"><i class='bx bx-time'></i></div>
            <h3 class="card-title">تبديل شيفت عمل</h3>
            <p class="screen-subtitle" style="font-size: 0.9rem;">عرض شيفت معين في يوم معين مقابل شيفت آخر.</p>
        </div>

    </div>
    <button data-action="show-swap-finder" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة للسوق</button>
</template>

<template id="create-off-swap-screen-template">
    <h1 class="screen-title"><i class='bx bx-calendar-off'></i> طلب تبديل إجازة</h1>
    <p class="screen-subtitle">سيتم عرض طلبك لمدة 24 ساعة بتكلفة 25 عملة.</p>

    <div class="form-group">
        <label class="form-label">يوم إجازتي هو:</label>
        <input id="off-have-day" type="text" class="input-field" placeholder="مثال: يوم الأحد">
    </div>

    <div class="form-group">
        <label class="form-label">أرغب في إجازة يوم:</label>
        <input id="off-want-day" type="text" class="input-field" placeholder="مثال: يوم الخميس">
    </div>

    <div class="form-group">
        <label class="form-label">الشيفت المطلوب (اختياري):</label>
        <input id="off-want-shift-optional" type="text" class="input-field" placeholder="مثال: شيفت صباحي، مسائي، أو اتركه فارغاً">
    </div>

    <div class="form-group">
        <label class="form-label">رقم الموبايل للتواصل (اختياري):</label>
        <input id="off-poster-phone" type="tel" class="input-field" placeholder="لن يظهر إلا عند حدوث توافق">
    </div>

    <button data-action="post-off-swap" class="btn btn-primary"><i class='bx bxs-send'></i> نشر الطلب</button>
    <button data-action="show-select-swap-type" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة</button>
</template>

<template id="create-shift-swap-screen-template">
    <h1 class="screen-title"><i class='bx bx-time'></i> طلب تبديل شيفت</h1>
    <p class="screen-subtitle">سيتم عرض طلبك لمدة 24 ساعة بتكلفة 25 عملة.</p>

     <div class="form-group">
        <label class="form-label">تاريخ الشيفت الذي أملكه:</label>
        <input id="shift-have-date" type="text" class="input-field" placeholder="مثال: 15/07/2025">
    </div>

    <div class="form-group">
        <label class="form-label">وقت الشيفت الذي أملكه:</label>
        <input id="shift-have-time" type="text" class="input-field" placeholder="مثال: 7 مساءً">
    </div>

    <div class="form-group">
        <label class="form-label">وقت الشيفت الذي أريده (في نفس اليوم):</label>
        <input id="shift-want-time" type="text" class="input-field" placeholder="مثال: 9 صباحاً">
    </div>

    <div class="form-group">
        <label class="form-label">رقم الموبايل للتواصل (اختياري):</label>
        <input id="shift-poster-phone" type="tel" class="input-field" placeholder="لن يظهر إلا عند حدوث توافق">
    </div>

    <button data-action="post-shift-swap" class="btn btn-primary"><i class='bx bxs-send'></i> نشر الطلب</button>
    <button data-action="show-select-swap-type" class="btn back-btn"><i class='bx bx-arrow-back'></i> العودة</button>
</template>


    <!-- =================================
       ✨ JavaScript - الجزء السابع (Achievements) ✨
       ================================= -->
<script type="module">
    window.testMessage = "مرحباً من داخل لعبتي!";
        // --- استيراد دوال Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, serverTimestamp, runTransaction, updateDoc, arrayUnion, increment, collection, query, where, getDocs, writeBatch, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // --- إعدادات Firebase ---
        const firebaseConfig = { apiKey: "AIzaSyAvGDEbWA3UumCa0P4AfFUVv6xxwL5Porc", authDomain: "nc1-eagles-race.firebaseapp.com", projectId: "nc1-eagles-race", storageBucket: "nc1-eagles-race.appspot.com", messagingSenderId: "772415266484", appId: "1:772415266484:web:5813cb3355f7298ade81e1" };

        // --- تهيئة خدمات Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- عقل اللعبة (GAME_CONFIG) ---
  const GAME_CONFIG = {
    musicPlaylist: [ 
        'https://v15mbanna3.github.io/my-sounds/Gna7%20felsama.mp3',
        'https://v15mbanna3.github.io/my-sounds/Nocturne.mp3',
        'https://v15mbanna3.github.io/my-sounds/Sadness-and-Sorrow.mp3'
    ],
    questionBanks: {
        singlePlayer: [
            { id: 'sp_1', question: "ما هو أول إجراء يجب اتخاذه عند استلام شكوى من العميل؟", options: {"1": "الاعتذار", "2": "الاستماع الجيد", "3": "تقديم حل فوري", "4": "توثيق الشكوى"}, correct_answer: "2" },
            { id: 'sp_2', question: "ماذا يعني اختصار 'SLA'؟", options: {"1": "Service Level Agreement", "2": "Sales Lead Account", "3": "Service Line Access", "4": "System Logic Area"}, correct_answer: "1" }
        ],
          online_freeplay: [
            { id: 'on_3', question: "لو العميل علي نظام we business prepaid بيتصل و بيشتكي إنه معاه ميجا بايت ووحدات و بيشتكي إنه بيخصم من الوحدات، ماذا يجب على الموظف أن يفعل؟", options: {"1": "يجب على الموظف أن يبلغ العميل أنه سيقوم باستبدال الميجابايتس الخاصة به لوحدات", "2": "يجب على الموظف إزالة الباقة وإضافة الوحدات المطلوبة وإبلاغ العميل بالإجراء المتخذ", "3": "يجب على الموظف إبلاغ العميل في حالة تكرار المشكلة بالرجوع إلينا", "4": "جميع ما سبق"}, correct_answer: "4" },
            { id: 'on_4', question: "يمكن للعميل شراء أكثر من شريحة E-sim، فما هو الحد الأقصى؟", options: {"1": "5 خطوط للمصريين، 10 للأجانب", "2": "10 خطوط للأجانب، 7 للمصريين", "3": "10 خطوط للمصريين، 5 للأجانب", "4": "5 خطوط للمصريين، 5 للأجانب"}, correct_answer: "3" },
            { id: 'on_5', question: "لو عميل خطه هو الـ Owner ويريد معرفة اسم المفوض ويتصل من رقم مختلف ليس تحت نفس الحساب، ما هو الإجراء الصحيح؟", options: {"1": "Full verification", "2": "Simple verification", "3": "Not allowed", "4": "No verification"}, correct_answer: "3" },
            { id: 'on_6', question: "لو العميل شحن online من تطبيق My WE والشحن لم يظهر، كم المدة التي يجب أن ينتظرها قبل عمل شكوى؟", options: {"1": "24 ساعة", "2": "ساعة واحدة", "3": "24 يوم عمل", "4": "30 دقيقة"}, correct_answer: "2" },
            { id: 'on_7', question: "ما هو الحد الأدنى للعميل لتحويل الرصيد؟", options: {"1": "100 جنيه", "2": "5 جنيهات", "3": "10 جنيهات", "4": "25 جنيهاً"}, correct_answer: "4" },
            { id: 'on_8', question: "لو عميل خطه عليه إيقاف 'remove from corporate'، ما الإجراءات اللازمة لتشغيل الخط؟", options: {"1": "يذهب للفرع بالبطاقة وخطاب تنازل ممضي من المفوض", "2": "يذهب للفرع بخطاب ممضي من المفوض فقط", "3": "يرجع للمفوض", "4": "يقدم طلب تنازل ملكية"}, correct_answer: "1" },
            { id: 'on_9', question: "كم سعر خدمة MCN (Missed Call Notification) لخطوط الـ Open؟", options: {"1": "10 جنيهات", "2": "5 جنيهات", "3": "مجانية", "4": "20 جنيهاً"}, correct_answer: "3" },
            { id: 'on_10', question: "لو عميل corporate طلب إلغاء الخط، ماذا يفعل؟", options: {"1": "يذهب للفرع ومعه بطاقة سارية", "2": "يرجع للمفوض", "3": "يتم عمل تيكت من خلال خدمة العملاء", "4": "من خلال التطبيق"}, correct_answer: "2" },
            { id: 'on_11', question: "لو العميل شحن بالخطأ على خط Open ويريد تحويل الرصيد إلى ميجابايتس، ما هو الإجراء الصحيح؟", options: {"1": "نتأكد أنه لم يستخدم منه ونعمل ICTI فيها كل التفاصيل ثم نأخذ الإجراء على BSS", "2": "نعمل ICTI فيها كل التفاصيل ونأخذ الإجراء على BSS", "3": "نتأكد من أنه لم يستخدم ونأخذ الإجراء ثم نعمل ICTI", "4": "نبعت ميل للسوبرفايزر من غير أي إجراء"}, correct_answer: "1" },
            { id: 'on_12', question: "لو عميل على باقة WE Business Value 70 ويريد الترقية إلى WE Business Value 300، ماذا نقول له؟", options: {"1": "يمكن الترقية من خلالي (خدمة العملاء)", "2": "من خلال الفروع", "3": "من خلال التطبيق", "4": "يرجع للمفوض"}, correct_answer: "4" },
            { id: 'on_13', question: "ما هو الحد الأقصى لشراء الخطوط للـ Enterprise User بالنسبة للمواطن الأجنبي؟", options: {"1": "10 خطوط صوت و 5 خطوط داتا", "2": "5 خطوط صوت و 5 خطوط داتا", "3": "10 خطوط صوت و 10 خطوط داتا", "4": "5 خطوط صوت و 10 خطوط داتا"}, correct_answer: "2" },
            { id: 'on_14', question: "لو العميل اتصل من رقم تحت الحساب ويحتاج معرفة الأرقام التي كلمها هذا الشهر على رقم Business آخر، ما هو الإجراء؟", options: {"1": "Full verification ونعطيه الأرقام", "2": "Simple verification", "3": "No verification", "4": "Not allowed"}, correct_answer: "4" },
            { id: 'on_15', question: "لو العميل يسألنا على سعر الخط، ماذا تكون الإجابة؟", options: {"1": "يرجع للمفوض الخاص بالشركة", "2": "60 جنيه غير شامل الضريبة", "3": "سعر الخط مجاني", "4": "50 قرش غير شامل الضريبة"}, correct_answer: "1" },
            { id: 'on_16', question: "لو مفوض يتصل من رقم التفويض (وهو رقم WE) على 522، ماذا نفعل؟", options: {"1": "نعمل تيكت SPOC not flagged", "2": "نعمل تيكت follow up CAM team", "3": "نعمل ICTI direct to CAM team", "4": "نجعل المفوض يتصل على 01551555222"}, correct_answer: "2" },
            { id: 'on_17', question: "لو عميل اتصل يسأل على خدمة WE Pay، ماذا أفعل؟", options: {"1": "أقول له يقفل ويكلم 500", "2": "أحول العميل لقسم WE Pay", "3": "أقول له يقفل ويكلم 565", "4": "أقول له يقفل ويكلم 111"}, correct_answer: "2" },
            { id: 'on_18', question: "لو عميل WE Air Business النت لا يعمل لديه، ما هو الإجراء الصحيح؟", options: {"1": "يرجع للمفوض", "2": "أعمل TT can't connect", "3": "يرجع للفرع لفحص الجهاز", "4": "أتأكد من Home zone والباقة، ثم أتبع كل خطوات الـ troubleshooting"}, correct_answer: "4" },
            { id: 'on_19', question: "لو عميل يبعت رسائل واتصل يسأل عن الـ SMS limit، ما هو الحد؟", options: {"1": "متاح عدد غير محدود من الرسائل", "2": "200 رسالة لأرقام WE و 150 رسالة خارج الشبكة شهرياً", "3": "500 رسالة لأرقام WE و 150 رسالة خارج الشبكة شهرياً", "4": "500 رسالة لأرقام WE و 500 رسالة خارج الشبكة شهرياً"}, correct_answer: "3" },
            { id: 'on_20', question: "لو عميل على باقة M2M shared data bundle ويريد معرفة استهلاكه، ماذا يفعل؟", options: {"1": "من خلال تطبيق My WE", "2": "من خلال USSD", "3": "يرجع للمفوض", "4": "من خلال خدمة العملاء"}, correct_answer: "3" },
            { id: 'on_21', question: "لو عميل متصل من رقم 010 ويسأل على رقم prepaid، ماذا نفعل؟", options: {"1": "نحول المكالمة للـ prepaid", "2": "نحوله على الـ Main IVR", "3": "نسأل العميل كيف وصل إلينا، ونقول له يتصل على الرقم الصحيح للوصول للأفراد", "4": "نجعله يكلم 01551555222"}, correct_answer: "3" },
            { id: 'on_22', question: "ما هي أول خطوة في troubleshooting خدمة الـ roaming؟", options: {"1": "Check Sim serial", "2": "Check roaming services activated or not", "3": "Check if customer has enough balance", "4": "Check Sim registration on UMNS profile"}, correct_answer: "4" }
        ],
        islands: {
            tech_island: [{ id: 't_1', question: "ما هو البروتوكول المستخدم لإعطاء IP للأجهزة تلقائياً؟", options: {"1": "HTTP", "2": "FTP", "3": "DHCP", "4": "SMTP"}, correct_answer: "3" }],
            nontech_island: [{ id: 'nt_1', question: "ما هي المدة القياسية للرد على طلب فاتورة إلكترونية؟", options: {"1": "24 ساعة", "2": "48 ساعة", "3": "72 ساعة", "4": "5 أيام عمل"}, correct_answer: "2" }],
            quality_fort: [{ id: 'q_1', question: "ما هو الهدف من مكالمة المتابعة بعد حل الشكوى؟", options: {"1": "بيع خدمة جديدة", "2": "التأكد من رضا العميل التام", "3": "تحديث البيانات", "4": "إغلاق الشكوى فقط"}, correct_answer: "2" }],
            faulty_valley: [{ id: 'f_1', question: "لمبة DSL على الراوتر تومض باستمرار، ماذا يعني ذلك غالبًا؟", options: {"1": "مشكلة في كلمة سر الواي فاي", "2": "مشكلة في التزامن مع السنترال", "3": "الراوتر يحتاج تحديث", "4": "لا يوجد رصيد"}, correct_answer: "2" }],
            briefings_archipelago: [{ id: 'b_1', question: "حسب آخر تحديث، ما هي الباقة الإضافية الجديدة التي تم إطلاقها؟", options: {"1": "Nitro", "2": "Turbo", "3": "Gamerz", "4": "Plus"}, correct_answer: "1" }],
            citadel: [{ id: 'c_1', question: "من هو قائد فريق NC1 Eagles؟", options: {"1": "Botros", "2": "Peter", "3": "Mina", "4": "George"}, correct_answer: "1" }]
        },
      vacancy_questions: [
    // Level 1 Questions
    { id: 'vac_1', question: "ما هو الإجراء الأول عند بدء مكالمة مع عميل؟", options: {"1": "سؤاله عن اسمه", "2": "التحية والتعريف بنفسك", "3": "طلب رقم الحساب", "4": "سؤاله عن مشكلته"}, correct_answer: "2", level: 1 },
    { id: 'vac_2', question: "لو العميل شحن online من تطبيق My WE والشحن لم يظهر، كم المدة التي يجب أن ينتظرها قبل عمل شكوى؟", options: {"1": "24 ساعة", "2": "ساعة واحدة", "3": "24 يوم عمل", "4": "30 دقيقة"}, correct_answer: "2", level: 1 },
    { id: 'vac_3', question: "ما هو الحد الأدنى للعميل لتحويل الرصيد؟", options: {"1": "100 جنيه", "2": "5 جنيهات", "3": "10 جنيهات", "4": "25 جنيهاً"}, correct_answer: "4", level: 1 },
    { id: 'vac_4', question: "كم سعر خدمة MCN (Missed Call Notification) لخطوط الـ Open؟", options: {"1": "10 جنيهات", "2": "5 جنيهات", "3": "مجانية", "4": "20 جنيهاً"}, correct_answer: "3", level: 1 },
    { id: 'vac_22', question: "ما هو رقم الجروب الذي يمكن من خلاله إزالة الإيقاف لأي رقم تحته بعد استبدال الشريحة؟", options: {"1": "20199548156811521", "2": "20199101003411809", "3": "20196564543470056", "4": "20145455485411759"}, correct_answer: "2", level: 1 },
    { id: 'vac_23', question: "عميل معه خط جديد على نظام (WE Business Prepaid) لمدة 5 أيام والباقة suspend، ما هو الإجراء الصحيح لتجديد الباقة؟", options: {"1": "يرجع للمفوض", "2": "يشحن بثمن الباقة وستتجدد تلقائياً", "3": "يجددها من خلال تطبيق MY WE", "4": "نعمل شكوى renewal issue"}, correct_answer: "4", level: 1 },
    { id: 'vac_35', question: "هل يمكن استخدام خدمة سلفني على نظام WE Business Prepaid 25 ؟", options: {"1": "True", "2": "False"}, correct_answer: "1", level: 1 },


    // Level 2 Questions
    { id: 'vac_5', question: "لو العميل يسألنا على سعر الخط، ماذا تكون الإجابة؟", options: {"1": "يرجع للمفوض الخاص بالشركة", "2": "60 جنيه غير شامل الضريبة", "3": "سعر الخط مجاني", "4": "50 قرش غير شامل الضريبة"}, correct_answer: "1", level: 2 },
    { id: 'vac_6', question: "لو عميل اتصل يسأل على خدمة WE Pay، ماذا أفعل؟", options: {"1": "أقول له يقفل ويكلم 500", "2": "أحول العميل لقسم WE Pay", "3": "أقول له يقفل ويكلم 565", "4": "أقول له يقفل ويكلم 111"}, correct_answer: "2", level: 2 },
    { id: 'vac_7', question: "لو عميل متصل من رقم 010 ويسأل على رقم prepaid، ماذا نفعل؟", options: {"1": "نحول المكالمة للـ prepaid", "2": "نحوله على الـ Main IVR", "3": "نسأل العميل كيف وصل إلينا، ونقول له يتصل على الرقم الصحيح للوصول للأفراد", "4": "نجعله يكلم 01551555222"}, correct_answer: "3", level: 2 },
    { id: 'vac_8', question: "ما هي أول خطوة في troubleshooting خدمة الـ roaming؟", options: {"1": "Check Sim serial", "2": "Check roaming services activated or not", "3": "Check if customer has enough balance", "4": "Check Sim registration on UMNS profile"}, correct_answer: "4", level: 2 },
    { id: 'vac_24', question: "عميل على نظام كنترول تظبيط 40 ويريد تجديد الباقة، ما هو الاجراء الصحيح؟", options: {"1": "الرجوع للمفوض", "2": "يتم الشحن بثمن الباقة وتتجدد من خلالنا", "3": "توجيهه بالاتصال بخدمة عملاء الأفراد 111", "4": "يشحن الباقة ويجددها من خلال التطبيق أو الكود"}, correct_answer: "2", level: 2 },
    { id: 'vac_25', question: "عميل على نظام WE Club يتصل من نفس الرقم ويريد معرفة هل باقته خلصت أم لا؟", options: {"1": "يتصل بخدمة عملاء الأفراد 111", "2": "يرجع للمفوض", "3": "نرى استهلاكه ونخبره بشكل عادي", "4": "لا يمكن إخباره لأن الخط بدون اسم"}, correct_answer: "3", level: 2 },
    { id: 'vac_34', question: "ما هي خطوات تغيير بيانات الخط بإسم العميل؟", options: {"1": "إنشاء طلب بتغيير البيانات مدته يومين عمل", "2": "الرجوع للمفوض", "3": "لا يمكن تغيير البيانات لأنه تابع لنظام الشركات", "4": "يمكن التغيير من خلال الفرع"}, correct_answer: "2", level: 2 },


    // Level 3 Questions
    { id: 'vac_9', question: "لو عميل corporate طلب إلغاء الخط، ماذا يفعل؟", options: {"1": "يذهب للفرع ومعه بطاقة سارية", "2": "يرجع للمفوض", "3": "يتم عمل تيكت من خلال خدمة العملاء", "4": "من خلال التطبيق"}, correct_answer: "2", level: 3 },
    { id: 'vac_10', question: "لو عميل يبعت رسائل واتصل يسأل عن الـ SMS limit، ما هو الحد؟", options: {"1": "متاح عدد غير محدود من الرسائل", "2": "200 رسالة لأرقام WE و 150 رسالة خارج الشبكة شهرياً", "3": "500 رسالة لأرقام WE و 150 رسالة خارج الشبكة شهرياً", "4": "500 رسالة لأرقام WE و 500 رسالة خارج الشبكة شهرياً"}, correct_answer: "3", level: 3 },
    { id: 'vac_11', question: "لو عميل على باقة M2M shared data bundle ويريد معرفة استهلاكه، ماذا يفعل؟", options: {"1": "من خلال تطبيق My WE", "2": "من خلال USSD", "3": "يرجع للمفوض", "4": "من خلال خدمة العملاء"}, correct_answer: "3", level: 3 },
    { id: 'vac_12', question: "لو عميل WE Air Business النت لا يعمل لديه، ما هو الإجراء الصحيح؟", options: {"1": "يرجع للمفوض", "2": "أعمل TT can't connect", "3": "يرجع للفرع لفحص الجهاز", "4": "أتأكد من Home zone والباقة، ثم أتبع كل خطوات الـ troubleshooting"}, correct_answer: "4", level: 3 },
    { id: 'vac_28', question: "عميل موجود في فلسطين وخدمة الرومينج لا تعمل معه، ما هو الاجراء الصحيح؟", options: {"1": "نتحقق من تفعيل الخدمة على UNMS", "2": "نتبع معه خطوات الـ Troubleshooting العادية", "3": "نخبره أن الخدمة غير متوفرة", "4": "نتحقق من الـ sim serial أولاً"}, correct_answer: "3", level: 3 },
    { id: 'vac_29', question: "هل يمكن للعميل الاشتراك في باقات انترنت التجوال في السعودية من خلال الكود؟", options: {"1": "True", "2": "False"}, correct_answer: "2", level: 3 },
    { id: 'vac_30', question: "هل خدمة الرومينج متاحة على أجهزة الـ MIFI خارج مصر؟", options: {"1": "True", "2": "False"}, correct_answer: "1", level: 3 },
    
    // Level 4 Questions
    { id: 'vac_13', question: "لو عميل خطه هو الـ Owner ويريد معرفة اسم المفوض ويتصل من رقم مختلف ليس تحت نفس الحساب، ما هو الإجراء الصحيح؟", options: {"1": "Full verification", "2": "Simple verification", "3": "Not allowed", "4": "No verification"}, correct_answer: "3", level: 4 },
    { id: 'vac_14', question: "لو العميل شحن بالخطأ على خط Open ويريد تحويل الرصيد إلى ميجابايتس، ما هو الإجراء الصحيح؟", options: {"1": "نتأكد أنه لم يستخدم منه ونعمل ICTI فيها كل التفاصيل ثم نأخذ الإجراء على BSS", "2": "نعمل ICTI فيها كل التفاصيل ونأخذ الإجراء على BSS", "3": "نتأكد من أنه لم يستخدم ونأخذ الإجراء ثم نعمل ICTI", "4": "نبعت ميل للسوبرفايزر من غير أي إجراء"}, correct_answer: "1", level: 4 },
    { id: 'vac_15', question: "لو عميل على باقة WE Business Value 70 ويريد الترقية إلى WE Business Value 300، ماذا نقول له؟", options: {"1": "يمكن الترقية من خلالي (خدمة العملاء)", "2": "من خلال الفروع", "3": "من خلال التطبيق", "4": "يرجع للمفوض"}, correct_answer: "4", level: 4 },
    { id: 'vac_16', question: "لو العميل اتصل من رقم تحت الحساب ويحتاج معرفة الأرقام التي كلمها هذا الشهر على رقم Business آخر، ما هو الإجراء؟", options: {"1": "Full verification ونعطيه الأرقام", "2": "Simple verification", "3": "No verification", "4": "Not allowed"}, correct_answer: "4", level: 4 },
    { id: 'vac_26', question: "عميل لديه مشكلة incoming calls issue، ما هو الاجراء الصحيح لحل مشكلته؟", options: {"1": "نتبع معه الـ Troubleshooting العادية", "2": "نصعّد شكوى مباشرة لأنه no name", "3": "يذهب للفرع لاستبدال الشريحة", "4": "يرجع للمفوض لإلغاء خدمة إيقاف المكالمات"}, correct_answer: "4", level: 4 },
    { id: 'vac_27', question: "خدمة الرومينج لا تعمل على رقم ينتمي لهذا Sim Serial: 89204111172952848587. ما هو الاجراء الصحيح؟", options: {"1": "يعمل استبدال شريحة", "2": "يرجع للمفوض", "3": "نتبع معه الـ Troubleshooting العادية", "4": "نصعّد شكوى للقسم المختص"}, correct_answer: "1", level: 4 },
    { id: 'vac_31', question: "تكلفة مكالمة خدمة العملاء في التجوال لنظام الـ Open بـ 5 جنيهات بصرف النظر عن سعر التجوال لكل بلد؟", options: {"1": "True", "2": "False"}, correct_answer: "2", level: 4 },


    // Level 5 Questions
    { id: 'vac_17', question: "لو عميل خطه عليه إيقاف 'remove from corporate'، ما الإجراءات اللازمة لتشغيل الخط؟", options: {"1": "يذهب للفرع بالبطاقة وخطاب تنازل ممضي من المفوض", "2": "يذهب للفرع بخطاب ممضي من المفوض فقط", "3": "يرجع للمفوض", "4": "يقدم طلب تنازل ملكية"}, correct_answer: "1", level: 5 },
    { id: 'vac_18', question: "يمكن للعميل شراء أكثر من شريحة E-sim، فما هو الحد الأقصى؟", options: {"1": "5 خطوط للمصريين، 10 للأجانب", "2": "10 خطوط للأجانب، 7 للمصريين", "3": "10 خطوط للمصريين، 5 للأجانب", "4": "5 خطوط للمصريين، 5 للأجانب"}, correct_answer: "3", level: 5 },
    { id: 'vac_19', question: "ما هو الحد الأقصى لشراء الخطوط للـ Enterprise User بالنسبة للمواطن الأجنبي؟", options: {"1": "10 خطوط صوت و 5 خطوط داتا", "2": "5 خطوط صوت و 5 خطوط داتا", "3": "10 خطوط صوت و 10 خطوط داتا", "4": "5 خطوط صوت و 10 خطوط داتا"}, correct_answer: "2", level: 5 },
    { id: 'vac_20', question: "لو مفوض يتصل من رقم التفويض (وهو رقم WE) على 522، ماذا نفعل؟", options: {"1": "نعمل تيكت SPOC not flagged", "2": "نعمل تيكت follow up CAM team", "3": "نعمل ICTI direct to CAM team", "4": "نجعل المفوض يتصل على 01551555222"}, correct_answer: "2", level: 5 },
    { id: 'vac_21', question: "لو العميل علي نظام we business prepaid بيتصل و بيشتكي إنه معاه ميجا بايت ووحدات و بيشتكي إنه بيخصم من الوحدات، ماذا يجب على الموظف أن يفعل؟", options: {"1": "يبلغ العميل أنه سيقوم باستبدال الميجابايتس لوحدات", "2": "يزيل الباقة ويضيف الوحدات المطلوبة", "3": "يبلغ العميل بالرجوع في حالة تكرار المشكلة", "4": "جميع ما سبق"}, correct_answer: "4", level: 5 },
    { id: 'vac_32', question: "في شكوى من عدم ترحيل الجيجا بايت غير المستخدمة على نظام (WE Business Value 680)، ما هو الاجراء الصحيح؟", options: {"1": "يرجع للمفوض", "2": "مراجعة الاستهلاك من CDR وإنشاء شكوى", "3": "يتم إبلاغه بعدم ترحيل الجزء غير المستخدم للشهر التالي", "4": "يتم تعويضه يدوياً من BSS"}, correct_answer: "3", level: 5 },
    { id: 'vac_33', question: "تكلفة باقة We Business Value 450 المفعلة على خصم 50% للموظفين هي 225 جنيه شامل ضريبة القيمة المضافة؟", options: {"1": "True", "2": "False"}, correct_answer: "2", level: 5 },
    { id: 'vac_36', question: "ما هو الاجراء الصحيح لشحن رصيد على نظام الـ Open عن طريق الخطأ؟", options: {"1": "تحويل الرصيد لرقم كارت أو شركات كنترول", "2": "تحويل الرصيد لميجا بايت", "3": "استرداد الرصيد كاش من الفرع", "4": "جميع ما سبق"}, correct_answer: "4", level: 5 },
    { id: 'vac_37', question: "ما هو الاجراء الصحيح في حالة إصرار العميل على معرفة المبلغ المتبقي في الـ Payment Relation؟", options: {"1": "الرجوع للمدير لطلب استثناء", "2": "إخباره بالمبلغ الموجود", "3": "لا يمكن الإفصاح عن المبلغ", "4": "الرجوع للمفوض"}, correct_answer: "2", level: 5 },
    { id: 'vac_38', question: "ما هو الاجراء الصحيح لعميل تحت جروب (TEData & Xceed) يريد إضافة باقة إضافية بدون شحن رصيد؟", options: {"1": "لو فيه رصيد كافي في الـ Payment Relation نشترك له في الباقة", "2": "إخباره بشحن رصيد أولاً", "3": "عمل طلب لإضافة الباقة مدته 24 ساعة", "4": "إخباره أنه لا يمكن الاشتراك"}, correct_answer: "1", level: 5 },
],
trick_questions: [
    { id: 'trick_1', question: "إذا كان القطار يسير بسرعة 80 كم/ساعة والرياح شمالية، إلى أي اتجاه يتجه دخانه؟", options: {"1": "شمال", "2": "جنوب", "3": "عكس اتجاه القطار", "4": "القطار كهربائي لا دخان له"}, correct_answer: "4" },
    { id: 'trick_2', question: "ما هو الشيء الذي له عين واحدة ولكنه لا يرى؟", options: {"1": "الأعور", "2": "الإبرة", "3": "الكاميرا", "4": "السمكة"}, correct_answer: "2" },
    { id: 'trick_3', question: "رجل خرج في المطر الغزير بدون قبعة أو مظلة، ومع ذلك لم تبتل شعرة واحدة من رأسه. لماذا؟", options: {"1": "كان يرتدي معطفًا مقاومًا للماء", "2": "كان يركض بسرعة كبيرة", "3": "كان أصلعًا", "4": "اختبأ تحت شجرة"}, correct_answer: "3" },
    { id: 'trick_4', question: "سيناريو: عميل يتصل لأن جهاز Mi-Fi الخاص به متصل بالشبكة ولكن لا يوجد إنترنت، وعند فحص الإعدادات تبين أنه لا يسحب عنوان IP. ما هو الإجراء الصحيح؟", options: {"1": "إعادة تشغيل الجهاز والاتصال مرة أخرى.", "2": "الدخول لصفحة الإعدادات وعمل Disable ثم Enable لخاصية الـ DHCP.", "3": "تحديث برنامج التشغيل (Firmware) الخاص بالجهاز.", "4": "إنشاء شكوى مشكلة (Problem TT) على الفور."}, correct_answer: "2", explanation: "عندما يواجه جهاز الماي فاي مشكلة في الحصول على عنوان IP، فإن الخطوة الأولى الصحيحة هي إعادة تنشيط بروتوكول DHCP، مما يجبر الجهاز على طلب عنوان IP جديد من الشبكة." },
    { id: 'trick_5', question: "سيناريو: عميل يتصل لأنه استلم رسالة نصية بعرض 5G، ولكن عند محاولة الاشتراك اكتشف أن العرض منتهي الصلاحية. ما هو تصنيف الشكوى الصحيح؟", options: {"1": "Complaint / Corporate End user / Services / Wrong Content", "2": "Problem / Corporate End user / Services / 5G", "3": "Problem / Corporate End user / Services / General والـ Summary يكون Wrong Content", "4": "Inquiry / Corporate End user / Offers / Eligibility"}, correct_answer: "3", explanation: "طالما أن المشكلة في المحتوى الخاطئ للرسالة وليس في خدمة الـ 5G نفسها، فإن الإجراء الصحيح هو إنشاء شكوى مشكلة عامة مع توضيح المحتوى الخاطئ في الملخص." },
    { id: 'trick_6', question: "سيناريو: عميل لديه خط Control ويريد إضافة باقة إنترنت، لكنه يشتكي من خصم ضريبة دمغة مرة أخرى عند تجديد الباقة الإضافية في نفس الشهر. ما هو الإجراء الصحيح؟", options: {"1": "إبلاغ العميل أن هذا إجراء طبيعي.", "2": "إنشاء شكوى Problem / Corporate End user / Billing / Wrong Charges.", "3": "تعويض العميل بقيمة ضريبة الدمغة المكررة بعد التحقق.", "4": "إبلاغ العميل بالرجوع إلى المفوض (SPOC)."}, correct_answer: "3", explanation: "لا يجب تحميل العميل ضريبة الدمغة مرتين في نفس الشهر. في حالة حدوث ذلك، يجب على الموظف التحقق ورد المبلغ المخصوم بالخطأ إلى رصيد العميل." },
    { id: 'trick_7', question: "سيناريو: عميل خطه تم إيقافه (Suspended) بسبب انتهاء صلاحية الإقامة (الفيزا). ما هو الإجراء الصحيح الذي يجب على الموظف اتخاذه؟", options: {"1": "إبلاغ العميل بضرورة زيارة أقرب فرع.", "2": "رفع طلب Request / Corporate End user / Activation / Renew Expired Visa.", "3": "تحويل المكالمة مباشرة إلى قسم الـ CAM.", "4": "إبلاغ العميل أن هذه مشكلة من جانب المفوض (SPOC)."}, correct_answer: "2", explanation: "تم تحديد مسار طلب واضح لتسهيل الإجراءات على العميل، حيث يقوم الموظف برفع طلب بهذا التصنيف المحدد ليصل مباشرة للفريق المسؤول." },
    { id: 'trick_8', question: "سيناريو: عميل لديه باقة كنترول ويريد تفعيل خدمة الانتظار (Call Waiting)، ولكن الخدمة لا تعمل. ما هو الإجراء الصحيح؟", options: {"1": "إبلاغ العميل أن خدمة الانتظار غير متاحة لخطوط الكنترول.", "2": "إنشاء شكوى Problem / Corporate End user / Services / Call Waiting.", "3": "إرشاد العميل لتفعيل الخدمة من إعدادات الهاتف.", "4": "إبلاغ العميل أن الخدمة تتطلب تفعيلها من خلال المفوض (SPOC)."}, correct_answer: "1", explanation: "خدمة انتظار المكالمات غير متاحة بشكل قياسي لباقات الكنترول الخاصة بالشركات، لذا يجب إبلاغ العميل بذلك بوضوح." },
    { id: 'trick_9', question: "خدمة Wifi Calling لا تعمل مع العميل، ما هو الإجراء الصحيح؟", options: {"1": "نرجعه للمفوض لعمل طلب لتشغيل الخدمة", "2": "نعمل شكوى مدتها 3WD", "3": "نتحقق إذا كان موبايله يدعم الخدمة أم لا", "4": "يجب أن يكون شاحن رصيد على الخط"}, correct_answer: "3", explanation: "قبل تصعيد المشكلة، الخطوة الأولى والمنطقية هي التأكد من أن جهاز العميل يدعم الخاصية من الأساس." },
    { id: 'trick_10', question: "العميل يشتكي أن خدمة Wifi Calling لا تعمل عندما يفعل وضع الطيران (Airplane Mode)، ما هو الإجراء؟", options: {"1": "نصعد شكوى", "2": "نبلغه أنها غير متاحة في حالة وضع الطيران", "3": "يرجع للمفوض", "4": "نتحقق إذا كان موبايله يدعم الخدمة"}, correct_answer: "2", explanation: "خدمة الواي فاي كولينج تتطلب أن تكون شريحة الخط نشطة على الشبكة، ووضع الطيران يقوم بإيقاف الشريحة تمامًا." },
    { id: 'trick_11', question: "عميل عندما يشغل جهاز WE Air تظهر له رسالة 'Enter Sim lock code'، ما هو الإجراء الصحيح؟", options: {"1": "نعمل Reset & Configuration", "2": "نقول له غيّر الجهاز بجهاز جديد من الفرع", "3": "نعمل له شكوى مدتها 3WD", "4": "نبلغه بالتوجه للفرع لعمل استبدال للشريحة"}, correct_answer: "4", explanation: "هذه الرسالة تعني أن الشريحة نفسها مقفولة (PIN/PUK) أو بها مشكلة، والحل المباشر هو استبدالها." },
    { id: 'trick_12', question: "عميل وصلته رسالة تفيد بأنه كسب 5 جيجا، ولكن لا يوجد أثر لذلك على النظام. ما هو الإجراء الصحيح؟", options: {"1": "يرجع للمفوض", "2": "نقول له تجاهل الرسالة", "3": "نفتح له شكوى (Duplicated SMS) مدتها 3WD", "4": "نأخذ استثناء ونعوضه يدوياً"}, correct_answer: "3", explanation: "هذه الحالة تُعرف بـ Duplicated SMS، والإجراء المتبع هو إنشاء شكوى للتحقق من مصدر الرسالة وحل المشكلة." }
],
    singlePlayerTiers: [
        { id: 'tier-1', name: 'ايجنت عادي', levels: 3, questionsPerLevel: 5, timePerQuestion: 30, medal: '🥉', points: 10, awardPoints: 50, icon: 'bxs-shield-quarter', achievement: 'complete_tier1' },
        { id: 'tier-2', name: 'ايجنت جامد', levels: 6, questionsPerLevel: 5, timePerQuestion: 25, medal: '🥈', points: 15, awardPoints: 75, icon: 'bxs-shield-alt-2', achievement: 'complete_tier2' },
        { id: 'tier-3', name: 'ايجنت كوالتي', levels: 12, questionsPerLevel: 5, timePerQuestion: 20, medal: '🥇', points: 20, awardPoints: 100, icon: 'bxs-shield-x', achievement: 'complete_tier3' },
        { id: 'tier-4', name: 'ايجنت سوبرفايزر', levels: 24, questionsPerLevel: 5, timePerQuestion: 15, medal: '🏆', points: 25, awardPoints: 150, icon: 'bxs-shield', achievement: 'complete_tier4' },
        { id: 'tier-5', name: 'ايجنت خرافي', levels: 48, questionsPerLevel: 5, timePerQuestion: 10, medal: '💎', points: 30, awardPoints: 200, icon: 'bxs-diamond', achievement: 'complete_tier5' },
        { id: 'tier-6', name: 'أسطورة النسور', levels: 96, questionsPerLevel: 5, timePerQuestion: 8, medal: '👑', points: 50, awardPoints: 500, icon: 'bxs-crown', achievement: 'complete_tier6' }
    ],
    achievements: {
        'join_team': { name: "جزء من المجموعة", description: "انضم إلى فريق لأول مرة", icon: "<i class='bx bx-user-plus'></i>", target: 1, stat: 'joinedTeam', rewardPoints: 15 },
        'create_team': { name: "القائد المؤسس", description: "قم بإنشاء فريقك الخاص", icon: "<i class='bx bxs-shield-plus'></i>", target: 1, stat: 'createdTeam', rewardPoints: 30 },
        'complete_tier1': { name: "ايجنت طموح", description: "أكمل جميع مستويات فئة 'ايجنت عادي'", icon: "<i class='bx bx-shield-quarter'></i>", target: 1, stat: 'complete_tier1', rewardPoints: 50 },
        'complete_tier3': { name: "خبير الجودة", description: "أكمل جميع مستويات فئة 'ايجنت كوالتي'", icon: "<i class='bx bx-shield-x'></i>", target: 1, stat: 'complete_tier3', rewardPoints: 150 },
        'complete_all_sp': { name: "أسطورة فردية", description: "أكمل جميع مستويات اللعب الفردي", icon: "<i class='bx bxs-diamond'></i>", target: 1, stat: 'allSPCompleted', rewardPoints: 500 },
        'reach_level_10': { name: "المستوى العاشر", description: "أوصل حسابك إلى المستوى 10", icon: "<i class='bx bxs-up-arrow-circle'></i>", target: 1, stat: 'level10Reached', rewardPoints: 40 },
        'reach_level_25': { name: "المستوى 25", description: "أوصل حسابك إلى المستوى 25", icon: "<i class='bx bxs-chevrons-up'></i>", target: 1, stat: 'level25Reached', rewardPoints: 120 },
        'first_conquest': { name: "الفاتح الأول", description: "سيطر على جزيرة لأول مرة مع فريقك", icon: "<i class='bx bxs-flag-alt'></i>", target: 1, stat: 'islandsConquered', rewardPoints: 100 },
        'capital_owner': { name: "سيد القلعة", description: "سيطر على القلعة المركزية", icon: "<i class='bx bxs-chess'></i>", target: 1, stat: 'citadelConquered', rewardPoints: 250 },
        'war_veteran': { name: "محارب قديم", description: "شارك في 50 مباراة احتلال", icon: "<i class='bx bxs-swords'></i>", target: 50, stat: 'conquestMatchesPlayed', rewardPoints: 75 }
    },
    islands: [
        { id: 'citadel', name: 'القلعة المركزية', icon: 'bxs-castle', category: 'General', style: { top: '50%', left: '50%', width: '120px', height: '120px', transform: 'translate(-50%, -50%)' } },
        { id: 'tech_island', name: 'جزيرة التقنية', icon: 'bxs-chip', category: 'tech_island', style: { top: '10%', left: '50%', width: '95px', height: '95px', transform: 'translateX(-50%)' } },
        { id: 'nontech_island', name: 'جزيرة الأنظمة', icon: 'bxs-file-doc', category: 'nontech_island', style: { top: '50%', left: '15%', width: '95px', height: '95px', transform: 'translateY(-50%)' } },
        { id: 'quality_fort', name: 'حصن الجودة', icon: 'bxs-badge-check', category: 'quality_fort', style: { top: '50%', right: '15%', width: '95px', height: '95px', transform: 'translateY(-50%)' } },
        { id: 'faulty_valley', name: 'وادي الأعطال', icon: 'bxs-wrench', category: 'faulty_valley', style: { bottom: '10%', left: '30%', width: '95px', height: '95px', transform: 'translateX(-50%)' } },
        { id: 'briefings_archipelago', name: 'أرخبيل المستجدات', icon: 'bxs-megaphone', category: 'briefings_archipelago', style: { bottom: '10%', right: '30%', width: '95px', height: '95px', transform: 'translateX(50%)' } }
    ],
    vacancy_ladder: [
        { name: 'موظف جديد', salary: '1,000' },
        { name: 'موظف خبير', salary: '5,000' },
        { name: 'مشرف فريق', salary: '10,000' },
        { name: 'قائد فريق', salary: '50,000' },
        { name: 'مدير قسم', salary: '100,000' },
        { name: 'الفائز بالفاكنسي!', salary: '500,000' }
    ],
    special_abilities: {
        '50_50': { name: "حذف إجابتين", type: 'lifeline', icon: 'bx-star' },
        'swap_question': { name: "تغيير السؤال", type: 'lifeline', icon: 'bx-swap-horizontal' },
        'skip_turn': { name: "تخطي الدور", type: 'attack', icon: 'bx-skip-next-circle' },
        'reverse_turn': { name: "عكس الاتجاه", type: 'attack', icon: 'bx-reflect-vertical' },
        'fiery_question': { name: "السؤال الناري", type: 'attack', icon: 'bxs-hot' },
        'trick_question': { name: "سؤال خادع", type: 'attack', icon: 'bxs-magic-wand' },
    },

};
    // =================================================
// ✨ DEV TOOL: لإضافة عملات يدوياً للاختبار ✨
// =================================================
window.addMyCoins = async function(amount) {
    if (!AppState.playerProfile || !AppState.playerProfile.id) {
        console.log("يجب تسجيل الدخول أولاً لإضافة عملات.");
        return;
    }
    if (typeof amount !== 'number' || amount <= 0) {
         console.log("الرجاء إدخال رقم صحيح أكبر من صفر.");
        return;
    }

    const playerRef = doc(db, "players", AppState.playerProfile.id);
    await updateDoc(playerRef, { coins: increment(amount) });

    // تحديث البيانات فوراً في الواجهة
    await loadPlayerProfile(AppState.playerProfile.id);

    console.log(`تمت إضافة ${amount} عملة بنجاح!`);
    showToast(`تمت إضافة ${amount} عملة إلى رصيدك!`);
}

        // --- الحالة العامة للتطبيق ---
        let AppState = {
            currentUser: null,
            playerProfile: null,
            playerTeam: null,
            modalCallback: null,
            singlePlayerState: { currentTier: null, currentLevel: null, questions: [], currentQuestionIndex: 0, answers: [], },
            currentLobbyId: null,
            unsubscribeLobby: null,
            unsubscribeChat: null,
            questionTimer: null,
            musicPlayer: null,
            isMuted: true,
            currentTrackIndex: 0,
        };

        // =================================================
        // ✨ دوال الواجهة الرسومية (UI Functions) ✨
        // =================================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen-container').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(screenId);
            if (screen) {
                if (!screen.hasAttribute('data-rendered')) {
                    const template = document.getElementById(`${screenId}-template`);
                    if (template) { screen.innerHTML = template.innerHTML; screen.setAttribute('data-rendered', 'true'); }
                }
                screen.classList.add('active');
                if (screenId === 'online-menu-screen') {
                    const conquestBtn = document.getElementById('conquest-match-btn');
                    if (conquestBtn) {
                        const canAttack = AppState.playerTeam && AppState.playerTeam.currentTarget;
                        conquestBtn.disabled = !canAttack;
                        if (!canAttack) {
                            conquestBtn.title = "يجب على قائد فريقك استهداف جزيرة أولاً!";
                        } else {
                            const targetIsland = GAME_CONFIG.islands.find(i => i.id === AppState.playerTeam.currentTarget);
                            conquestBtn.title = targetIsland ? `الهجوم على: ${targetIsland.name}` : '';
                        }
                    }
                }
            }
        }
        function showModal(title, message, confirmText = 'نعم', cancelText = 'إلغاء', onConfirm) {
            const modal = document.getElementById('modal');
            if (!modal) return;
            modal.innerHTML = document.getElementById('modal-template').innerHTML;
            const titleEl = modal.querySelector('#modal-title'), bodyEl = modal.querySelector('#modal-body'), confirmBtn = modal.querySelector('[data-action="modal-confirm"]'), cancelBtn = modal.querySelector('[data-action="modal-cancel"]');
            if (titleEl) titleEl.textContent = title;
            if (bodyEl) bodyEl.innerHTML = message;
            if (confirmBtn) confirmBtn.textContent = confirmText;
            if (cancelBtn) cancelBtn.textContent = cancelText;
            if (!onConfirm) {
                if (confirmBtn) confirmBtn.style.display = 'none';
                if (cancelBtn) cancelBtn.textContent = 'حسنًا';
                cancelBtn.onclick = hideModal;
            } else {
                if (confirmBtn) confirmBtn.style.display = 'flex';
                confirmBtn.onclick = () => { onConfirm(); hideModal(); };
                cancelBtn.onclick = hideModal;
            }
            AppState.modalCallback = onConfirm;
            modal.classList.add('visible');
        }
        function hideModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.classList.remove('visible');
            AppState.modalCallback = null;
        }
        function showToast(message) {
            const container = document.getElementById('toast-container'); if (!container) return;
            const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = `🎉 ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        }

        // --- دوال اللاعب وتسجيل الدخول ---
        async function handleLogin(loginButton) {
            loginButton.disabled = true;
            loginButton.innerHTML = `<i class='bx bx-loader-alt bx-spin'></i> جار الدخول...`;
            const name = document.getElementById('name-input')?.value.trim();
            const teleoptiId = document.getElementById('teleopti-id-input')?.value.trim();
            if (!name || !teleoptiId || !/^\d+$/.test(teleoptiId)) {
                showModal("بيانات غير مكتملة", "الرجاء إدخال الاسم و Teleopti ID صحيح (أرقام فقط).", null, "حسنًا");
                loginButton.disabled = false;
                loginButton.innerHTML = `<i class='bx bx-log-in-circle'></i> دخول`;
                return;
            }
            try {
                if (!auth.currentUser) { await signInAnonymously(auth); }
                AppState.currentUser = auth.currentUser;
                const playerRef = doc(db, "players", teleoptiId);
                await runTransaction(db, async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    if (!playerDoc.exists()) {
                        const defaultStats = Object.values(GAME_CONFIG.achievements).reduce((acc, ach) => ({...acc, [ach.stat]: 0}), {});
                        transaction.set(playerRef, { name, teleoptiId, uid: AppState.currentUser.uid, score: 0, coins: 0, awards: [], singlePlayerProgress: {}, stats: defaultStats, unlockedAchievements: [], teamId: null, createdAt: serverTimestamp(), lastLogin: serverTimestamp() });
                    } else {
                        transaction.update(playerRef, { name, uid: AppState.currentUser.uid, lastLogin: serverTimestamp() });
                    }
                });
                if (document.getElementById('remember-me-checkbox')?.checked) {
                    localStorage.setItem('triviaTeleoptiId', teleoptiId);
                    localStorage.setItem('triviaName', name);
                } else {
                    localStorage.removeItem('triviaTeleoptiId');
                    localStorage.removeItem('triviaName');
                }
                await loadPlayerProfile(teleoptiId);
listenForNotifications();
            } catch (error) {
                console.error("Login failed:", error);
                showModal("فشل تسجيل الدخول", `حدث خطأ: ${error.message}`, null, "حسنًا");
                loginButton.disabled = false; loginButton.innerHTML = `<i class='bx bx-log-in-circle'></i> دخول`;
            }
        }
        async function loadPlayerProfile(teleoptiId) {
            try {
                const playerDoc = await getDoc(doc(db, "players", teleoptiId));
                if (playerDoc.exists()) {
                    AppState.playerProfile = { ...playerDoc.data(), id: playerDoc.id };
                    if (AppState.playerProfile.teamId) {
                        const teamDoc = await getDoc(doc(db, "teams", AppState.playerProfile.teamId));
                        AppState.playerTeam = teamDoc.exists() ? { ...teamDoc.data(), id: teamDoc.id } : null;
                    } else { AppState.playerTeam = null; }
                    showScreen('main-menu-screen');
                    updateMainMenu();
                    await checkAndGrantAchievements();
                } else {
                    localStorage.removeItem('triviaTeleoptiId');
                    showScreen('registration-screen');
                    showModal("خطأ", "لم يتم العثور على ملف اللاعب هذا.", null, "حسنًا");
                }
            } catch (error) {
                console.error("Error loading profile:", error);
                showScreen('registration-screen');
                showModal("خطأ في الشبكة", `لا يمكن تحميل ملفك الشخصي: ${error.message}`, null, "حسنًا");
            }
        }
        
function updateMainMenu() {
    if (!AppState.playerProfile) return;
    const welcomeMsg = document.getElementById('welcome-message');
    const awardsDisplay = document.getElementById('player-awards-display');
    const resourcesDisplay = document.getElementById('player-resources'); // <-- السطر الجديد

    const teamTagDisplay = AppState.playerTeam ? `<span class="team-tag">[${AppState.playerTeam.tag}]</span>` : '';

    if (welcomeMsg) { 
        welcomeMsg.innerHTML = `أهلاً بك, ${teamTagDisplay} <span class="name">${AppState.playerProfile.name}</span>`; 
    }

    if (awardsDisplay) { 
        const awards = AppState.playerProfile.awards || []; 
        awardsDisplay.innerHTML = awards.join(' '); 
    }

    // ✨ --- START: NEW LOGIC TO DISPLAY COINS --- ✨
    if (resourcesDisplay) {
        const coins = AppState.playerProfile.coins || 0;
        resourcesDisplay.innerHTML = `<i class='bx bxs-coin-stack' style="color: var(--accent-yellow);"></i> عملات النسور: <span style="color:var(--accent-yellow);">${coins}</span>`;
    }
    // ✨ --- END: NEW LOGIC TO DISPLAY COINS --- ✨
}

        function handleLogout() {
            showModal('تسجيل الخروج', 'هل أنت متأكد؟', 'نعم', 'لا', async () => {
                await signOut(auth).catch(console.error);
                AppState.currentUser = null; AppState.playerProfile = null; AppState.playerTeam = null;
                localStorage.removeItem('triviaTeleoptiId'); localStorage.removeItem('triviaName');
                showScreen('registration-screen');
                repopulateLoginFields();
            });
        }
        
        // الخطوة 3: دالة الاستماع لرسائل البث
async function listenForBroadcast() {
    const broadcastRef = doc(db, "game_state", "broadcast");
    onSnapshot(broadcastRef, (docSnap) => {
        const broadcastBar = document.getElementById('broadcast-bar');
        const messageEl = broadcastBar.querySelector('.broadcast-message');
        if (!broadcastBar || !messageEl) return;

        if (docSnap.exists() && docSnap.data().isActive) {
            messageEl.textContent = docSnap.data().message;
            broadcastBar.classList.add('active');
        } else {
            broadcastBar.classList.remove('active');
        }
    });



}

// الخطوة 6: إضافة دوال نظام الإشعارات
function listenForNotifications() {
    if (!AppState.playerProfile) return;

    const q = query(collection(db, "notifications"), where("recipientId", "==", AppState.playerProfile.id), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
        const notifications = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
        const unreadCount = notifications.filter(n => !n.isRead).length;

        const badge = document.getElementById('notifications-badge');
        if (badge) {
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        AppState.notifications = notifications; // تخزين الإشعارات للاستخدام لاحقاً
    });
}

function showInboxScreen() {
    showScreen('inbox-screen');
    const listContainer = document.getElementById('inbox-list');
    if (!listContainer) return;

    const notifications = AppState.notifications || [];

    if (notifications.length === 0) {
        listContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">صندوق الوارد فارغ.</p>';
        return;
    }

    listContainer.innerHTML = notifications.map(n => {
        const isUnread = !n.isRead ? 'my-rank' : ''; // استخدام نفس استايل التميز للإشعارات غير المقروءة
        return `
            <div class="list-item ${isUnread}">
                <div class="item-info" style="flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                    <span class="item-name">${n.title}</span>
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">${n.message}</span>
                </div>
                ${!n.isRead ? `<button class="btn" data-action="mark-notif-read" data-notif-id="${n.id}" style="width:auto; padding: 0.5rem 1rem; font-size:0.8rem;">وضع علامة كمقروء</button>` : ''}
            </div>
        `;
    }).join('');

    // بمجرد فتح صندوق الوارد، يمكننا تحديث جميع الإشعارات لتصبح مقروءة بعد فترة
    setTimeout(() => {
        const batch = writeBatch(db);
        notifications.forEach(n => {
            if (!n.isRead) {
                const notifRef = doc(db, "notifications", n.id);
                batch.update(notifRef, { isRead: true });
            }
        });
        batch.commit().catch(err => console.error("Failed to mark notifications as read", err));
    }, 3000); // تحديث بعد 3 ثواني
}



        function repopulateLoginFields() {
            try {
                document.getElementById('name-input').value = localStorage.getItem('triviaName') || '';
                document.getElementById('teleopti-id-input').value = localStorage.getItem('triviaTeleoptiId') || '';
            } catch (e) { /* ignore */ }
        }

        // =================================================
        // ✨ دوال اللعب الفردي (Single Player) ✨
        // =================================================

        function getQuestions(category, subCategory, count) {
            let bank = [];
            if (category === 'islands' && subCategory) {
                bank = GAME_CONFIG.questionBanks.islands[subCategory] || [];
            } else {
                bank = GAME_CONFIG.questionBanks[category] || [];
            }

            if (bank.length === 0) {
                console.warn(`بنك الأسئلة ${category}/${subCategory} فارغ! سيتم استخدام البنك الاحتياطي.`);
                // في حالة عدم وجود أسئلة، استخدم بنك اللعب الحر كاحتياطي
                bank = GAME_CONFIG.questionBanks.online_freeplay || [];
            }

            const shuffled = [...bank].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, Math.min(count, bank.length));
        }        function displayTiers() {
            showScreen('single-player-menu-screen');
            const grid = document.getElementById('tiers-grid');
            if (!grid) return;
            grid.innerHTML = '';
            let lastTierUnlocked = true;
            GAME_CONFIG.singlePlayerTiers.forEach((tier, index) => {
                const progress = AppState.playerProfile.singlePlayerProgress || {};
                const completedLevels = progress[tier.id]?.length || 0;
                const isLocked = !lastTierUnlocked;
                const progressPercent = (completedLevels / tier.levels) * 100;
                const card = document.createElement('div');
                card.className = `card ${isLocked ? 'locked' : ''}`;
                card.innerHTML = `<div class="card-icon"><i class='bx ${isLocked ? 'bxs-lock' : tier.icon}'></i></div><h3 class="card-title">${tier.name} ${tier.medal}</h3><p class="screen-subtitle" style="margin:0.5rem 0; font-size: 0.9rem;">المستويات: ${completedLevels} / ${tier.levels}</p><div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>`;
                if (!isLocked) { card.onclick = () => displayLevels(tier); }
                grid.appendChild(card);
                if(index > 0) {
                    const prevTier = GAME_CONFIG.singlePlayerTiers[index - 1];
                    const prevTierProgress = progress[prevTier.id]?.length || 0;
                    if (prevTierProgress < prevTier.levels) { lastTierUnlocked = false; }
                }
            });
        }
        function displayLevels(tier) {
            AppState.singlePlayerState.currentTier = tier;
            showScreen('level-select-screen');
            document.getElementById('level-select-title').innerHTML = `<i class='bx ${tier.icon}'></i> ${tier.name}`;
            const grid = document.getElementById('levels-grid');
            if (!grid) return;
            grid.innerHTML = '';
            const completedInTier = AppState.playerProfile.singlePlayerProgress?.[tier.id] || [];
            for (let i = 0; i < tier.levels; i++) {
                const isCompleted = completedInTier.includes(i);
                const card = document.createElement('div');
                card.className = `card level-card ${isCompleted ? 'completed' : ''}`;
                card.innerHTML = `<h3 class="card-title">المستوى ${i + 1}</h3> ${isCompleted ? '<p style="color:var(--accent-green); margin:0;">✅ مكتمل</p>' : ''}`;
                card.onclick = () => startSinglePlayerLevel(tier, i);
                grid.appendChild(card);
            }
        }
        function startSinglePlayerLevel(tier, levelIndex) { AppState.singlePlayerState = { currentTier: tier, currentLevel: levelIndex, questions: getQuestions('singlePlayer', null, tier.questionsPerLevel), currentQuestionIndex: 0, answers: [], }; displaySinglePlayerQuestion(); }
        function displaySinglePlayerQuestion() {
            showScreen('match-screen');
            const { currentTier, currentQuestionIndex, questions } = AppState.singlePlayerState;
            if (!questions || questions.length === 0) { return showModal("خطأ", "لا توجد أسئلة متاحة.", null, 'موافق', () => displayTiers()); }
            const question = questions[currentQuestionIndex];
            document.getElementById('match-header').textContent = `${currentTier.name} - المستوى ${AppState.singlePlayerState.currentLevel + 1}`;
            document.getElementById('question-counter').textContent = `السؤال ${currentQuestionIndex + 1} / ${questions.length}`;
            document.getElementById('question-text').innerHTML = question.question;
            document.getElementById('explanation-box').style.display = 'none';
            const optionsGrid = document.getElementById('options-grid');
            optionsGrid.innerHTML = '';
            Object.entries(question.options).forEach(([key, optionText]) => {
                const btn = document.createElement('button');
                btn.className = 'btn option-btn';
                btn.textContent = optionText;
                btn.onclick = () => handleSinglePlayerAnswer(key);
                optionsGrid.appendChild(btn);
            });
        }
        function handleSinglePlayerAnswer(selectedKey) {
            const { questions, currentQuestionIndex, currentTier } = AppState.singlePlayerState;
            const question = questions[currentQuestionIndex];
            const isCorrect = selectedKey === question.correct_answer;
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent === question.options[question.correct_answer]) { btn.classList.add('correct'); }
            });
            if (!isCorrect) {
                const wrongBtn = Array.from(document.querySelectorAll('.option-btn')).find(btn => btn.textContent === question.options[selectedKey]);
                if (wrongBtn) wrongBtn.classList.add('wrong');
                const explanationBox = document.getElementById('explanation-box');
                if (question.explanation && explanationBox) { explanationBox.textContent = `💡 التفسير: ${question.explanation}`; explanationBox.style.display = 'block'; }
                setTimeout(() => { showModal("إجابة خاطئة!", "يجب الإجابة على كل الأسئلة بشكل صحيح.", null, 'حاول مرة أخرى', () => { displayLevels(currentTier); }); }, 2500);
            } else {
                AppState.singlePlayerState.answers.push(isCorrect);
                setTimeout(() => {
                    if (AppState.singlePlayerState.currentQuestionIndex < questions.length - 1) {
                        AppState.singlePlayerState.currentQuestionIndex++;
                        displaySinglePlayerQuestion();
                    } else {
                        finishSinglePlayerLevel();
                    }
                }, 1200);
            }
        }
        async function finishSinglePlayerLevel() {
            const { id: tierId, name, medal, points, awardPoints, achievement } = AppState.singlePlayerState.currentTier;
            const levelIndex = AppState.singlePlayerState.currentLevel;
            const playerRef = doc(db, "players", AppState.playerProfile.id);
            const wasAlreadyCompleted = AppState.playerProfile.singlePlayerProgress?.[tierId]?.includes(levelIndex);
            let message = `أحسنت! لقد أكملت هذا المستوى بنجاح.`;
            if (!wasAlreadyCompleted) {
                message += ` +${points} نقاط وخبرة +5 عملات!`;
                await updateDoc(playerRef, { score: increment(points), coins: increment(5), [`singlePlayerProgress.${tierId}`]: arrayUnion(levelIndex) });
            }
            await loadPlayerProfile(AppState.playerProfile.id);
            const currentTierData = GAME_CONFIG.singlePlayerTiers.find(t => t.id === tierId);
            const completedLevelsInTier = AppState.playerProfile.singlePlayerProgress?.[tierId]?.length || 0;
            const wasTierAlreadyCompleted = AppState.playerProfile.awards?.includes(medal);
            if (completedLevelsInTier >= currentTierData.levels && !wasTierAlreadyCompleted) {
                message = `🎉 تهانينا! 🎉\nلقد أكملت فئة ${name} وحصلت على الميدالية ${medal} ومكافأة ${awardPoints} نقطة و **50 عملة**!`;
                await updateDoc(playerRef, { awards: arrayUnion(medal), score: increment(awardPoints), coins: increment(50) });
                if (achievement) { await updatePlayerStat(achievement); } // Grant achievement for completing tier
                await loadPlayerProfile(AppState.playerProfile.id);
            }
            showModal("مستوى مكتمل!", message, null, "متابعة", () => { displayTiers(); });
        }
// =================================================
// ✨ دوال اللعب الجماعي (Online Multiplayer) ✨
// =================================================

function getHighestMedal(playerProfile) {
    if (!playerProfile || !playerProfile.awards || !Array.isArray(playerProfile.awards)) return '';
    const tierOrder = ['💎', '🏆', '🥇', '🥈', '🥉'];
    for (const medal of tierOrder) {
        if (playerProfile.awards.includes(medal)) {
            return medal;
        }
    }
    return '';
}

// تم تصحيح الخطأ الإملائي هنا
async function createLobby(type) {
    if (!AppState.currentUser || !AppState.playerProfile) return showModal("خطأ", "يجب تسجيل الدخول أولاً.", null, "حسنًا");

    let lobbyDetails = {
        type: type
    };

    if (type === 'conquest') {
        if (!AppState.playerTeam?.currentTarget) {
            return showModal("خطأ", "لم يحدد قائد فريقك جزيرة لاستهدافها بعد.", null, "حسنًا");
        }
        const islandId = AppState.playerTeam.currentTarget;
        const islandData = GAME_CONFIG.islands.find(i => i.id === islandId);
        lobbyDetails.islandId = islandId;
        lobbyDetails.islandCategory = islandData.category;
    }

    const lobbyCode = Math.random().toString(36).substring(2, 6).toUpperCase();
    const lobbyRef = doc(db, "lobbies", lobbyCode);
    const medal = getHighestMedal(AppState.playerProfile);

    const getRandomAbilities = (count = 3) => {
        const allAbilities = Object.keys(GAME_CONFIG.special_abilities);
        return allAbilities.sort(() => 0.5 - Math.random()).slice(0, count);
    };

    const hostPlayer = {
        uid: AppState.currentUser.uid,
        name: AppState.playerProfile.name,
        teleoptiId: AppState.playerProfile.teleoptiId,
        score: 0,
        totalScore: AppState.playerProfile.score || 0,
        medal: medal,
        teamId: AppState.playerTeam?.id || null
    };

    if (type === 'vacancy') {
        hostPlayer.rankIndex = 0;
        hostPlayer.abilities = getRandomAbilities(3);
    }

    const newLobby = {
        ...lobbyDetails,
        lobbyCode,
        hostUid: AppState.currentUser.uid,
        createdAt: serverTimestamp(),
        status: "waiting",
        players: [hostPlayer],
        currentQuestionIndex: -1,
        answers: {},
        turnIndex: 0,
        playDirection: 1,
    };

    await setDoc(lobbyRef, newLobby);
    joinLobby(lobbyCode);
}
// ==========================================================
// ✨ دالة تحديث شاشة الانتظار (Lobby) المفقودة ✨
// ==========================================================
function updateLobbyScreen(lobbyData) {
    if (!lobbyData || !AppState.currentUser) return;
    AppState.currentLobbyId = lobbyData.lobbyCode;
    const isHost = lobbyData.hostUid === AppState.currentUser.uid;

    let title = 'ردهة الانتظار';
    if (lobbyData.type === '1v1') title = '⚔️ مواجهة 1 ضد 1 ⚔️';
    else if (lobbyData.type === 'massive') title = '🏟️ منافسة حاشدة 🏟️';
    else if (lobbyData.type === 'conquest') title = '⚔️ حــــرب الجــــزر ⚔️';
    else if (lobbyData.type === 'vacancy') title = '👑 من سيربح الفاكنسي 👑';

    const lobbyTitleEl = document.getElementById('lobby-title');
    if (lobbyTitleEl) lobbyTitleEl.textContent = title;

    const lobbyCodeDisplayEl = document.getElementById('lobby-code-display');
    if (lobbyCodeDisplayEl) lobbyCodeDisplayEl.textContent = lobbyData.lobbyCode;

    const playersListEl = document.getElementById('lobby-players-list');
    if (playersListEl) {
        playersListEl.innerHTML = '';
        lobbyData.players.forEach(player => {
            const item = document.createElement('div');
            item.className = 'list-item';
            const hostIcon = player.uid === lobbyData.hostUid ? '👑' : '';

            if (lobbyData.type === 'vacancy') {
                const rankName = GAME_CONFIG.vacancy_ladder[player.rankIndex || 0]?.name || 'مرتبة غير معروفة';
                item.innerHTML = `<span class="item-name" style="font-weight:700;">${player.name} ${hostIcon}</span> <span class="item-value" style="color:var(--accent-cyan);">${rankName}</span>`;
            } else {
                const { level, color } = getPlayerLevelInfo(player.totalScore);
                item.innerHTML = `<span class="player-level" style="background-color:${color}; margin-left: 8px;">Lvl ${level}</span> <span class="item-name" style="font-weight:700;">${player.medal || ''} ${player.name} ${hostIcon}</span>`;
            }
            playersListEl.appendChild(item);
        });
    }

    const startGameBtn = document.getElementById('start-game-btn');
    const lobbyStatusEl = document.getElementById('lobby-status');

    if (isHost) {
        if (startGameBtn) startGameBtn.style.display = 'block';
        const canStart = (lobbyData.type === 'vacancy' || lobbyData.type === 'massive' || lobbyData.type === 'conquest') 
                       ? lobbyData.players.length >= 2 
                       : lobbyData.players.length === 2;
        if (startGameBtn) startGameBtn.disabled = !canStart;
    } else {
        if (startGameBtn) startGameBtn.style.display = 'none';
    }

    if (lobbyStatusEl) {
        if (lobbyData.status === 'countdown') {
            lobbyStatusEl.textContent = `المباراة ستبدأ في ${lobbyData.countdown}...`;
        } else { // 'waiting'
            let waitingText = `في انتظار لاعبين... (${lobbyData.players.length})`;
            if (lobbyData.type === '1v1') {
                waitingText = `في انتظار اللاعب الثاني... (${lobbyData.players.length}/2)`;
            } else if (lobbyData.type === 'vacancy') {
                waitingText = `في انتظار لاعبين... (${lobbyData.players.length} / 4)`;
            }
            lobbyStatusEl.textContent = waitingText;
        }
    }
}

function joinLobby(code) {
    if (!AppState.currentUser || !AppState.playerProfile) {
        return showModal("خطأ", "يجب تسجيل الدخول أولاً للانضمام.");
    }
    const lobbyCode = code.toUpperCase();
    const lobbyRef = doc(db, "lobbies", lobbyCode);

    // إلغاء أي استماع قديم لضمان عدم وجود تكرار
    if (AppState.unsubscribeLobby) AppState.unsubscribeLobby();

    AppState.unsubscribeLobby = onSnapshot(lobbyRef, async (docSnap) => {
        // ✨ خطوة تشخيصية: اطبع أي تحديث يصل من قاعدة البيانات
        console.log('[DEBUG] Lobby update received:', docSnap.data());

        if (!docSnap.exists()) {
            showModal("خطأ", "الغرفة لم تعد موجودة أو تم إغلاقها.");
            if (AppState.unsubscribeLobby) AppState.unsubscribeLobby();
            AppState.unsubscribeLobby = null;
            return showScreen('online-menu-screen');
        }

        const lobbyData = docSnap.data();
        const playerInLobby = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);

        // إذا كان اللاعب غير موجود في الردهة والحالة ما زالت انتظار، قم بإضافته
        if (!playerInLobby && lobbyData.status === 'waiting') {
            // تحقق من أن الردهة ليست ممتلئة (خاصة للـ 1 ضد 1)
            if (lobbyData.type === '1v1' && lobbyData.players.length >= 2) {
                return showModal("ممتلئة", "هذه المواجهة ممتلئة بالفعل.");
            }
            
            const medal = getHighestMedal(AppState.playerProfile);
            const newPlayerPayload = {
                uid: AppState.currentUser.uid,
                name: AppState.playerProfile.name,
                teleoptiId: AppState.playerProfile.teleoptiId,
                score: 0,
                totalScore: AppState.playerProfile.score || 0,
                medal: medal,
                teamId: AppState.playerTeam?.id || null,
            };

            if (lobbyData.type === 'vacancy') {
                newPlayerPayload.rankIndex = 0;
                newPlayerPayload.abilities = ['50_50', 'swap_question', 'skip_turn'].sort(() => 0.5 - Math.random());
            }

            await updateDoc(lobbyRef, { players: arrayUnion(newPlayerPayload) });
            // لا تفعل شيئاً آخر هنا، انتظر التحديث التالي من onSnapshot
            return; 
        }

        // إذا كان اللاعب موجوداً، أو إذا بدأت اللعبة
        if (playerInLobby) {
            // ✨ خطوة تشخيصية: اطبع الحالة التي يراها اللاعب
            console.log(`[DEBUG] Player ${AppState.playerProfile.name} sees lobby status: ${lobbyData.status}`);

            switch (lobbyData.status) {
                case 'waiting':
                case 'countdown':
                    showScreen('online-lobby-screen');
                    updateLobbyScreen(lobbyData);
                    break;
                case 'in-progress':
                    // هذا هو الجزء الأهم للاعب الثاني
                    runGame(lobbyData);
                    break;
                case 'finished':
                    displayGameOver(lobbyData);
                    break;
                default:
                    console.error("Unknown lobby status:", lobbyData.status);
                    leaveLobby();
            }
        } else if (lobbyData.status !== 'waiting') {
             showModal("مغلق", "هذه المنافسة قد بدأت بالفعل أو انتهت.");
             leaveLobby();
        }

    }, (error) => {
        console.error("Lobby snapshot error:", error);
        showModal("خطأ بالاتصال", "فقد الاتصال بغرفة اللعب.");
        leaveLobby();
    });
}

async function leaveLobby() {
    if (AppState.unsubscribeLobby) AppState.unsubscribeLobby();
    AppState.unsubscribeLobby = null;
    AppState.currentLobbyId = null;
    showScreen('online-menu-screen');
}

async function startGame() {
    if (!AppState.currentLobbyId) return;
    const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

    try {
        const lobbyDoc = await getDoc(lobbyRef);
        if (!lobbyDoc.exists()) throw new Error("Lobby not found");

        const lobbyData = lobbyDoc.data();
        let gameQuestions;

        if (lobbyData.type === 'conquest') {
            gameQuestions = getQuestions('islands', lobbyData.islandCategory, 10);
        } else if (lobbyData.type === 'vacancy') {
            gameQuestions = getQuestions('vacancy_questions', null, 50);
        } else {
            gameQuestions = getQuestions('online_freeplay', null, 20);
        }

        if (!gameQuestions || gameQuestions.length === 0) {
            return showModal("خطأ فادح", "لا يمكن بدء اللعبة لعدم وجود أسئلة في بنك الأسئلة لهذا الوضع.");
        }

        // 1. التحديث الأول: تغيير الحالة إلى العد التنازلي
        await updateDoc(lobbyRef, {
            questions: gameQuestions,
            status: 'countdown',
            countdown: 3
        });

        // 2. بدء العد التنازلي
        let count = 3;
        const countdownInterval = setInterval(async () => {
            count--;
            if (count > 0) {
                await updateDoc(lobbyRef, { countdown: count });
            } else {
                // انتهاء العد التنازلي
                clearInterval(countdownInterval);
                
                // 3. التحديث الأخير: تغيير الحالة لبدء اللعب
                await updateDoc(lobbyRef, {
                    status: 'in-progress',
                    currentQuestionIndex: 0,
                    questionStartTime: serverTimestamp()
                });

                // ✨ --- الحل المباشر والنهائي للمضيف --- ✨
                // بعد إرسال التحديث الأخير، نقوم بجلب أحدث بيانات للردهة
                // ونبدأ اللعبة يدوياً عند المضيف لضمان استجابته الفورية.
                console.log("[DEBUG] Host is now manually starting the game.");
                const finalLobbyDoc = await getDoc(lobbyRef);
                if (finalLobbyDoc.exists()) {
                    runGame(finalLobbyDoc.data());
                }
                // ✨ --- نهاية الحل المباشر --- ✨
            }
        }, 1000);

    } catch (error) {
        console.error("Failed to start game:", error);
        showModal("خطأ", "فشلت عملية بدء اللعبة: " + error.message);
    }
}


function showVacancyMatchScreen(lobbyData) {
    // هذه هي الدالة المتخصصة فقط في عرض شاشة "من سيربح الفاكنسي"
    showScreen('vacancy-match-screen');

    const ladderContainer = document.getElementById('vacancy-ladder-container');
    const questionTextEl = document.querySelector('#vacancy-match-screen #question-text');
    const optionsGridEl = document.querySelector('#vacancy-match-screen #options-grid');
    const turnIndicatorEl = document.getElementById('turn-indicator');
    const abilitiesContainerEl = document.getElementById('player-abilities-container');
    const explanationBoxEl = document.querySelector('#vacancy-match-screen #explanation-box');

    if (!ladderContainer || !questionTextEl || !optionsGridEl || !turnIndicatorEl || !abilitiesContainerEl) {
        console.error("أحد عناصر واجهة لعبة الفاكنسي مفقود!");
        return;
    }
    
    // شبكة أمان لمنع الخروج المفاجئ
    const currentPlayer = lobbyData.players[lobbyData.turnIndex];
    if (!currentPlayer) {
        console.error("Crash prevented: Current player not found!", lobbyData);
        showModal("خطأ في المباراة", "حدث خطأ في تحديد اللاعب الحالي. سيتم إعادتك للقائمة.", null, "موافق", leaveLobby);
        return;
    }

    ladderContainer.innerHTML = GAME_CONFIG.vacancy_ladder.map((step, index) => {
        const playersOnStep = lobbyData.players.filter(p => p.rankIndex === index);
        let playerAvatars = playersOnStep.map(p => {
            const isMe = p.uid === AppState.currentUser.uid;
            return `<div class="player-avatar" title="${p.name}" style="background-color: ${isMe ? 'var(--accent-purple)' : 'var(--accent-red)'};">${p.name.charAt(0)}</div>`;
        }).join('');

        const isCurrentPlayerStep = playersOnStep.some(p => p.uid === AppState.currentUser.uid);
        const stepClass = isCurrentPlayerStep ? 'current-player' : (playersOnStep.length > 0 ? 'other-player' : '');

        return `
            <div class="ladder-step ${stepClass}">
                <span>${step.salary} - ${step.name}</span>
                <div class="step-players">${playerAvatars}</div>
            </div>
        `;
    }).join('');

    const isMyTurn = currentPlayer.uid === AppState.currentUser.uid;

    if (turnIndicatorEl) {
        turnIndicatorEl.textContent = isMyTurn ? "انه دورك الآن!" : `في انتظار اللاعب: ${currentPlayer.name}`;
        turnIndicatorEl.style.color = isMyTurn ? 'var(--accent-green)' : 'var(--accent-yellow)';
    }

    const question = lobbyData.questions[lobbyData.currentQuestionIndex];
    if (question) {
        questionTextEl.innerHTML = question.question;
        optionsGridEl.innerHTML = '';

        Object.entries(question.options).forEach(([key, optionText]) => {
            const btn = document.createElement('button');
            btn.className = 'btn option-btn';
            btn.textContent = optionText;
            if (isMyTurn) {
                btn.onclick = () => handleOnlineAnswer(lobbyData, lobbyData.currentQuestionIndex, key);
            } else {
                btn.disabled = true;
            }
            optionsGridEl.appendChild(btn);
        });
    } else {
        questionTextEl.innerHTML = "في انتظار السؤال...";
        optionsGridEl.innerHTML = '';
    }

    if(explanationBoxEl) explanationBoxEl.style.display = 'none';

    abilitiesContainerEl.innerHTML = '';
    if (isMyTurn) {
        const myAbilities = currentPlayer.abilities || [];
        myAbilities.forEach(abilityKey => {
            const ability = GAME_CONFIG.special_abilities[abilityKey];
            if (ability) {
                const abilityBtn = document.createElement('button');
                abilityBtn.className = 'btn ability-btn';
                abilityBtn.dataset.action = 'use-ability';
                abilityBtn.dataset.ability = abilityKey;
                abilityBtn.innerHTML = `<i class='bx ${ability.icon}'></i> ${ability.name}`;
                abilitiesContainerEl.appendChild(abilityBtn);
            }
        });
    }
}

function displayOnlineMatchScreen(lobbyData) {
    // هذه الدالة هي "الموزع" الرئيسي
    // تتأكد من نوع المباراة ثم تستدعي الدالة المناسبة لعرضها
    if (lobbyData.type === 'vacancy') {
        showVacancyMatchScreen(lobbyData);
        return;
    }

    showScreen('match-screen');
    const questionIndex = lobbyData.currentQuestionIndex;
    const question = lobbyData.questions[questionIndex];
    if (!question) {
        console.error("Crash prevented: Question not found for index:", questionIndex);
        showModal("خطأ في اللعبة", "لم يتم العثور على السؤال الحالي.", null, "العودة للقائمة", leaveLobby);
        return;
    }

    const scoreboardEntries = document.getElementById('live-scoreboard-entries');
    const sortedPlayers = [...lobbyData.players].sort((a, b) => b.score - a.score);
    scoreboardEntries.innerHTML = sortedPlayers.map(p => {
        const { level, color } = getPlayerLevelInfo(p.totalScore);
        return `<div class="list-item" style="padding: 0.75rem;">
            <div style="flex-grow: 1; text-align: right; display: flex; align-items: center; gap: 0.5rem;">
                <span class="player-level" style="background-color:${color};">Lvl ${level}</span>
                <div style="font-weight: 700;">${p.medal || ''} ${p.name}</div>
            </div>
            <div style="font-weight: 900; color: var(--accent-green); font-size: 1.2rem;">${p.score}</div>
        </div>`;
    }).join('');

    document.getElementById('match-header').textContent = lobbyData.type === 'conquest' ? `⚔️ الهجوم على ${GAME_CONFIG.islands.find(i => i.id === lobbyData.islandId).name} ⚔️` : (lobbyData.type === '1v1' ? '⚔️ مواجهة 1 ضد 1 ⚔️' : '🏟️ منافسة حاشدة 🏟️');
    document.getElementById('question-counter').textContent = `السؤال ${questionIndex + 1} / ${lobbyData.questions.length}`;
    document.getElementById('question-text').innerHTML = question.question;
    document.getElementById('explanation-box').style.display = 'none';

    const optionsGrid = document.getElementById('options-grid');
    optionsGrid.innerHTML = '';
    const myAnswer = lobbyData.answers?.[questionIndex]?.[AppState.currentUser?.uid];
    const isRevealPhase = lobbyData.revealAnswerForIndex === questionIndex;

    Object.entries(question.options).forEach(([key, optionText]) => {
        const btn = document.createElement('button');
        btn.className = 'btn option-btn';
        btn.textContent = optionText;
        if (myAnswer || isRevealPhase) {
            btn.classList.add('disabled');
        } else {
            btn.onclick = () => handleOnlineAnswer(lobbyData, questionIndex, key);
        }
        optionsGrid.appendChild(btn);
    });

    if (isRevealPhase) {
        showUniversalQuestionResult(lobbyData, questionIndex);
    } else if (myAnswer) {
        revealOnlineQuestionResult(lobbyData, questionIndex);
    }

    const timerBar = document.getElementById('timer-bar');
    const questionDuration = 20000;
    clearTimeout(AppState.questionTimer);

    if (isRevealPhase) {
        timerBar.style.width = '0%';
    } else {
        const startTime = lobbyData.questionStartTime?.toDate();
        if (startTime) {
            const elapsed = Date.now() - startTime.getTime();
            const remainingTime = Math.max(0, questionDuration - elapsed);
            timerBar.style.transition = 'none';
            timerBar.style.width = `${(remainingTime / questionDuration) * 100}%`;
            requestAnimationFrame(() => {
                timerBar.style.transition = `width ${remainingTime / 1000}s linear`;
                timerBar.style.width = '0%';
            });
        }
        if (lobbyData.hostUid === AppState.currentUser?.uid) {
            AppState.questionTimer = setTimeout(advanceOnlineQuestion, 20000);
        }
    }
}

function runGame(lobbyData) {
    if (lobbyData.status === 'finished') {
        displayGameOver(lobbyData);
        return;
    }
    if (lobbyData.status === 'in-progress' && lobbyData.currentQuestionIndex >= 0) {
        displayOnlineMatchScreen(lobbyData);
    }
}



    

async function handleOnlineAnswer(lobbyData, questionIndex, selectedKey) {
    if (!AppState.currentLobbyId || !AppState.currentUser) return;
    const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

    // لا نسمح بالإجابة إذا لم يكن دور اللاعب في مود الفاكنسي
    if (lobbyData.type === 'vacancy' && lobbyData.players[lobbyData.turnIndex].uid !== AppState.currentUser.uid) {
        return showToast("ليس دورك!");
    }

    const answerPath = `answers.${questionIndex}.${AppState.currentUser.uid}`;
    const questionStartTime = lobbyData.questionStartTime?.toDate();
    const timeTaken = questionStartTime ? Date.now() - questionStartTime.getTime() : 99999;

    try {
        // إرسال الإجابة مع الوقت المستغرق
        await updateDoc(lobbyRef, { [answerPath]: { option: selectedKey, time: timeTaken } });

        // ✨ --- START: NEW LOGIC FOR VACANCY --- ✨
        // في مود الفاكنسي، يتم التقدم للدور التالي فوراً بعد الإجابة
        if (lobbyData.type === 'vacancy') {
            // نمرر كود اللوبي لضمان الحصول على أحدث البيانات
            advanceVacancyTurn(lobbyData.lobbyCode);
        }
        // ✨ --- END: NEW LOGIC FOR VACANCY --- ✨

    } catch(error) {
        console.error("Failed to submit answer:", error);
    }
}

async function advanceVacancyTurn(lobbyCode) {
    const lobbyRef = doc(db, "lobbies", lobbyCode);
    try {
        await runTransaction(db, async (transaction) => {
            const lobbyDoc = await transaction.get(lobbyRef);
            if (!lobbyDoc.exists()) return;

            let lobbyData = lobbyDoc.data();
            let players = [...lobbyData.players];
            const turnIndex = lobbyData.turnIndex;
            let currentPlayer = players[turnIndex];

            if (!currentPlayer) {
                console.error("Could not find current player at turn index:", turnIndex);
                return;
            }

            // --- منطق تحديد السؤال والإجابة ---
            let question = lobbyData.questions[lobbyData.currentQuestionIndex];
            if (currentPlayer.hasTrickQuestion) {
                question = getQuestions('trick_questions', null, 1)[0];
                currentPlayer.hasTrickQuestion = false;
            }
            
            // playerAnswer سيكون فارغاً (undefined) إذا لم يجاوب اللاعب
            const playerAnswer = lobbyData.answers?.[lobbyData.currentQuestionIndex]?.[currentPlayer.uid]?.option;

            let rankChange = 0;
            // التحقق من وجود إجابة وسؤال
            if (playerAnswer && question) {
                // جاوب بالفعل
                if (playerAnswer === question.correct_answer) {
                    rankChange = currentPlayer.hasFieryQuestion ? 2 : 1; // +1 أو +2 للإجابة الصحيحة
                } else {
                    rankChange = currentPlayer.hasFieryQuestion ? -2 : -1; // -1 أو -2 للإجابة الخاطئة
                }
            } else {
                // ✨ لم يجاوب اللاعب (انتهى الوقت) ✨
                // يعامل كأنه إجابة خاطئة
                rankChange = -1;
            }
            
            if (currentPlayer.hasFieryQuestion) {
                currentPlayer.hasFieryQuestion = false;
            }
            
            currentPlayer.rankIndex += rankChange;

            // --- التحقق من الخروج من المنافسة ---
            if (currentPlayer.rankIndex < 0) {
                const eliminatedPlayerName = currentPlayer.name;
                players.splice(turnIndex, 1); // إزالة اللاعب من القائمة
                
                // مكافأة اللاعبين الباقين
                if (players.length > 0) {
                    showToast(`${eliminatedPlayerName} خرج من المنافسة! اللاعبون الباقون يتقدمون مرتبة!`);
                    let gameHasAWinner = false;
                    players.forEach(p => {
                        p.rankIndex = Math.min(p.rankIndex + 1, GAME_CONFIG.vacancy_ladder.length - 1);
                        if (p.rankIndex >= GAME_CONFIG.vacancy_ladder.length - 1) {
                            gameHasAWinner = true;
                        }
                    });

                    if (gameHasAWinner) {
                        transaction.update(lobbyRef, { status: 'finished', players: players });
                        return;
                    }
                }
            } else if (currentPlayer.rankIndex >= GAME_CONFIG.vacancy_ladder.length - 1) {
                // اللاعب وصل للقمة وفاز!
                transaction.update(lobbyRef, { status: 'finished', players: players });
                return;
            }

            // إذا لم يتبق سوى لاعب واحد، فهو الفائز
            if (players.length <= 1) {
                transaction.update(lobbyRef, { status: 'finished', players: players });
                return;
            }

            // --- منطق تحديد الدور القادم ---
            const playDirection = lobbyData.playDirection || 1;
            let nextTurnIndex = (turnIndex % players.length);

            if (players.length > turnIndex) {
                 nextTurnIndex = (turnIndex + playDirection) % players.length;
                 if (nextTurnIndex < 0) nextTurnIndex += players.length;
            } else {
                 nextTurnIndex = 0;
            }

            const nextPlayer = players[nextTurnIndex];
            const nextQuestion = lobbyData.questions.find(q => q.level === (nextPlayer.rankIndex + 1)) || lobbyData.questions[Math.floor(Math.random() * lobbyData.questions.length)];

            transaction.update(lobbyRef, {
                players: players,
                turnIndex: nextTurnIndex,
                currentQuestionIndex: lobbyData.questions.indexOf(nextQuestion),
                questionStartTime: serverTimestamp(),
                answers: {}
            });
        });
    } catch (error) {
        console.error("Error advancing vacancy turn:", error);
        showModal("خطأ فادح", "حدث خطأ في منطق اللعبة.");
    }
}

        
        function revealOnlineQuestionResult(lobbyData, questionIndex) {
            const question = lobbyData.questions[questionIndex];
            const myAnswerObj = lobbyData.answers?.[questionIndex]?.[AppState.currentUser.uid];
            if (!myAnswerObj) return;

            const correctKey = question.correct_answer;
            const myKey = myAnswerObj.option;

            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent === question.options[correctKey]) {
                    btn.classList.add('correct');
                } else if (btn.textContent === question.options[myKey]) {
                    btn.classList.add('wrong');
                }
            });
        }
        
        function showUniversalQuestionResult(lobbyData, questionIndex) {
            const question = lobbyData.questions[questionIndex];
            if (!question) return;

            const correctKey = question.correct_answer;
            
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.textContent === question.options[correctKey]) {
                    btn.classList.add('correct');
                    if (!btn.innerHTML.includes('✅')) btn.innerHTML += ' ✅';
                }
            });
            
            if (question.explanation) {
                const explanationBox = document.getElementById('explanation-box');
                explanationBox.textContent = `💡 التفسير: ${question.explanation}`;
                explanationBox.style.display = 'block';
            }
        }

function scoreOnlineRound(lobbyData, questionIndex) {
    if (questionIndex < 0) return lobbyData.players;

    const question = lobbyData.questions[questionIndex];
    const answers = lobbyData.answers?.[questionIndex] || {};
    let players = JSON.parse(JSON.stringify(lobbyData.players));

    const correctKey = question.correct_answer;

    players.forEach(player => {
        const playerAnswer = answers[player.uid];
        
        // التأكد من أن اللاعب لديه عداد كومبو، وإن لم يكن، نبدأه من صفر
        if (player.combo === undefined) {
            player.combo = 0;
        }

        if (playerAnswer && playerAnswer.option === correctKey) {
            // === الجزء الخاص بالكومبو ===
            player.combo += 1; // زيادة الكومبو عند الإجابة الصحيحة
            
            // حساب النقاط الأساسية بناءً على الوقت
            const timePenalty = Math.floor(playerAnswer.time / 2000);
            const basePoints = Math.max(1, 10 - timePenalty);
            
            // النقاط النهائية = النقاط الأساسية + نقاط الكومبو
            const totalPoints = basePoints + player.combo;
            player.score += totalPoints;
            
            // إظهار رسالة تشجيعية إذا كان الكومبو فعالاً
            if (player.combo > 1) {
                // فقط للاعب الحالي لكي لا تزعج الآخرين
                if(player.uid === AppState.currentUser.uid) {
                   showToast(`كومبو ${player.combo}x ! +${totalPoints} نقطة`);
                }
            }

        } else {
            // إذا كانت الإجابة خاطئة أو لم يجاوب، يتم تصفير الكومبو
            player.combo = 0;
        }
    });

    return players;
}

async function advanceOnlineQuestion() {
            if (!AppState.currentLobbyId) return;
            const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

            await runTransaction(db, async (transaction) => {
                const lobbyDoc = await transaction.get(lobbyRef);
                if (!lobbyDoc.exists()) return;

                const lobbyData = lobbyDoc.data();
                const oldIndex = lobbyData.currentQuestionIndex;

                let playersUpdate = scoreOnlineRound(lobbyData, oldIndex);
                
                transaction.update(lobbyRef, {
                    players: playersUpdate,
                    revealAnswerForIndex: oldIndex
                });
            }).then(() => {
                setTimeout(async () => {
                    const currentLobbyDoc = await getDoc(lobbyRef);
                    if (!currentLobbyDoc.exists()) return;
                    const currentLobbyData = currentLobbyDoc.data();
                    const questionIndex = currentLobbyData.currentQuestionIndex;

                    if (questionIndex >= currentLobbyData.questions.length - 1) {
                        // قبل إنهاء اللعبة، قم بتوزيع الجوائز
                        await finalizeOnlineGameAwards(currentLobbyData);
                        updateDoc(lobbyRef, { status: 'finished' }); 
                    } else {
                        updateDoc(lobbyRef, {
                            currentQuestionIndex: questionIndex + 1,
                            questionStartTime: serverTimestamp(),
                            revealAnswerForIndex: null
                        });
                    }
                }, 4000);
            });
        }

async function surrenderGame() {
            if (!AppState.currentLobbyId || !AppState.currentUser) return;
            const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

            showModal("تأكيد الاستسلام", "هل أنت متأكد أنك تريد الاستسلام؟", "نعم, استسلم", "إلغاء", async () => {
                try {
                    await runTransaction(db, async (transaction) => {
                        const lobbyDoc = await transaction.get(lobbyRef);
                        if (!lobbyDoc.exists()) throw "Lobby does not exist!";
                        
                        const lobbyData = lobbyDoc.data();
                        if (lobbyData.status !== 'in-progress') return;

                        if (lobbyData.type === '1v1') {
                            // في وضع 1 ضد 1, اللعبة تنتهي
                            transaction.update(lobbyRef, {
                                surrendered: { uid: AppState.currentUser.uid, name: AppState.playerProfile.name },
                                status: 'finished',
                            });
                            // سيتم منح الجائزة للفائز عند عرض شاشة النهاية
                        } else {
                            // في المنافسة الحاشدة, اللاعب يخرج فقط
                            const remainingPlayers = lobbyData.players.filter(p => p.uid !== AppState.currentUser.uid);
                            transaction.update(lobbyRef, { players: remainingPlayers });
                            // نعود به إلى القائمة الرئيسية
                            showScreen('main-menu-screen');
                        }
                    });
                } catch (error) {
                    console.error("Surrender failed:", error);
                    showModal("خطأ", "فشل في عملية الاستسلام.", null, "حسنًا");
                }
            });
        }

     async function finalizeOnlineGameAwards(lobbyData) {
    const batch = writeBatch(db);
    const finalPlayers = lobbyData.players;
    const sortedPlayers = [...finalPlayers].sort((a, b) => b.score - a.score);

    // --- توزيع جوائز المباريات العادية (لم تتغير) ---
    if (lobbyData.type === '1v1') {
        const winner = lobbyData.surrendered ? sortedPlayers.find(p => p.uid !== lobbyData.surrendered.uid) : sortedPlayers[0];
        const loser = lobbyData.surrendered ? sortedPlayers.find(p => p.uid === lobbyData.surrendered.uid) : sortedPlayers[1];
        if (winner && (!loser || winner.score > loser.score || lobbyData.surrendered)) {
            const winnerRef = doc(db, "players", winner.teleoptiId);
            batch.update(winnerRef, { score: increment(25), coins: increment(20), awards: arrayUnion("Botros Race Cup 🏆") });
        }
    } else if (lobbyData.type === 'massive') {
         const uniqueScores = [...new Set(sortedPlayers.map(p => p.score))].filter(s => s > 0).sort((a,b) => b-a);
         if (uniqueScores.length > 0) {
             sortedPlayers.filter(p => p.score === uniqueScores[0]).forEach(p => {
                 const playerRef = doc(db, "players", p.teleoptiId);
                 batch.update(playerRef, { score: increment(150), coins: increment(100), awards: arrayUnion("Botros Ultimate Cup 🥇 (1)") });
             });
         }
         if (uniqueScores.length > 1) {
             sortedPlayers.filter(p => p.score === uniqueScores[1]).forEach(p => {
                 const playerRef = doc(db, "players", p.teleoptiId);
                 batch.update(playerRef, { score: increment(100), coins: increment(75), awards: arrayUnion("Botros Ultimate Cup 🥈 (2)") });
             });
         }
         if (uniqueScores.length > 2) {
             sortedPlayers.filter(p => p.score === uniqueScores[2]).forEach(p => {
                 const playerRef = doc(db, "players", p.teleoptiId);
                 batch.update(playerRef, { score: increment(50), coins: increment(50), awards: arrayUnion("Botros Ultimate Cup 🥉 (3)") });
             });
         }
    }
    // --- نهاية جوائز المباريات العادية ---

    // ==========================================================
    // ✨ --- الجزء الجديد والمهم: منطق مباريات الاحتلال --- ✨
    // ==========================================================
    else if (lobbyData.type === 'conquest') {
        console.log("إنهاء مباراة احتلال...");
        const islandRef = doc(db, "island_state", lobbyData.islandId);

        // تجميع نقاط كل فريق
        const teams = {};
        finalPlayers.forEach(p => {
            if (p.teamId) {
                if (!teams[p.teamId]) teams[p.teamId] = 0;
                teams[p.teamId] += p.score;
            }
        });

        const sortedTeams = Object.entries(teams).sort((a, b) => b[1] - a[1]);

        if (sortedTeams.length > 0) {
            const winningTeamId = sortedTeams[0][0];
            const damage = 35; // الفريق الفائز يسبب 35 ضرر

            console.log(`الفريق الفائز ${winningTeamId} سبب ${damage} ضرر.`);
            // تحديث صحة الجزيرة بدلاً من "النفوذ"
            batch.update(islandRef, { hp: increment(-damage) });

            // تحديث إنجاز "محارب قديم" لكل المشاركين في المباراة
            finalPlayers.forEach(p => {
                const playerRef = doc(db, "players", p.teleoptiId);
                batch.update(playerRef, { "stats.conquestMatchesPlayed": increment(1) });
            });
        }
    }
    // --- نهاية منطق مباريات الاحتلال ---

    try {
        await batch.commit();
        console.log("تم توزيع الجوائز النهائية بنجاح.");
    } catch (error) {
        console.error("Failed to commit final awards:", error);
        
    }
}

// ==========================================================
// ✨ --- دالة الغارة الفردية الجديدة بالكامل --- ✨
// ==========================================================
async function startSoloRaid(target) {
    const islandId = target.dataset.islandId;
    if (!islandId) return;

    const islandData = GAME_CONFIG.islands.find(i => i.id === islandId);
    if (!islandData) return;

    // إظهار نافذة تحميل بسيطة
    showModal("تجهيز الغارة...", "جارِ تحميل الأسئلة، استعد!", null, "...");

    const questions = getQuestions('islands', islandData.category, 3); // سنجلب 3 أسئلة للغارة
    if (questions.length === 0) {
        return showModal("خطأ", "لا توجد أسئلة متاحة لهذه الجزيرة حالياً.", null, "حسنًا");
    }

    let damageDealt = 0;

    // سنستخدم حلقة (loop) لطرح الأسئلة واحداً تلو الآخر
    for (const question of questions) {
        // استخدام Promise لانتظار إجابة اللاعب
        const userAnsweredCorrectly = await new Promise(resolve => {
            let optionsHTML = '<div style="display:flex; flex-direction:column; gap:1rem;">';
            Object.entries(question.options).forEach(([key, text]) => {
                // key هو رقم الخيار, text هو نص الخيار
                const isCorrect = key === question.correct_answer;
                optionsHTML += `<button class="btn option-btn" onclick="this.closest('.modal').__resolve(${isCorrect})">${text}</button>`;
            });
            optionsHTML += '</div>';

            showModal(question.question, optionsHTML, null, "تخطي");

            // هذه خدعة بسيطة لربط دالة resolve بالنافذة المنبثقة
            document.querySelector('.modal').__resolve = resolve;
        });

        // إخفاء النافذة بعد الإجابة
        hideModal();

        if (userAnsweredCorrectly) {
            damageDealt += 2; // كل إجابة صحيحة تسبب 2 ضرر
            const islandRef = doc(db, "island_state", islandId);
            await updateDoc(islandRef, { hp: increment(-2) });
            // ========================> الكود الجديد الذي ستضيفه <========================
const islandDoc = await getDoc(islandRef);
const islandState = islandDoc.data();
if (islandState.hp <= 0) {
    // احتلال الجزيرة!
    await updateDoc(islandRef, {
        ownerTeamId: AppState.playerTeam.id,
        ownerTeamName: AppState.playerTeam.name,
        hp: islandState.maxHp // إعادة صحة الجزيرة بالكامل للمالك الجديد
    });
    // إرسال إشعار للجميع
    showModal("🎉 تم احتلال الجزيرة! 🎉", `فريق ${AppState.playerTeam.name} سيطر على ${islandData.name}!`, null, "رائع!");
    // يمكنك إضافة مكافأة هنا للفريق إذا أردت
    // await updateDoc(doc(db, "teams", AppState.playerTeam.id), { score: increment(100) });
}
// ========================> نهاية الكود الجديد <========================
            showToast("إجابة صحيحة! +2 ضرر!");
        } else {
            showToast("إجابة خاطئة! انتهت الغارة.");
            break; // إنهاء الغارة عند أول إجابة خاطئة
        }
         // انتظار بسيط بين الأسئلة
        await new Promise(res => setTimeout(res, 1500));
    }

    // عرض النتيجة النهائية للغارة
    showModal("اكتملت الغارة!", `لقد سببت ما مجموعه ${damageDealt} ضرر للجزيرة.`, null, "رائع!", () => {
        displayIslandConquestScreen(); // تحديث الخريطة لإظهار الضرر الجديد
    });
}

function displayGameOver(lobbyData) {
    showScreen('game-over-screen');
    // ✨ --- START: NEW LINE TO REFRESH PLAYER DATA --- ✨
    if(AppState.playerProfile?.id) {
        loadPlayerProfile(AppState.playerProfile.id); 
    }
    // ✨ --- END: NEW LINE TO REFRESH PLAYER DATA --- ✨

    const resultsContainer = document.getElementById('results-container');
    const resultsList = document.getElementById('results-list');

    const sortedPlayers = [...lobbyData.players].sort((a,b) => b.score - a.score);
    let winnerText = '<h2>انتهت المباراة بالتعادل!</h2>';

    if (lobbyData.surrendered?.name) {
        const winner = sortedPlayers.find(p => p.uid !== lobbyData.surrendered.uid);
        winnerText = winner ? `<h2>الفائز هو <span style="color:var(--accent-green);">${winner.name}</span> بعد استسلام ${lobbyData.surrendered.name}!</h2>` : '<h2>انتهت المباراة بالاستسلام.</h2>';
    } else if (sortedPlayers.length > 0 && (sortedPlayers.length === 1 || sortedPlayers[0].score > (sortedPlayers[1]?.score || -1))) {
        winnerText = `<h2>الفائز هو: <span style="color:var(--accent-green);">${sortedPlayers[0].name}</span></h2>`;
    }
    resultsContainer.innerHTML = winnerText;

    resultsList.innerHTML = sortedPlayers.map((player, index) => {
        return `<div class="list-item">
            <div class="item-info"><span class="item-rank">${index + 1}</span><span class="item-name">${player.medal || ''} ${player.name}</span></div>
            <span class="item-value">${player.score} نقطة</span>
        </div>`;
    }).join('');

    if (AppState.unsubscribeLobby) AppState.unsubscribeLobby();
    AppState.unsubscribeLobby = null;
    AppState.currentLobbyId = null;
}

// =================================================
        // ✨ دوال نظام الفرق (Team System) ✨
        // =================================================
        async function showTeamHub() {
            showScreen('team-hub-screen');
            const noTeamView = document.getElementById('no-team-view');
            const teamView = document.getElementById('team-view');
            if (!noTeamView || !teamView) return;

            if (!AppState.playerTeam) {
                noTeamView.style.display = 'block';
                teamView.style.display = 'none';
            } else {
                noTeamView.style.display = 'none';
                teamView.style.display = 'block';
                document.getElementById('team-name-title').innerHTML = `<i class='bx bxs-shield-alt-2'></i> ${AppState.playerTeam.name}`;
                document.getElementById('team-score').textContent = AppState.playerTeam.score || 0;
                document.getElementById('team-id-display').textContent = AppState.playerTeam.id;

                const membersList = document.getElementById('team-members-list');
                membersList.innerHTML = `<p>جار تحميل الأعضاء...</p>`;
                const q = query(collection(db, "players"), where("teamId", "==", AppState.playerTeam.id));
                const querySnapshot = await getDocs(q);
                const members = querySnapshot.docs.map(doc => doc.data());
                document.getElementById('team-member-count').textContent = members.length;
                // الخطوة 3: عرض الأدوار في قائمة الفريق
membersList.innerHTML = members.sort((a, b) => {
    // ترتيب القائمة بحيث يظهر القائد أولاً ثم المساعدين
    const rolesOrder = { 'Leader': 0, 'Co-Leader': 1, 'Member': 2 };
    return (rolesOrder[a.teamRole] || 2) - (rolesOrder[b.teamRole] || 2);
}).map(member => {
    const roleDisplay = member.teamRole ? `<span style="color: var(--accent-yellow); font-size: 0.8rem; margin-right: 8px;">[${member.teamRole}]</span>` : '';
    return `<div class="list-item">
                <div class="item-info">
                    <span class="item-name">${roleDisplay}${member.name}</span>
                </div>
                <span class="item-value">${member.score || 0} نقطة</span>
            </div>`;
}).join('');
                const requestsSection = document.getElementById('join-requests-section');
                const isLeader = AppState.playerTeam.leaderId === AppState.currentUser.uid;
                if (isLeader && requestsSection) {
                    requestsSection.style.display = 'block';
                    const requestsList = document.getElementById('join-requests-list');
                    const requests = AppState.playerTeam.joinRequests || [];
                    if (requests.length === 0) {
                        requestsList.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">لا توجد طلبات انضمام معلقة.</p>';
                    } else {
                        requestsList.innerHTML = requests.map(req => `
                            <div class="list-item">
                                <span class="item-name">${req.name}</span>
                                <div style="display:flex; gap:0.5rem;">
                                    <button class="btn btn-primary" data-action="accept-join-request" data-request='${JSON.stringify(req)}' style="width:auto; padding:0.5rem 1rem; font-size:0.8rem; background-color:var(--accent-green);">قبول</button>
                                    <button class="btn" data-action="reject-join-request" data-request='${JSON.stringify(req)}' style="width:auto; padding:0.5rem 1rem; font-size:0.8rem; background-color:var(--accent-red);">رفض</button>
                                </div>
                        </div>`).join('');
                    }
                } else if (requestsSection) {
                    requestsSection.style.display = 'none';
                }
            }
        }

        async function handleCreateTeam() {
            const name = document.getElementById('team-name-input')?.value.trim();
            const tag = document.getElementById('team-tag-input')?.value.trim().toUpperCase();
            if (!name || tag.length < 3) { return showModal("خطأ", "يجب إدخال اسم وشعار للفريق (3-5 حروف).", null, "حسنًا"); }
            const teamId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const teamRef = doc(db, "teams", teamId);
// الخطوة 7: تعديل طلب الانضمام لإرسال إشعار

            const playerRef = doc(db, "players", AppState.playerProfile.id);
            try {
                await runTransaction(db, async (t) => {
                    t.set(teamRef, { name, tag, leaderId: AppState.currentUser.uid, score: 0, createdAt: serverTimestamp(), membersCount: 1 });
                    // الخطوة 1: تعديل دالة إنشاء الفريق
// تعيين هوية الفريق ودور "القائد" لمنشئ الفريق
t.update(playerRef, { teamId: teamId, teamRole: 'Leader' });
                });
                await updatePlayerStat('createdTeam');
                await loadPlayerProfile(AppState.playerProfile.id);
                showTeamHub();
            } catch (error) {
                console.error("فشل إنشاء الفريق:", error);
                showModal("خطأ", "فشل إنشاء الفريق. يرجى المحاولة مرة أخرى.", null, "حسنًا");
            }
        }

        // الخطوة 4: تحديث دالة الانضمام للفريق
async function handleJoinTeam() {
    const teamIdInput = document.getElementById('team-id-input');
    if (!teamIdInput) return;
    
    const teamId = teamIdInput.value.trim().toUpperCase();
    
    if (teamId.length !== 6) { // أكواد الفرق الآن 6 حروف
        return showModal("خطأ", "كود الفريق يجب أن يتكون من 6 حروف.", null, "حسنًا");
    }

    // استدعاء الدالة التي ترسل طلب الانضمام
    await requestToJoinTeam(teamId);
}

        // الخطوة 1: تفعيل دالة مغادرة الفريق
function handleLeaveTeam() {
    // التأكد من وجود فريق لمغادرته أصلاً
    if (!AppState.playerTeam || !AppState.playerProfile) return;

    // سؤال اللاعب للتأكيد قبل المغادرة
    showModal('مغادرة الفريق', `هل أنت متأكد أنك تريد مغادرة فريق "${AppState.playerTeam.name}"؟`, 'نعم, غادر', 'إلغاء', async () => {
        
        // لا يمكن لقائد الفريق المغادرة، يجب عليه حل الفريق أو نقل القيادة أولاً (سنضيفها لاحقاً)
        if (AppState.playerTeam.leaderId === AppState.currentUser.uid) {
            return showModal("لا يمكن المغادرة", "قائد الفريق لا يمكنه المغادرة. يجب عليك حل الفريق أولاً.", null, "حسنًا");
        }

        const playerRef = doc(db, "players", AppState.playerProfile.id);
        const teamRef = doc(db, "teams", AppState.playerTeam.id);

        try {
            // تنفيذ العمليات معاً لضمان عدم حدوث خطأ
            await runTransaction(db, async (transaction) => {
                // تحديث ملف اللاعب: حذف هوية الفريق
                // تحديث ملف اللاعب: حذف هوية الفريق والدور أيضاً
transaction.update(playerRef, { teamId: null, teamRole: null });                // تحديث ملف الفريق: إنقاص عدد الأعضاء بمقدار 1
                transaction.update(teamRef, { membersCount: increment(-1) });
            });

            showToast("لقد غادرت الفريق بنجاح.");
            
            // إعادة تحميل بيانات اللاعب بعد التحديث
            await loadPlayerProfile(AppState.playerProfile.id);
            // عرض شاشة الفرق مرة أخرى (ستظهر الآن واجهة "لم تنضم لفريق")
            showTeamHub();

        } catch (error) {
            console.error("فشلت مغادرة الفريق:", error);
            showModal("خطأ", "حدث خطأ أثناء محاولة مغادرة الفريق.", null, "حسنًا");
        }
    });
}
        async function showTeamBrowser() {
            showScreen('team-browser-screen');
            const listContainer = document.getElementById('team-browser-list');
            if (!listContainer) return;
            listContainer.innerHTML = `<p>جارِ تحميل قائمة الفرق...</p>`;
            
            try {
                const teamsQuery = query(collection(db, "teams"), orderBy("score", "desc"));
                const snapshot = await getDocs(teamsQuery);
                const teams = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

                if (teams.length === 0) {
                    listContainer.innerHTML = '<p>لا توجد فرق متاحة حاليًا. كن أول من ينشئ فريقًا!</p>';
                    return;
                }

                listContainer.innerHTML = teams.map(team => {
                    const membersCount = team.membersCount || 0;
                    return `
                        <div class="list-item">
                            <div class="item-info">
                                <span class="item-name">${team.name} [${team.tag}]</span>
                                <span class="text-secondary" style="font-size:0.8rem;">(${membersCount} أعضاء)</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:1.5rem;">
                                <span class="item-value">${team.score || 0}</span>
                                <button class="btn btn-primary" data-action="request-to-join" data-team-id="${team.id}" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem;">طلب انضمام</button>
                            </div>
                        </div>`;
                }).join('');
            } catch (error) {
                console.error("Error fetching teams:", error);
                listContainer.innerHTML = '<p>حدث خطأ في جلب قائمة الفرق.</p>';
            }
        }

 // === قم باستبدال الدالة القديمة بالكامل بهذا الكود الجديد ===

async function requestToJoinTeam(teamId) {
    
    // 1. التحقق المبدئي: نتأكد أن اللاعب ليس في فريق بالفعل أو ليس لديه طلب معلق.
    if (AppState.playerProfile.teamId) return showToast("أنت بالفعل في فريق!");
    if (AppState.playerProfile.pendingRequestTo) return showToast("لديك طلب انضمام معلق بالفعل.");

    const teamRef = doc(db, "teams", teamId);
    const playerRef = doc(db, "players", AppState.playerProfile.id);

    try {
        // 2. التحقق من وجود الفريق: قبل إرسال الطلب، نتأكد من أن الكود الذي أدخله اللاعب صحيح وأن الفريق موجود.
        const teamDoc = await getDoc(teamRef);
        if (!teamDoc.exists()) {
            return showToast("هذا الفريق غير موجود.");
        }
        // نحصل على بيانات الفريق لنعرف من هو القائد الذي سنرسل له الإشعار
        const teamData = teamDoc.data();
        const leaderId = teamData.leaderId; 
        if (!leaderId) {
            return showToast("هذا الفريق ليس لديه قائد لتلقي الطلب.");
        }

        // 3. تنفيذ الطلب: نستخدم "Transaction" لضمان تنفيذ العمليتين معاً (تحديث الفريق واللاعب) أو فشلهما معاً.
        await runTransaction(db, async (transaction) => {
            const playerDoc = await transaction.get(playerRef);
            if (playerDoc.data().teamId || playerDoc.data().pendingRequestTo) throw new Error("Player already in a team or has a pending request.");

            const requestData = { uid: AppState.currentUser.uid, name: AppState.playerProfile.name, teleoptiId: AppState.playerProfile.id };
            
            transaction.update(teamRef, { joinRequests: arrayUnion(requestData) });
            transaction.update(playerRef, { pendingRequestTo: teamId });
        });

        // 4. إرسال الإشعار (المكان الصحيح): بعد التأكد من نجاح الطلب، نقوم بإنشاء مستند جديد في مجموعة "notifications"
        const notificationRef = collection(db, "notifications");
        await addDoc(notificationRef, {
            recipientId: leaderId, // نرسل الإشعار إلى القائد
            title: "طلب انضمام جديد",
            message: `اللاعب "${AppState.playerProfile.name}" يريد الانضمام إلى فريقك.`,
            isRead: false,
            timestamp: serverTimestamp(),
            type: 'join_request'
        });

        // 5. تحديث واجهة المستخدم: نُعلم اللاعب أن طلبه قد تم بنجاح.
        AppState.playerProfile.pendingRequestTo = teamId;
        showToast("تم إرسال طلب الانضمام بنجاح!");

    } catch (e) {
        // 6. في حالة حدوث أي خطأ: نعرض رسالة خطأ للمستخدم.
        console.error("Error requesting to join team: ", e);
        showToast(e.message || "حدث خطأ أثناء إرسال الطلب.");
    }
}

        async function handleJoinRequest(teamId, request, accept = true) {
            const playerRef = doc(db, "players", request.teleoptiId);
            const teamRef = doc(db, "teams", teamId);

            try {
                await runTransaction(db, async (transaction) => {
                    const teamDoc = await transaction.get(teamRef);
                    if (!teamDoc.exists) throw new Error("Team not found.");

                    const currentRequests = teamDoc.data().joinRequests || [];
                    const remainingRequests = currentRequests.filter(req => req.uid !== request.uid);
                    
                    transaction.update(teamRef, { joinRequests: remainingRequests });

                    if (accept) {
                        // الخطوة 2: تعديل دالة قبول الطلب
// تعيين هوية الفريق ودور "عضو" للاعب الجديد
transaction.update(playerRef, { teamId: teamId, pendingRequestTo: null, teamRole: 'Member' });
                        transaction.update(teamRef, { membersCount: increment(1) });
                    } else {
                        transaction.update(playerRef, { pendingRequestTo: null });
                    }
                });

                showToast(accept ? `تم قبول ${request.name} في الفريق!` : `تم رفض طلب ${request.name}.`);
                await loadPlayerProfile(AppState.playerProfile.id);
                showTeamHub();

            } catch (error) {
                console.error("Error handling join request:", error);
                showToast("حدث خطأ أثناء معالجة الطلب.");
            }
        }

// =================================================
        // ✨ دوال احتلال الجزر (Island Conquest) ✨
        // =================================================

// الخطوة 3.2: تحديث دالة عرض الجزر
// الخطوة 2: استخدام Grid لرسم الخريطة والجزر والسفينة
// الصق هذا الكود الجديد بالكامل مكان الكود القديم
// الصق هذه الدالة الجديدة بالكامل
// === قم باستبدال الدالة القديمة بالكامل بهذا الكود النهائي ===

// === قم باستبدال الدالة الحالية بالكامل بهذا الكود الخاص بالفقاعات ===

async function displayIslandConquestScreen() {
    showScreen('island-conquest-screen');
    const mapContainer = document.querySelector('#island-conquest-screen .map-container');
    if (!mapContainer) return;

    // إزالة أي جزر قديمة قبل رسم الجديدة
    mapContainer.innerHTML = '';

    const islandsConfig = GAME_CONFIG.islands;
    // جلب بيانات كل الجزر مرة واحدة من قاعدة البيانات
    const islandsStateSnapshot = await getDocs(collection(db, "island_state"));
    const islandsStates = {};
    islandsStateSnapshot.forEach(doc => {
        islandsStates[doc.id] = doc.data();
    });

    islandsConfig.forEach(islandData => {
        console.log(`[DEBUG] Checking Island ID: ${islandData.id}`, islandsStates[islandData.id]);
        // الحصول على بيانات الجزيرة الحالية من البيانات التي جلبناها
        const state = islandsStates[islandData.id] || { hp: 100, maxHp: 100, ownerTeamId: null, ownerTeamName: null };
        const islandDiv = document.createElement('div');
        islandDiv.className = 'island'; // الكلاس الأساسي

        // --- الجزء الجديد لتحديد لون الجزيرة ---
        if (state.ownerTeamId) {
            if (state.ownerTeamId === AppState.playerTeam?.id) {
                islandDiv.classList.add('owned-by-me'); // إضافة كلاس "ملكي"
            } else {
                islandDiv.classList.add('owned-by-enemy'); // إضافة كلاس "عدو"
            }
        } else {
            islandDiv.classList.add('neutral'); // إضافة كلاس "محايد"
        }
        // --- نهاية الجزء الجديد ---

        // تطبيق الموقع والحركة العشوائية
        Object.assign(islandDiv.style, islandData.style);
        islandDiv.style.animationDelay = `${Math.random() * 2.5}s`;

        // إضافة كلاس "مستهدف" إذا كانت هذه هي الجزيرة المستهدفة
        if (AppState.playerTeam && AppState.playerTeam.currentTarget === islandData.id) {
            islandDiv.classList.add('targeted-by-my-team');
        }

        // --- الجزء الجديد لحساب وعرض شريط الصحة ---
        const hpPercent = (state.hp / (state.maxHp || 100)) * 100;
        const hpBarHTML = `
            <div class="island-hp-bar-container">
                <div class="island-hp-bar" style="width: ${hpPercent}%;"></div>
            </div>
        `;
        // --- نهاية جزء شريط الصحة ---

        // بناء محتوى الجزيرة بالكامل
        islandDiv.innerHTML = `
            <div class="island-icon"><i class='bx ${islandData.icon}'></i></div>
            <div class="island-name">${islandData.name}</div>
            ${state.ownerTeamName ? `<div class="island-owner">${state.ownerTeamName}</div>` : ''}
            ${hpBarHTML}
        `;

        // إضافة البيانات اللازمة للضغط على الجزيرة
        islandDiv.dataset.action = "show-island-details";
        islandDiv.dataset.islandId = islandData.id;

        mapContainer.appendChild(islandDiv);
    });
}
// ==========================================================
// ✨ --- الدالة الجديدة المفقودة: عرض شاشة الهجوم --- ✨
// ==========================================================
function showIslandAttackScreen(islandId, islandData) {
    showScreen('island-attack-screen');
    const titleEl = document.getElementById('island-attack-title');
    if (titleEl) {
        titleEl.innerHTML = `<i class='bx bxs-crosshair'></i> الهجوم على ${islandData.name}`;
    }

    // خطوة مهمة: نمرر هوية الجزيرة إلى زر الغارة الفردية
    // حتى تعرف دالة startSoloRaid أي جزيرة يتم الهجوم عليها
    const soloRaidCard = document.querySelector('#island-attack-screen [data-action="start-solo-raid"]');
    if (soloRaidCard) {
        soloRaidCard.dataset.islandId = islandId;
    }
}
// === قم باستبدال الدالة الحالية بالكامل بهذا الكود الصحيح ===

async function showIslandDetails(target) {
    const islandId = target.dataset.islandId;
    if (!islandId) return;

    const islandData = GAME_CONFIG.islands.find(i => i.id === islandId);
    if (!islandData) return;

    // -- التحقق إذا كانت هذه هي الجزيرة المستهدفة، للانتقال لشاشة الهجوم --
    const isTargetedByMyTeam = AppState.playerTeam && AppState.playerTeam.currentTarget === islandId;
    if (isTargetedByMyTeam) {
        showIslandAttackScreen(islandId, islandData);
        return; 
    }

    // -- إذا لم تكن الهدف، أظهر التفاصيل الكاملة في نافذة منبثقة --
    const islandStateRef = doc(db, "island_state", islandId);
    const islandStateDoc = await getDoc(islandStateRef);

    let currentOwner = "لا يوجد حاليًا";
    let influenceListHTML = '<p style="text-align:center;color:var(--text-secondary);">لا توجد فرق تتنافس حاليًا.</p>';

    if (islandStateDoc.exists()) {
        const state = islandStateDoc.data();
        if (state.ownerTeamName) {
            currentOwner = state.ownerTeamName;
        }

        if (state.influence && Object.keys(state.influence).length > 0) {
            const sortedInfluence = Object.entries(state.influence).sort((a, b) => b[1] - a[1]);
            influenceListHTML = sortedInfluence.map(([teamId, points]) => {
                const teamTag = AppState.allTeams?.[teamId]?.tag || teamId.substring(0, 4);
                return `<div class="list-item" style="padding:0.5rem;"><span class="item-name">فريق [${teamTag}]</span> <span class="item-value">${points}</span></div>`;
            }).join('');
        }
    }

    let modalBody = `
        <p style="margin-bottom:1.5rem;"><strong>فئة الأسئلة:</strong> ${islandData.category}</p>
        <div style="text-align:right;">
            <p><strong>الفريق المسيطر:</strong> ${currentOwner}</p>
            <hr style="border-color: var(--border-glass); margin: 1rem 0;">
            <h4 style="margin-bottom:0.5rem;">الفرق المتنافسة حاليًا:</h4>
            <div class="list-container" style="max-height: 150px; overflow-y: auto;">${influenceListHTML}</div>
        </div>
    `;

    const isLeader = AppState.playerTeam && AppState.playerTeam.leaderId === AppState.currentUser.uid;
    const hasTarget = AppState.playerTeam && AppState.playerTeam.currentTarget;

    if (isLeader && !hasTarget) {
        showModal(islandData.name, modalBody, "استهداف هذه الجزيرة", "إغلاق", () => {
            targetIsland(islandId);
        });
    } else {
        if (!isLeader && AppState.playerTeam && !hasTarget) {
            modalBody += `<p style="color:var(--text-secondary); margin-top:1rem; font-weight:bold;">قائد فريقك لم يحدد هدفًا بعد.</p>`;
        }
        showModal(islandData.name, modalBody, null, "حسنًا");
    }
}

        async function targetIsland(islandId) {
            if (!AppState.playerTeam) return showToast("يجب أن تكون في فريق لاستهداف جزيرة!");
            const teamRef = doc(db, "teams", AppState.playerTeam.id);
            try {
                await updateDoc(teamRef, { currentTarget: islandId });
                if(AppState.playerTeam) AppState.playerTeam.currentTarget = islandId; 
                showToast(`تم تحديد الهدف! فريقك الآن يهاجم ${GAME_CONFIG.islands.find(i => i.id === islandId).name}`);
                displayIslandConquestScreen(); 
            } catch (error) {
                console.error("Error targeting island: ", error);
                showToast("فشل في تحديد الهدف.");
            }
        }
async function endConquestSeason() {
        console.log("بدء عملية إنهاء موسم الإحتلال...");
        const islandsStateQuery = query(collection(db, "island_state"));
        const teamsQuery = query(collection(db, "teams"));
        
        try {
            const [islandsSnapshot, teamsSnapshot] = await Promise.all([getDocs(islandsStateQuery), getDocs(teamsQuery)]);
            const batch = writeBatch(db);

            const teamsData = {};
            teamsSnapshot.forEach(doc => {
                teamsData[doc.id] = doc.data();
            });

            // معالجة كل جزيرة على حدة
            for (const islandDoc of islandsSnapshot.docs) {
                const islandId = islandDoc.id;
                const islandState = islandDoc.data();
                
                if (!islandState.influence || Object.keys(islandState.influence).length === 0) {
                    console.log(`لا يوجد تنافس على ${islandId}، تم التجاوز.`);
                    continue;
                }

                const sortedInfluence = Object.entries(islandState.influence).sort((a, b) => b[1] - a[1]);
                const winningTeamId = sortedInfluence[0][0];
                const winningTeamName = teamsData[winningTeamId]?.name || "فريق غير معروف";
                
                console.log(`الفائز بجزيرة ${islandId} هو فريق ${winningTeamName}`);

                // تحديث بيانات الجزيرة: المالك الجديد وتصفير نقاط السيطرة
                const islandRef = doc(db, "island_state", islandId);
                batch.update(islandRef, {
                    ownerTeamId: winningTeamId,
                    ownerTeamName: winningTeamName,
                    influence: {} // تصفير النقاط للموسم الجديد
                });

                // إضافة نقاط ومكافآت للفريق الفائز
                const teamRef = doc(db, "teams", winningTeamId);
                batch.update(teamRef, {
                    score: increment(500) // مكافأة احتلال جزيرة
                });

                // تحديث إنجازات أعضاء الفريق الفائز
                const playersQuery = query(collection(db, "players"), where("teamId", "==", winningTeamId));
                const playersSnapshot = await getDocs(playersQuery);
                playersSnapshot.forEach(playerDoc => {
                    const playerRef = doc(db, "players", playerDoc.id);
                    batch.update(playerRef, { 
                        stats: { 
                            islandsConquered: increment(1),
                            citadelConquered: increment(islandId === 'citadel' ? 1 : 0)
                        }
                    });
                });
            }

            // تصفير الهدف الحالي لكل الفرق
            teamsSnapshot.forEach(teamDoc => {
                const teamRef = doc(db, "teams", teamDoc.id);
                batch.update(teamRef, { currentTarget: null });
            });

            await batch.commit();
            showModal("انتهى الموسم!", "تم تحديد الفائزين بالجزر بنجاح وبدء موسم جديد.", null, "رائع!");
            console.log("تم إنهاء الموسم بنجاح!");

        } catch (error) {
            console.error("حدث خطأ أثناء إنهاء الموسم:", error);
            showModal("خطأ فادح", "حدث خطأ أثناء معالجة نهاية الموسم.");
        }
    }
    // =================================================
// ✨ دوال الدردشة (Chat System) ✨
// =================================================

function showChatScreen() {
    showScreen('chat-screen');
    const messagesContainer = document.getElementById('chat-messages-container');

    // إلغاء أي استماع سابق للدردشة لتجنب التكرار
    if (AppState.unsubscribeChat) AppState.unsubscribeChat();

    const q = query(collection(db, "chat_messages"), orderBy("timestamp", "desc"), limit(50));

    AppState.unsubscribeChat = onSnapshot(q, (querySnapshot) => {
        if (!messagesContainer) return;
        messagesContainer.innerHTML = ''; // مسح الرسائل القديمة قبل عرض الجديدة

        // onSnapshot's result is already in reverse chronological order.
        // We process it as is and use flex-direction: column-reverse in CSS to show the newest at the bottom.
        querySnapshot.docs.forEach(doc => {
            const msg = doc.data();
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';

            // تحديد إذا كانت الرسالة مني أم من شخص آخر
            if (msg.senderId === AppState.currentUser.uid) {
                msgEl.classList.add('my-message');
            } else {
                msgEl.classList.add('other-message');
            }

            const teamTag = msg.senderTeamTag ? `<span class="team-tag" style="font-size:0.7rem;">[${msg.senderTeamTag}]</span>` : '';
            msgEl.innerHTML = `
                <div class="message-meta">${teamTag} ${msg.senderName}</div>
                <div class="message-content">${msg.text}</div>
            `;
            messagesContainer.prepend(msgEl); // Use prepend to add new messages to the top of the reversed container
        });
    });
}

async function sendChatMessage(e) {
    const input = document.getElementById('chat-message-input');
    if (!input) return;
    const text = input.value.trim();
    if (text === '') return;

    const message = {
        text: text,
        senderId: AppState.currentUser.uid,
        senderName: AppState.playerProfile.name,
        senderTeamTag: AppState.playerTeam?.tag || null,
        timestamp: serverTimestamp()
    };

    try {
        await addDoc(collection(db, "chat_messages"), message);
        input.value = ''; // تفريغ حقل الإدخال بعد الإرسال
        input.focus();
    } catch (error) {
        console.error("Error sending message: ", error);
        showToast("فشل إرسال الرسالة.");
    }
}
        // =================================================
        // ✨ دوال نظام الموسيقى (Music System) ✨
        // =================================================
        
        function playNextTrack() {
            AppState.currentTrackIndex++;
            if (AppState.currentTrackIndex >= GAME_CONFIG.musicPlaylist.length) { AppState.currentTrackIndex = 0; }
            AppState.musicPlayer.src = GAME_CONFIG.musicPlaylist[AppState.currentTrackIndex];
            AppState.musicPlayer.play().catch(e => console.error("Autoplay was prevented.", e));
        }

        function playPreviousTrack() {
    AppState.currentTrackIndex--;
    if (AppState.currentTrackIndex < 0) {
        AppState.currentTrackIndex = GAME_CONFIG.musicPlaylist.length - 1; // للرجوع لآخر أغنية
    }
    AppState.musicPlayer.src = GAME_CONFIG.musicPlaylist[AppState.currentTrackIndex];
    if (!AppState.isMuted) AppState.musicPlayer.play();
}


        function toggleMusic() {
            if (!AppState.musicPlayer) {
                AppState.musicPlayer = new Audio();
                AppState.musicPlayer.src = GAME_CONFIG.musicPlaylist[AppState.currentTrackIndex];
                AppState.musicPlayer.addEventListener('ended', playNextTrack);
            }
            AppState.isMuted = !AppState.isMuted;
            const muteBtn = document.getElementById('mute-btn');
            if (AppState.isMuted) {
                AppState.musicPlayer.pause();
                if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-mute'></i>";
            } else {
                AppState.musicPlayer.play().catch(() => {
                    AppState.isMuted = true;
                    if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-mute'></i>";
                    showModal("تنبيه", "المتصفح يمنع التشغيل التلقائي. اضغط على زر الصوت مرة أخرى لبدء الموسيقى.", null, "حسنًا");
                });
                if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-full'></i>";
            }
        }

        // =================================================
        // ✨ دوال لوحة الصدارة (Leaderboard) ✨
        // =================================================


        function getPlayerLevelInfo(score = 0) {
            const calculatedLevel = Math.floor(score / 500) + 1;
            const levelColors = ['#94a3b8', '#3b82f6', '#22c55e', '#facc15', '#ef4444', '#8b5cf6', '#ec4899'];
            const color = levelColors[Math.min(Math.floor(calculatedLevel / 10), levelColors.length - 1)];
            return { level: calculatedLevel, color: color };
        }

        async function showLeaderboards(type = 'individual') {
            showScreen('leaderboard-screen');
            const individualPill = document.getElementById('pills-individual');
            const teamsPill = document.getElementById('pills-teams');
            const listContainer = document.getElementById('leaderboard-list');
            if (!individualPill || !teamsPill || !listContainer) return;
            listContainer.innerHTML = `<p>جار تحميل البيانات...</p>`;
            individualPill.classList.toggle('active', type === 'individual');
            teamsPill.classList.toggle('active', type === 'teams');
            if (type === 'individual') {
                const q = query(collection(db, "players"), orderBy("score", "desc"), limit(50));
                const snapshot = await getDocs(q);
                const players = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                listContainer.innerHTML = players.length ? players.map((p, i) => {
    const { level, color } = getPlayerLevelInfo(p.score);
    const medals = (p.awards || []).filter(award => award.includes('Cup')).join(' '); // عرض الكؤوس فقط
    return `<div class="list-item ${p.id === AppState.playerProfile.id ? 'my-rank' : ''}">
        <div class="item-info">
            <span class="item-rank">${i + 1}</span>
            <div class="player-details">
                <span class="item-name">${p.name}</span>
                <span class="player-level" style="background-color: ${color};">Lvl ${level}</span>
                <span class="player-medals">${medals}</span>
            </div>
        </div>
        <span class="item-value">${p.score || 0}</span>
    </div>`;
}).join('') : '<p style="text-align:center;">لا يوجد لاعبون لعرضهم.</p>';

                const isPlayerInTop50 = players.some(p => p.id === AppState.playerProfile.id);
                if (!isPlayerInTop50 && AppState.playerProfile.score >= 0) {
                    const higherRankQuery = query(collection(db, "players"), where("score", ">", AppState.playerProfile.score || 0));
                    const higherRankSnapshot = await getDocs(higherRankQuery);
                    const myRank = higherRankSnapshot.size + 1;
                    const { level, color } = getPlayerLevelInfo(AppState.playerProfile.score);
                    const medals = (AppState.playerProfile.awards || []).join(' ');
                    const myRankHTML = `<div class="list-separator"></div><div class="list-item my-rank"><div class="item-info"><span class="item-rank">${myRank}</span><div class="player-details"><span class="item-name">${AppState.playerProfile.name} (أنت)</span><span class="player-level" style="background-color: ${color};">Lvl ${level}</span><span class="player-medals">${medals}</span></div></div><span class="item-value">${AppState.playerProfile.score || 0}</span></div>`;
                    listContainer.innerHTML += myRankHTML;
                }
            } else {
                const q = query(collection(db, "teams"), orderBy("score", "desc"), limit(50));
                const snapshot = await getDocs(q);
                const teams = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                listContainer.innerHTML = teams.length ? teams.map((t, i) => `<div class="list-item"><div class="item-info"><span class="item-rank">${i + 1}</span><span class="item-name">${t.name} [${t.tag}]</span></div><span class="item-value">${t.score || 0}</span></div>`).join('') : '<p style="text-align:center;">لا توجد فرق لعرضها.</p>';
            }
        }

        // =================================================
        // ✨ NEW: دوال نظام الإنجازات (Achievements) ✨
        // =================================================

        async function updatePlayerStat(stat, value = 1) {
            if (!AppState.playerProfile || !AppState.playerProfile.id) return;
            const playerRef = doc(db, "players", AppState.playerProfile.id);
            try {
                const statKey = `stats.${stat}`;
                await updateDoc(playerRef, { [statKey]: increment(value) });
                if (!AppState.playerProfile.stats) AppState.playerProfile.stats = {};
                AppState.playerProfile.stats[stat] = (AppState.playerProfile.stats[stat] || 0) + value;
                await checkAndGrantAchievements();
            } catch (e) { console.error("Failed to update stat: ", e); }
        }

        async function checkAndGrantAchievements() {
            const profile = AppState.playerProfile;
            if (!profile || !profile.stats) return;
            
            const myAchievements = profile.unlockedAchievements || [];
            let newAchievementsFound = false;
            const batch = writeBatch(db);
            const playerRef = doc(db, "players", profile.id);
            let pointsToAdd = 0;

            // Check level-based achievements
            const { level } = getPlayerLevelInfo(profile.score);
            if (level >= 10 && !myAchievements.includes('reach_level_10')) {
                await updatePlayerStat('level10Reached');
            }
            if (level >= 25 && !myAchievements.includes('reach_level_25')) {
                await updatePlayerStat('level25Reached');
            }

            // Check other stat-based achievements
            for (const [key, ach] of Object.entries(GAME_CONFIG.achievements)) {
                if (!myAchievements.includes(key)) {
                    const statValue = profile.stats[ach.stat] || 0;
                    if (statValue >= ach.target) {
                        myAchievements.push(key);
                        newAchievementsFound = true;
                        pointsToAdd += ach.rewardPoints;
                        batch.update(playerRef, { unlockedAchievements: arrayUnion(key) });
                        showToast(`إنجاز جديد: ${ach.name}!`);
                    }
                }
            }

            if (newAchievementsFound) {
                batch.update(playerRef, { score: increment(pointsToAdd) });
                await batch.commit().catch(console.error);
                await loadPlayerProfile(profile.id); // Reload to get updated score and achievements
            }
        }

        function showAchievementsScreen() {
            showScreen('achievements-screen');
            const list = document.getElementById('achievements-list');
            if (!list) return;
            const myAchievements = AppState.playerProfile.unlockedAchievements || [];
            list.innerHTML = Object.entries(GAME_CONFIG.achievements).map(([key, ach]) => {
                const unlocked = myAchievements.includes(key);
                const currentProgress = AppState.playerProfile.stats?.[ach.stat] || 0;
                const progressPercent = Math.min((currentProgress / ach.target) * 100, 100);
                
                return `
                    <div class="achievement-item ${unlocked ? 'unlocked' : ''}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div>
                            <h3 style="margin:0;">${ach.name}</h3>
                            <p style="color:var(--text-secondary); margin:0.25rem 0;">${ach.description}</p>
                            <p style="color:var(--accent-yellow); margin:0.5rem 0 0 0; font-weight:bold;">+${ach.rewardPoints} نقطة</p>
                            ${!unlocked ? `
                                <div class="achievement-progress">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <p style="text-align: center; font-size: 0.8rem; margin-top: 0.25rem;">${currentProgress} / ${ach.target}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        // =================================================
        // ✨ مشغل الأحداث الرئيسي (Main App Runner) ✨
        // =================================================

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                AppState.currentUser = user;
                        listenForBroadcast(); // استدعاء دالة البث هنا

                if (user) {
                    const rememberedId = localStorage.getItem('triviaTeleoptiId');
                    if (rememberedId) { showScreen('loading-screen'); loadPlayerProfile(rememberedId);listenForNotifications(); } 
                    
                    else { showScreen('registration-screen'); repopulateLoginFields(); }
                } else {
                    showScreen('registration-screen');
                    repopulateLoginFields();
                }
            });

const actions = {
    'login': (target) => handleLogin(target),
    'logout': handleLogout,
    'toggle-music': toggleMusic,
    'play-next': playNextTrack,
    'play-previous': playPreviousTrack,
    'modal-cancel': hideModal,
    'modal-confirm': () => { if (AppState.modalCallback) AppState.modalCallback(); },
    'back-to-main': () => { updateMainMenu(); showScreen('main-menu-screen'); },
    'back-to-levels': () => displayLevels(AppState.singlePlayerState.currentTier),
    'show-single-player': displayTiers,
    'show-team-hub': showTeamHub,
    'show-create-team': () => showScreen('create-team-screen'),
    'show-join-team': () => showScreen('join-team-screen'),
    'submit-create-team': handleCreateTeam,
    'submit-join-team': handleJoinTeam,
    'leave-team': handleLeaveTeam,
    'browse-teams': showTeamBrowser,
    'show-inbox': showInboxScreen,
    'mark-notif-read': (target) => {
        const notifId = target.dataset.notifId;
        if(notifId) {
            const notifRef = doc(db, "notifications", notifId);
            updateDoc(notifRef, { isRead: true });
        }
    },
    'request-to-join': (target) => {
        const teamId = target.dataset.teamId;
        if (teamId) requestToJoinTeam(teamId);
    },
    'accept-join-request': (target) => {
        const request = JSON.parse(target.dataset.request);
        handleJoinRequest(AppState.playerTeam.id, request, true);
    },
    'reject-join-request': (target) => {
        const request = JSON.parse(target.dataset.request);
        handleJoinRequest(AppState.playerTeam.id, request, false);
    },
    'show-leaderboards': () => showLeaderboards('individual'),
    'show-individual-leaderboard': () => showLeaderboards('individual'),
    'show-teams-leaderboard': () => showLeaderboards('teams'),
    'show-achievements': showAchievementsScreen,
    'show-island-conquest': displayIslandConquestScreen,
    'show-island-details': (target) => showIslandDetails(target),
    'start-solo-raid': (target) => startSoloRaid(target),
    'show-chat': showChatScreen,
    'show-online-menu': () => showScreen('online-menu-screen'),
    'create-1v1-lobby': () => createLobby('1v1'),
    'create-massive-lobby': () => createLobby('massive'),
    'create-vacancy-lobby': () => createLobby('vacancy'),
    'dev-add-coins': () => addMyCoins(500), // <-- أضف هذا السطر
    'show-join-lobby': () => showScreen('join-lobby-screen'),
    'submit-join-lobby': () => {
        const code = document.getElementById('lobby-code-input')?.value.trim();
        if (code) joinLobby(code); else showModal("خطأ", "الرجاء إدخال كود المنافسة.");
    },
    'start-game': startGame,
    'leave-lobby': leaveLobby,
    'surrender-game': surrenderGame,
    'send-chat-message': sendChatMessage,
    'start-conquest-match': () => createLobby('conquest'),
    
    // ✨ --- START: SWAP SYSTEM ACTIONS --- ✨
    'show-swap-finder': () => showSwapFinderScreen(),
    'show-select-swap-type': () => showScreen('select-swap-type-screen'),
    'show-create-off-swap': () => showScreen('create-off-swap-screen'),
    'show-create-shift-swap': () => showScreen('create-shift-swap-screen'),
    'post-off-swap': () => handlePostSwap('off'),
    'post-shift-swap': () => handlePostSwap('shift'),
    
    'contact-swapper': (target) => handleContactSwapper(target.dataset.posterId, target.dataset.swapId),
    // ✨ --- END: SWAP SYSTEM ACTIONS --- ✨
'use-ability': (target) => handleUseAbility(target.dataset.ability, target),

'select-opponent': (target) => {
    const opponentId = target.dataset.opponentId;
    const abilityKey = target.dataset.abilityKey;
    hideModal();
    confirmAndApplyAbility(abilityKey, opponentId);
}

};

document.body.addEventListener('click', (e) => {
    const target = e.target.closest('[data-action]');
    if (target && actions[target.dataset.action]) {
        actions[target.dataset.action](target);
    }
});

// =================================================
// ✨ NEW: Swap Finder System Functions ✨
// =================================================

function showSwapFinderScreen() {
    showScreen('swap-finder-screen');
    // في الخطوة التالية سنقوم بجلب الطلبات من قاعدة البيانات وعرضها هنا
    console.log("Showing the Swap Finder screen.");
}

async function handlePostSwap(type) {
    if (type === 'off') {
        console.log("Attempting to post an OFF DAY swap.");
    } else if (type === 'shift') {
        console.log("Attempting to post a SHIFT swap.");
    }
    showModal("قيد الإنشاء", "سيتم تفعيل منطق النشر في الخطوة التالية!");
}

async function handleContactSwapper(posterId, swapId) {
    // سيتم برمجة هذا الجزء لاحقاً
    console.log(`Player wants to contact poster ${posterId} about swap ${swapId}`);
    showModal("بدء التواصل", "هل أنت متأكد أنك مهتم بهذا التبادل؟ سيتم إرسال إشعار لصاحب الطلب.", "نعم، أرسل اهتمامي", "إلغاء", () => {
        showToast("تم إرسال اهتمامك بنجاح!");
    });
}

// --- دالة لتشغيل الأنيميشن على الشاشة ---
function playAbilityAnimation(abilityKey) {
    const ability = GAME_CONFIG.special_abilities[abilityKey];
    if (!ability) return;

    const overlay = document.getElementById('animation-overlay');
    const iconEl = document.getElementById('animation-icon');
    if (!overlay || !iconEl) return;

    iconEl.className = `ability-animation-icon bx ${ability.icon}`; // تغيير الأيقونة
    overlay.classList.add('show'); // إظهار الحركة

    // إخفاء الحركة بعد ثانيتين
    setTimeout(() => {
        overlay.classList.remove('show');
    }, 2000);
}

// --- الدالة الرئيسية التي يتم استدعاؤها عند الضغط على زر القدرة ---
// --- الدالة الرئيسية التي يتم استدعاؤها عند الضغط على زر القدرة (النسخة المُصلحة) ---
async function handleUseAbility(abilityKey, abilityButton) {
    if (!AppState.currentLobbyId || !AppState.playerProfile || abilityButton.disabled) return;

    const lobbyDoc = await getDoc(doc(db, "lobbies", AppState.currentLobbyId));
    if (!lobbyDoc.exists()) return;
    const lobbyData = lobbyDoc.data();

    if (lobbyData.players[lobbyData.turnIndex].uid !== AppState.currentUser.uid) {
        return showToast("ليس دورك لاستخدام قدرة!");
    }

    const ability = GAME_CONFIG.special_abilities[abilityKey];
    if (!ability) return;

    // تعطيل الزر مؤقتاً لمنع الضغطات المتكررة
    abilityButton.disabled = true;

    if (ability.type === 'attack') {
        const opponents = lobbyData.players.filter(p => p.uid !== AppState.currentUser.uid);
        if (opponents.length === 0) {
            abilityButton.disabled = false; // إعادة تفعيل الزر
            return showToast("لا يوجد خصوم لاستخدام القدرة عليهم.");
        }

        let opponentsHTML = '<div style="display:flex; flex-direction:column; gap:1rem;">';
        opponents.forEach(opp => {
            // لاحظ إضافة data-ability-key هنا
            opponentsHTML += `<button class="btn option-btn" data-action="select-opponent" data-opponent-id="${opp.uid}" data-ability-key="${abilityKey}">${opp.name}</button>`;
        });
        opponentsHTML += '</div>';

        showModal(`اختر الهدف لقدرة "${ability.name}"`, opponentsHTML, null, "إلغاء", () => {
            abilityButton.disabled = false; // أعد تفعيل الزر إذا ألغى المستخدم
        });

    } else { // إذا كانت قدرة مساعدة (lifeline)
        confirmAndApplyAbility(abilityKey, null);
    }
}

// دالة جديدة للتأكيد النهائي وتطبيق القدرة
// دالة جديدة للتأكيد النهائي وتطبيق القدرة (النسخة المُصلحة)
async function confirmAndApplyAbility(abilityKey, targetId) {
    const ability = GAME_CONFIG.special_abilities[abilityKey];
    const message = targetId 
        ? `هل أنت متأكد أنك تريد استخدام قدرة "${ability.name}" على اللاعب المستهدف؟`
        : `هل أنت متأكد أنك تريد استخدام قدرة "${ability.name}"؟`;

    showModal("تأكيد استخدام القدرة", message, "نعم، استخدمها", "إلغاء", async () => {
        playAbilityAnimation(abilityKey);

        const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);
        const lobbyDoc = await getDoc(lobbyRef);
        if (!lobbyDoc.exists()) return;
        let lobbyData = lobbyDoc.data();

        // استدعاء الدالة المنطقية المناسبة بناءً على نوع القدرة
        switch (abilityKey) {
            case 'skip_turn':
                await applySkipTurn(lobbyRef, lobbyData, targetId);
                break;
            case 'reverse_turn':
                await applyReverseTurn(lobbyRef, lobbyData);
                break;
            case 'fiery_question':
                await applyFieryQuestion(lobbyRef, lobbyData, targetId);
                break;
            case 'trick_question':
                await applyTrickQuestion(lobbyRef, lobbyData, targetId);
                break;
            case '50_50':
                await apply5050(lobbyRef, lobbyData);
                break;
            case 'swap_question':
                await applySwapQuestion(lobbyRef, lobbyData);
                break;
        }
    });
}
// =================================================
// ✨ Special Abilities Logic Functions (النسخة الكاملة) ✨
// =================================================

// --- منطق حذف إجابتين ---
async function apply5050(lobbyRef, lobbyData) {
    const question = lobbyData.questions[lobbyData.currentQuestionIndex];
    const optionsContainer = document.querySelector('#vacancy-match-screen #options-grid');
    if (!question || !optionsContainer) return;

    let wrongAnswers = Object.keys(question.options).filter(key => key !== question.correct_answer);
    wrongAnswers.sort(() => 0.5 - Math.random()); // خلط الإجابات الخاطئة

    const answersToRemove = wrongAnswers.slice(0, 2);

    optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
        const btnKey = Object.keys(question.options).find(key => question.options[key] === btn.textContent);
        if (answersToRemove.includes(btnKey)) {
            btn.disabled = true;
            btn.style.opacity = '0.3';
        }
    });

    // إزالة القدرة من اللاعب في قاعدة البيانات
    const me = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);
    const myNewAbilities = me.abilities.filter(a => a !== '50_50');
    const updatedPlayers = lobbyData.players.map(p => p.uid === me.uid ? { ...p, abilities: myNewAbilities } : p);
    await updateDoc(lobbyRef, { players: updatedPlayers, lastAbilityUsed: '50_50' });
    showToast("تم حذف إجابتين!");
}

// --- منطق تبديل السؤال ---
async function applySwapQuestion(lobbyRef, lobbyData) {
    const me = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);
    const currentLevel = me.rankIndex + 1;
    const currentQuestionId = lobbyData.questions[lobbyData.currentQuestionIndex].id;

    // البحث عن سؤال بديل من نفس المستوى لم يتم استخدامه
    const newQuestion = GAME_CONFIG.vacancy_questions.find(q => q.level === currentLevel && q.id !== currentQuestionId);

    if (newQuestion) {
        // إضافة السؤال الجديد إلى قائمة أسئلة اللوبي إذا لم يكن موجوداً
        if (!lobbyData.questions.some(q => q.id === newQuestion.id)) {
            lobbyData.questions.push(newQuestion);
        }
        
        const myNewAbilities = me.abilities.filter(a => a !== 'swap_question');
        const updatedPlayers = lobbyData.players.map(p => p.uid === me.uid ? { ...p, abilities: myNewAbilities } : p);

        await updateDoc(lobbyRef, {
            players: updatedPlayers,
            questions: lobbyData.questions, // تحديث قائمة الأسئلة
            currentQuestionIndex: lobbyData.questions.findIndex(q => q.id === newQuestion.id),
            lastAbilityUsed: 'swap_question'
        });
        showToast("تم تبديل السؤال!");
    } else {
        showToast("عذراً، لا توجد أسئلة بديلة متاحة.");
    }
}

// --- منطق تخطي دور لاعب معين ---
async function applySkipTurn(lobbyRef, lobbyData, targetId) {
    const me = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);
    const myNewAbilities = me.abilities.filter(a => a !== 'skip_turn');
    const targetPlayer = lobbyData.players.find(p => p.uid === targetId);

    if (!targetPlayer) return showToast("لم يتم العثور على اللاعب المستهدف.");

    // إضافة علامة "تخطي الدور" على اللاعب المستهدف
    const updatedPlayers = lobbyData.players.map(p => {
        if (p.uid === me.uid) return { ...p, abilities: myNewAbilities };
        if (p.uid === targetId) return { ...p, hasSkipTurn: true };
        return p;
    });

    await updateDoc(lobbyRef, {
        players: updatedPlayers,
        lastAbilityUsed: `skip_turn_on_${targetPlayer.name}`
    });

    showToast(`تم استخدام "تخطي الدور"! سيتم تخطي دور ${targetPlayer.name} القادم.`);
    // الدور لا يتغير الآن، سيتغير عند انتهاء دور اللاعب الحالي
}

// --- منطق عكس الدور ---
async function applyReverseTurn(lobbyRef, lobbyData) {
    const newDirection = (lobbyData.playDirection || 1) * -1; // عكس الاتجاه
    const me = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);
    const myNewAbilities = me.abilities.filter(a => a !== 'reverse_turn');
    const updatedPlayers = lobbyData.players.map(p => p.uid === me.uid ? { ...p, abilities: myNewAbilities } : p);

    await updateDoc(lobbyRef, {
        players: updatedPlayers,
        playDirection: newDirection,
        lastAbilityUsed: 'reverse_turn'
    });
    showToast("تم عكس اتجاه اللعب!");
}

// --- دالة مساعدة لتطبيق الحالات على اللاعبين ---
async function applyStatusToPlayer(lobbyRef, lobbyData, targetId, statusKey, abilityKey) {
    const me = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);
    const myNewAbilities = me.abilities.filter(a => a !== abilityKey);
    const targetPlayer = lobbyData.players.find(p => p.uid === targetId);

    if (!targetPlayer) return showToast("لم يتم العثور على اللاعب المستهدف.");

    const updatedPlayers = lobbyData.players.map(p => {
        if (p.uid === me.uid) return { ...p, abilities: myNewAbilities }; // إزالة القدرة مني
        if (p.uid === targetId) return { ...p, [statusKey]: true }; // إضافة العلامة للهدف
        return p;
    });

    await updateDoc(lobbyRef, {
        players: updatedPlayers,
        lastAbilityUsed: `${abilityKey}_on_${targetPlayer.name}`
    });
    showToast(`تم تفعيل قدرة "${GAME_CONFIG.special_abilities[abilityKey].name}" على ${targetPlayer.name}!`);
}

// --- منطق تطبيق السؤال الناري ---
async function applyFieryQuestion(lobbyRef, lobbyData, targetId) {
    await applyStatusToPlayer(lobbyRef, lobbyData, targetId, 'hasFieryQuestion', 'fiery_question');
}

// --- منطق تطبيق السؤال الخادع ---
async function applyTrickQuestion(lobbyRef, lobbyData, targetId) {
    await applyStatusToPlayer(lobbyRef, lobbyData, targetId, 'hasTrickQuestion', 'trick_question');
}


});
        

    </script>
</body>
</html>
