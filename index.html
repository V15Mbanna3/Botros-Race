<!DOCTYPE html>

<html lang="ar" dir="rtl">

<head>

Â  Â  <meta charset="UTF-8">

Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">

Â  Â  <title>NC 1 Eagles - Botros Race Ultimate</title>

Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">

Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

Â  Â  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>



Â  Â  <style>

Â  Â  Â  Â  :root {

Â  Â  --bg-primary: #0f172a;Â 

Â  Â  --bg-secondary: rgba(30, 41, 59, 0.75);Â 

Â  Â  --bg-tertiary: rgba(51, 65, 85, 0.75);

Â  Â  --bg-locked: rgba(71, 85, 105, 0.75);Â 

Â  Â  --accent-cyan: #06b6d4;Â 

Â  Â  --accent-green: #22c55e;

Â  Â  --accent-red: #ef4444;Â 

Â  Â  --accent-yellow: #facc15;Â 

Â  Â  --accent-purple: #8b5cf6;Â 

Â  Â  --accent-blue: #3b82f6;

Â  Â  --text-primary: #f8fafc;Â 

Â  Â  --text-secondary: #94a3b8;

}

body {Â 

Â  Â  font-family: 'Cairo', sans-serif;Â 

Â  Â  background-image: url('https://v15mbanna3.github.io/my-sounds/Botros%20race.png');Â 

Â  Â  background-size: cover;Â 

Â  Â  background-position: center;Â 

Â  Â  background-attachment: fixed;Â 

Â  Â  color: var(--text-primary);Â 

Â  Â  margin: 0;Â 

Â  Â  padding: 1rem;Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  justify-content: center;Â 

Â  Â  min-height: 100vh;Â 

Â  Â  box-sizing: border-box;Â 

}

main {Â 

Â  Â  width: 100%;Â 

Â  Â  max-width: 900px;Â 

}

.screen-container {Â 

Â  Â  width: 100%;Â 

Â  Â  padding: 1.5rem;Â 

Â  Â  border: 1px solid rgba(51, 65, 85, 0.5);Â 

Â  Â  border-radius: 1.5rem;Â 

Â  Â  background-color: rgba(15, 23, 42, 0.85);Â 

Â  Â  backdrop-filter: blur(10px);Â 

Â  Â  box-sizing: border-box;Â 

Â  Â  display: none;Â 

Â  Â  position: relative;Â 

Â  Â  overflow: hidden;Â 

}

.screen-container.active {Â 

Â  Â  display: block;Â 

Â  Â  animation: fadeIn 0.5s ease;Â 

}

@keyframes fadeIn {Â 

Â  Â  from { opacity: 0; transform: translateY(10px); }Â 

Â  Â  to { opacity: 1; transform: translateY(0); }Â 

}

.screen-title {Â 

Â  Â  font-size: 2rem;Â 

Â  Â  font-weight: 900;Â 

Â  Â  text-align: center;Â 

Â  Â  margin-top: 0;Â 

Â  Â  margin-bottom: 2rem;Â 

Â  Â  color: var(--accent-cyan);Â 

Â  Â  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  justify-content: center;Â 

Â  Â  gap: 0.75rem;Â 

}

.screen-title i {Â 

Â  Â  font-size: 2.5rem;Â 

}

.screen-subtitle {Â 

Â  Â  text-align: center;Â 

Â  Â  color: var(--text-secondary);Â 

Â  Â  font-size: 1rem;Â 

Â  Â  margin-top: -1.5rem;Â 

Â  Â  margin-bottom: 2rem;Â 

Â  Â  max-width: 500px;Â 

Â  Â  margin-left: auto;Â 

Â  Â  margin-right: auto;Â 

}

.input-field {Â 

Â  Â  width: 100%;Â 

Â  Â  padding: 0.75rem 1rem;Â 

Â  Â  background-color: var(--bg-secondary);Â 

Â  Â  border: 1px solid var(--bg-tertiary);Â 

Â  Â  border-radius: 0.75rem;Â 

Â  Â  font-size: 1rem;Â 

Â  Â  color: var(--text-primary);Â 

Â  Â  box-sizing: border-box;Â 

Â  Â  text-align: right;Â 

Â  Â  transition: border-color 0.3s;Â 

}

.input-field:focus {Â 

Â  Â  border-color: var(--accent-cyan);Â 

Â  Â  outline: none;Â 

}

.form-group {Â 

Â  Â  margin-bottom: 1.25rem;Â 

Â  Â  text-align: right;Â 

}

.form-label {Â 

Â  Â  display: block;Â 

Â  Â  margin-bottom: 0.5rem;Â 

Â  Â  font-weight: 700;Â 

Â  Â  color: var(--text-secondary);Â 

}

.btn {Â 

Â  Â  width: 100%;Â 

Â  Â  padding: 1rem;Â 

Â  Â  border-radius: 0.75rem;Â 

Â  Â  font-size: 1.125rem;Â 

Â  Â  font-weight: 700;Â 

Â  Â  border: none;Â 

Â  Â  cursor: pointer;Â 

Â  Â  transition: all 0.2s;Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  justify-content: center;Â 

Â  Â  gap: 0.75rem;Â 

}

.btn i {Â 

Â  Â  font-size: 1.5em;Â 

}

.btn:disabled {Â 

Â  Â  background-color: var(--bg-locked);Â 

Â  Â  color: var(--text-secondary);Â 

Â  Â  cursor: not-allowed;Â 

}

.btn-primary {Â 

Â  Â  background-color: var(--accent-cyan);Â 

Â  Â  color: white;Â 

}Â 

.btn-primary:hover:not(:disabled) {Â 

Â  Â  background-color: #0891b2;Â 

Â  Â  transform: translateY(-2px);Â 

}

.btn-secondary {Â 

Â  Â  background-color: var(--bg-tertiary);Â 

Â  Â  color: var(--text-primary);Â 

}Â 

.btn-secondary:hover:not(:disabled) {Â 

Â  Â  background-color: rgba(71, 85, 105, 0.8);Â 

}

.back-btn {Â 

Â  Â  display: block;Â 

Â  Â  margin: 2rem auto 0;Â 

Â  Â  width: fit-content;Â 

Â  Â  padding: 0.5rem 1.5rem;Â 

Â  Â  font-size: 1rem;Â 

}

#mute-btn {Â 

Â  Â  position: fixed;Â 

Â  Â  top: 1.5rem;Â 

Â  Â  right: 1.5rem;Â 

Â  Â  width: 50px;Â 

Â  Â  height: 50px;Â 

Â  Â  border-radius: 50%;Â 

Â  Â  background-color: rgba(255, 255, 255, 0.1);Â 

Â  Â  color: white;Â 

Â  Â  font-size: 1.5rem;Â 

Â  Â  border: 1px solid var(--bg-tertiary);Â 

Â  Â  cursor: pointer;Â 

Â  Â  z-index: 1000;Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  justify-content: center;Â 

}



#main-menu-screen .welcome-container {Â 

Â  Â  position: relative;Â 

Â  Â  padding-bottom: 1rem;Â 

}

#main-menu-screen .welcome-message {Â 

Â  Â  font-size: 1.75rem;Â 

Â  Â  font-weight: 900;Â 

Â  Â  text-align: center;Â 

Â  Â  margin-bottom: 0.5rem;Â 

}

#main-menu-screen .welcome-message .name {Â 

Â  Â  color: var(--accent-cyan);Â 

}

#main-menu-screen .welcome-message .team-tag {Â 

Â  Â  font-size: 1.2rem;Â 

Â  Â  color: var(--accent-yellow);Â 

Â  Â  font-weight: 700;Â 

}

#logout-btn {Â 

Â  Â  position: absolute;Â 

Â  Â  top: 0;Â 

Â  Â  left: 0;Â 

Â  Â  background: none;Â 

Â  Â  border: none;Â 

Â  Â  color: var(--text-secondary);Â 

Â  Â  cursor: pointer;Â 

Â  Â  padding: 0.5rem;Â 

Â  Â  font-size: 1.5rem;Â 

}

#logout-btn:hover {Â 

Â  Â  color: var(--accent-red);Â 

}

.tabs-container {Â 

Â  Â  display: grid;Â 

Â  Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));Â 

Â  Â  gap: 1rem;Â 

}

.tab-item {Â 

Â  Â  background-color: var(--bg-secondary);Â 

Â  Â  padding: 1rem;Â 

Â  Â  border-radius: 1rem;Â 

Â  Â  text-align: center;Â 

Â  Â  font-size: 1rem;Â 

Â  Â  font-weight: 700;Â 

Â  Â  cursor: pointer;Â 

Â  Â  transition: transform 0.2s ease, background-color 0.2s ease, border-bottom-color 0.2s ease;

Â  Â  border-bottom: 4px solid transparent;Â 

}

.tab-item:hover {Â 

Â  Â  transform: translateY(-5px);Â 

Â  Â  background-color: var(--bg-tertiary);Â 

Â  Â  border-bottom-color: var(--accent-cyan);Â 

}

.tab-item .tab-icon {Â 

Â  Â  font-size: 2.5rem;Â 

Â  Â  margin-bottom: 0.5rem;Â 

Â  Â  line-height: 1;Â 

Â  Â  color: var(--accent-cyan);Â 

}



.list-container {Â 

Â  Â  max-height: 450px;Â 

Â  Â  overflow-y: auto;Â 

Â  Â  padding-right: 0.5rem;Â 

Â  Â  scrollbar-width: thin;Â 

Â  Â  scrollbar-color: var(--accent-cyan) var(--bg-tertiary);Â 

}

.list-item {Â 

Â  Â  display: flex;Â 

Â  Â  justify-content: space-between;Â 

Â  Â  align-items: center;Â 

Â  Â  background-color: var(--bg-secondary);Â 

Â  Â  padding: 1rem;Â 

Â  Â  border-radius: 0.75rem;Â 

Â  Â  margin-bottom: 0.75rem;Â 

Â  Â  transition: background-color 0.3s;Â 

}

.list-item:hover {Â 

Â  Â  background-color: var(--bg-tertiary);Â 

}

.list-item .item-info {Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  gap: 1rem;Â 

}

.list-item .item-rank {Â 

Â  Â  font-weight: 900;Â 

Â  Â  font-size: 1.2rem;Â 

Â  Â  color: var(--accent-cyan);Â 

Â  Â  width: 40px;Â 

Â  Â  text-align: center;Â 

}

.list-item .item-name {Â 

Â  Â  font-weight: 700;Â 

Â  Â  font-size: 1.1rem;Â 

}

.list-item .player-details {Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  gap: 0.5rem;Â 

}

.list-item .player-level {Â 

Â  Â  background-color: var(--accent-purple);Â 

Â  Â  color: white;Â 

Â  Â  font-size: 0.8rem;Â 

Â  Â  font-weight: bold;Â 

Â  Â  padding: 2px 8px;Â 

Â  Â  border-radius: 12px;Â 

}

.list-item .player-medals {Â 

Â  Â  font-size: 1rem;Â 

}

.list-item .item-value {Â 

Â  Â  font-weight: 700;Â 

Â  Â  font-size: 1.2rem;Â 

Â  Â  color: var(--accent-yellow);Â 

}



.card {Â 

Â  Â  background-color: var(--bg-secondary);Â 

Â  Â  padding: 1.5rem;Â 

Â  Â  border-radius: 1rem;Â 

Â  Â  border: 2px solid var(--bg-tertiary);Â 

Â  Â  transition: all 0.2s;Â 

Â  Â  text-align: center;Â 

}

.card:not(.locked) {Â 

Â  Â  cursor: pointer;Â 

}

.card:not(.locked):hover {Â 

Â  Â  border-color: var(--accent-cyan);Â 

Â  Â  transform: translateY(-5px);Â 

Â  Â  box-shadow: 0 5px 15px rgba(6, 182, 212, 0.2);Â 

}

.card.locked {Â 

Â  Â  background-color: var(--bg-locked);Â 

Â  Â  color: var(--text-secondary);Â 

Â  Â  cursor: not-allowed;Â 

}

.card.completed {Â 

Â  Â  border-color: var(--accent-green);Â 

Â  Â  background-color: rgba(34, 197, 94, 0.1);Â 

}

.card .card-icon {Â 

Â  Â  font-size: 3rem;Â 

Â  Â  color: var(--accent-cyan);Â 

Â  Â  margin-bottom: 1rem;Â 

}

.progress-bar-container {Â 

Â  Â  background-color: var(--bg-tertiary);Â 

Â  Â  border-radius: 99px;Â 

Â  Â  height: 10px;Â 

Â  Â  overflow: hidden;Â 

Â  Â  margin-top: 1rem;Â 

}

.progress-bar {Â 

Â  Â  background-color: var(--accent-green);Â 

Â  Â  height: 100%;Â 

Â  Â  width: 0%;Â 

Â  Â  transition: width 0.5s;Â 

}

.grid-container {Â 

Â  Â  display: grid;Â 

Â  Â  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));Â 

Â  Â  gap: 1rem;Â 

}



#options-grid {Â 

Â  Â  display: grid;Â 

Â  Â  grid-template-columns: 1fr 1fr;Â 

Â  Â  gap:1rem;

}

#question-text {Â 

Â  Â  font-size: 1.4rem; /* <-- ØªÙ… Ø§Ù„ØªØµØºÙŠØ± Ù‡Ù†Ø§ */

Â  Â  font-weight: 700;Â 

Â  Â  margin-bottom: 1.5rem;Â 

Â  Â  min-height: 100px;Â 

}

.option-btn.correct {Â 

Â  Â  background-color: var(--accent-green) !important;Â 

Â  Â  transform: scale(1.05); color: white;Â 

}

.option-btn.wrong {Â 

Â  Â  background-color: var(--accent-red) !important;Â 

Â  Â  color: white;Â 

}

.option-btn.disabled {Â 

Â  Â  opacity: 0.6;Â 

Â  Â  pointer-events: none;Â 

}

#explanation-box {Â 

Â  Â  background-color: rgba(250, 204, 21, 0.1);Â 

Â  Â  border: 1px solid var(--accent-yellow);Â 

Â  Â  border-radius: 0.75rem;Â 

Â  Â  padding: 1rem;Â 

Â  Â  margin-top: 1.5rem;Â 

Â  Â  display: none;Â 

}



.modal {Â 

Â  Â  position: fixed;Â 

Â  Â  top: 0; left: 0;Â 

Â  Â  width: 100%;Â 

Â  Â  height: 100%;Â 

Â  Â  background-color: rgba(0,0,0,0.7);Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  justify-content: center;Â 

Â  Â  z-index: 2000;Â 

Â  Â  opacity: 0;Â 

Â  Â  pointer-events: none;Â 

Â  Â  transition: opacity 0.3s;Â 

}

.modal.visible {Â 

Â  Â  opacity: 1;Â 

Â  Â  pointer-events: auto;Â 

}

.modal-content {Â 

Â  Â  background-color: var(--bg-primary);Â 

Â  Â  padding: 2rem;Â 

Â  Â  border-radius: 1rem;Â 

Â  Â  text-align: center;Â 

Â  Â  border: 1px solid var(--bg-tertiary);Â 

Â  Â  max-width: 90%;Â 

Â  Â  width: 400px;Â 

}

.modal-actions {Â 

Â  Â  display: flex;Â 

Â  Â  gap: 1rem;Â 

Â  Â  justify-content: center;Â 

}

#toast-container {Â 

Â  Â  position: fixed;Â 

Â  Â  bottom: 20px;Â 

Â  Â  left: 50%;Â 

Â  Â  transform: translateX(-50%);Â 

Â  Â  z-index: 3000;Â 

Â  Â  display: flex;Â 

Â  Â  flex-direction: column;Â 

Â  Â  gap: 0.5rem;Â 

}

.toast {Â 

Â  Â  background-color: var(--accent-purple);Â 

Â  Â  color: white;Â 

Â  Â  padding: 1rem 1.5rem;Â 

Â  Â  border-radius: 0.75rem;Â 

Â  Â  font-weight: 700;Â 

Â  Â  box-shadow: 0 4px 15px rgba(0,0,0,0.3);Â 

Â  Â  opacity: 0;Â 

Â  Â  transform: translateY(20px);Â 

Â  Â  transition: all 0.5s ease;Â 

}

.toast.show {Â 

Â  Â  opacity: 1;Â 

Â  Â  transform: translateY(0);Â 

}



.achievement-item {Â 

Â  Â  display: flex;Â 

Â  Â  align-items: center;Â 

Â  Â  gap: 1.5rem;Â 

Â  Â  padding: 1rem;Â 

Â  Â  background-color: var(--bg-secondary);Â 

Â  Â  border-radius: 0.75rem;Â 

Â  Â  margin-bottom: 1rem;Â 

Â  Â  border-left: 5px solid var(--bg-tertiary);Â 

Â  Â  opacity: 0.6;Â 

Â  Â  transition: all 0.3s ease;Â 

}

.achievement-item.unlocked {Â 

Â  Â  opacity: 1;Â 

Â  Â  border-left-color: var(--accent-green);Â 

Â  Â  background: linear-gradient(90deg, rgba(34, 197, 94, 0.1), var(--bg-secondary));Â 

}

.achievement-icon {Â 

Â  Â  font-size: 3rem;Â 

Â  Â  line-height: 1;Â 

Â  Â  color: var(--accent-yellow);Â 

}



.island-map-grid {Â 

Â  Â  display: grid;Â 

Â  Â  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));Â 

Â  Â  gap: 1.5rem;Â 

Â  Â  padding: 1rem;Â 

}

.island-tile {Â 

Â  Â  background-color: var(--bg-secondary);Â 

Â  Â  border-radius: 1rem;Â 

Â  Â  padding: 1.5rem;Â 

Â  Â  text-align: center;Â 

Â  Â  border: 3px solid var(--bg-tertiary);Â 

Â  Â  transition: all 0.3s;Â 

Â  Â  position: relative;Â 

}

.island-tile.my-team {Â 

Â  Â  border-color: var(--accent-green);Â 

Â  Â  box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);Â 

}

.island-tile.enemy-team {Â 

Â  Â  border-color: var(--accent-red);Â 

}

.island-tile .island-icon {Â 

Â  Â  font-size: 4rem;Â 

Â  Â  margin-bottom: 1rem;Â 

}

.island-name {Â 

Â  Â  font-size: 1.5rem;Â 

Â  Â  font-weight: 900;Â 

Â  Â  margin-bottom: 0.5rem;Â 

}

.island-owner .team-tag {Â 

Â  Â  font-size: 1.1rem;Â 

Â  Â  color: var(--accent-yellow);Â 

}

.island-tile .btn {Â 

Â  Â  margin-top: 1rem;Â 

Â  Â  padding: 0.5rem 1rem;Â 

Â  Â  width: auto;Â 

Â  Â  font-size: 1rem;Â 

}

.island-reward-timer {Â 

Â  Â  font-size: 0.8rem;Â 

Â  Â  color: var(--text-secondary);Â 

Â  Â  margin-top: 0.5rem;Â 

}



/* Chat Styles */

#chat-screen .chat-messages {Â 

Â  Â  height: 400px;Â 

Â  Â  overflow-y: auto;Â 

Â  Â  border: 1px solid var(--bg-tertiary);Â 

Â  Â  border-radius: 0.75rem;Â 

Â  Â  padding: 1rem;Â 

Â  Â  margin-bottom: 1rem;Â 

Â  Â  display: flex;Â 

Â  Â  flex-direction: column-reverse;Â 

}

.chat-message {Â 

Â  Â  background-color: var(--bg-secondary);Â 

Â  Â  padding: 0.75rem 1rem;Â 

Â  Â  border-radius: 10px;Â 

Â  Â  margin-bottom: 0.75rem;Â 

Â  Â  max-width: 80%;Â 

Â  Â  align-self: flex-start;Â 

}

.chat-message.mine {Â 

Â  Â  background-color: var(--accent-blue);Â 

Â  Â  align-self: flex-end;Â 

}

.chat-message .sender {Â 

Â  Â  font-weight: bold;Â 

Â  Â  color: var(--accent-cyan);Â 

Â  Â  margin-bottom: 0.25rem;Â 

Â  Â  font-size: 0.9rem;Â 

}

.chat-message.mine .sender {Â 

Â  Â  color: var(--text-primary);Â 

}

.chat-message .timestamp {Â 

Â  Â  font-size: 0.7rem;Â 

Â  Â  color: var(--text-secondary);Â 

Â  Â  margin-top: 0.25rem;Â 

}

#chat-input-container {Â 

Â  Â  display: flex;Â 

Â  Â  gap: 1rem;Â 

}

#chat-input-container input {Â 

Â  Â  flex-grow: 1;Â 

}

/* --- START: ÙƒÙˆØ¯ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */



/* Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„Ø¬Ø²Ø± (Ø£Ø®Ø¶Ø±) */

.tab-item[data-action="show-island-conquest"] .tab-icon { color: var(--accent-green); }

.tab-item[data-action="show-island-conquest"]:hover { border-bottom-color: var(--accent-green); }



/* Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ (Ø£Ø²Ø±Ù‚) */

.tab-item[data-action="show-single-player"] .tab-icon { color: var(--accent-blue); }

.tab-item[data-action="show-single-player"]:hover { border-bottom-color: var(--accent-blue); }



/* Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø­Ø±Ø© (Ø£Ø­Ù…Ø±) */

.tab-item[data-action="show-online-menu"] .tab-icon { color: var(--accent-red); }

.tab-item[data-action="show-online-menu"]:hover { border-bottom-color: var(--accent-red); }



/* Ø§Ù„ÙØ±ÙŠÙ‚ (Ø¨Ù†ÙØ³Ø¬ÙŠ) */

.tab-item[data-action="show-team-hub"] .tab-icon { color: var(--accent-purple); }

.tab-item[data-action="show-team-hub"]:hover { border-bottom-color: var(--accent-purple); }



/* Ø§Ù„ØµØ¯Ø§Ø±Ø© (Ø£ØµÙØ±) */

.tab-item[data-action="show-leaderboards"] .tab-icon { color: var(--accent-yellow); }

.tab-item[data-action="show-leaderboards"]:hover { border-bottom-color: var(--accent-yellow); }



/* Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª (Ø³ÙŠØ§Ù† - Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ) */

.tab-item[data-action="show-achievements"] .tab-icon { color: var(--accent-cyan); }

.tab-item[data-action="show-achievements"]:hover { border-bottom-color: var(--accent-cyan); }



/* Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­) */

.tab-item[data-action="show-chat"] .tab-icon { color: var(--accent-blue); }

.tab-item[data-action="show-chat"]:hover { border-bottom-color: var(--accent-blue); }



/* --- END: ÙƒÙˆØ¯ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */

Â  Â  </style>

</head>

<body>

Â  Â  <button id="mute-btn" data-action="toggle-music"><i class='bx bx-volume-mute'></i></button>

Â  Â  <div id="toast-container"></div>



Â  Â  <main>

Â  Â  Â  Â  <div id="registration-screen" class="screen-container active"></div>

Â  Â  Â  Â  <div id="loading-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="main-menu-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="single-player-menu-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="level-select-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="online-menu-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="join-lobby-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="online-lobby-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="team-hub-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="create-team-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="join-team-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="leaderboard-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="achievements-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="island-conquest-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="chat-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="match-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="game-over-screen" class="screen-container"></div>

Â  Â  Â  Â  <div id="notifications-screen" class="screen-container"></div>

<template id="notifications-screen-template">

Â  Â  <h1 class="screen-title"><i class='bx bxs-bell-ring'></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h1>

Â  Â  <div id="notifications-list" class="list-container"></div>

Â  Â  <button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button>

</template>

Â  Â  </main>

Â  Â  <div id="modal" class="modal"></div>

Â  Â Â 

Â  Â  <template id="loading-screen-template"><h1 class="screen-title"><i class='bx bx-loader-alt bx-spin'></i> ...Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„</h1></template>

Â  Â Â 

Â  Â  <template id="registration-screen-template"><div style="max-width:400px;margin:auto"><h1 class="screen-title"><i class='bx bxl-flutter'></i> NC 1 Eagles<br>Islands Conquer</h1><div class="form-group"><label for="name-input" class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="name-input" type="text" class="input-field"></div><div class="form-group"><label for="teleopti-id-input" class="form-label">Teleopti ID</label><input id="teleopti-id-input" type="tel" pattern="[0-9]*" class="input-field"></div><div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin:1.5rem 0;color:var(--text-secondary)"><input type="checkbox" id="remember-me-checkbox" checked><label for="remember-me-checkbox">ØªØ°ÙƒØ±Ù†ÙŠ</label></div><button data-action="login" class="btn btn-primary"><i class='bx bx-log-in-circle'></i> Ø¯Ø®ÙˆÙ„</button></div></template>

Â  Â Â 

Â  Â  <template id="main-menu-screen-template"><div class="welcome-container"><h1 id="welcome-message" class="welcome-message"><button data-action="show-notifications" id="notifications-btn" style="position: absolute; top: 0; right: 0; background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; font-size: 1.5rem;">

Â  Â  <i class='bx bxs-bell'></i>

Â  Â  <span id="notification-indicator" style="position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: var(--accent-red); border-radius: 50%; display: none;"></span>

</button></h1><button data-action="logout" id="logout-btn" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"><i class='bx bx-exit'></i></button></div><div class="tabs-container"><div data-action="show-island-conquest" class="tab-item"><div class="tab-icon"><i class='bx bxs-map-alt'></i></div><div>Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„Ø¬Ø²Ø±</div></div><div data-action="show-single-player" class="tab-item"><div class="tab-icon"><i class='bx bxs-user'></i></div><div>Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ</div></div><div data-action="show-online-menu" class="tab-item"><div class="tab-icon"><i class='bx bxs-group'></i></div><div>Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø­Ø±Ø©</div></div><div data-action="show-team-hub" class="tab-item"><div class="tab-icon"><i class='bx bxs-shield-alt-2'></i></div><div>Ø§Ù„ÙØ±ÙŠÙ‚</div></div><div data-action="show-leaderboards" class="tab-item"><div class="tab-icon"><i class='bx bxs-trophy'></i></div><div>Ø§Ù„ØµØ¯Ø§Ø±Ø©</div></div><div data-action="show-achievements" class="tab-item"><div class="tab-icon"><i class='bx bxs-medal'></i></div><div>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div></div><div data-action="show-chat" class="tab-item"><div class="tab-icon"><i class='bx bxs-message-square-dots'></i></div><div>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div></div></div></template>

Â  Â Â 

Â  Â  <template id="single-player-menu-screen-template"><h1 class="screen-title"><i class='bx bxs-user'></i> Ø·ÙˆØ± Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ</h1><p class="screen-subtitle">Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù„ØªÙØªØ­ ØªØ­Ø¯ÙŠØ§Øª Ø£ØµØ¹Ø¨ ÙˆØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙŠØ¯Ø§Ù„ÙŠØ§Øª.</p><div id="tiers-grid" class="grid-container"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></template>

Â  Â Â 

Â  Â  <template id="level-select-screen-template"><h1 id="level-select-title" class="screen-title"></h1><div id="levels-grid" class="grid-container"></div><button data-action="show-single-player" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></template>



Â  Â  <template id="online-lobby-screen-template"><h1 id="lobby-title" class="screen-title">ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h1><div style="text-align:center;margin-bottom:1.5rem"><p>Ø´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ:</p><h2 id="lobby-id-display" style="color:var(--accent-yellow);cursor:pointer" title="Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®"></h2></div><h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ø§Ù„Ø±Ø¯Ù‡Ø© (<span id="player-count">0</span>)</h3><div id="lobby-players-list" class="list-container" style="max-height:150px"></div><div id="lobby-chat-container" style="margin-top:1rem;"><h4>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù„ÙˆØ¨ÙŠ</h4><div id="chat-screen" style="direction: ltr;"><div class="chat-messages" id="lobby-chat-messages" style="height: 120px;"></div><div id="chat-input-container"><input type="text" id="lobby-chat-input" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."><button data-action="send-lobby-chat" id="lobby-chat-send" class="btn btn-primary" style="width: auto; padding: 0.75rem;"><i class='bx bxs-send'></i></button></div></div></div><button id="start-game" data-action="start-game" class="btn btn-primary" style="margin-top:1.5rem"><i class='bx bx-rocket'></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© (Ù„Ù„Ù…Ø¶ÙŠÙ)</button><button data-action="leave-lobby" class="btn btn-secondary back-btn" style="background-color: var(--accent-red);"><i class='bx bx-log-out'></i> Ù…ØºØ§Ø¯Ø±Ø©</button></template>



Â <template id="team-hub-screen-template">

Â  Â  <div id="no-team-view">

Â  Â  Â  Â  <h1 class="screen-title"><i class='bx bxs-shield-x'></i> Ù„Ù… ØªÙ†Ø¶Ù… Ù„ÙØ±ÙŠÙ‚ Ø¨Ø¹Ø¯</h1>

Â  Â  Â  Â  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;max-width:500px;margin:auto">

Â  Â  Â  Â  Â  Â  <button data-action="show-create-team" class="btn btn-primary"><i class='bx bxs-shield-plus'></i> Ø¥Ù†Ø´Ø§Ø¡ ÙØ±ÙŠÙ‚</button>

Â  Â  Â  Â  Â  Â  <button data-action="show-join-team" class="btn btn-secondary"><i class='bx bx-user-plus'></i> Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ÙØ±ÙŠÙ‚</button>

Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <div id="team-view" style="display:none">

Â  Â  Â  Â  <h1 id="team-name-title" class="screen-title"></h1>

Â  Â  Â  Â  <p class="screen-subtitle">Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚: <strong id="team-score" style="color:var(--accent-yellow)">0</strong> | ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠÙ‚: <strong id="team-id-display" style="color:var(--accent-cyan);cursor:pointer" title="Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®"></strong></p>

Â  Â  Â  Â  <h3><i class='bx bxs-user-detail'></i> Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ (<span id="team-member-count">0</span>)</h3>

Â  Â  Â  Â  <div id="team-members-list" class="list-container" style="max-height:250px"></div>



Â  Â  Â  Â  <div id="team-requests-container" style="display:none; margin-top: 2rem;">

Â  Â  Â  Â  Â  Â  <h3><i class='bx bx-user-plus'></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h3>

Â  Â  Â  Â  Â  Â  <div id="team-requests-list" class="list-container" style="max-height: 200px;"></div>

Â  Â  Â  Â  </div>



Â  Â  Â  Â  <button data-action="show-team-chat" class="btn btn-primary" style="margin-top: 2rem;"><i class='bx bxs-message-alt-dots'></i> Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙØ±ÙŠÙ‚</button>

Â  Â  Â  Â  <button data-action="leave-team" class="btn btn-secondary" style="background-color:var(--accent-red);margin-top:1rem"><i class='bx bx-exit'></i> Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚</button>

Â  Â  </div>

Â  Â  <button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button>

</template>



Â  Â  <template id="leaderboard-screen-template"><h1 class="screen-title"><i class='bx bxs-trophy'></i> Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h1><div style="display:flex;gap:1rem;margin-bottom:2rem;border-bottom:2px solid var(--bg-tertiary)"><button id="pills-individual" data-action="show-individual-leaderboard" class="btn btn-primary" style="flex:1"><i class='bx bxs-user'></i> ÙØ±Ø¯ÙŠ</button><button id="pills-teams" data-action="show-teams-leaderboard" class="btn btn-secondary" style="flex:1"><i class='bx bxs-shield-alt-2'></i> ÙØ±Ù‚</button></div><div id="leaderboard-list" class="list-container"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></template>

Â  Â Â 

Â  Â  <template id="achievements-screen-template"><h1 class="screen-title"><i class='bx bxs-medal'></i> Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h1><p class="screen-subtitle">Ø§ÙØªØ­ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© ÙˆØªØ«Ø¨Øª Ø¬Ø¯Ø§Ø±ØªÙƒ.</p><div id="achievements-list" class="list-container"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></template>

Â  Â Â 

Â  Â  <template id="island-conquest-screen-template"><h1 class="screen-title"><i class='bx bxs-map-alt'></i> Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„Ø¬Ø²Ø±</h1><p class="screen-subtitle">Ø³ÙŠØ·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²Ø± Ù…Ø¹ ÙØ±ÙŠÙ‚Ùƒ. ÙƒÙ„ Ø¬Ø²ÙŠØ±Ø© ØªÙ…Ø«Ù„ ÙØ¦Ø© Ø£Ø³Ø¦Ù„Ø© Ù…Ø®ØªÙ„ÙØ©. Ø§Ù„Ø³ÙŠØ·Ø±Ø© ØªÙ…Ù†Ø­ ÙØ±ÙŠÙ‚Ùƒ Ù†Ù‚Ø§Ø·Ù‹Ø§ Ø¥Ø¶Ø§ÙÙŠØ© ÙŠÙˆÙ…ÙŠÙ‹Ø§!</p><div id="island-map-grid" class="island-map-grid"></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></template>

Â  Â Â 

Â  Â  <template id="chat-screen-template"><h1 id="chat-screen-title" class="screen-title"><i class='bx bxs-message-square-dots'></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h1><p id="chat-screen-subtitle" class="screen-subtitle">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©.</p><div id="chat-container" style="direction: ltr;"><div class="chat-messages" id="chat-messages-list"></div><div id="chat-input-container"><input type="text" id="chat-input-field" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."><button id="chat-send-btn" class="btn btn-primary" style="width: auto; padding: 0.75rem;"><i class='bx bxs-send'></i></button></div></div><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></template>Â  Â Â 

Â  Â  <template id="game-over-screen-template"><h1 id="game-over-title" class="screen-title">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©!</h1><h2 id="game-over-subtitle" class="screen-subtitle"></h2><div id="final-results-list" class="list-container"></div><button data-action="back" class="btn btn-primary back-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button></template>



Â  Â  <template id="online-menu-screen-template"><h1 class="screen-title"><i class='bx bxs-game'></i> Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø­Ø±Ø©</h1><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;max-width:500px;margin:0 auto 2rem"><button data-action="create-lobby" data-type="1v1" class="btn btn-primary"><i class='bx bxs-user-check'></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ§Ø¬Ù‡Ø© 1 Ø¶Ø¯ 1</button><button data-action="create-lobby" data-type="massive" class="btn btn-primary"><i class='bx bxs-group'></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø§ÙØ³Ø© Ø­Ø§Ø´Ø¯Ø©</button></div><button data-action="show-join-lobby" class="btn btn-secondary"><i class='bx bx-link-external'></i> Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨ÙƒÙˆØ¯</button><button data-action="back" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></template>

Â  Â Â 

Â  Â  <template id="join-lobby-screen-template"><div style="max-width:400px;margin:auto;text-align:center"><h1 class="screen-title">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ù†Ø§ÙØ³Ø©</h1><p class="screen-subtitle">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù….</p><input id="lobby-id-input" type="text" class="input-field" placeholder="KOD" style="text-align:center;text-transform:uppercase;font-size:1.5rem;letter-spacing:5px"><button data-action="submit-join-lobby" class="btn btn-primary" style="margin-top:1rem">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button><button data-action="show-online-menu" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></div></template>

Â  Â Â 

Â  Â  <template id="create-team-screen-template"><div style="max-width:400px;margin:auto"><h1 class="screen-title">Ø¥Ù†Ø´Ø§Ø¡ ÙØ±ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯</h1><div class="form-group"><label for="team-name-input" class="form-label">Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚</label><input id="team-name-input" type="text" class="input-field"></div><div class="form-group"><label for="team-tag-input" class="form-label">Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ (Tag - 3 Ø¥Ù„Ù‰ 5 Ø­Ø±ÙˆÙ)</label><input id="team-tag-input" type="text" class="input-field" maxlength="5" minlength="3"></div><button data-action="submit-create-team" class="btn btn-primary">Ø£Ù†Ø´Ø¦ Ø§Ù„ÙØ±ÙŠÙ‚</button><button data-action="show-team-hub" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></div></template>

Â  Â Â 

Â  Â  <template id="join-team-screen-template"><div style="max-width:400px;margin:auto;text-align:center"><h1 class="screen-title">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ÙØ±ÙŠÙ‚</h1><input id="team-id-input" type="text" class="input-field" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠÙ‚" style="text-align:center;font-size:1.5rem;letter-spacing:5px;margin-top:2rem"><button data-action="submit-join-team" class="btn btn-primary" style="margin-top:1rem">Ø§Ù†Ø¶Ù…Ø§Ù…</button><button data-action="show-team-hub" class="btn btn-secondary back-btn"><i class='bx bx-arrow-back'></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button></div></template>

Â  Â Â 

<template id="match-screen-template">

Â  Â  <div class="match-layout" style="display: flex; gap: 1.5rem;">



Â  Â  Â  Â  <div class="match-main-content" style="flex-grow: 1;">

Â  Â  Â  Â  Â  Â  <h2 id="match-header" style="font-size:1.5rem;font-weight:900;margin-bottom:1rem"></h2>

Â  Â  Â  Â  Â  Â  <p id="question-counter"></p>

Â  Â  Â  Â  Â  Â  <div id="timer-container" style="width:100%;background-color:var(--bg-tertiary);border-radius:5px;margin-bottom:1.5rem">

Â  Â  Â  Â  Â  Â  Â  Â  <div id="timer-bar" style="height:10px;background-color:var(--accent-red);border-radius:5px;transition:width 1s linear"></div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="question-text"></div>

Â  Â  Â  Â  Â  Â  <div id="options-grid" class="grid-container"></div>

Â  Â  Â  Â  Â  Â  <div id="explanation-box"></div>

Â  Â  Â  Â  Â  Â  <button data-action="surrender" class="btn btn-secondary" style="background-color:var(--accent-red);margin-top:2rem">Ø§Ø³ØªØ³Ù„Ø§Ù…</button>

Â  Â  Â  Â  </div>

    

Â  Â  Â  Â  <aside id="live-scoreboard-container" style="width: 280px; flex-shrink: 0; background-color: rgba(0,0,0,0.2); border-radius: 1rem; padding: 1rem;">

Â  Â  Â  Â  Â  Â  <h3 style="text-align: center; margin-top: 0; color: var(--accent-cyan);">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h3>

Â  Â  Â  Â  Â  Â  <div id="live-scoreboard-list" class="list-container" style="max-height: 400px;">

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </aside>



Â  Â  </div>

Â  Â  <button data-action="back" class="btn btn-secondary back-btn" style="display:none">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>

</template>Â  Â Â 

Â  Â  <template id="modal-template"><div class="modal-content"><h2 id="modal-title" style="margin-top:0;color:var(--accent-cyan)"></h2><p id="modal-body"></p><div class="modal-actions"><button data-action="modal-confirm" class="btn btn-primary">Ù†Ø¹Ù…</button><button data-action="modal-cancel" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button></div></div></template>



Â  Â  <script type="module">

// FINAL, COMPLETE, AND VERIFIED SCRIPT - RESTRUCTURED

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, where, orderBy, limit, serverTimestamp, updateDoc, arrayUnion, runTransaction, getDocs, writeBatch, increment, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyAvGDEbWA3UumCa0P4AfFUVv6xxwL5Porc", authDomain: "nc1-eagles-race.firebaseapp.com", projectId: "nc1-eagles-race", storageBucket: "nc1-eagles-race.appspot.com", messagingSenderId: "772415266484", appId: "1:772415266484:web:5813cb3355f7298ade81e1" };



// ===================================================================================

// âœ¨âœ¨âœ¨ ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ¨Ù†ÙˆÙƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© âœ¨âœ¨âœ¨

// ===================================================================================

const GAME_CONFIG = {

Â  Â  // --- â¬‡ï¸â¬‡ï¸â¬‡ï¸ Ù‡Ù†Ø§ ØªØ¶Ø¹ Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ â¬‡ï¸â¬‡ï¸â¬‡ï¸ ---

Â  Â  questionBanks: {

Â  Â  Â  Â  // Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ±Ø¯ÙŠ

Â  Â  Â  Â  singlePlayer: [

Â  Â  Â  Â  Â  Â  { id: 1, question: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ", options: { "1": "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "2": "Ø§Ù„Ø¬ÙŠØ²Ø©" }, correct_answer: "1", explanation: "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ù…ØµØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©." },

Â  Â  Â  Â  Â  Â  { id: 2, question: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ù„ÙˆØ§Ù† Ø¹Ù„Ù… Ù…ØµØ±ØŸ", options: { "1": "Ù„ÙˆÙ†Ø§Ù†", "2": "Ø«Ù„Ø§Ø«Ø© Ø£Ù„ÙˆØ§Ù†" }, correct_answer: "2", explanation: "Ø¹Ù„Ù… Ù…ØµØ± ÙŠØªÙƒÙˆÙ† Ù…Ù† Ø«Ù„Ø§Ø«Ø© Ø£Ù„ÙˆØ§Ù†: Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ø£Ø¨ÙŠØ¶ ÙˆØ§Ù„Ø£Ø³ÙˆØ¯." }

Â  Â  Â  Â  ],

Â  Â  Â  Â  // Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø©)

Â  Â  Â  Â  online: [

Â  Â  Â  Â  Â  Â  { id: 101, question: "Ø³Ø¤Ø§Ù„ Ø¹Ø§Ù… Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† 1", options: { "1": "Ø£", "2": "Ø¨" }, correct_answer: "1", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" },

Â  Â  Â  Â  Â  Â  { id: 102, question: "Ø³Ø¤Ø§Ù„ Ø¹Ø§Ù… Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† 2", options: { "1": "Ø£", "2": "Ø¨" }, correct_answer: "2", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" }

Â  Â  Â  Â  ],

Â  Â  Â  Â  // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ù…Ù† Ù‡Ù†Ø§

islands: {

Â  Â  // Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø²ÙŠØ±Ø© Tech

Â  Â  'island_tech': [

Â  Â  Â  Â  { id: 201, question: "Ø³Ø¤Ø§Ù„ Tech Ø±Ù‚Ù… 1ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "1", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." },

Â  Â  Â  Â  { id: 202, question: "Ø³Ø¤Ø§Ù„ Tech Ø±Ù‚Ù… 2ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "2", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." }

Â  Â  ],

Â  Â  // Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø²ÙŠØ±Ø© Non-Tech

Â  Â  'island_non_tech': [

Â  Â  Â  Â  { id: 301, question: "Ø³Ø¤Ø§Ù„ Non-Tech Ø±Ù‚Ù… 1ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "1", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." },

Â  Â  Â  Â  { id: 302, question: "Ø³Ø¤Ø§Ù„ Non-Tech Ø±Ù‚Ù… 2ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "2", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." }

Â  Â  ],

Â  Â  // Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø²ÙŠØ±Ø© Faulty

Â  Â  'island_faulty': [

Â  Â  Â  Â  { id: 401, question: "Ø³Ø¤Ø§Ù„ Faulty Ø±Ù‚Ù… 1ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "1", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." },

Â  Â  Â  Â  { id: 402, question: "Ø³Ø¤Ø§Ù„ Faulty Ø±Ù‚Ù… 2ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "2", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." }

Â  Â  ],

Â  Â  // Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø²ÙŠØ±Ø© Quality

Â  Â  'island_quality': [

Â  Â  Â  Â  { id: 501, question: "Ø³Ø¤Ø§Ù„ Quality Ø±Ù‚Ù… 1ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "1", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." },

Â  Â  Â  Â  { id: 502, question: "Ø³Ø¤Ø§Ù„ Quality Ø±Ù‚Ù… 2ØŸ", options: { "1": "Ø¥Ø¬Ø§Ø¨Ø© Ø£", "2": "Ø¥Ø¬Ø§Ø¨Ø© Ø¨" }, correct_answer: "2", explanation: "Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." }

Â  Â  ]

}

// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ù‡Ù†Ø§

Â  Â  },

Â  Â  // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ø²Ø±

Â  // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ù…Ù† Ù‡Ù†Ø§

islandDefinitions: {Â 

Â  Â  'island_tech': { name: "Ø¬Ø²ÙŠØ±Ø© Tech", icon: "<i class='bx bx-chip'></i>", dailyReward: 75 },

Â  Â  'island_non_tech': { name: "Ø¬Ø²ÙŠØ±Ø© Non-Tech", icon: "<i class='bx bx-book-content'></i>", dailyReward: 75 },

Â  Â  'island_faulty': { name: "Ø¬Ø²ÙŠØ±Ø© Faulty", icon: "<i class='bx bxs-bug'></i>", dailyReward: 75 },

Â  Â  'island_quality': { name: "Ø¬Ø²ÙŠØ±Ø© Quality", icon: "<i class='bx bxs-check-shield'></i>", dailyReward: 75 }

},

Â  Â  // ØªØ¹Ø±ÙŠÙ ÙØ¦Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ

Â  Â  singlePlayerTiers: [Â 

Â  Â  Â  Â  { id: 'tier-1', name: 'Ø§ÙŠØ¬Ù†Øª Ø¹Ø§Ø¯ÙŠ', levels: 3, questionsPerLevel: 5, timePerQuestion: 30, medal: 'ğŸ¥‰', points: 10, awardPoints: 50, icon: 'bx-shield-quarter' },

Â  Â  Â  Â  { id: 'tier-2', name: 'Ø§ÙŠØ¬Ù†Øª Ø¬Ø§Ù…Ø¯', levels: 3, questionsPerLevel: 5, timePerQuestion: 25, medal: 'ğŸ¥ˆ', points: 15, awardPoints: 75, icon: 'bx-shield-alt-2' },

Â  Â  Â  Â  { id: 'tier-3', name: 'Ø§ÙŠØ¬Ù†Øª ÙƒÙˆØ§Ù„ØªÙŠ', levels: 6, questionsPerLevel: 10, timePerQuestion: 20, medal: 'ğŸ¥‡', points: 20, awardPoints: 100, icon: 'bx-shield-x' },

Â  Â  Â  Â  { id: 'tier-4', name: 'Ø§ÙŠØ¬Ù†Øª Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±', levels: 6, questionsPerLevel: 20, timePerQuestion: 15, medal: 'ğŸ†', points: 25, awardPoints: 150, icon: 'bxs-shield' },

Â  Â  Â  Â  { id: 'tier-5', name: 'Ø§ÙŠØ¬Ù†Øª Ø¨Ø·Ø±Ø³', levels: 6, questionsPerLevel: 40, timePerQuestion: 10, medal: 'ğŸ’', points: 30, awardPoints: 200, icon: 'bxs-diamond' }

Â  Â  ],

Â  Â  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª

Â  Â  // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ù…Ù† Ù‡Ù†Ø§

achievements: {

Â  Â  // --- ğŸ–ï¸ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ (Online Matches) ğŸ–ï¸ ---

Â  Â  'play_1_game':Â  Â  Â  { name: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©", description: "Ø£ÙƒÙ…Ù„ Ø£ÙˆÙ„ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©", icon: "<i class='bx bx-rocket'></i>", target: 1, stat: 'gamesPlayed', rewardPoints: 10 },

Â  Â  'play_10_games':Â  Â  Â { name: "Ù„Ø§Ø¹Ø¨ Ù…ØªÙ…Ø±Ø³", description: "Ø£ÙƒÙ…Ù„ 10 Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©", icon: "<i class='bx bxs-hot'></i>", target: 10, stat: 'gamesPlayed', rewardPoints: 50 },

Â  Â  'play_50_games':Â  Â  Â { name: "Ù…Ø­Ø§Ø±Ø¨ Ù…Ø®Ø¶Ø±Ù…", description: "Ø£ÙƒÙ…Ù„ 50 Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©", icon: "<i class='bx bxs-crown'></i>", target: 50, stat: 'gamesPlayed', rewardPoints: 200 },

Â  Â Â 

Â  Â  'win_1_1v1':Â  Â  Â  Â  Â { name: "Ù…Ø­Ø§Ø±Ø¨ Ù…Ø¨ØªØ¯Ø¦", description: "ÙØ² ÙÙŠ Ø£ÙˆÙ„ Ù…ÙˆØ§Ø¬Ù‡Ø© 1 Ø¶Ø¯ 1", icon: "<i class='bx bx-swords'></i>", target: 1, stat: 'wins1v1', rewardPoints: 25 },

Â  Â  'win_10_1v1':Â  Â  Â  Â  { name: "Ù…Ø¨Ø§Ø±Ø² Ù…Ø­ØªØ±Ù", description: "ÙØ² ÙÙŠ 10 Ù…ÙˆØ§Ø¬Ù‡Ø§Øª 1 Ø¶Ø¯ 1", icon: "<i class='bx bxs-swords'></i>", target: 10, stat: 'wins1v1', rewardPoints: 100 },

Â  Â  'win_5_massive':Â  Â  Â { name: "Ø³ÙŠØ¯ Ø§Ù„Ø­Ø´ÙˆØ¯", description: "ÙØ² ÙÙŠ 5 Ù…Ù†Ø§ÙØ³Ø§Øª Ø­Ø§Ø´Ø¯Ø©", icon: "<i class='bx bxs-group'></i>", target: 5, stat: 'winsMassive', rewardPoints: 150 },



Â  Â  // --- ğŸ›¡ï¸ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„ÙØ±Ù‚ ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø© (Teams & Leadership) ğŸ›¡ï¸ ---

Â  Â  'create_team':Â  Â  Â  Â { name: "Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³", description: "Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙØ±ÙŠÙ‚Ùƒ Ø§Ù„Ø®Ø§Øµ", icon: "<i class='bx bxs-shield-plus'></i>", target: 1, stat: 'teamsLed', rewardPoints: 30 },

Â  Â  'join_team':Â  Â  Â  Â  Â { name: "Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", description: "Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©", icon: "<i class='bx bx-user-plus'></i>", target: 1, stat: 'joinedTeam', rewardPoints: 15 },

Â  Â  'team_reach_1000':Â  Â { name: "ÙØ±ÙŠÙ‚ ØµØ§Ø¹Ø¯", description: "Ø³Ø§Ù‡Ù… ÙÙŠ ÙˆØµÙˆÙ„ ÙØ±ÙŠÙ‚Ùƒ Ø¥Ù„Ù‰ 1000 Ù†Ù‚Ø·Ø©", icon: "<i class='bx bxs-chart'></i>", target: 1, stat: 'team1000Points', rewardPoints: 75 },

Â  Â  'team_reach_5000':Â  Â { name: "Ù‚ÙˆØ© Ù„Ø§ ÙŠØ³ØªÙ‡Ø§Ù† Ø¨Ù‡Ø§", description: "Ø³Ø§Ù‡Ù… ÙÙŠ ÙˆØµÙˆÙ„ ÙØ±ÙŠÙ‚Ùƒ Ø¥Ù„Ù‰ 5000 Ù†Ù‚Ø·Ø©", icon: "<i class='bx bxs-bar-chart-alt-2'></i>", target: 1, stat: 'team5000Points', rewardPoints: 250 },



Â  Â  // --- ğŸï¸ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„Ø¬Ø²Ø± (Island Conquest) ğŸï¸ ---

Â  Â  'challenge_island':Â  { name: "Ø§Ù„Ù…ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ÙˆÙ„", description: "Ø®Ø¶ Ø£ÙˆÙ„ ØªØ­Ø¯ÙŠ Ù„Ùƒ Ø¹Ù„Ù‰ Ø¬Ø²ÙŠØ±Ø©", icon: "<i class='bx bxs-flag-alt'></i>", target: 1, stat: 'islandChallenges', rewardPoints: 20 },

Â  Â  'conquer_1_island':Â  { name: "ÙØ§ØªØ­ Ø§Ù„Ø¬Ø²Ø±", description: "Ø³Ø§Ù‡Ù… ÙÙŠ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø¬Ø²ÙŠØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ ÙØ±ÙŠÙ‚Ùƒ", icon: "<i class='bx bxs-landscape'></i>", target: 1, stat: 'islandVictories', rewardPoints: 200 },

Â  Â  'conquer_all_islands': { name: "Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±", description: "Ø³Ø§Ù‡Ù… ÙÙŠ Ø³ÙŠØ·Ø±Ø© ÙØ±ÙŠÙ‚Ùƒ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø²Ø± ÙÙŠ ÙˆÙ‚Øª ÙˆØ§Ø­Ø¯", icon: "<i class='bx bxs-map-alt'></i>", target: 1, stat: 'conqueredAllIslands', rewardPoints: 1000 },

Â  Â  'hold_island_bonus': { name: "Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø³ÙŠØ·Ø±Ø©", description: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ø²ÙŠØ±Ø©", icon: "<i class='bx bxs-gift'></i>", target: 1, stat: 'islandBonusCollected', rewardPoints: 50 },

Â  Â Â 

Â  Â  // --- ğŸ† Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ (Single Player) ğŸ† ---

Â  Â  'complete_tier1':Â  Â  { name: "Ø§ÙŠØ¬Ù†Øª Ø·Ù…ÙˆØ­", description: "Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª ÙØ¦Ø© 'Ø§ÙŠØ¬Ù†Øª Ø¹Ø§Ø¯ÙŠ'", icon: "<i class='bx bx-shield-quarter'></i>", target: 1, stat: 'tier1unlocked', rewardPoints: 50 },

Â  Â  'complete_tier3':Â  Â  { name: "Ø®Ø¨ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©", description: "Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª ÙØ¦Ø© 'Ø§ÙŠØ¬Ù†Øª ÙƒÙˆØ§Ù„ØªÙŠ'", icon: "<i class='bx bx-shield-x'></i>", target: 1, stat: 'tier3unlocked', rewardPoints: 150 },

Â  Â  'complete_all_sp':Â  Â { name: "Ø£Ø³Ø·ÙˆØ±Ø© ÙØ±Ø¯ÙŠØ©", description: "Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ", icon: "<i class='bx bxs-diamond'></i>", target: 1, stat: 'allSPCompleted', rewardPoints: 500 },



Â  Â  // --- âœ¨ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© (Misc & Social) âœ¨ ---

Â  Â  'chat_first_message':{ name: "Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", description: "Ø£Ø±Ø³Ù„ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ù„Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©", icon: "<i class='bx bxs-message-dots'></i>", target: 1, stat: 'messagesSent', rewardPoints: 10 },

Â  Â  'reach_level_10':Â  Â  { name: "Ù…Ø³ØªÙˆÙ‰ 10", description: "Ø£ÙˆØµÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 10", icon: "<i class='bx bxs-up-arrow-circle'></i>", target: 1, stat: 'level10Reached', rewardPoints: 40 },

Â  Â  'reach_level_25':Â  Â  { name: "Ù…Ø³ØªÙˆÙ‰ 25", description: "Ø£ÙˆØµÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 25", icon: "<i class='bx bxs-chevrons-up'></i>", target: 1, stat: 'level25Reached', rewardPoints: 120 }

}

// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ù‡Ù†Ø§

};



const app = initializeApp(firebaseConfig);

const auth = getAuth(app);

const db = getFirestore(app);

let AppState = { currentUser: null, playerProfile: null, playerTeam: null, currentLobbyId: null, modalCallback: null, musicPlayer: null, isMuted: true, unsubscribers: {}, singlePlayerState: { currentTier: null, currentLevel: null, questions: [], currentQuestionIndex: 0, answers: [] }, questionTimer: null };



// ===================================================================================

// âœ¨ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… âœ¨

// ===================================================================================

function showScreen(screenId) {

Â  Â  document.querySelectorAll('.screen-container').forEach(s => s.classList.remove('active'));

Â  Â  const screen = document.getElementById(screenId);

Â  Â  if (screen) {

Â  Â  Â  Â  if (!screen.hasAttribute('data-rendered')) {

Â  Â  Â  Â  Â  Â  const template = document.getElementById(`${screenId}-template`);

Â  Â  Â  Â  Â  Â  if (template) { screen.innerHTML = template.innerHTML; screen.setAttribute('data-rendered', 'true'); }

Â  Â  Â  Â  }

Â  Â  Â  Â  screen.classList.add('active');

Â  Â  }

}

function showModal(title, message, confirmText = 'Ù†Ø¹Ù…', cancelText = 'Ø¥Ù„ØºØ§Ø¡', onConfirm) {

Â  Â  const modal = document.getElementById('modal');

Â  Â  if(!modal) return;

Â  Â  modal.innerHTML = document.getElementById('modal-template').innerHTML;

Â  Â  const titleEl = modal.querySelector('#modal-title'), bodyEl = modal.querySelector('#modal-body'), confirmBtn = modal.querySelector('[data-action="modal-confirm"]'), cancelBtn = modal.querySelector('[data-action="modal-cancel"]');

Â  Â  if (titleEl) titleEl.textContent = title;

Â  Â  if (bodyEl) bodyEl.textContent = message;

Â  Â  if (confirmBtn) confirmBtn.textContent = confirmText;

Â  Â  if (cancelBtn) cancelBtn.textContent = cancelText;

Â  Â  if (!onConfirm) {

Â  Â  Â  Â  if (confirmBtn) confirmBtn.style.display = 'none';

Â  Â  Â  Â  if (cancelBtn) cancelBtn.textContent = 'Ø­Ø³Ù†Ù‹Ø§';

Â  Â  Â  Â  cancelBtn.onclick = hideModal;

Â  Â  } else {

Â  Â  Â  Â  if (confirmBtn) confirmBtn.style.display = 'flex';

Â  Â  Â  Â  confirmBtn.onclick = () => { onConfirm(); hideModal(); };

Â  Â  Â  Â  cancelBtn.onclick = hideModal;

Â  Â  }

Â  Â  AppState.modalCallback = onConfirm;

Â  Â  modal.classList.add('visible');

}

function hideModal() {Â 

Â  Â  const modal = document.getElementById('modal');

Â  Â  if(modal) modal.classList.remove('visible');Â 

Â  Â  AppState.modalCallback = null;Â 

}

function showToast(message) {

Â  Â  const container = document.getElementById('toast-container'); if (!container) return;

Â  Â  const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = `ğŸ‰ ${message}`;

Â  Â  container.appendChild(toast);

Â  Â  setTimeout(() => toast.classList.add('show'), 10);

Â  Â  setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);

}

function toggleMusic() {

Â  Â  if (!AppState.musicPlayer) { AppState.musicPlayer = new Audio('https://v15mbanna3.github.io/my-sounds/Gna7%20felsama.mp3'); AppState.musicPlayer.loop = true; }

Â  Â  AppState.isMuted = !AppState.isMuted;

Â  Â  const muteBtn = document.getElementById('mute-btn');

Â  Â  if (AppState.isMuted) { AppState.musicPlayer.pause(); if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-mute'></i>"; }Â 

Â  Â  else { AppState.musicPlayer.play().catch(() => { AppState.isMuted = true; if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-mute'></i>"; }); if (muteBtn) muteBtn.innerHTML = "<i class='bx bx-volume-full'></i>"; }

}

function cleanupListeners() { Object.values(AppState.unsubscribers).forEach(unsub => unsub()); AppState.unsubscribers = {}; AppState.currentLobbyId = null; clearTimeout(AppState.questionTimer); }



/**

Â * Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ø¯Ø¯

Â * @param {string} bankName - Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ ('singlePlayer', 'online', Ø£Ùˆ 'islands.island_id')

Â * @param {number} count - Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

Â * @returns {Array}

Â */

function getQuestions(bankName, count) {

Â  Â  let bank;

Â  Â  if (bankName.startsWith('islands.')) {

Â  Â  Â  Â  const islandId = bankName.split('.')[1];

Â  Â  Â  Â  bank = GAME_CONFIG.questionBanks.islands[islandId] || [];

Â  Â  } else {

Â  Â  Â  Â  bank = GAME_CONFIG.questionBanks[bankName] || [];

Â  Â  }

Â  Â  const shuffled = [...bank].sort(() => 0.5 - Math.random());

Â  Â  return shuffled.slice(0, count);

}



// ===================================================================================

// âœ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŒ ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª âœ¨

// ===================================================================================

async function updatePlayerStat(stat, value = 1) {

Â  Â  if (!AppState.playerProfile || !AppState.playerProfile.id) return;

Â  Â  const playerRef = doc(db, "players", AppState.playerProfile.id);

Â  Â  try {

Â  Â  Â  Â  await updateDoc(playerRef, { [`stats.${stat}`]: increment(value) });

Â  Â  Â  Â  if (!AppState.playerProfile.stats) AppState.playerProfile.stats = {};

Â  Â  Â  Â  AppState.playerProfile.stats[stat] = (AppState.playerProfile.stats[stat] || 0) + value;

Â  Â  Â  Â  await checkAndGrantAchievements();

Â  Â  } catch(e) { console.error("Failed to update stat: ", e); }

}



async function checkAndGrantAchievements() {

Â  Â  const profile = AppState.playerProfile;

Â  Â  if (!profile || !profile.stats) return;

Â  Â  const myAchievements = profile.unlockedAchievements || [];

Â  Â  let newAchievements = false;

Â  Â  const batch = writeBatch(db);

Â  Â  const playerRef = doc(db, "players", profile.id);

Â  Â  let pointsToAdd = 0;

Â  Â  for (const [key, ach] of Object.entries(GAME_CONFIG.achievements)) {

Â  Â  Â  Â  if (!myAchievements.includes(key)) {

Â  Â  Â  Â  Â  Â  const statValue = profile.stats[ach.stat] || 0;

Â  Â  Â  Â  Â  Â  if (statValue >= ach.target) {

Â  Â  Â  Â  Â  Â  Â  Â  myAchievements.push(key); newAchievements = true; pointsToAdd += ach.rewardPoints;

Â  Â  Â  Â  Â  Â  Â  Â  batch.update(playerRef, { unlockedAchievements: arrayUnion(key) });

Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯: ${ach.name}! (+${ach.rewardPoints} Ù†Ù‚Ø·Ø©)`);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

Â  Â  if (newAchievements) {

Â  Â  Â  Â  batch.update(playerRef, { score: increment(pointsToAdd) });

Â  Â  Â  Â  await batch.commit().catch(console.error);

Â  Â  Â  Â  AppState.playerProfile.unlockedAchievements = myAchievements;

Â  Â  Â  Â  AppState.playerProfile.score = (AppState.playerProfile.score || 0) + pointsToAdd;

Â  Â  Â  Â  updateMainMenu();

Â  Â  }

}



function showAchievementsScreen() {

Â  Â  showScreen('achievements-screen');

Â  Â  const list = document.getElementById('achievements-list');

Â  Â  if(!list) return;

Â  Â  const myAchievements = AppState.playerProfile.unlockedAchievements || [];

Â  Â  list.innerHTML = Object.entries(GAME_CONFIG.achievements).map(([key, ach]) => {

Â  Â  Â  Â  const unlocked = myAchievements.includes(key);

Â  Â  Â  Â  const currentProgress = AppState.playerProfile.stats?.[ach.stat] || 0;

Â  Â  Â  Â  const progressText = unlocked ? 'Ù…ÙƒØªÙ…Ù„' : `${currentProgress} / ${ach.target}`;

Â  Â  Â  Â  const iconHTML = typeof ach.icon === 'string' && ach.icon.startsWith('<') ? ach.icon : `<div class="achievement-icon">${ach.icon}</div>`;

Â  Â  Â  Â  return `<div class="achievement-item ${unlocked ? 'unlocked' : ''}">${iconHTML}<div><h3 style="margin:0;">${ach.name}</h3><p style="color:var(--text-secondary); margin:0;">${ach.description}</p><p style="color:var(--accent-cyan); margin:0.5rem 0 0 0; font-weight:bold;">${progressText}</p></div></div>`;

Â  Â  }).join('');

}



async function handleLogin() {

Â  Â  const name = document.getElementById('name-input')?.value.trim();

Â  Â  const teleoptiId = document.getElementById('teleopti-id-input')?.value.trim();

Â  Â  if (!name || !teleoptiId || !/^\d+$/.test(teleoptiId)) return showModal("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ùˆ Teleopti ID ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·).", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  showScreen('loading-screen');

Â  Â  try {

Â  Â  Â  Â  if (!auth.currentUser) await signInAnonymously(auth);

Â  Â  Â  Â  AppState.currentUser = auth.currentUser;

Â  Â  Â  Â  const playerRef = doc(db, "players", teleoptiId);

Â  Â  Â  Â  await runTransaction(db, async (t) => {

Â  Â  Â  Â  Â  Â  const playerDoc = await t.get(playerRef);

Â  Â  Â  Â  Â  Â  const defaultStats = Object.keys(GAME_CONFIG.achievements).reduce((acc, key) => {

Â  Â  Â  Â  Â  Â  Â  Â  acc[GAME_CONFIG.achievements[key].stat] = 0;

Â  Â  Â  Â  Â  Â  Â  Â  return acc;

Â  Â  Â  Â  Â  Â  }, {});



Â  Â  Â  Â  Â  Â  if (!playerDoc.exists()) {

Â  Â  Â  Â  Â  Â  Â  Â  t.set(playerRef, { name, teleoptiId, uid: auth.currentUser.uid, score: 0, awards: [], singlePlayerProgress: {}, stats: defaultStats, unlockedAchievements: [], teamId: null, createdAt: serverTimestamp() });

Â  Â  Â  Â  Â  } else {

Â  Â  // Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†ØŒ Ù†Ù‚ÙˆÙ… ÙÙ‚Ø· Ø¨ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.

Â  Â  // Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€ UID Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

Â  Â  // Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ÙŠÙ† Ø§Ù„Ù…ØªÙƒØ±Ø±ÙŠÙ†.

Â  Â  t.update(playerRef, { lastLogin: serverTimestamp() });

}

Â  Â  Â  Â  });

Â  Â  Â  Â  if (document.getElementById('remember-me-checkbox')?.checked) {

Â  Â  Â  Â  Â  Â  localStorage.setItem('triviaTeleoptiId', teleoptiId); localStorage.setItem('triviaName', name);

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  localStorage.removeItem('triviaTeleoptiId'); localStorage.removeItem('triviaName');

Â  Â  Â  Â  }

Â  Â  Â  Â  await loadPlayerProfile(teleoptiId);

Â  Â  } catch (error) { console.error(error); showModal("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`, null, "Ø­Ø³Ù†Ù‹Ø§"); showScreen('registration-screen'); }

}



async function loadPlayerProfile(teleoptiId) {

Â  Â  try {

Â  Â  Â  Â  const playerDoc = await getDoc(doc(db, "players", teleoptiId));

Â  Â  Â  Â  if (playerDoc.exists()) {

Â  Â  Â  Â  Â  Â  AppState.playerProfile = { ...playerDoc.data(), id: playerDoc.id };

Â  Â  Â  Â  Â  Â  if (!AppState.playerProfile.stats) AppState.playerProfile.stats = {}; // Safety check

Â  Â  Â  Â  Â  Â  if (AppState.playerProfile.teamId) {

Â  Â  Â  Â  Â  Â  Â  Â  const teamDoc = await getDoc(doc(db, "teams", AppState.playerProfile.teamId));

Â  Â  Â  Â  Â  Â  Â  Â  AppState.playerTeam = teamDoc.exists() ? { ...teamDoc.data(), id: teamDoc.id } : null;

Â  Â  Â  Â  Â  Â  } else { AppState.playerTeam = null; }

Â  Â  Â  Â  Â  Â  showScreen('main-menu-screen');

Â  Â  Â  Â  Â  Â  updateMainMenu();

Â  Â  Â  Â  Â  Â  await checkAndGrantAchievements();

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  localStorage.removeItem('triviaTeleoptiId'); showScreen('registration-screen'); showModal("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ø°Ø§.", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  Â  Â  }

Â  Â  } catch (error) { console.error(error); showScreen('registration-screen'); showModal("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©", `Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ: ${error.message}`, null, "Ø­Ø³Ù†Ù‹Ø§"); }

}



function handleLogout() {

Â  Â  showModal('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', 'Ù†Ø¹Ù…', 'Ù„Ø§', async () => {

Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  await signOut(auth).catch(console.error);

Â  Â  Â  Â  AppState = { ...AppState, currentUser: null, playerProfile: null, playerTeam: null };

Â  Â  Â  Â  localStorage.removeItem('triviaTeleoptiId'); localStorage.removeItem('triviaName');

Â  Â  Â  Â  showScreen('registration-screen');

Â  Â  Â  Â  repopulateLoginFields();

Â  Â  });

}



function repopulateLoginFields() {

Â  Â  try {

Â  Â  Â  Â  document.getElementById('name-input').value = localStorage.getItem('triviaName') || '';

Â  Â  Â  Â  document.getElementById('teleopti-id-input').value = localStorage.getItem('triviaTeleoptiId') || '';

Â  Â  } catch (e) {}

}



function updateMainMenu() {

Â  Â Â 

Â  Â  if (!AppState.playerProfile) return;

Â  Â  const welcomeMsg = document.getElementById('welcome-message');

Â  Â  const teamTagDisplay = AppState.playerTeam ? `<span class="team-tag">[${AppState.playerTeam.tag}]</span>` : '';

Â  Â  if (welcomeMsg) welcomeMsg.innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ, ${teamTagDisplay} <span class="name">${AppState.playerProfile.name}</span>`;

}

function listenForNotifications() {

Â  Â  if (!AppState.playerProfile?.id) return;

Â  Â  const notificationsRef = collection(db, `players/${AppState.playerProfile.id}/notifications`);

Â  Â  const q = query(notificationsRef, where("isRead", "==", false));



Â  Â  AppState.unsubscribers.notifications = onSnapshot(q, (snapshot) => {

Â  Â  Â  Â  const indicator = document.getElementById('notification-indicator');

Â  Â  Â  Â  if (!indicator) return;



Â  Â  Â  Â  if (snapshot.empty) {

Â  Â  Â  Â  Â  Â  indicator.style.display = 'none';

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  indicator.style.display = 'block';

Â  Â  Â  Â  }

Â  Â  });

}

// === Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===

async function sendNotification(playerId, message) {

Â  Â  if (!playerId || !message) return;

Â  Â  const notificationsRef = collection(db, `players/${playerId}/notifications`);

Â  Â  await addDoc(notificationsRef, {

Â  Â  Â  Â  text: message,

Â  Â  Â  Â  isRead: false,

Â  Â  Â  Â  timestamp: serverTimestamp()

Â  Â  });

}

// === Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===

async function showNotificationsScreen() {

Â  Â  showScreen('notifications-screen');

Â  Â  const list = document.getElementById('notifications-list');

Â  Â  list.innerHTML = `<p>Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</p>`;



Â  Â  const notificationsRef = collection(db, `players/${AppState.playerProfile.id}/notifications`);

Â  Â  const q = query(notificationsRef, orderBy("timestamp", "desc"));

Â  Â  const snapshot = await getDocs(q);



Â  Â  if (snapshot.empty) {

Â  Â  Â  Â  list.innerHTML = `<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.</p>`;

Â  Â  } else {

Â  Â  Â  Â  list.innerHTML = snapshot.docs.map(doc => {

Â  Â  Â  Â  Â  Â  const notif = doc.data();

Â  Â  Â  Â  Â  Â  // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªØµÙ…ÙŠÙ… Ø£ÙØ¶Ù„ Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§

Â  Â  Â  Â  Â  Â  return `<div class="list-item">${notif.text}</div>`;

Â  Â  Â  Â  }).join('');

Â  Â  }

}

// Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ù…Ù† Ù‡Ù†Ø§

async function checkLevelUpAchievements() {

Â  Â  if (!AppState.playerProfile) return;

Â  Â  const score = AppState.playerProfile.score || 0;

Â  Â  const level = Math.floor(score / 500) + 1;

Â  Â  const achievements = AppState.playerProfile.unlockedAchievements || [];



Â  Â  if (level >= 10 && !achievements.includes('reach_level_10')) {

Â  Â  Â  Â  await updatePlayerStat('level10Reached');

Â  Â  }

Â  Â  if (level >= 25 && !achievements.includes('reach_level_25')) {

Â  Â  Â  Â  await updatePlayerStat('level25Reached');

Â  Â  }

}

// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ Ù‡Ù†Ø§

// ===================================================================================

// âœ¨ Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ±Ù‚ âœ¨

// ===================================================================================

async function showTeamHub() {

Â  Â  showScreen('team-hub-screen');

Â  Â  const noTeamView = document.getElementById('no-team-view');

Â  Â  const teamView = document.getElementById('team-view');

Â  Â  if (!AppState.playerProfile || !noTeamView || !teamView) return;



Â  Â  if (!AppState.playerTeam) {

Â  Â  Â  Â  noTeamView.style.display = 'block';

Â  Â  Â  Â  teamView.style.display = 'none';

Â  Â  } else {

Â  Â  Â  Â  noTeamView.style.display = 'none';

Â  Â  Â  Â  teamView.style.display = 'block';



Â  Â  Â  Â  const teamDoc = await getDoc(doc(db, "teams", AppState.playerTeam.id));

Â  Â  Â  Â  const teamData = teamDoc.data();

Â  Â  Â  Â  // ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØ§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ) ...

Â  Â  Â  Â  document.getElementById('team-name-title').textContent = `${teamData.name} [${teamData.tag}]`;

Â  Â  Â  Â  // ...



Â  Â  Â  Â  // >> ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯: Ø¥Ø¸Ù‡Ø§Ø± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ø§Ø¦Ø¯ <<

Â  Â  Â  Â  const requestsContainer = document.getElementById('team-requests-container');

Â  Â  Â  Â  if (AppState.currentUser.uid === teamData.leaderId) {

Â  Â  Â  Â  Â  Â  requestsContainer.style.display = 'block';

Â  Â  Â  Â  Â  Â  const requestsList = document.getElementById('team-requests-list');



Â  Â  Â  Â  Â  Â  const requestsQuery = query(collection(db, `teams/${AppState.playerTeam.id}/joinRequests`));

Â  Â  Â  Â  Â  Â  onSnapshot(requestsQuery, (snapshot) => {

Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestsList.innerHTML = '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù†Ø¶Ù…Ø§Ù… Ø­Ø§Ù„ÙŠØ©.</p>';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  requestsList.innerHTML = snapshot.docs.map(doc => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const request = doc.data();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="list-item">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-name">${request.name}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-value" style="font-size:0.9rem; margin-right: 1rem;">${request.score} Ù†Ù‚Ø·Ø©</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:0.5rem;">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="accept-join-request" data-player-id="${request.playerId}" data-team-id="${AppState.playerTeam.id}" class="btn" style="background-color:var(--accent-green); padding: 0.5rem; width:auto;">Ù‚Ø¨ÙˆÙ„</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="decline-join-request" data-request-id="${doc.id}" data-team-id="${AppState.playerTeam.id}" class="btn" style="background-color:var(--accent-red); padding: 0.5rem; width:auto;">Ø±ÙØ¶</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  requestsContainer.style.display = 'none';

Â  Â  Â  Â  }

Â  Â  }

}

// === Ø£Ø¶Ù Ù‡Ø§ØªÙŠÙ† Ø§Ù„Ø¯Ø§Ù„ØªÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ØªÙŠÙ† ===



async function acceptJoinRequest(playerId, teamId) {

Â  Â  const playerRef = doc(db, "players", playerId);

Â  Â  const requestRef = doc(db, `teams/${teamId}/joinRequests`, playerId);

Â  Â  const teamRef = doc(db, "teams", teamId);



Â  Â  try {

Â  Â  Â  Â  const teamDoc = await getDoc(teamRef);

Â  Â  Â  Â  const teamName = teamDoc.exists() ? teamDoc.data().name : "ÙØ±ÙŠÙ‚Ùƒ";



Â  Â  Â  Â  await runTransaction(db, async (t) => {

Â  Â  Â  Â  Â  Â  t.update(playerRef, { teamId: teamId });

Â  Â  Â  Â  Â  Â  t.delete(requestRef);

Â  Â  Â  Â  });



Â  Â  Â  Â  sendNotification(playerId, `ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù…Ùƒ Ù„ÙØ±ÙŠÙ‚ "${teamName}".`);

Â  Â  Â  Â  showToast("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");



Â  Â  Â  Â  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙˆØ±Ù‹Ø§

Â  Â  Â  Â  if(document.getElementById('team-hub-screen').classList.contains('active')) {

Â  Â  Â  Â  Â  Â  showTeamHub();

Â  Â  Â  Â  }

Â  Â  } catch(error) {

Â  Â  Â  Â  console.error("Failed to accept request", error);

Â  Â  Â  Â  showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.");

Â  Â  }

}



async function declineJoinRequest(requestId, teamId) {

Â  Â  await deleteDoc(doc(db, `teams/${teamId}/joinRequests`, requestId));

Â  Â  showToast("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨.");

}



async function handleCreateTeam() {

Â  Â  const nameInput = document.getElementById('team-name-input');

Â  Â  const tagInput = document.getElementById('team-tag-input');

Â  Â  if (!nameInput || !tagInput) return;



Â  Â  const name = nameInput.value.trim();

Â  Â  const tag = tagInput.value.trim().toUpperCase();



Â  Â  if (!name || tag.length < 3) {

Â  Â  Â  Â  return showModal("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ´Ø¹Ø§Ø± Ù„Ù„ÙØ±ÙŠÙ‚ (3-5 Ø­Ø±ÙˆÙ).", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  }



Â  Â  const teamId = Math.random().toString(36).substring(2, 8).toUpperCase();

Â  Â  const teamRef = doc(db, "teams", teamId);

Â  Â  const playerRef = doc(db, "players", AppState.playerProfile.id);



Â  Â  try {

Â  Â  Â  Â  await runTransaction(db, async (t) => {

Â  Â  Â  Â  Â  Â  t.set(teamRef, { name, tag, leaderId: AppState.currentUser.uid, score: 0, createdAt: serverTimestamp(), islandControlCount: 0 });

Â  Â  Â  Â  Â  Â  t.update(playerRef, { teamId: teamId });

Â  Â  Â  Â  });

Â  Â  Â  Â  await updatePlayerStat('teamsLed');

Â  Â  Â  Â  await loadPlayerProfile(AppState.playerProfile.id);

Â  Â  Â  Â  showTeamHub();

Â  Â  } catch (error) {

Â  Â  Â  Â  console.error("Team creation failed:", error);

Â  Â  Â  Â  showModal("Ø®Ø·Ø£", "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  }

Â  Â  listenForNotifications();

}



// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ÙØ±ÙŠÙ‚ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª)

async function handleJoinTeam() {

Â  Â  const teamIdInput = document.getElementById('team-id-input');

Â  Â  if(!teamIdInput) return;

Â  Â  const teamId = teamIdInput.value.trim().toUpperCase();

Â  Â  if (!teamId) return showModal("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠÙ‚.", null, "Ø­Ø³Ù†Ù‹Ø§");



Â  Â  const teamRef = doc(db, "teams", teamId);

Â  Â  try {

Â  Â  Â  Â  const teamDoc = await getDoc(teamRef);

Â  Â  Â  Â  if (!teamDoc.exists()) {

Â  Â  Â  Â  Â  Â  return showModal("Ø®Ø·Ø£", "ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­.", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±

Â  Â  Â  Â  const requestRef = doc(db, `teams/${teamId}/joinRequests`, AppState.playerProfile.id);

Â  Â  Â  Â  await setDoc(requestRef, {

Â  Â  Â  Â  Â  Â  playerId: AppState.playerProfile.id,

Â  Â  Â  Â  Â  Â  name: AppState.playerProfile.name,

Â  Â  Â  Â  Â  Â  score: AppState.playerProfile.score || 0,

Â  Â  Â  Â  Â  Â  requestedAt: serverTimestamp()

Â  Â  Â  Â  });



Â  Â  Â  Â  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚ (Ø³Ù†Ø¶ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§)

Â  Â  Â  Â  const teamData = teamDoc.data();

Â  Â  Â  Â  if(teamData.leaderId) {

Â  Â  Â  Â  Â  Â  Â  sendNotification(teamData.leaderId, `Ø§Ù„Ù„Ø§Ø¹Ø¨ ${AppState.playerProfile.name} ÙŠØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ÙØ±ÙŠÙ‚Ùƒ.`);

Â  Â  Â  Â  }



Â  Â  Â  Â  showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!");

Â  Â  Â  Â  showScreen('main-menu-screen');



Â  Â  } catch (error) {

Â  Â  Â  Â  console.error("Send join request failed:", error);

Â  Â  Â  Â  showModal("Ø®Ø·Ø£", "ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù….", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  }

}



function handleLeaveTeam() {

Â  Â  showModal("Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚ØŸ", "Ù†Ø¹Ù…", "Ù„Ø§", async () => {

Â  Â  Â  Â  if (!AppState.playerProfile) return;

Â  Â  Â  Â  const playerRef = doc(db, "players", AppState.playerProfile.id);

Â  Â  Â  Â  await updateDoc(playerRef, { teamId: null });

Â  Â  Â  Â  AppState.playerTeam = null; // Clear local state immediately

Â  Â  Â  Â  showTeamHub();

Â  Â  });

}

// ===================================================================================

// âœ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ âœ¨

// ===================================================================================

function displayTiers() {

Â  Â  showScreen('single-player-menu-screen');

Â  Â  const grid = document.getElementById('tiers-grid');

Â  Â  if(!grid) return;

Â  Â  grid.innerHTML = '';

Â  Â  let lastTierCompleted = true;

Â  Â  GAME_CONFIG.singlePlayerTiers.forEach((tier, index) => {

Â  Â  Â  Â  const completedLevels = AppState.playerProfile.singlePlayerProgress?.[tier.id]?.length || 0;

Â  Â  Â  Â  const isLocked = index > 0 && !lastTierCompleted;

Â  Â  Â  Â  const progressPercent = (completedLevels / tier.levels) * 100;

Â  Â  Â  Â Â 

Â  Â  Â  Â  const card = document.createElement('div');

Â  Â  Â  Â  card.className = `card ${isLocked ? 'locked' : ''}`;

Â  Â  Â  Â  card.innerHTML = `

Â  Â  Â  Â  Â  Â  <div class="card-icon"><i class='bx ${isLocked ? 'bxs-lock' : tier.icon}'></i></div>

Â  Â  Â  Â  Â  Â  <h3 class="card-title">${tier.name} ${tier.medal}</h3>

Â  Â  Â  Â  Â  Â  <p class="screen-subtitle" style="margin:0.5rem 0;">Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª: ${tier.levels}</p>

Â  Â  Â  Â  Â  Â  <div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>

Â  Â  Â  Â  `;

Â  Â  Â  Â  if (!isLocked) card.onclick = () => displayLevels(tier);

Â  Â  Â  Â  grid.appendChild(card);

Â  Â  Â  Â  if (progressPercent < 100) lastTierCompleted = false;

Â  Â  });

}



function displayLevels(tier) {

Â  Â  AppState.singlePlayerState.currentTier = tier;

Â  Â  showScreen('level-select-screen');

Â  Â  document.getElementById('level-select-title').textContent = tier.name;

Â  Â  const grid = document.getElementById('levels-grid');

Â  Â  if(!grid) return;

Â  Â  grid.innerHTML = '';

Â  Â  const completedInTier = AppState.playerProfile.singlePlayerProgress?.[tier.id] || [];

Â  Â  for (let i = 0; i < tier.levels; i++) {

Â  Â  Â  Â  const isCompleted = completedInTier.includes(i);

Â  Â  Â  Â  const card = document.createElement('div');

Â  Â  Â  Â  card.className = `card level-card ${isCompleted ? 'completed' : ''}`;

Â  Â  Â  Â  card.innerHTML = `<h3 class="card-title">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${i + 1}</h3> ${isCompleted ? '<p style="color:var(--accent-green); margin:0;">âœ… Ù…ÙƒØªÙ…Ù„</p>' : ''}`;

Â  Â  Â  Â  card.onclick = () => startSinglePlayerLevel(tier, i);

Â  Â  Â  Â  grid.appendChild(card);

Â  Â  }

}



function startSinglePlayerLevel(tier, levelIndex) {

Â  Â  AppState.singlePlayerState = { currentTier: tier, currentLevel: levelIndex, questions: getQuestions('singlePlayer', tier.questionsPerLevel), currentQuestionIndex: 0, answers: [] };

Â  Â  displaySinglePlayerQuestion();

}



function displaySinglePlayerQuestion() {

Â  Â  showScreen('match-screen');

Â  Â  document.querySelector('#match-screen [data-action="surrender"]').style.display = 'none';

Â  Â  const backBtn = document.querySelector('#match-screen .back-btn');

Â  Â  if(backBtn) {

Â  Â  Â  Â  backBtn.style.display = 'block';

Â  Â  Â  Â  backBtn.onclick = () => {

Â  Â  Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  Â  Â  showScreen('level-select-screen');

Â  Â  Â  Â  Â  Â  displayLevels(AppState.singlePlayerState.currentTier);

Â  Â  Â  Â  };

Â  Â  }



Â  Â  const { currentTier, currentQuestionIndex, questions } = AppState.singlePlayerState;

Â  Â  if (!questions || questions.length === 0) {

Â  Â  Â  Â  showModal("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.", null, "Ù…ÙˆØ§ÙÙ‚", () => displayTiers());

Â  Â  Â  Â  return;

Â  Â  }

Â  Â  const question = questions[currentQuestionIndex];



Â  Â  document.getElementById('match-header').textContent = `${currentTier.name} - Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${AppState.singlePlayerState.currentLevel + 1}`;

Â  Â  document.getElementById('question-counter').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} / ${questions.length}`;

Â  Â  document.getElementById('question-text').innerHTML = question.question;

Â  Â  document.getElementById('explanation-box').style.display = 'none';

Â  Â  const optionsGrid = document.getElementById('options-grid');

Â  Â  optionsGrid.innerHTML = '';



Â  Â  Object.entries(question.options).forEach(([key, optionText]) => {

Â  Â  Â  Â  const btn = document.createElement('button');

Â  Â  Â  Â  btn.className = 'btn btn-secondary option-btn';

Â  Â  Â  Â  btn.textContent = optionText;

Â  Â  Â  Â  btn.onclick = () => handleSinglePlayerAnswer(key);

Â  Â  Â  Â  optionsGrid.appendChild(btn);

Â  Â  });

}



function handleSinglePlayerAnswer(selectedKey) {

Â  Â  const { questions, currentQuestionIndex, currentTier } = AppState.singlePlayerState;

Â  Â  const question = questions[currentQuestionIndex];

Â  Â  const isCorrect = selectedKey === question.correct_answer;

Â  Â Â 

Â  Â  document.querySelectorAll('.option-btn').forEach(btn => { btn.disabled = true; });

Â  Â  const correctBtn = Array.from(document.querySelectorAll('.option-btn')).find(btn => btn.textContent === question.options[question.correct_answer]);

Â  Â  if(correctBtn) correctBtn.classList.add('correct');



Â  Â  if (!isCorrect) {

Â  Â  Â  Â  const wrongBtn = Array.from(document.querySelectorAll('.option-btn')).find(btn => btn.textContent === question.options[selectedKey]);

Â  Â  Â  Â  if(wrongBtn) wrongBtn.classList.add('wrong');

Â  Â  Â  Â  const explanationBox = document.getElementById('explanation-box');

Â  Â  Â  Â  if (question.explanation && explanationBox) {

Â  Â  Â  Â  Â  Â  explanationBox.textContent = `Ø§Ù„ØªÙØ³ÙŠØ±: ${question.explanation}`;

Â  Â  Â  Â  Â  Â  explanationBox.style.display = 'block';

Â  Â  Â  Â  }

Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  showModal("Ù„Ù„Ø£Ø³Ù!", "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.", null, 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', () => {

Â  Â  Â  Â  Â  Â  Â  Â  displayLevels(currentTier);

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  }, 2000);

Â  Â  } else {

Â  Â  Â  Â  AppState.singlePlayerState.answers.push(isCorrect);

Â  Â  Â  Â  if (AppState.singlePlayerState.currentQuestionIndex < questions.length - 1) {

Â  Â  Â  Â  Â  Â  AppState.singlePlayerState.currentQuestionIndex++;

Â  Â  Â  Â  Â  Â  setTimeout(displaySinglePlayerQuestion, 1200);

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  finishSinglePlayerLevel();

Â  Â  Â  Â  }

Â  Â  }

}



// Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ (Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¯Ø§Ù„Ø©)

// Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚ (Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¯Ø§Ù„Ø©)

async function finishSinglePlayerLevel() {

Â  Â  const { id: tierId, name, medal, points, awardPoints } = AppState.singlePlayerState.currentTier;

Â  Â  const levelIndex = AppState.singlePlayerState.currentLevel;

Â  Â  const playerRef = doc(db, "players", AppState.playerProfile.id);



Â  Â  const wasAlreadyCompleted = AppState.playerProfile.singlePlayerProgress[tierId]?.includes(levelIndex);



Â  Â  if (!wasAlreadyCompleted) {

Â  Â  Â  Â  await updateDoc(playerRef, {

Â  Â  Â  Â  Â  Â  score: increment(points),

Â  Â  Â  Â  Â  Â  [`singlePlayerProgress.${tierId}`]: arrayUnion(levelIndex)

Â  Â  Â  Â  });

Â  Â  Â  Â  AppState.playerProfile.score += points;

Â  Â  Â  Â  if (!AppState.playerProfile.singlePlayerProgress[tierId]) {

Â  Â  Â  Â  Â  Â  AppState.playerProfile.singlePlayerProgress[tierId] = [];

Â  Â  Â  Â  }

Â  Â  Â  Â  AppState.playerProfile.singlePlayerProgress[tierId].push(levelIndex);

Â  Â  }



Â  Â  const allTiers = GAME_CONFIG.singlePlayerTiers;

Â  Â  const currentTierData = allTiers.find(t => t.id === tierId);

Â  Â  const completedLevelsInTier = new Set(AppState.playerProfile.singlePlayerProgress[tierId] || []).size;

Â  Â  const wasTierAlreadyCompleted = AppState.playerProfile.awards?.includes(medal);



Â  Â  if (completedLevelsInTier >= currentTierData.levels && !wasTierAlreadyCompleted) {

Â  Â  Â  Â  await updateDoc(playerRef, {

Â  Â  Â  Â  Â  Â  awards: arrayUnion(medal),

Â  Â  Â  Â  Â  Â  score: increment(awardPoints)

Â  Â  Â  Â  });

Â  Â  Â  Â  showModal("ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!", `Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª ÙØ¦Ø© ${name} ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ¯Ø§Ù„ÙŠØ© ${medal} ÙˆÙ…ÙƒØ§ÙØ£Ø© ${awardPoints} Ù†Ù‚Ø·Ø©!`, null, "Ø±Ø§Ø¦Ø¹");



Â  Â  Â  Â  if (tierId === 'tier-1') await updatePlayerStat('tier1unlocked');

Â  Â  Â  Â  if (tierId === 'tier-3') await updatePlayerStat('tier3unlocked');



Â  Â  Â  Â  const allTiersCompleted = allTiers.every(tier => {

Â  Â  Â  Â  Â  Â  const progress = AppState.playerProfile.singlePlayerProgress[tier.id] || [];

Â  Â  Â  Â  Â  Â  return progress.length >= tier.levels;

Â  Â  Â  Â  });



Â  Â  Â  Â  if (allTiersCompleted) {

Â  Â  Â  Â  Â  Â  await updatePlayerStat('allSPCompleted');

Â  Â  Â  Â  }

Â  Â  } else {

Â  Â  Â  Â  showModal("Ù…Ø³ØªÙˆÙ‰ Ù…ÙƒØªÙ…Ù„!", `Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­. ${!wasAlreadyCompleted ? `+${points} Ù†Ù‚Ø§Ø·.` : ''}`, null, "Ù…ØªØ§Ø¨Ø¹Ø©");

Â  Â  }



Â  Â  await loadPlayerProfile(AppState.playerProfile.id);

Â  Â  displayTiers();

Â  Â  await checkLevelUpAchievements();

}

// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„ØµÙ‚

// ===================================================================================

// âœ¨âœ¨âœ¨ Ù†Ø¸Ø§Ù… Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„Ø¬Ø²Ø± Ø§Ù„Ù…Ø·ÙˆØ± âœ¨âœ¨âœ¨

// ===================================================================================

async function showIslandConquestScreen() {

Â  Â  if (!AppState.playerTeam) return showModal("Ù…ÙŠØ²Ø© Ù„Ù„ÙØ±Ù‚ ÙÙ‚Ø·", "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ø¶ÙˆÙ‹Ø§ ÙÙŠ ÙØ±ÙŠÙ‚ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„Ø¬Ø²Ø±.", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  showScreen('island-conquest-screen');

Â  Â  const grid = document.getElementById('island-map-grid');

Â  Â  if(!grid) return;

Â  Â  grid.innerHTML = `<p>Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø²Ø±...</p>`;

Â  Â  cleanupListeners();



Â  Â  await grantDailyIslandRewards();



Â  Â  AppState.unsubscribers.islands = onSnapshot(collection(db, 'islands'), async (snapshot) => {

Â  Â  Â  Â  const islands = {}; snapshot.docs.forEach(doc => { islands[doc.id] = doc.data(); });

Â  Â  Â  Â  const teamIds = new Set(Object.values(islands).map(i => i.controllingTeamId).filter(Boolean));

Â  Â  Â  Â  const teamDataMap = {};

Â  Â  Â  Â  if (teamIds.size > 0) {

Â  Â  Â  Â  Â  Â  const teamsQuery = query(collection(db, "teams"), where("__name__", "in", Array.from(teamIds)));

Â  Â  Â  Â  Â  Â  const teamDocs = await getDocs(teamsQuery);

Â  Â  Â  Â  Â  Â  teamDocs.forEach(doc => { teamDataMap[doc.id] = doc.data(); });

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  grid.innerHTML = Object.entries(GAME_CONFIG.islandDefinitions).map(([id, def]) => {

Â  Â  Â  Â  Â  Â  const islandState = islands[id];

Â  Â  Â  Â  Â  Â  const ownerTeamId = islandState?.controllingTeamId;

Â  Â  Â  Â  Â  Â  let ownerTag = 'Ù„Ø§ Ø£Ø­Ø¯';

Â  Â  Â  Â  Â  Â  let tileClass = '';

Â  Â  Â  Â  Â  Â  if (ownerTeamId && teamDataMap[ownerTeamId]) {

Â  Â  Â  Â  Â  Â  Â  Â  ownerTag = teamDataMap[ownerTeamId].tag;

Â  Â  Â  Â  Â  Â  Â  Â  if(ownerTeamId === AppState.playerTeam.id) tileClass = 'my-team'; else tileClass = 'enemy-team';

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return `<div class="island-tile ${tileClass}">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="island-icon">${def.icon}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="island-name">${def.name}</h3>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="island-owner">Ø§Ù„Ù…Ø³ÙŠØ·Ø±: <span class="team-tag">${ownerTag}</span></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${ownerTeamId === AppState.playerTeam.idÂ 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p style="color:var(--accent-green); font-weight:bold;">ØªØ­Øª Ø³ÙŠØ·Ø±ØªÙƒÙ…</p><div class="island-reward-timer">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø®Ù„Ø§Ù„ ~24 Ø³Ø§Ø¹Ø©</div>`Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<button data-action="challenge-island" data-island-id="${id}" class="btn btn-primary"><i class='bx bxs-flag-alt'></i> ØªØ­Ø¯ÙŠ</button>`}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  }).join('');

Â  Â  });

}



// âœ…âœ…âœ… Ø§Ù„ØµÙ‚ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ø¸ÙŠÙ ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„ÙƒØªÙ„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© âœ…âœ…âœ…

async function handleChallengeIsland(islandId) {
    const islandDef = GAME_CONFIG.islandDefinitions[islandId];
    if (!islandDef) {
        console.error("Island definition not found for:", islandId);
        return;
    }

    showModal("ØªØ­Ø¯ÙŠ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©!", `Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ ${islandDef.name}ØŸ Ø³ØªÙˆØ§Ø¬Ù‡ Ø£Ù†Øª ÙˆÙ„Ø§Ø¹Ø¨ Ø¢Ø®Ø± Ù…Ù† ÙØ±ÙŠÙ‚Ùƒ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø³ÙŠØ·Ø±. Ø§Ù„ÙØ§Ø¦Ø² ÙŠØ³ÙŠØ·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©!`, "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ", "Ø¥Ù„ØºØ§Ø¡", async () => {
        createLobby('island_challenge', { islandId: islandId });
        await updatePlayerStat('islandChallenges');
        showToast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ¨ÙŠ Ù„ØªØ­Ø¯ÙŠ ${islandDef.name}!`);
    });
}

async function grantDailyIslandRewards() {

Â  Â  if (!AppState.playerTeam) return;



Â  Â  const islandsQuery = query(collection(db, "islands"), where("controllingTeamId", "==", AppState.playerTeam.id));

Â  Â  const ownedIslandsSnap = await getDocs(islandsQuery);



Â  Â  const batch = writeBatch(db);

Â  Â  const now = Date.now();

Â  Â  const oneDay = 24 * 60 * 60 * 1000;

Â  Â  let rewardsGranted = 0;

Â  Â  let pointsAwarded = 0;



Â  Â  ownedIslandsSnap.forEach(islandDoc => {

Â  Â  Â  Â  const island = islandDoc.data();

Â  Â  Â  Â  const islandDef = GAME_CONFIG.islandDefinitions[islandDoc.id];

Â  Â  Â  Â  const lastRewardTime = island.lastRewardGrantedAt?.toMillis() || 0;



Â  Â  Â  Â  if (now - lastRewardTime > oneDay) {

Â  Â  Â  Â  Â  Â  const teamRef = doc(db, "teams", island.controllingTeamId);

Â  Â  Â  Â  Â  Â  batch.update(teamRef, { score: increment(islandDef.dailyReward) });

Â  Â  Â  Â  Â  Â  batch.update(islandDoc.ref, { lastRewardGrantedAt: serverTimestamp() });

Â  Â  Â  Â  Â  Â  rewardsGranted++;

Â  Â  Â  Â  Â  Â  pointsAwarded += islandDef.dailyReward;

Â  Â  Â  Â  }

Â  Â  });



Â  Â  if (rewardsGranted > 0) {

Â  Â  Â  Â  await batch.commit();

Â  Â  Â  Â  await updatePlayerStat('islandBonusCollected', rewardsGranted);

Â  Â  Â  Â  showToast(`Ø­ØµÙ„ ÙØ±ÙŠÙ‚Ùƒ Ø¹Ù„Ù‰ ${pointsAwarded} Ù†Ù‚Ø·Ø© ÙƒÙ…ÙƒØ§ÙØ£Ø© Ù„Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ ${rewardsGranted} Ø¬Ø²ÙŠØ±Ø©!`);

Â  Â  }

}

// ===================================================================================

// âœ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙˆØ§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† âœ¨

// ===================================================================================



async function createLobby(type, options = {}) {

Â  Â  if (!AppState.currentUser || !AppState.playerProfile) return showModal("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  const lobbyCode = Math.random().toString(36).substring(2, 7).toUpperCase();

Â  Â  const lobbyRef = doc(db, "lobbies", lobbyCode);

Â  Â  const player = { uid: AppState.currentUser.uid, name: AppState.playerProfile.name, teleoptiId: AppState.playerProfile.id, score: 0 };

Â  Â  const newLobby = {

Â  Â  Â  Â  lobbyCode, type, hostUid: AppState.currentUser.uid,

Â  Â  Â  Â  createdAt: serverTimestamp(), status: "waiting",

Â  Â  Â  Â  players: [player], currentQuestionIndex: -1, answers: {},

Â  Â  Â  Â  options

Â  Â  };

Â  Â  await setDoc(lobbyRef, newLobby);

Â  Â  joinLobby(lobbyCode);

}



function joinLobby(code) {

Â  Â  if (!AppState.currentUser || !AppState.playerProfile) return showModal("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù….", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  const lobbyCode = code.toUpperCase();

Â  Â  const lobbyRef = doc(db, "lobbies", lobbyCode);

Â  Â  cleanupListeners();

Â  Â  AppState.unsubscribers.lobby = onSnapshot(lobbyRef, async (docSnap) => {

Â  Â  Â  Â  if (!docSnap.exists()) {

Â  Â  Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  Â  Â  return showModal("Ø®Ø·Ø£", "Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ØªÙ… Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§.", null, "Ø­Ø³Ù†Ù‹Ø§", () => showScreen('online-menu-screen'));

Â  Â  Â  Â  }

Â  Â  Â  Â  const lobbyData = docSnap.data();

Â  Â  Â  Â  AppState.currentLobbyId = lobbyData.lobbyCode;

Â  Â  Â  Â  const playerInLobby = lobbyData.players.find(p => p.uid === AppState.currentUser.uid);

Â  Â  Â  Â  if (lobbyData.status !== 'waiting' && !playerInLobby) {

Â  Â  Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  Â  Â  return showModal("Ù…ØºÙ„Ù‚", "Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù‚Ø¯ Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª.", null, "Ø­Ø³Ù†Ù‹Ø§", () => showScreen('online-menu-screen'));

Â  Â  Â  Â  }

Â  Â  Â  Â  if (lobbyData.type === '1v1' && lobbyData.players.length >= 2 && !playerInLobby) {

Â  Â  Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  Â  Â  return showModal("Ù…Ù…ØªÙ„Ø¦Ø©", "Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø© Ù…Ù…ØªÙ„Ø¦Ø© Ø¨Ø§Ù„ÙØ¹Ù„.", null, "Ø­Ø³Ù†Ù‹Ø§", () => showScreen('online-menu-screen'));

Â  Â  Â  Â  }

Â  Â  Â  Â  if (!playerInLobby) {

Â  Â  Â  Â  Â  Â  const newPlayer = { uid: AppState.currentUser.uid, name: AppState.playerProfile.name, teleoptiId: AppState.playerProfile.id, score: 0 };

Â  Â  Â  Â  Â  Â  await updateDoc(lobbyRef, { players: arrayUnion(newPlayer) });

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  switch (lobbyData.status) {

Â  Â  Â  Â  Â  Â  Â  Â  case 'waiting':Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showScreen('online-lobby-screen');Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateLobbyScreen(lobbyData);Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'intermission':

Â  Â  Â  Â  Â  Â  Â  Â  case 'in-progress':Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  runGame(lobbyData);Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  Â  Â  case 'finished':Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayGameOver(lobbyData);Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }, (error) => {

Â  Â  Â  Â  console.error("Lobby snapshot error:", error);

Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  showModal("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„", "ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨.", null, "Ø­Ø³Ù†Ù‹Ø§", () => showScreen('main-menu-screen'));

Â  Â  });

}



function updateLobbyScreen(lobbyData) {

Â  Â  if (!lobbyData || !document.getElementById('online-lobby-screen').classList.contains('active')) return;

Â  Â  document.getElementById('lobby-title').textContent = lobbyData.type === '1v1' ? 'Ø±Ø¯Ù‡Ø© Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø© (1 Ø¶Ø¯ 1)' : 'Ø±Ø¯Ù‡Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„Ø­Ø§Ø´Ø¯Ø©';

Â  Â  document.getElementById('lobby-id-display').textContent = lobbyData.lobbyCode;

Â  Â  document.getElementById('player-count').textContent = lobbyData.players.length;

Â  Â  document.getElementById('lobby-players-list').innerHTML = lobbyData.players.map(p => `<div class="list-item" style="justify-content: center;"><span class="item-name">${p.name}${p.uid === lobbyData.hostUid ? ' ğŸ‘‘' : ''}</span></div>`).join('');

Â  Â  const startGameBtn = document.getElementById('start-game');

Â  Â  const isHost = lobbyData.hostUid === AppState.currentUser.uid;

Â  Â  startGameBtn.style.display = isHost ? 'flex' : 'none';

Â  Â  const canStart = lobbyData.type === '1v1' ? lobbyData.players.length === 2 : lobbyData.players.length >= 1;

Â  Â  startGameBtn.disabled = !canStart;

Â  Â  setupLobbyChat();Â 

Â };





function leaveLobby() {

Â  Â  cleanupListeners();

Â  Â  showScreen('online-menu-screen');

}



async function startGame() {

Â  Â  if (!AppState.currentLobbyId) return;

Â  Â  const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

Â  Â  try {

Â  Â  Â  Â  await runTransaction(db, async (t) => {

Â  Â  Â  Â  Â  Â  const lobbyDoc = await t.get(lobbyRef);

Â  Â  Â  Â  Â  Â  if (!lobbyDoc.exists()) throw "Lobby not found";

Â  Â  Â  Â  Â  Â  const lobbyData = lobbyDoc.data();

Â  Â  Â  Â  Â  Â  if (lobbyData.status !== 'waiting') throw "Lobby not in waiting state";

Â  Â  Â  Â  Â  Â  let gameQuestions;

Â  Â  Â  Â  Â  Â  if (lobbyData.type === 'island_challenge') {

Â  Â  Â  Â  Â  Â  Â  Â  gameQuestions = getQuestions(`islands.${lobbyData.options.islandId}`, 10);

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  gameQuestions = getQuestions('online', 30);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  t.update(lobbyRef, { questions: gameQuestions, status: 'in-progress', currentQuestionIndex: 0, questionStartTime: serverTimestamp() });

Â  Â  Â  Â  });

Â  Â  Â  Â  await updatePlayerStat('gamesPlayed');

Â  Â  } catch (error) {

Â  Â  Â  Â  console.error("Failed to start game:", error);

Â  Â  Â  Â  showModal("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  }

}



function runGame(lobbyData) {

Â  Â  if (lobbyData.status === 'in-progress' || lobbyData.status === 'intermission') {

Â  Â  Â  Â  displayOnlineMatchScreen(lobbyData);

Â  Â  } else if (lobbyData.status === 'finished') {

Â  Â  Â  Â  displayGameOver(lobbyData);

Â  Â  }

}



function displayOnlineMatchScreen(lobbyData) {

Â  Â  showScreen('match-screen');

Â  Â  const questionIndex = lobbyData.currentQuestionIndex;

Â  Â  if (questionIndex < 0 || !lobbyData.questions || questionIndex >= lobbyData.questions.length) return;



Â  Â  const question = lobbyData.questions[questionIndex];

Â  Â  const isIntermission = lobbyData.status === 'intermission';



Â  Â  document.getElementById('match-header').textContent = lobbyData.type === '1v1' ? 'Ù…ÙˆØ§Ø¬Ù‡Ø© 1 Ø¶Ø¯ 1' : 'Ù…Ù†Ø§ÙØ³Ø© Ø­Ø§Ø´Ø¯Ø©';

Â  Â  document.getElementById('question-counter').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${questionIndex + 1} / ${lobbyData.questions.length}`;

Â  Â  document.getElementById('question-text').innerHTML = question.question;

Â  Â Â 

Â  Â  const explanationBox = document.getElementById('explanation-box');

Â  Â  if (isIntermission && question.explanation) {

Â  Â  Â  Â  explanationBox.textContent = `Ø§Ù„ØªÙØ³ÙŠØ±: ${question.explanation}`;

Â  Â  Â  Â  explanationBox.style.display = 'block';

Â  Â  } else {

Â  Â  Â  Â  explanationBox.style.display = 'none';

Â  Â  }



Â  Â  const optionsGrid = document.getElementById('options-grid');

Â  Â  optionsGrid.innerHTML = '';

Â  Â  const myAnswerData = lobbyData.answers?.[questionIndex]?.[AppState.currentUser.uid];



Â  Â  Object.entries(question.options).forEach(([key, optionText]) => {

Â  Â  Â  Â  const btn = document.createElement('button');

Â  Â  Â  Â  btn.className = 'btn btn-secondary option-btn';

Â  Â  Â  Â  btn.textContent = optionText;



Â  Â  Â  Â  if (isIntermission) {

Â  Â  Â  Â  Â  Â  btn.classList.add('disabled');

Â  Â  Â  Â  Â  Â  if (key === lobbyData.lastCorrectAnswer) {

Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('correct');

Â  Â  Â  Â  Â  Â  } else if (myAnswerData?.key === key) {

Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('wrong');

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  if (!!myAnswerData) {

Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('disabled');

Â  Â  Â  Â  Â  Â  Â  Â  if (myAnswerData.key === key) btn.style.borderColor = 'var(--accent-yellow)';

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => handleOnlineAnswer(questionIndex, key);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  optionsGrid.appendChild(btn);

Â  Â  });



Â  Â  if (!isIntermission && lobbyData.hostUid === AppState.currentUser.uid) {

Â  Â  Â  Â  clearTimeout(AppState.questionTimer);

Â  Â  Â  Â  AppState.questionTimer = setTimeout(advanceOnlineQuestion, 25000);

Â  Â  }



Â  Â  const scoreboardList = document.getElementById('live-scoreboard-list');

Â  Â  if (scoreboardList) {

Â  Â  Â  Â  const sortedPlayers = [...lobbyData.players].sort((a, b) => (b.score || 0) - (a.score || 0));

Â  Â  Â  Â  scoreboardList.innerHTML = sortedPlayers.map((p, i) => {

Â  Â  Â  Â  Â  Â  const isMe = p.uid === AppState.currentUser.uid;

Â  Â  Â  Â  Â  Â  const myStyle = isMe ? 'background-color: var(--accent-blue);' : '';

Â  Â  Â  Â  Â  Â  return `<div class="list-item" style="padding: 0.75rem; ${myStyle}"><div class="item-info" style="gap: 0.75rem;"><span class="item-rank" style="font-size: 1rem;">${i + 1}</span><span class="item-name" style="font-size: 0.9rem;">${p.name}</span></div><span class="item-value" style="font-size: 1rem;">${p.score || 0}</span></div>`;

Â  Â  Â  Â  }).join('');

Â  Â  }

}



async function handleOnlineAnswer(questionIndex, selectedKey) {

Â  Â  if (!AppState.currentLobbyId || !AppState.currentUser) return;

Â  Â  const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

Â  Â  const answerPath = `answers.${questionIndex}.${AppState.currentUser.uid}`;

Â  Â  await updateDoc(lobbyRef, { [answerPath]: { key: selectedKey, time: serverTimestamp() } });

}



async function advanceOnlineQuestion() {

Â  Â  if (!AppState.currentLobbyId) return;

Â  Â  const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

Â  Â  try {

Â  Â  Â  Â  const lobbyDoc = await getDoc(lobbyRef);

Â  Â  Â  Â  if (!lobbyDoc.exists()) return;

Â  Â  Â  Â Â 

Â  Â  Â  Â  const lobbyData = lobbyDoc.data();

Â  Â  Â  Â  const question = lobbyData.questions[lobbyData.currentQuestionIndex];

Â  Â  Â  Â  const updatedPlayers = scoreOnlineRound(lobbyData, lobbyData.currentQuestionIndex);



Â  Â  Â  Â  await updateDoc(lobbyRef, {

Â  Â  Â  Â  Â  Â  players: updatedPlayers,

Â  Â  Â  Â  Â  Â  lastCorrectAnswer: question.correct_answer,

Â  Â  Â  Â  Â  Â  status: 'intermission'

Â  Â  Â  Â  });



Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  moveToNextQuestion(lobbyData, updatedPlayers);

Â  Â  Â  Â  }, 10000);



Â  Â  } catch (error) {

Â  Â  Â  Â  console.error("Error advancing question:", error);

Â  Â  }

}



async function moveToNextQuestion(lobbyData, players) {

Â  Â  const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

Â  Â  const oldIndex = lobbyData.currentQuestionIndex;



Â  Â  if (oldIndex >= lobbyData.questions.length - 1) {

Â  Â  Â  Â  await updateDoc(lobbyRef, { status: 'finished' });

Â  Â  Â  Â  await finalizeOnlineGameAwards({ ...lobbyData, players: players });

Â  Â  } else {

Â  Â  Â  Â  await updateDoc(lobbyRef, {

Â  Â  Â  Â  Â  Â  status: 'in-progress',

Â  Â  Â  Â  Â  Â  currentQuestionIndex: oldIndex + 1,

Â  Â  Â  Â  Â  Â  lastCorrectAnswer: null,

Â  Â  Â  Â  Â  Â  answers: {}Â 

Â  Â  Â  Â  });

Â  Â  }

}



function scoreOnlineRound(lobbyData, questionIndex) {

Â  Â  if (questionIndex < 0) return lobbyData.players;

Â  Â  const question = lobbyData.questions[questionIndex];

Â  Â  const answersForRound = lobbyData.answers?.[questionIndex] || {};

Â  Â  let players = JSON.parse(JSON.stringify(lobbyData.players));



Â  Â  Object.keys(answersForRound).forEach(uid => {

Â  Â  Â  Â  if (answersForRound[uid].key === question.correct_answer) {

Â  Â  Â  Â  Â  Â  const player = players.find(p => p.uid === uid);

Â  Â  Â  Â  Â  Â  if (player) player.score += 10;

Â  Â  Â  Â  }

Â  Â  });

Â  Â  return players;

}



async function finalizeOnlineGameAwards(lobbyData) {

Â  Â  const batch = writeBatch(db);

Â  Â  const sortedPlayers = [...lobbyData.players].sort((a, b) => (b.score || 0) - (a.score || 0));

Â  Â  if (sortedPlayers.length === 0 || sortedPlayers[0].score === 0) return;



Â  Â  const winner = sortedPlayers[0];

Â  Â  const winnerRef = doc(db, "players", winner.teleoptiId);

Â  Â  let pointsToAdd = 0;



Â  Â  if (lobbyData.type === '1v1' && sortedPlayers.length > 1) {

Â  Â  Â  Â  if (winner.score > (sortedPlayers[1].score || 0)) {

Â  Â  Â  Â  Â  Â  pointsToAdd = 50;

Â  Â  Â  Â  Â  Â  batch.update(winnerRef, { score: increment(pointsToAdd), "stats.wins1v1": increment(1) });

Â  Â  Â  Â  }

Â  Â  } else if (lobbyData.type === 'massive') {

Â  Â  Â  Â  pointsToAdd = 100;

Â  Â  Â  Â  batch.update(winnerRef, {Â 

Â  Â  Â  Â  Â  Â  score: increment(pointsToAdd),

Â  Â  Â  Â  Â  Â  "stats.winsMassive": increment(1)Â 

Â  Â  Â  Â  });

Â  Â  }



Â  Â  await batch.commit();

Â  Â  AppState.playerProfile.score = (AppState.playerProfile.score || 0) + pointsToAdd;

Â  Â  await checkLevelUpAchievements();

} // <--- Ø¥ØºÙ„Ø§Ù‚ finalizeOnlineGameAwards





function displayGameOver(lobbyData) {

Â  Â  cleanupListeners();

Â  Â  showScreen('game-over-screen');

Â  Â  const subtitle = document.getElementById('game-over-subtitle');

Â  Â  const resultsList = document.getElementById('final-results-list');

Â  Â  const sortedPlayers = [...lobbyData.players].sort((a, b) => (b.score || 0) - (a.score || 0));



Â  Â  if (lobbyData.surrendered?.uid) {

Â  Â  Â  Â  const surrenderer = lobbyData.players.find(p => p.uid === lobbyData.surrendered.uid);

Â  Â  Â  Â  const winner = lobbyData.players.find(p => p.uid !== lobbyData.surrendered.uid);

Â  Â  Â  Â  if(subtitle && surrenderer && winner) subtitle.textContent = `${surrenderer.name} Ø§Ø³ØªØ³Ù„Ù…! Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ ${winner.name}!`;

Â  Â  } else if (sortedPlayers.length > 0) {

Â  Â  Â  Â  if(subtitle) subtitle.textContent = `Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ ${sortedPlayers[0].name}!`;

Â  Â  }



Â  Â  if (resultsList) {

Â  Â  Â  Â  resultsList.innerHTML = sortedPlayers.map((p, i) =>

Â  Â  Â  Â  Â  Â  `<div class="list-item"><div class="item-info"><span class="item-rank">${i + 1}</span><span class="item-name">${p.name} ${p.surrendered ? '(Ù…Ø³ØªØ³Ù„Ù…)' : ''}</span></div><span class="item-value">${p.score} Ù†Ù‚Ø·Ø©</span></div>`

Â  Â  Â  Â  ).join('');

Â  Â  }

}



async function surrender() {

Â  Â  showModal("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ³Ù„Ø§Ù…", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ùƒ Ø®Ø§Ø³Ø±Ù‹Ø§.", "Ù†Ø¹Ù…, Ø§Ø³ØªØ³Ù„Ù…", "Ø¥Ù„ØºØ§Ø¡", async () => {

Â  Â  Â  Â  if (!AppState.currentLobbyId || !AppState.currentUser) return;

Â  Â  Â  Â  const lobbyRef = doc(db, "lobbies", AppState.currentLobbyId);

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  await runTransaction(db, async (t) => {

Â  Â  Â  Â  Â  Â  Â  Â  const lobbyDoc = await t.get(lobbyRef);

Â  Â  Â  Â  Â  Â  Â  Â  if (!lobbyDoc.exists()) throw new Error("Lobby not found");

Â  Â  Â  Â  Â  Â  Â  Â  const lobbyData = lobbyDoc.data();

Â  Â  Â  Â  Â  Â  Â  Â  if (lobbyData.status !== 'in-progress') return;



Â  Â  Â  Â  Â  Â  Â  Â  if (lobbyData.type === '1v1') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.update(lobbyRef, {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'finished',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  surrendered: { uid: AppState.currentUser.uid, name: AppState.playerProfile.name }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const players = lobbyData.players;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const playerIndex = players.findIndex(p => p.uid === AppState.currentUser.uid);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (playerIndex > -1) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players[playerIndex].surrendered = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.update(lobbyRef, { players: players });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const finalDoc = await getDoc(lobbyRef);

Â  Â  Â  Â  Â  Â  if (finalDoc.exists() && finalDoc.data().type === 'massive') {

Â  Â  Â  Â  Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  Â  Â  Â  Â  showScreen('main-menu-screen');

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (error) {

Â  Â  Â  Â  Â  Â  console.error("Surrender failed:", error);

Â  Â  Â  Â  }

Â  Â  });

}

// ===================================================================================

// âœ¨ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø© âœ¨

// ===================================================================================

function getPlayerLevelInfo(score = 0) {

Â  Â  const calculatedLevel = Math.floor(score / 500) + 1;

Â  Â  const levelColors = ['#94a3b8', '#3b82f6', '#22c55e', '#facc15', '#ef4444', '#8b5cf6', '#ec4899'];

Â  Â  const color = levelColors[Math.min(Math.floor(calculatedLevel / 10), levelColors.length - 1)];

Â  Â  return { level: calculatedLevel, color: color };

}



async function showLeaderboards(type = 'individual') {

Â  Â  showScreen('leaderboard-screen');

Â  Â  const individualPill = document.getElementById('pills-individual');

Â  Â  const teamsPill = document.getElementById('pills-teams');

Â  Â  const listContainer = document.getElementById('leaderboard-list');

Â  Â  if(!individualPill || !teamsPill || !listContainer) return;

Â  Â  listContainer.innerHTML = `<p>Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>`;

Â  Â Â 

Â  Â  if (type === 'individual') {

Â  Â  Â  Â  individualPill.classList.replace('btn-secondary', 'btn-primary');

Â  Â  Â  Â  teamsPill.classList.replace('btn-primary', 'btn-secondary');

Â  Â  Â  Â  const q = query(collection(db, "players"), orderBy("score", "desc"), limit(50));

Â  Â  Â  Â  const snapshot = await getDocs(q);

Â  Â  Â  Â  const players = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

Â  Â  Â  Â  listContainer.innerHTML = players.length ? players.map((p, i) => {

Â  Â  Â  Â  Â  Â  const { level, color } = getPlayerLevelInfo(p.score);

Â  Â  Â  Â  Â  Â  const medals = (p.awards || []).join(' ');

Â  Â  Â  Â  Â  Â  return `

Â  Â  Â  Â  Â  Â  Â  Â  <div class="list-item">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-info">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-rank">${i+1}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-details">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-name">${p.name}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="player-level" style="background-color: ${color};">Lvl ${level}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="player-medals">${medals}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-value">${p.score || 0}</span>

Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  }).join('') : '<p style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù„Ø¹Ø±Ø¶Ù‡Ù….</p>';

Â  Â  } else {

Â  Â  Â  Â  teamsPill.classList.replace('btn-secondary', 'btn-primary');

Â  Â  Â  Â  individualPill.classList.replace('btn-primary', 'btn-secondary');

Â  Â  Â  Â  const q = query(collection(db, "teams"), orderBy("score", "desc"), limit(50));

Â  Â  Â  Â  const snapshot = await getDocs(q);

Â  Â  Â  Â  const teams = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

Â  Â  Â  Â  listContainer.innerHTML = teams.length ? teams.map((t, i) => `

Â  Â  Â  Â  Â  Â  <div class="list-item">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-info">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-rank">${i+1}</span>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-name">${t.name} [${t.tag}]</span>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <span class="item-value">${t.score || 0}</span>

Â  Â  Â  Â  Â  Â  </div>`

Â  Â  Â  Â  ).join('') : '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Ù‚ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';

Â  Â  }

}

// ===================================================================================

// âœ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø·ÙˆØ± âœ¨

// ===================================================================================

function setupChatScreen(type) {

Â  Â  showScreen('chat-screen');

Â  Â  const titleEl = document.getElementById('chat-screen-title');

Â  Â  const subtitleEl = document.getElementById('chat-screen-subtitle');

Â  Â  const messagesContainer = document.getElementById('chat-messages-list');

Â  Â  const input = document.getElementById('chat-input-field');

Â  Â  const sendBtn = document.getElementById('chat-send-btn');



Â  Â  if (!titleEl || !messagesContainer || !input || !sendBtn) {

Â  Â  Â  Â  Â console.error("Chat screen elements not found!");

Â  Â  Â  Â  Â return;

Â  Â  }

Â  Â Â 

Â  Â  let collectionName = '';

Â  Â Â 

Â  Â  if (type === 'global') {

Â  Â  Â  Â  titleEl.innerHTML = "<i class='bx bxs-message-square-dots'></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©";

Â  Â  Â  Â  subtitleEl.textContent = "ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©.";

Â  Â  Â  Â  collectionName = 'chat_global';

Â  Â  } else if (type === 'team') {

Â  Â  Â  Â  if (!AppState.playerTeam) return showModal("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ ÙØ±ÙŠÙ‚ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙØ±ÙŠÙ‚.", null, "Ø­Ø³Ù†Ù‹Ø§", () => showScreen('main-menu-screen'));

Â  Â  Â  Â  titleEl.innerHTML = `<i class='bx bxs-shield-alt-2'></i> Ø¯Ø±Ø¯Ø´Ø© ÙØ±ÙŠÙ‚ [${AppState.playerTeam.tag}]`;

Â  Â  Â  Â  subtitleEl.textContent = `ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø£Ø¹Ø¶Ø§Ø¡ ÙØ±ÙŠÙ‚Ùƒ.`;

Â  Â  Â  Â  collectionName = `teams/${AppState.playerTeam.id}/chat`;

Â  Â  }



Â  Â  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù‚Ø¯Ø§Ù…Ù‰ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±

Â  Â  if (AppState.unsubscribers.chat) AppState.unsubscribers.chat();

Â  Â Â 

Â  Â  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯

Â  Â  const q = query(collection(db, collectionName), orderBy('timestamp', 'desc'), limit(50));

Â  Â  AppState.unsubscribers.chat = onSnapshot(q, (snapshot) => {messagesContainer.innerHTML = snapshot.docs.map(doc => {

Â  Â  Â  Â  const msg = doc.data();

Â  Â  Â  Â  Â  Â  const isMine = msg.uid === AppState.currentUser.uid;

Â  Â  Â  Â  Â  Â  const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';

Â  Â  Â  Â  Â  Â  return `<div class="chat-message ${isMine ? 'mine' : ''}"><div class="sender">${isMine ? 'Ø£Ù†Ø§' : msg.senderName} <span class="team-tag">[${msg.teamTag || '---'}]</span></div><div class="text" style="direction: rtl;">${msg.text}</div><div class="timestamp">${time}</div></div>`;

Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„

Â  Â  Â  Â  messagesContainer.scrollTop = messagesContainer.scrollHeight;Â 

Â  Â  }, (error) => {

Â  Â  Â  Â  console.error(`Error listening to ${collectionName}:`, error);

Â  Â  Â  Â  messagesContainer.innerHTML = `<p style="text-align:center; color: var(--accent-red);">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.</p>`;

Â  Â  });



Â  Â  // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„

Â  Â  const sendMessageHandler = () => sendChatMessage(collectionName, input);

Â  Â  sendBtn.onclick = sendMessageHandler;

Â  Â Â 

Â  Â  // Ø±Ø¨Ø· Ù…ÙØªØ§Ø­ Enter

Â  Â  input.onkeypress = (e) => {

Â  Â  Â  Â  if (e.key === 'Enter') {

Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  sendMessageHandler();

Â  Â  Â  Â  }

Â  Â  };

}



async function sendChatMessage(collectionName, inputElement) {

Â  Â  const text = inputElement.value.trim();

Â  Â  if (!text || !AppState.currentUser || !collectionName) return;



Â  Â  // ØªØ¹Ø·ÙŠÙ„ Ù…Ø¤Ù‚Øª Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬

Â  Â  inputElement.disabled = true;



Â  Â  try {

Â  Â  Â  Â  await addDoc(collection(db, collectionName), {

Â  Â  Â  Â  Â  Â  uid: AppState.currentUser.uid,

Â  Â  Â  Â  Â  Â  senderName: AppState.playerProfile.name,

Â  Â  Â  Â  Â  Â  teamTag: AppState.playerTeam?.tag || 'N/A',

Â  Â  Â  Â  Â  Â  text: text,

Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()

Â  Â  Â  Â  });



Â  Â  Â  Â  if (collectionName === 'chat_global' && (!AppState.playerProfile.stats.messagesSent || AppState.playerProfile.stats.messagesSent < 1)) {

Â  Â  Â  Â  Â  Â  await updatePlayerStat('messagesSent');

Â  Â  Â  Â  }

Â  Â  Â  Â  inputElement.value = '';

Â  Â  } catch (error) {

Â  Â  Â  Â  console.error("Error sending message:", error);

Â  Â  } finally {

Â  Â  Â  Â  inputElement.disabled = false;

Â  Â  Â  Â  inputElement.focus();

Â  Â  }

}



function setupLobbyChat() {

Â  Â  const lobbyId = AppState.currentLobbyId;

Â  Â  if (!lobbyId) return;



Â  Â  const messagesContainer = document.getElementById('lobby-chat-messages');

Â  Â  const input = document.getElementById('lobby-chat-input');

Â  Â  const sendBtn = document.getElementById('lobby-chat-send');

Â  Â  if (!messagesContainer || !input || !sendBtn) return;

Â  Â Â 

Â  Â  const collectionName = `lobbies/${lobbyId}/chat`;



Â  Â  if (AppState.unsubscribers.lobbyChat) AppState.unsubscribers.lobbyChat();



Â  Â  const q = query(collection(db, collectionName), orderBy('timestamp', 'desc'), limit(25));

Â  Â  AppState.unsubscribers.lobbyChat = onSnapshot(q, (snapshot) => {

Â  Â  Â  Â  messagesContainer.innerHTML = snapshot.docs.reverse().map(doc => {Â  Â  Â  Â  Â  Â  Â const msg = doc.data();

Â  Â  Â  Â  Â  Â  const isMine = msg.uid === AppState.currentUser.uid;

Â  Â  Â  Â  Â  Â  const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';

Â  Â  Â  Â  Â  Â  return `<div class="chat-message ${isMine ? 'mine' : ''}" style="max-width: 95%;"><div class="sender">${isMine ? 'Ø£Ù†Ø§' : msg.senderName}</div><div class="text" style="direction: rtl;">${msg.text}</div><div class="timestamp">${time}</div></div>`;

Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  messagesContainer.scrollTop = messagesContainer.scrollHeight;

Â  Â  });



Â  Â  const sendLobbyMessageHandler = () => sendChatMessage(collectionName, input);

Â  Â  sendBtn.onclick = sendLobbyMessageHandler;

Â  Â Â 

Â  Â  input.onkeypress = (e) => {

Â  Â  Â  Â  if (e.key === 'Enter') {

Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  sendLobbyMessageHandler();

Â  Â  Â  Â  }

Â  Â  };

}

// ===================================================================================

// âœ¨ Ù…Ø´ØºÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âœ¨

// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {

Â  Â  const actions = {

Â  Â  Â  Â  'login': handleLogin,

Â  Â  Â  Â  'logout': handleLogout,

Â  Â  Â  Â  'toggle-music': toggleMusic,

Â  Â  Â  Â  'back': (target) => {

Â  Â  Â  Â  Â  Â  const parentScreenId = target.closest('.screen-container')?.id;

Â  Â  Â  Â  Â  Â  if (parentScreenId === 'level-select-screen') {

Â  Â  Â  Â  Â  Â  Â  Â  displayTiers();

Â  Â  Â  Â  Â  Â  } else if (parentScreenId === 'chat-screen') {

Â  Â  Â  Â  Â  Â  Â  Â  Â if (AppState.unsubscribers.chat) AppState.unsubscribers.chat(); // Stop listening to chat

Â  Â  Â  Â  Â  Â  Â  Â  Â showScreen('main-menu-screen');

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  else {

Â  Â  Â  Â  Â  Â  Â  Â  cleanupListeners();

Â  Â  Â  Â  Â  Â  Â  Â  showScreen('main-menu-screen');

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  },

Â  Â  Â  Â  'show-single-player': displayTiers,

Â  Â  Â  Â  'show-online-menu': () => showScreen('online-menu-screen'),

Â  Â  Â  Â  'create-lobby': (target) => createLobby(target.dataset.type),

Â  Â  Â  Â  'show-join-lobby': () => showScreen('join-lobby-screen'),

Â  Â  Â  Â  'submit-join-lobby': () => {

Â  Â  Â  Â  Â  Â  const code = document.getElementById('lobby-id-input')?.value.trim().toUpperCase();

Â  Â  Â  Â  Â  Â  if (code) joinLobby(code);

Â  Â  Â  Â  Â  Â  else showModal("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©.", null, "Ø­Ø³Ù†Ù‹Ø§");

Â  Â  Â  Â  },

Â  Â  Â  Â  'start-game': startGame,

Â  Â  Â  Â  'leave-lobby': leaveLobby,

Â  Â  Â  Â  'surrender': surrender,

Â  Â  Â  Â  'show-team-hub': showTeamHub,

Â  Â  Â  Â  'show-create-team': () => showScreen('create-team-screen'),

Â  Â  Â  Â  'show-join-team': () => showScreen('join-team-screen'),

Â  Â  Â  Â  'submit-create-team': handleCreateTeam,

Â  Â  Â  Â  'submit-join-team': handleJoinTeam,

Â  Â  Â  Â  'leave-team': handleLeaveTeam,

Â  Â  Â  Â  'show-leaderboards': () => showLeaderboards('individual'),

Â  Â  Â  Â  'show-individual-leaderboard': () => showLeaderboards('individual'),

Â  Â  Â  Â  'show-teams-leaderboard': () => showLeaderboards('teams'),

Â  Â  Â  Â  'show-achievements': showAchievementsScreen,

Â  Â  Â  Â  'show-island-conquest': showIslandConquestScreen,

Â  Â  Â  Â  'challenge-island': (target) => handleChallengeIsland(target.dataset.islandId),

Â  Â  Â  Â  'show-chat': () => setupChatScreen('global'),

Â  Â  Â  Â  'show-team-chat': () => setupChatScreen('team'),

Â  Â  Â  Â  'modal-cancel': hideModal,

Â  Â  Â  Â  'modal-confirm': () => {

Â  Â  Â  Â  Â  Â  if (AppState.modalCallback) AppState.modalCallback();

Â  Â  Â  Â  },

Â  Â  Â  Â  'accept-join-request': (target) => acceptJoinRequest(target.dataset.playerId, target.dataset.teamId),

Â  Â  Â  Â  'decline-join-request': (target) => declineJoinRequest(target.dataset.requestId, target.dataset.teamId),

Â  Â  Â  Â  'show-notifications': showNotificationsScreen,

Â  Â  };



Â  Â  document.body.addEventListener('click', (e) => {

Â  Â  Â  Â  const target = e.target.closest('[data-action]');

Â  Â  Â  Â  if (target && actions[target.dataset.action]) {

Â  Â  Â  Â  Â  Â  if (target.dataset.action === 'start-game' && !target.disabled) {

Â  Â  Â  Â  Â  Â  Â  Â  target.disabled = true;

Â  Â  Â  Â  Â  Â  Â  Â  target.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> ...Ø¬Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©";

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  actions[target.dataset.action](target);

Â  Â  Â  Â  }

Â  Â  });



Â  Â  onAuthStateChanged(auth, (user) => {

Â  Â  Â  Â  AppState.currentUser = user;

Â  Â  Â  Â  if (user) {

Â  Â  Â  Â  Â  Â  const rememberedId = localStorage.getItem('triviaTeleoptiId');

Â  Â  Â  Â  Â  Â  if (rememberedId) {

Â  Â  Â  Â  Â  Â  Â  Â  showScreen('loading-screen');

Â  Â  Â  Â  Â  Â  Â  Â  loadPlayerProfile(rememberedId);

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  showScreen('registration-screen');

Â  Â  Â  Â  Â  Â  Â  Â  repopulateLoginFields();

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  showScreen('registration-screen');

Â  Â  Â  Â  Â  Â  repopulateLoginFields();

Â  Â  Â  Â  }

Â  Â  });

});

</script>

</body>

</html>
